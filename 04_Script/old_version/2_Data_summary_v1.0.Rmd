---
title: "Data_summary"
author: "Takuto Yoshida"
date: "2025-10-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#データの確認
```{r}
summary(ds01_model)
plot_missing(ds01_model)
plot_bar(ds01_model)       # 離散（文字/因子）を棒グラフ
plot_histogram(ds01_model)
```

# 記述統計、外れ値の確認
```{r}
# ---- 記述統計 / EDA（既存チャンクを更新） -------------------------------

# 依存：dplyr, tidyr（普段お使いの tidyverse が読み込み済みなら追加不要）
suppressMessages({
  library(dplyr); library(tidyr)
})

# 1) 変数マッピング（あなたの列名に合わせて必要なところだけ直してください）
varmap <- c(
  tumor_size_cm        = "max_diam_cm",     # 最大腫瘍径[cm]
  tumor_count          = "count",    # 腫瘍個数（数値）
  mvi                  = "mvi",              # 微小血管侵襲（0/1 or カテゴリ）
  intrahepatic_met     = "im",           # 肝内転移（0/1 or カテゴリ）
  differentiation      = "grade_txt",             # 分化度（Well/Mod/Poor 等）
  portal_vein_invasion = "vp_path",           # 門脈浸潤（0/1 or カテゴリ）
  margin_positive      = "sm",       # 断端陽性（0/1 or カテゴリ）
  tumor_volume         = "tumor_vol",          # 腫瘍体積（存在すれば数値）
  cirrhosis            = "cirrhosis",        # 肝硬変（0/1 or カテゴリ）
  albi                 = "albi",             # ALBIスコア（数値）※グレードは別名なら後述で追加
  platelets            = "plt",              # 血小板
  albumin              = "alb",              # アルブミン
  tbil                 = "tbil",             # T-bil 
  afp                  = "afp",              # AFP
  recurrence           = "eventfree10",         # 再発の有無（0/1 or カテゴリ）
  rfs_months           = "rfs_months"        # 無再発生存期間（月）
)

df <- ds01_model

# 2) 実在する列だけ抽出し、必要な二値派生を作る（>5cm、多発、AFP≧400）
exist_cols <- unname(varmap[varmap %in% names(df)])
df_sub <- df[, exist_cols, drop = FALSE]

# 安全に列を取り出すヘルパ（存在しなければ NULL）
col_ <- function(name) if (name %in% names(df)) df[[name]] else NULL

# >5cm
if (varmap["tumor_size_cm"] %in% names(df)) {
  x <- col_(varmap["tumor_size_cm"])
  df_sub$tumor_size_gt5 <- ifelse(is.na(x), NA_integer_, as.integer(x > 5))
}

# 多発（個数 >= 2）
if (varmap["tumor_count"] %in% names(df)) {
  x <- col_(varmap["tumor_count"])
  df_sub$multifocal <- ifelse(is.na(x), NA_integer_, as.integer(x >= 2))
}

# AFP ≥ 400
if (varmap["afp"] %in% names(df)) {
  x <- col_(varmap["afp"])
  df_sub$afp_ge400 <- ifelse(is.na(x), NA_integer_, as.integer(x >= 400))
}

# 3) 数値・カテゴリを仕分け（明示的にカテゴリ扱いしたい変数を指定）
cat_candidates <- c(
  "tumor_size_gt5","multifocal","afp_ge400",
  varmap["mvi"], varmap["intrahepatic_met"], varmap["differentiation"],
  varmap["portal_vein_invasion"], varmap["margin_positive"],
  varmap["cirrhosis"], varmap["recurrence"]
)
cat_vars <- intersect(cat_candidates, names(df_sub))

# 数値候補（上記カテゴリ以外で数値のもの）
num_vars <- names(df_sub)[sapply(df_sub, is.numeric)]
num_vars <- setdiff(num_vars, cat_vars)  # 0/1の二値派生はカテゴリ側へ

# 4) 数値記述統計＋外れ値集計（IQR法）
num_summary <- if (length(num_vars)) {
  do.call(rbind, lapply(num_vars, function(v){
    x <- df_sub[[v]]
    n_tot <- length(x); n <- sum(!is.na(x)); miss <- n_tot - n
    if (n == 0) {
      data.frame(
        var = v, n = 0, missing_n = miss, missing_pct = 100,
        mean = NA, sd = NA, median = NA, q1 = NA, q3 = NA, IQR = NA,
        min = NA, max = NA, outlier_n = NA, outlier_pct = NA,
        stringsAsFactors = FALSE
      )
    } else {
      q1  <- as.numeric(stats::quantile(x, 0.25, na.rm = TRUE))
      q3  <- as.numeric(stats::quantile(x, 0.75, na.rm = TRUE))
      iqr <- q3 - q1
      lower <- q1 - 1.5 * iqr
      upper <- q3 + 1.5 * iqr
      out_n <- sum(x < lower | x > upper, na.rm = TRUE)
      data.frame(
        var = v,
        n = n,
        missing_n = miss,
        missing_pct = round(100 * miss / n_tot, 1),
        mean = mean(x, na.rm = TRUE),
        sd = stats::sd(x, na.rm = TRUE),
        median = stats::median(x, na.rm = TRUE),
        q1 = q1, q3 = q3, IQR = iqr,
        min = suppressWarnings(min(x, na.rm = TRUE)),
        max = suppressWarnings(max(x, na.rm = TRUE)),
        outlier_n = out_n,
        outlier_pct = round(100 * out_n / n, 1),
        stringsAsFactors = FALSE
      )
    }
  }))
} else {
  data.frame()
}

# 5) カテゴリ頻度・割合（NA も一緒に出す）
cat_summary <- if (length(cat_vars)) {
  do.call(rbind, lapply(cat_vars, function(v){
    x <- df_sub[[v]]
    # 0/1 でも factor 化してラベルは「0」「1」に統一
    if (is.numeric(x)) x <- factor(x)
    tbl <- as.data.frame(table(x, useNA = "ifany"), stringsAsFactors = FALSE)
    names(tbl) <- c("level","n")
    tbl$var <- v
    tbl <- tbl %>%
      dplyr::mutate(pct = round(100 * n / sum(n), 1)) %>%
      dplyr::select(var, level, n, pct)
    tbl
  }))
} else {
  data.frame()
}

# 6) 欠損サマリ（対象変数のみ）
missingness <- data.frame(
  var = names(df_sub),
  missing_n = sapply(df_sub, function(x) sum(is.na(x))),
  missing_pct = round(100 * sapply(df_sub, function(x) mean(is.na(x))), 1),
  stringsAsFactors = FALSE
) %>% arrange(desc(missing_pct), var)

# 7) 表示（必要なら write.csv で保存も可）
message("■ 数値記述統計（mean, sd, median, IQR, 外れ値など）")
print(num_summary, row.names = FALSE)

message("■ カテゴリ頻度・割合（NA含む）")
print(cat_summary, row.names = FALSE)

message("■ 欠損サマリ（対象変数）")
print(missingness, row.names = FALSE)

# ▼（追記）出力先とCSV出力（このブロックを既存EDAチャンクの一番下に追加してください）
out_dir <- "/Users/yoshidatakuto/Dropbox/Hokkaido University/大学院医学院/Borderline HCC/Prediction model_Project1/03_Output"
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

write.csv(num_summary, file.path(out_dir, "num_summary.csv"),  row.names = FALSE)
write.csv(cat_summary, file.path(out_dir, "cat_summary.csv"),  row.names = FALSE)
write.csv(missingness, file.path(out_dir, "missingness.csv"),  row.names = FALSE)

```

# 外れ値・欠損値のIDリスト
```{r}
# ---- 欠損・外れ値 IDリスト（別チャンク） --------------------------------
suppressMessages({ library(dplyr) })

# 出力先
out_dir <- "/Users/yoshidatakuto/Dropbox/Hokkaido University/大学院医学院/Borderline HCC/Prediction model_Project1/03_Output"
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

# 解析に必要な変数（ユーザー指定）
varmap <- c(
  tumor_size_cm        = "max_diam_cm",     # 最大腫瘍径[cm]
  tumor_count          = "count",           # 腫瘍個数（数値）
  mvi                  = "mvi",             # 微小血管侵襲（0/1 or カテゴリ）
  intrahepatic_met     = "im",              # 肝内転移（0/1 or カテゴリ）
  differentiation      = "grade_txt",       # 分化度（Well/Mod/Poor 等）
  portal_vein_invasion = "vp_path",         # 門脈浸潤（0/1 or カテゴリ）
  margin_positive      = "sm",              # 断端陽性（0/1 or カテゴリ）
  tumor_volume         = "tumor_vol",       # 腫瘍体積（存在すれば数値）
  cirrhosis            = "cirrhosis",       # 肝硬変（0/1 or カテゴリ）
  albi                 = "albi",            # ALBIスコア（数値）
  platelets            = "plt",             # 血小板
  albumin              = "alb",             # アルブミン
  afp                  = "afp",             # AFP
  recurrence           = "eventfree10",     # 再発の有無（0/1 or カテゴリ）
  rfs_months           = "rfs_months"       # 無再発生存期間（月）
)

df <- ds01_model

# ID列を推定（無ければ連番を付与）
id_candidates <- c("id","ID","patient_id","case_id","record_id","study_id")
id_var <- intersect(id_candidates, names(df))
id_var <- if (length(id_var)) id_var[1] else NULL
if (is.null(id_var)) { df$row_id <- seq_len(nrow(df)); id_var <- "row_id" }

# 実在する列のみ抽出し、キー名（varmap左側）に統一
keep_raw <- varmap[varmap %in% names(df)]
df_sub <- df %>%
  dplyr::select(dplyr::all_of(id_var), dplyr::any_of(unname(keep_raw))) %>%
  dplyr::rename(!!!setNames(unname(keep_raw), names(keep_raw)))  # new = old

# 数値とみなす候補（ここだけは明示）
numeric_expected <- c("tumor_size_cm","tumor_count","tumor_volume","albi","platelets","albumin","afp","rfs_months")
num_vars <- intersect(numeric_expected, setdiff(names(df_sub), id_var))

# 可能なら数値化（文字→数値は抑制的に。非数はNA）
for (v in num_vars) {
  if (!is.numeric(df_sub[[v]])) {
    df_sub[[v]] <- suppressWarnings(as.numeric(df_sub[[v]]))
  }
}

# 欠損レコード（全対象変数）
make_missing_rows <- function(v){
  x <- df_sub[[v]]
  idx <- which(is.na(x))
  if (!length(idx)) return(NULL)
  data.frame(
    id = df_sub[[id_var]][idx],
    variable = v,
    value = NA,
    flag = "missing",
    stringsAsFactors = FALSE
  )
}

# 外れ値（数値のみ；Tukey IQR 法）
make_outlier_rows <- function(v){
  x <- df_sub[[v]]
  x_ok <- x[!is.na(x)]
  if (!length(x_ok)) return(NULL)
  q1 <- as.numeric(stats::quantile(x_ok, 0.25, na.rm=TRUE))
  q3 <- as.numeric(stats::quantile(x_ok, 0.75, na.rm=TRUE))
  iqr <- q3 - q1
  lower <- q1 - 1.5*iqr
  upper <- q3 + 1.5*iqr
  idx <- which(!is.na(x) & (x < lower | x > upper))
  if (!length(idx)) return(NULL)
  data.frame(
    id = df_sub[[id_var]][idx],
    variable = v,
    value = x[idx],
    flag = "outlier",
    stringsAsFactors = FALSE
  )
}

issue_list <- list()

# 欠損（IDを除く全対象変数）
for (v in setdiff(names(df_sub), id_var)) {
  issue_list[[paste0("miss_", v)]] <- make_missing_rows(v)
}

# 外れ値（数値変数のみ）
for (v in num_vars) {
  issue_list[[paste0("out_", v)]] <- make_outlier_rows(v)
}

issues_df <- dplyr::bind_rows(issue_list)
if (is.null(issues_df) || !nrow(issues_df)) {
  message("欠損・外れ値は検出されませんでした。")
  issues_df <- data.frame(id=NA, variable=NA, value=NA, flag=NA)[0,]
} else {
  issues_df <- issues_df %>% dplyr::arrange(variable, id)
}

# 出力（カルテ点検用リスト）
write.csv(issues_df, file.path(out_dir, "anomaly_check.csv"), row.names = FALSE)

# 確認用の先頭表示
print(head(issues_df, 30), row.names = FALSE)
# ---------------------------------------------------------------------------

```



```{r}
df <- ds01_model

# ------------------------ 変数マッピング -------------------------------------
# 左辺=標準名（この名前に統一します） / 右辺=元データ列名
varmap <- c(
  # 術後（病理）
  tumor_size_cm_post   = "max_diam_cm",
  tumor_count_post     = "count",
  # 術前（画像）
  tumor_size_cm_pre    = "tum_diam_pre",
  tumor_count_pre      = "tum_count_pre",
  # その他臨床
  mvi                  = "mvi",
  intrahepatic_met     = "im",
  differentiation      = "grade_txt",
  portal_vein_invasion = "vp_path",
  margin_positive      = "sm",
  tumor_volume         = "tumor_vol",
  fibrosis             = "fibrosis",
  platelets            = "plt",
  albumin              = "alb",      # g/dL
  tbil                 = "tbil",     # mg/dL
  afp                  = "afp",
  sex                  = "sex",
  recurrence           = "eventfree10",
  rfs_months           = "rfs_months"
)

# 実在列だけ抽出し、標準名に統一
# 実在列だけ抽出し、標準名にリネーム（←ここを修正）
keep_raw <- varmap[varmap %in% names(df)]

df_std <- df %>%
  dplyr::select(id, dplyr::any_of(unname(keep_raw))) %>%
  dplyr::rename(!!!stats::setNames(unname(keep_raw), names(keep_raw)))  # new = old


# ------------------------ 派生変数（ALBI/ln/二値化） -------------------------
to_num <- function(x) suppressWarnings(as.numeric(x))
to_pos_log <- function(x) ifelse(!is.na(x) & x > 0, log(x), NA_real_)

# ALBI（日本の単位に合わせた式）
if (all(c("tbil","albumin") %in% names(df_std))) {
  tbil_mgdl <- to_num(df_std$tbil)
  alb_gdl   <- to_num(df_std$albumin)
  df_std$albi_score <- ifelse(
    is.na(tbil_mgdl) | is.na(alb_gdl) | tbil_mgdl <= 0,
    NA_real_,
    (log10(tbil_mgdl * 17.1) * 0.66) + (alb_gdl * 10 * -0.085)
  )
  df_std$albi_grade <- ifelse(
    is.na(df_std$albi_score), NA_integer_,
    ifelse(df_std$albi_score <= -2.60, 1L,
           ifelse(df_std$albi_score <= -1.39, 2L, 3L))
  )
}

# ln 変換（自然対数）
if ("afp" %in% names(df_std))                df_std$ln_afp             <- to_pos_log(to_num(df_std$afp))
if ("tumor_size_cm_pre" %in% names(df_std))  df_std$ln_tumor_size_pre  <- to_pos_log(to_num(df_std$tumor_size_cm_pre))
if ("tumor_size_cm_post" %in% names(df_std)) df_std$ln_tumor_size_post <- to_pos_log(to_num(df_std$tumor_size_cm_post))

# 二値派生：>5 cm（術前/術後）、多発（>=2、術前/術後）、AFP>=400
if ("tumor_size_cm_pre" %in% names(df_std))  df_std$tumor_size_pre_gt5  <- as.integer(to_num(df_std$tumor_size_cm_pre)  > 5)
if ("tumor_size_cm_post" %in% names(df_std)) df_std$tumor_size_post_gt5 <- as.integer(to_num(df_std$tumor_size_cm_post) > 5)
if ("tumor_count_pre"  %in% names(df_std))   df_std$multifocal_pre      <- as.integer(to_num(df_std$tumor_count_pre)    >= 2)
if ("tumor_count_post" %in% names(df_std))   df_std$multifocal_post     <- as.integer(to_num(df_std$tumor_count_post)   >= 2)
if ("afp" %in% names(df_std))                df_std$afp_ge400           <- as.integer(to_num(df_std$afp)                >= 400)

# ------------------------ 記述統計 + 外れ値（IQR法） -------------------------
cat_candidates <- c(
  "tumor_size_pre_gt5","tumor_size_post_gt5","multifocal_pre","multifocal_post","afp_ge400",
  "mvi","intrahepatic_met","differentiation","portal_vein_invasion","margin_positive",
  "cirrhosis","recurrence","sex","albi_grade"
)
cat_vars <- intersect(cat_candidates, names(df_std))

num_vars <- names(df_std)[sapply(df_std, is.numeric)]
num_vars <- setdiff(num_vars, c("id", cat_vars))  # 二値派生はカテゴリ扱いへ

# 数値 記述統計＋外れ値
num_summary <- if (length(num_vars)) {
  do.call(rbind, lapply(num_vars, function(v){
    x <- df_std[[v]]
    n_tot <- length(x); n <- sum(!is.na(x)); miss <- n_tot - n
    if (n == 0) {
      data.frame(var=v, n=0, missing_n=miss, missing_pct=100,
                 mean=NA, sd=NA, median=NA, q1=NA, q3=NA, IQR=NA,
                 min=NA, max=NA, outlier_n=NA, outlier_pct=NA, stringsAsFactors=FALSE)
    } else {
      q1 <- as.numeric(stats::quantile(x, 0.25, na.rm=TRUE))
      q3 <- as.numeric(stats::quantile(x, 0.75, na.rm=TRUE))
      iqr <- q3 - q1; lower <- q1 - 1.5*iqr; upper <- q3 + 1.5*iqr
      out_n <- sum(x < lower | x > upper, na.rm = TRUE)
      data.frame(
        var=v, n=n, missing_n=miss, missing_pct=round(100*miss/n_tot,1),
        mean=mean(x, na.rm=TRUE), sd=stats::sd(x, na.rm=TRUE),
        median=stats::median(x, na.rm=TRUE),
        q1=q1, q3=q3, IQR=iqr,
        min=suppressWarnings(min(x, na.rm=TRUE)),
        max=suppressWarnings(max(x, na.rm=TRUE)),
        outlier_n=out_n, outlier_pct=round(100*out_n/n,1),
        stringsAsFactors=FALSE
      )
    }
  }))
} else data.frame()

# カテゴリ 頻度・割合
cat_summary <- if (length(cat_vars)) {
  do.call(rbind, lapply(cat_vars, function(v){
    x <- df_std[[v]]
    if (is.numeric(x)) x <- factor(x)
    tbl <- as.data.frame(table(x, useNA = "ifany"), stringsAsFactors = FALSE)
    names(tbl) <- c("level","n")
    tbl$var <- v
    tbl %>%
      dplyr::mutate(pct = round(100 * n / sum(n), 1)) %>%
      dplyr::select(var, level, n, pct)
  }))
} else data.frame()


# 欠損サマリ
missingness <- data.frame(
  var = setdiff(names(df_std), "id"),
  missing_n = sapply(df_std[ , setdiff(names(df_std), "id"), drop=FALSE], function(x) sum(is.na(x))),
  missing_pct = round(100 * sapply(df_std[ , setdiff(names(df_std), "id"), drop=FALSE], function(x) mean(is.na(x))), 1),
  stringsAsFactors = FALSE
) %>% arrange(desc(missing_pct), var)

# 表示＆保存
message("■ 数値記述統計"); print(num_summary, row.names = FALSE)
message("■ カテゴリ頻度・割合"); print(cat_summary, row.names = FALSE)
message("■ 欠損サマリ"); print(missingness, row.names = FALSE)

write.csv(num_summary, file.path(out_dir, "num_summary.csv"),  row.names = FALSE)
write.csv(cat_summary, file.path(out_dir, "cat_summary.csv"),  row.names = FALSE)
write.csv(missingness, file.path(out_dir, "missingness.csv"),  row.names = FALSE)

# ------------------------ 欠損/外れ値 ID リスト ------------------------------
# 数値として扱う標準名（術前/術後の腫瘍径・個数を含む）
numeric_expected <- c(
  "tumor_size_cm_pre","tumor_count_pre","tumor_size_cm_post","tumor_count_post",
  "tumor_volume","platelets","albumin","tbil","afp","rfs_months",
  "albi_score","ln_afp","ln_tumor_size_pre","ln_tumor_size_post"
)
num_vars2 <- intersect(numeric_expected, names(df_std))

make_missing_rows <- function(v){
  x <- df_std[[v]]
  idx <- which(is.na(x))
  if (!length(idx)) return(NULL)
  data.frame(id = df_std$id[idx], variable = v, value = NA, flag = "missing", stringsAsFactors = FALSE)
}
make_outlier_rows <- function(v){
  x <- df_std[[v]]; x_ok <- x[!is.na(x)]
  if (!length(x_ok)) return(NULL)
  q1 <- as.numeric(stats::quantile(x_ok, 0.25, na.rm=TRUE))
  q3 <- as.numeric(stats::quantile(x_ok, 0.75, na.rm=TRUE))
  iqr <- q3 - q1; lower <- q1 - 1.5*iqr; upper <- q3 + 1.5*iqr
  idx <- which(!is.na(x) & (x < lower | x > upper))
  if (!length(idx)) return(NULL)
  data.frame(id = df_std$id[idx], variable = v, value = x[idx], flag = "outlier", stringsAsFactors = FALSE)
}

issue_list <- list()
for (v in setdiff(names(df_std), "id")) issue_list[[paste0("miss_", v)]] <- make_missing_rows(v)
for (v in num_vars2)                   issue_list[[paste0("out_", v)]]  <- make_outlier_rows(v)

issues_df <- dplyr::bind_rows(issue_list)
if (is.null(issues_df) || !nrow(issues_df)) {
  message("欠損・外れ値は検出されませんでした。")
  issues_df <- data.frame(id=NA, variable=NA, value=NA, flag=NA)[0,]
} else {
  issues_df <- issues_df %>% dplyr::arrange(variable, id)
}
write.csv(issues_df, file.path(out_dir, "anomaly_check.csv"), row.names = FALSE)
print(head(issues_df, 30), row.names = FALSE)

# ------------------------ ERASL-pre / ERASL-post 特徴量 ----------------------
# sex_male 生成（男=1, 女=0）
sex_to01 <- function(z){
  if (is.null(z)) return(rep(NA_integer_, nrow(df_std)))
  if (is.numeric(z)) {
    u <- sort(unique(na.omit(as.numeric(z))))
    if (length(u) == 2) return(as.integer(as.numeric(z) == max(u)))
    return(as.integer(z))
  } else {
    s <- tolower(as.character(z))
    out <- ifelse(s %in% c("m","male","man","boy","1","男性","男"), 1L,
             ifelse(s %in% c("f","female","woman","girl","0","女性","女"), 0L, NA_integer_))
    return(as.integer(out))
  }
}
mvi_to01 <- function(z){
  if (is.null(z)) return(rep(NA_integer_, nrow(df_std)))
  if (is.numeric(z)) return(as.integer(z))
  s <- tolower(as.character(z))
  out <- ifelse(s %in% c("1","yes","y","positive","pos","present","あり","有","陽性"), 1L,
           ifelse(s %in% c("0","no","n","negative","neg","absent","なし","無","陰性"), 0L, NA_integer_))
  as.integer(out)
}

sex_male <- if ("sex" %in% names(df_std)) sex_to01(df_std$sex) else rep(NA_integer_, nrow(df_std))

# ERASL-pre = sex_male, albi_grade, ln(AFP), ln(腫瘍径_術前), 腫瘍個数_術前
feat_ERASL_pre <- data.frame(
  id = df_std$id,
  sex_male = sex_male,
  albi_grade = if ("albi_grade" %in% names(df_std)) df_std$albi_grade else NA,
  ln_afp = if ("ln_afp" %in% names(df_std)) df_std$ln_afp else NA,
  ln_tumor_size_cm = if ("ln_tumor_size_pre" %in% names(df_std)) df_std$ln_tumor_size_pre else NA,
  tumor_count = if ("tumor_count_pre" %in% names(df_std)) to_num(df_std$tumor_count_pre) else NA
)

miss_mat_pre <- sapply(feat_ERASL_pre[,-1, drop=FALSE], function(x) is.na(x))
miss_any_pre <- if (is.null(dim(miss_mat_pre))) miss_mat_pre else apply(miss_mat_pre, 1, any)
miss_cols_pre <- apply(as.data.frame(miss_mat_pre), 1, function(r) paste(names(r)[which(r)], collapse="|"))
missing_ids_ERASL_pre <- data.frame(id = feat_ERASL_pre$id[miss_any_pre], missing_cols = miss_cols_pre[miss_any_pre])

write.csv(feat_ERASL_pre,          file.path(out_dir, "features_ERASL_pre.csv"),         row.names = FALSE)
write.csv(missing_ids_ERASL_pre,   file.path(out_dir, "missing_ids_ERASL_pre.csv"),      row.names = FALSE)

# ERASL-post = ERASL-pre + MVI（術後情報を含む）
feat_ERASL_post <- data.frame(
  id = df_std$id,
  sex_male = sex_male,
  albi_grade = if ("albi_grade" %in% names(df_std)) df_std$albi_grade else NA,
  ln_afp = if ("ln_afp" %in% names(df_std)) df_std$ln_afp else NA,
  ln_tumor_size_cm = if ("ln_tumor_size_post" %in% names(df_std)) df_std$ln_tumor_size_post else NA,
  tumor_count = if ("tumor_count_post" %in% names(df_std)) to_num(df_std$tumor_count_post) else NA,
  mvi = if ("mvi" %in% names(df_std)) mvi_to01(df_std$mvi) else NA
)

miss_mat_post <- sapply(feat_ERASL_post[,-1, drop=FALSE], function(x) is.na(x))
miss_any_post <- if (is.null(dim(miss_mat_post))) miss_mat_post else apply(miss_mat_post, 1, any)
miss_cols_post <- apply(as.data.frame(miss_mat_post), 1, function(r) paste(names(r)[which(r)], collapse="|"))
missing_ids_ERASL_post <- data.frame(id = feat_ERASL_post$id[miss_any_post], missing_cols = miss_cols_post[miss_any_post])

write.csv(feat_ERASL_post,         file.path(out_dir, "features_ERASL_post.csv"),        row.names = FALSE)
write.csv(missing_ids_ERASL_post,  file.path(out_dir, "missing_ids_ERASL_post.csv"),     row.names = FALSE)

message("出力ファイル：",
        "\n- num_summary.csv, cat_summary.csv, missingness.csv",
        "\n- anomaly_check.csv",
        "\n- features_ERASL_pre.csv / missing_ids_ERASL_pre.csv",
        "\n- features_ERASL_post.csv / missing_ids_ERASL_post.csv")
# ============================================================================


```

```{r}
# ========= Skewness チェック：right / left skew の一覧を作成 =========
suppressMessages({ library(dplyr) })

# 解析対象データ（df_std があれば優先、なければ ds01_model）
stopifnot(exists("ds01_model"))
dat <- if (exists("df_std")) df_std else ds01_model

# 数値列の抽出（id 等は除外したい場合はここで指定）
exclude_cols <- c("id")
num_cols <- names(dat)[sapply(dat, function(x) is.numeric(x) || inherits(x, "integer"))]
num_cols <- setdiff(num_cols, exclude_cols)

# 歪度（skewness）の手計算（パッケージ不要：モーメント比）
skewness_moment <- function(x){
  x <- x[is.finite(x)]
  n <- length(x)
  if (n < 3) return(NA_real_)
  mu <- mean(x)
  m2 <- mean((x - mu)^2)
  if (m2 <= 0) return(NA_real_)
  m3 <- mean((x - mu)^3)
  m3 / (m2^(3/2))
}

# 判定しきい値（調整可）
thr_moderate <- 0.5   # |skew| >= 0.5 で「やや歪み」
thr_strong   <- 1.0   # |skew| >= 1.0 で「強い歪み」

# 推奨変換のヒント
suggest_transform <- function(sk, x_min){
  if (is.na(sk)) return(NA_character_)
  if (sk > 0) {
    # 右裾重（right skew）
    if (is.finite(x_min) && x_min > 0) return("log(x) or sqrt(x)")
    if (is.finite(x_min) && x_min >= 0) return("log1p(x) or sqrt(x)")
    return("Yeo-Johnson / Box-Cox (shift)")
  } else if (sk < 0) {
    # 左裾重（left skew）
    if (is.finite(x_min) && x_min >= 0) return("square(x) or reflect+log")
    return("reflect+log (e.g., log(max+1 - x))")
  } else return("none")
}

# 集計
skew_tbl <- lapply(num_cols, function(v){
  x <- dat[[v]]
  x_use <- x[is.finite(x)]
  n <- length(x_use)
  if (!n) {
    return(data.frame(
      variable = v, n = 0, skewness = NA_real_, direction = NA_character_,
      magnitude = NA_character_, min = NA_real_, max = NA_real_, recommend = NA_character_,
      stringsAsFactors = FALSE
    ))
  }
  sk <- skewness_moment(x_use)
  dir <- ifelse(is.na(sk), NA_character_,
                ifelse(sk > 0, "right", ifelse(sk < 0, "left", "symmetric")))
  mag <- ifelse(is.na(sk), NA_character_,
                ifelse(abs(sk) >= thr_strong,  "strong",
                       ifelse(abs(sk) >= thr_moderate, "moderate", "weak/none")))
  rec <- suggest_transform(sk, suppressWarnings(min(x_use)))
  data.frame(
    variable = v,
    n = n,
    skewness = unname(sk),
    direction = dir,
    magnitude = mag,
    min = suppressWarnings(min(x_use)),
    max = suppressWarnings(max(x_use)),
    recommend = rec,
    stringsAsFactors = FALSE
  )
}) %>% dplyr::bind_rows() %>%
  dplyr::arrange(dplyr::desc(abs(skewness)))

# 結果の確認
print(skew_tbl, row.names = FALSE)

# 右/左 skew のみ抽出（参考）
right_skew <- skew_tbl %>% dplyr::filter(!is.na(skewness) & skewness > 0)
left_skew  <- skew_tbl %>% dplyr::filter(!is.na(skewness) & skewness < 0)

cat("\n候補（右裾重 top 10）:\n"); print(head(right_skew, 10), row.names = FALSE)
cat("\n候補（左裾重 top 10）:\n");  print(head(left_skew, 10),  row.names = FALSE)

# （任意）CSV保存：出力先を既存の out_dir に合わせています
if (!exists("out_dir")) {
  out_dir <- "/Users/yoshidatakuto/Dropbox/Hokkaido University/大学院医学院/Borderline HCC/Prediction model_Project1/03_Output"
  if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
}
write.csv(skew_tbl, file.path(out_dir, "skewness_summary.csv"), row.names = FALSE)

```

```{r}
ds01_model %>% summarise(op_date_min = min(op_date, na.rm=TRUE),
                         op_date_max = max(op_date, na.rm=TRUE))

```

