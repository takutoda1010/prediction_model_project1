---
title: "3_Model_v1.1"
author: "Takuto Yoshida"
date: "2025-10-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

ERASL-postと同じ要領でモデルを作成する。

```{r}
# ---- Packages ----
base_libs <- c("tidyverse","survival","broom","survminer","MASS","rlang","conflicted")
to_install <- setdiff(base_libs, rownames(installed.packages()))
if(length(to_install)) install.packages(to_install)

suppressPackageStartupMessages({
  library(tidyverse)   # dplyr, tidyr, stringr など
  library(survival)
  library(broom)
  library(survminer)
  library(MASS)
  library(rlang)
  library(conflicted)
})

# ---- Prefer dplyr / purrr over others to avoid masking ----
conflict_prefer("select",   "dplyr")
conflict_prefer("filter",   "dplyr")
conflict_prefer("mutate",   "dplyr")
conflict_prefer("summarise","dplyr")
conflict_prefer("group_by", "dplyr")
conflict_prefer("arrange",  "dplyr")
conflict_prefer("rename",   "dplyr")
conflict_prefer("slice",    "dplyr")
conflict_prefer("lag",      "dplyr")
conflict_prefer("across",   "dplyr")
conflict_prefer("flatten",      "purrr")
conflict_prefer("flatten_chr",  "purrr")
conflict_prefer("flatten_dbl",  "purrr")
conflict_prefer("flatten_int",  "purrr")
conflict_prefer("flatten_lgl",  "purrr")
conflict_prefer("flatten_raw",  "purrr")

options(stringsAsFactors = FALSE, dplyr.summarise.inform = FALSE)
set.seed(123)

```

# ChatGPTに渡す用の変数一覧作成
```{r}
# ds01_model が存在する前提
stopifnot(exists("ds01_model"))
df <- ds01_model
n  <- nrow(df)

names_vec <- names(df)
cls       <- sapply(df, function(x) class(x)[1])
n_miss    <- sapply(df, function(x) sum(is.na(x)))
pct_miss  <- round(100 * n_miss / pmax(n, 1), 1)
n_unique  <- sapply(df, function(x) length(unique(x[!is.na(x)])))
example   <- sapply(df, function(x){
  v <- x[!is.na(x)]
  if (length(v) == 0) return("")
  paste(head(as.character(v), 3), collapse = ", ")
})

out <- data.frame(
  name      = names_vec,
  class     = cls,
  n         = n,
  n_miss    = n_miss,
  pct_miss  = pct_miss,
  n_unique  = n_unique,
  example   = example,
  stringsAsFactors = FALSE
)

# 名前順で見やすく
out <- out[order(out$name), ]

# 画面に表として表示（コピペしやすい）
print(out, row.names = FALSE)

# ---- 保存先を指定してCSV出力 ----
out_dir <- "/Users/yoshidatakuto/Dropbox/Hokkaido University/大学院医学院/Borderline HCC/Prediction model_Project1/03_Output"
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

outfile <- file.path(out_dir, "ds01_model_variables.csv")
write.csv(out, outfile, row.names = FALSE, fileEncoding = "UTF-8")

cat("Saved to: ", outfile, "\n")
```

# 不要な変数の削除
```{r}
# ===== 書き直しコード1：ds02 作成（行・列フィルタ）＋ 変数一覧出力 =====
# 前提：ds01_model が存在
stopifnot(exists("ds01_model"))

# 出力先
out_dir <- "/Users/yoshidatakuto/Dropbox/Hokkaido University/大学院医学院/Borderline HCC/Prediction model_Project1/03_Output"
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

# 不要列リスト
drop_vars <- c(
  "adm_dt","age_grp60","afp500_cat","comp_any_grade","comp_ascites","comp_bile","comp_bleeding",
  "comp_gi","comp_pleural","comp_resp","comp_txt","comp_wound","curability","dob",
  "fibrosis_score_old","first_visit_dt","func_resect_rate","grade_old","grade_txt",
  "grading_score_old","group","hbv_past","icg10_cat","nc_liver_stage_old","nh3",
  "num","op_date","op_dx_txt","op_proc_cat","op_proc_txt","pivka200_cat","pofil",
  "pre_func_rate","pre_liver_vol","pre_remnant_vol","pre_tumor_vol","pringle","ps",
  "ptpe","rehepatectomy","surgeon_name","tbil_post_grade","thoraco_lap","uni_vs_2to3",
  "w2_func_rate","w2_liver_vol","w2_tumor_vol","stage_diag","stage_surg","tnum_cat"
)

# 1) 行フィルタ：group が "Con" または "NAC" を除外
df <- ds01_model
if ("group" %in% names(df)) {
  df <- df[ !(tolower(df$group) %in% c("con","nac")), , drop = FALSE ]
}

# 2) 欠測30%以上の列を削除
miss_frac <- sapply(df, function(x) mean(is.na(x)))
df <- df[ , miss_frac < 0.30 | is.na(miss_frac), drop = FALSE ]

# 3) 指定の不要列を削除（存在するものだけ）
df <- df[ , setdiff(names(df), drop_vars), drop = FALSE ]

# 4) 完成データ
ds02 <- df

# 5) 変数一覧CSV出力
n  <- nrow(ds02)
nm <- names(ds02)
cls <- sapply(ds02, function(x) class(x)[1])
n_miss <- sapply(ds02, function(x) sum(is.na(x)))
pct_miss <- round(100 * n_miss / max(n,1), 1)
n_unique <- sapply(ds02, function(x) length(unique(x[!is.na(x)])))
example <- sapply(ds02, function(x){
  v <- x[!is.na(x)]
  if (!length(v)) "" else paste(head(as.character(v), 3), collapse = ", ")
})
out <- data.frame(
  name = nm, class = cls, n = n, n_miss = n_miss,
  pct_miss = pct_miss, n_unique = n_unique, example = example,
  stringsAsFactors = FALSE
)
out <- out[order(out$name), ]
outfile <- file.path(out_dir, "ds02_variables.csv")
utils::write.csv(out, outfile, row.names = FALSE, fileEncoding = "UTF-8")
cat("Saved ds02_variables.csv to: ", outfile, "\n")

```

# 変数作成
```{r}
# ===== 書き直しコード2：CHUNK1 — ds02→ds03（ALBI/MVI/MacroVI作成＋対数変換まで） =====
stopifnot(exists("ds02"))

# ---- Helpers ----
log_safely <- function(x, eps = 1e-6) log(pmax(as.numeric(x), eps))
mk_tnum_cat <- function(k){
  k <- suppressWarnings(as.integer(k))
  dplyr::case_when(
    is.na(k)    ~ NA_integer_,
    k <= 1      ~ 0L,
    k %in% 2:3  ~ 1L,
    k >= 4      ~ 2L
  )
}
sex_to01 <- function(s){
  x <- as.character(s); x <- trimws(x)
  out <- rep(NA_real_, length(x))
  out[grepl("^(M|Male|male|m|1)$", x)] <- 1
  out[grepl("^(F|Female|female|f|0)$", x)] <- 0
  suppressWarnings({
    xn <- as.numeric(x)
    out[is.na(out) & !is.na(xn)] <- ifelse(xn >= 1, 1, 0)
  })
  out
}
bin_to01 <- function(v){   # "+"/"pos"/"陽性"/1 →1,  "−"/"neg"/"陰性"/0 →0
  x <- as.character(v); x <- trimws(x)
  out <- rep(NA_integer_, length(x))
  out[grepl("^(1|\\+|pos|positive|yes|true|陽性)$", x, ignore.case = TRUE)] <- 1L
  out[grepl("^(0|-|neg|negative|no|false|陰性)$",   x, ignore.case = TRUE)] <- 0L
  suppressWarnings({
    xn <- as.numeric(x)
    out[is.na(out) & !is.na(xn)] <- as.integer(xn > 0)
  })
  out
}
calc_albi <- function(alb_g_dl, tbil_mg_dl){
  alb_g_l   <- alb_g_dl * 10
  tbil_umol <- tbil_mg_dl * 17.1
  score <- 0.66*log10(pmax(tbil_umol, 1e-6)) - 0.085*alb_g_l
  grade <- dplyr::case_when(
    is.na(score)     ~ NA_integer_,
    score <= -2.60   ~ 1L,
    score <= -1.39   ~ 2L,
    TRUE             ~ 3L
  )
  tibble::tibble(albi_score = score, albi_grade = grade)
}

# ---- 前処理：必要列の型そろえ ----
ds02 <- ds02 %>%
  dplyr::mutate(
    alb  = suppressWarnings(as.numeric(alb)),
    tbil = suppressWarnings(as.numeric(tbil))
  )

# ---- ALBI（無ければ作成） ----
if (!all(c("albi_score","albi_grade") %in% names(ds02)) || all(is.na(ds02$albi_score))) {
  albi_tmp <- calc_albi(ds02$alb, ds02$tbil)
  ds02 <- dplyr::bind_cols(ds02, albi_tmp)
}

# ---- MVI（無ければ作成：pre陰性 & path陽性 →1）----
if (!("mvi_01" %in% names(ds02))) {
  ds02 <- ds02 %>%
    dplyr::mutate(
      vp_pre  = suppressWarnings(as.integer(vp_pre)),
      vv_pre  = suppressWarnings(as.integer(vv_pre)),
      vp_path = suppressWarnings(as.integer(vp_path)),
      vv_path = suppressWarnings(as.integer(vv_path)),
      mvi_01 = dplyr::case_when(
        (!is.na(vp_pre) & vp_pre==0L & !is.na(vp_path) & vp_path >= 1L) ~ 1L,
        (!is.na(vv_pre) & vv_pre==0L & !is.na(vv_path) & vv_path >= 1L) ~ 1L,
        (!is.na(vp_pre) & vp_pre==0L & !is.na(vp_path) & vp_path==0L &
         !is.na(vv_pre) & vv_pre==0L & !is.na(vv_path) & vv_path==0L)   ~ 0L,
        TRUE ~ NA_integer_
      )
    )
}

# ---- Macro vascular invasion（新規追加：Vp_pre / Va_pre / Vv_pre のいずれか陽性で1）----
vp_pre_x <- if ("vp_pre" %in% names(ds02)) bin_to01(ds02$vp_pre) else rep(NA_integer_, nrow(ds02))
va_pre_x <- if ("va_pre" %in% names(ds02)) bin_to01(ds02$va_pre) else rep(NA_integer_, nrow(ds02))
vv_pre_x <- if ("vv_pre" %in% names(ds02)) bin_to01(ds02$vv_pre) else rep(NA_integer_, nrow(ds02))
pos_any  <- (vp_pre_x == 1L) | (va_pre_x == 1L) | (vv_pre_x == 1L)
all_zero <- (vp_pre_x %in% 0L | is.na(vp_pre_x)) &
            (va_pre_x %in% 0L | is.na(va_pre_x)) &
            (vv_pre_x %in% 0L | is.na(vv_pre_x))
macro_vi_pre01 <- ifelse(pos_any, 1L, ifelse(all_zero, 0L, NA_integer_))
ds02$macro_vi_pre01 <- macro_vi_pre01

# ---- ds03：解析用の整形＋対数変換 ----
ds03 <- ds02 %>%
  dplyr::mutate(
    .id    = id,
    time   = as.numeric(rfs_months),
    status = as.integer(recur_tf),

    afp          = suppressWarnings(as.numeric(afp)),
    afp_l3       = suppressWarnings(as.numeric(afp_l3)),
    age          = suppressWarnings(as.numeric(age)),
    alb          = suppressWarnings(as.numeric(alb)),
    alt          = suppressWarnings(as.numeric(alt)),
    ast          = suppressWarnings(as.numeric(ast)),
    bleed_ml     = suppressWarnings(as.numeric(bleed_ml)),
    ca19_9       = suppressWarnings(as.numeric(ca19_9)),
    cea          = suppressWarnings(as.numeric(cea)),
    che          = suppressWarnings(as.numeric(che)),
    icg_r15      = suppressWarnings(as.numeric(icg_r15)),
    lhl15        = suppressWarnings(as.numeric(lhl15)),
    max_diam_cm  = suppressWarnings(as.numeric(max_diam_cm)),
    n            = suppressWarnings(as.numeric(n)),
    op_time_min  = suppressWarnings(as.numeric(op_time_min)),
    pivka2       = suppressWarnings(as.numeric(pivka2)),
    plt          = suppressWarnings(as.numeric(plt)),
    pt_inr       = suppressWarnings(as.numeric(pt_inr)),
    specimen_wt  = suppressWarnings(as.numeric(specimen_wt)),
    tbil         = suppressWarnings(as.numeric(tbil)),
    tum_count_pre= suppressWarnings(as.integer(tum_count_pre)),
    tum_diam_pre = suppressWarnings(as.numeric(tum_diam_pre)),
    weight_kg    = suppressWarnings(as.numeric(weight_kg)),

    sex01        = sex_to01(sex),

    ALBI     = suppressWarnings(as.numeric(albi_score)),
    ALBI_g   = suppressWarnings(as.integer(albi_grade)),
    ALBI_23  = dplyr::if_else(is.na(ALBI_g), NA_integer_, dplyr::if_else(ALBI_g==1L, 0L, 1L)),
    mvi_01   = suppressWarnings(as.integer(mvi_01)),

    ln_afp         = log_safely(afp),
    ln_tbil        = log_safely(tbil),
    ln_plt         = log_safely(plt),
    ln_tum_pre_cm  = log_safely(tum_diam_pre),
    ln_max_diam_cm = log_safely(max_diam_cm),

    revlog_alb = { mx <- suppressWarnings(max(alb, na.rm = TRUE)); log_safely(mx + 1 - alb) },

    tnum_cat = mk_tnum_cat(tum_count_pre)
  ) %>%
  dplyr::select(dplyr::any_of(c(
    # アウトカム
    ".id","time","status",
    # 原候補（連続）
    "afp","afp_l3","age","alb","alt","ast","bleed_ml","ca19_9","cea","che",
    "icg_r15","lhl15","max_diam_cm","n","op_time_min","pivka2","plt","pt_inr",
    "specimen_wt","tbil","tum_count_pre","tum_diam_pre","weight_kg",
    # 原候補（カテゴリ）
    "b_path","child_pugh","fc","fc_inf","fibrosis_score","group_rb","growth_type",
    "hbv","hcv","im","liver_damage","m","sf","sm","stage","t",
    # 追加：Macro VI（pre）
    "macro_vi_pre01",
    # 置換/派生
    "sex01","ALBI","ALBI_g","ALBI_23","mvi_01","tnum_cat",
    "ln_afp","ln_tbil","ln_plt","ln_tum_pre_cm","ln_max_diam_cm","revlog_alb"
  ))) %>%
  dplyr::mutate(
    status   = dplyr::if_else(is.na(status), NA_integer_, as.integer(status == 1L)),
    tnum_cat = factor(tnum_cat, levels = c(0,1,2), labels = c("single","two_three","ge4"))
  )

# 確認（不足カラム表示）
needed <- c(
  "afp","afp_l3","age","alb","alt","ast","bleed_ml","ca19_9","cea","che",
  "icg_r15","lhl15","max_diam_cm","n","op_time_min","pivka2","plt","pt_inr",
  "specimen_wt","tbil","tum_count_pre","tum_diam_pre","weight_kg",
  "b_path","child_pugh","fc","fc_inf","fibrosis_score","group_rb","growth_type",
  "hbv","hcv","im","liver_damage","m","sf","sm","stage","t",
  "sex01","ALBI","mvi_01","macro_vi_pre01","tnum_cat",
  "ln_afp","ln_tbil","ln_plt","ln_tum_pre_cm","ln_max_diam_cm","revlog_alb"
)
miss <- setdiff(needed, names(ds03))
if(length(miss)) message("Missing in ds03: ", paste(miss, collapse=", "))

```


# 単変量解析スクリーニング
```{r}
# ===== CHUNK 3 — 2年再発（早期再発）に対する単変量Cox：p<0.20抽出（右スキューはログ/Albは反転ログ） =====
stopifnot(exists("ds03"))

# ---- 2年アウトカム（ERASLと同義）----
ds04 <- ds03 %>%
  dplyr::mutate(
    time2y  = ifelse(is.na(time), NA_real_, pmin(time, 24)),
    event2y = dplyr::case_when(
      !is.na(status) & !is.na(time) & status==1L & time <= 24 ~ 1L,
      !is.na(status) & !is.na(time)                            ~ 0L,
      TRUE                                                    ~ NA_integer_
    )
  )

# ---- p値（LRT）を1本ずつ返す関数（因子は項目全体のp）----
cox_p <- function(formula_obj){
  fit <- try(survival::coxph(formula_obj, data = ds04, ties = "efron"), silent = TRUE)
  if (inherits(fit, "try-error")) return(NA_real_)
  a <- try(anova(fit, test = "Chisq"), silent = TRUE)
  if (inherits(a, "try-error")) return(NA_real_)
  pcol <- which(colnames(a) %in% c("Pr(>|Chi|)", "P(>|Chi|)"))
  if (length(pcol) == 0) return(NA_real_)
  as.numeric(tail(a[[pcol]], 1))
}

# ===== 連続（ログ/反転ログのみ採用するもの） =====
p_ln_afp         <- if ("ln_afp" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ ln_afp)         else NA_real_
p_ln_tbil        <- if ("ln_tbil" %in% names(ds04))        cox_p(Surv(time2y, event2y) ~ ln_tbil)        else NA_real_
p_ln_plt         <- if ("ln_plt" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ ln_plt)         else NA_real_
p_ln_tum_pre_cm  <- if ("ln_tum_pre_cm" %in% names(ds04))  cox_p(Surv(time2y, event2y) ~ ln_tum_pre_cm)  else NA_real_
p_ln_max_diam_cm <- if ("ln_max_diam_cm" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ ln_max_diam_cm) else NA_real_
p_revlog_alb     <- if ("revlog_alb" %in% names(ds04))     cox_p(Surv(time2y, event2y) ~ revlog_alb)     else NA_real_

# ===== 連続（ログ化不要な候補） =====
p_afp_l3      <- if ("afp_l3" %in% names(ds04))      cox_p(Surv(time2y, event2y) ~ afp_l3)      else NA_real_
p_age         <- if ("age" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ age)         else NA_real_
p_alt         <- if ("alt" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ alt)         else NA_real_
p_ast         <- if ("ast" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ ast)         else NA_real_
p_bleed_ml    <- if ("bleed_ml" %in% names(ds04))    cox_p(Surv(time2y, event2y) ~ bleed_ml)    else NA_real_
p_ca19_9      <- if ("ca19_9" %in% names(ds04))      cox_p(Surv(time2y, event2y) ~ ca19_9)      else NA_real_
p_cea         <- if ("cea" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ cea)         else NA_real_
p_che         <- if ("che" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ che)         else NA_real_
p_icg_r15     <- if ("icg_r15" %in% names(ds04))     cox_p(Surv(time2y, event2y) ~ icg_r15)     else NA_real_
p_lhl15       <- if ("lhl15" %in% names(ds04))       cox_p(Surv(time2y, event2y) ~ lhl15)       else NA_real_
p_n           <- if ("n" %in% names(ds04))           cox_p(Surv(time2y, event2y) ~ n)           else NA_real_
p_op_time_min <- if ("op_time_min" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ op_time_min) else NA_real_
p_pivka2      <- if ("pivka2" %in% names(ds04))      cox_p(Surv(time2y, event2y) ~ pivka2)      else NA_real_
p_pt_inr      <- if ("pt_inr" %in% names(ds04))      cox_p(Surv(time2y, event2y) ~ pt_inr)      else NA_real_
p_specimen_wt <- if ("specimen_wt" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ specimen_wt) else NA_real_
p_weight_kg   <- if ("weight_kg" %in% names(ds04))   cox_p(Surv(time2y, event2y) ~ weight_kg)   else NA_real_
p_tum_count   <- if ("tum_count_pre" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ tum_count_pre) else NA_real_

# ===== カテゴリ =====
p_b_path       <- if ("b_path" %in% names(ds04))       cox_p(Surv(time2y, event2y) ~ factor(b_path))       else NA_real_
p_child_pugh   <- if ("child_pugh" %in% names(ds04))   cox_p(Surv(time2y, event2y) ~ factor(child_pugh))   else NA_real_
p_fc           <- if ("fc" %in% names(ds04))           cox_p(Surv(time2y, event2y) ~ factor(fc))           else NA_real_
p_fc_inf       <- if ("fc_inf" %in% names(ds04))       cox_p(Surv(time2y, event2y) ~ factor(fc_inf))       else NA_real_
p_fibrosis     <- if ("fibrosis_score" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ factor(fibrosis_score)) else NA_real_
p_group_rb     <- if ("group_rb" %in% names(ds04))     cox_p(Surv(time2y, event2y) ~ factor(group_rb))     else NA_real_
p_growth_type  <- if ("growth_type" %in% names(ds04))  cox_p(Surv(time2y, event2y) ~ factor(growth_type))  else NA_real_
p_hbv          <- if ("hbv" %in% names(ds04))          cox_p(Surv(time2y, event2y) ~ factor(hbv))          else NA_real_
p_hcv          <- if ("hcv" %in% names(ds04))          cox_p(Surv(time2y, event2y) ~ factor(hcv))          else NA_real_
p_im           <- if ("im" %in% names(ds04))           cox_p(Surv(time2y, event2y) ~ factor(im))           else NA_real_
p_liver_damage <- if ("liver_damage" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ factor(liver_damage)) else NA_real_
p_m            <- if ("m" %in% names(ds04))            cox_p(Surv(time2y, event2y) ~ factor(m))            else NA_real_
p_sf           <- if ("sf" %in% names(ds04))           cox_p(Surv(time2y, event2y) ~ factor(sf))           else NA_real_
p_sm           <- if ("sm" %in% names(ds04))           cox_p(Surv(time2y, event2y) ~ factor(sm))           else NA_real_
p_stage        <- if ("stage" %in% names(ds04))        cox_p(Surv(time2y, event2y) ~ factor(stage))        else NA_real_
p_t            <- if ("t" %in% names(ds04))            cox_p(Surv(time2y, event2y) ~ factor(t))            else NA_real_
p_sex01        <- if ("sex01" %in% names(ds04))        cox_p(Surv(time2y, event2y) ~ sex01)                else NA_real_
p_ALBI         <- if ("ALBI" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ ALBI)                 else NA_real_
p_mvi_01       <- if ("mvi_01" %in% names(ds04))       cox_p(Surv(time2y, event2y) ~ mvi_01)               else NA_real_
p_tnum_cat     <- if ("tnum_cat" %in% names(ds04))     cox_p(Surv(time2y, event2y) ~ tnum_cat)             else NA_real_
p_macro_preVI  <- if ("macro_vi_pre01" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ macro_vi_pre01)     else NA_real_

# ---- p値一覧 → p<0.20を抽出 ----
p_map <- c(
  # 連続（ログ/反転ログ）
  ln_afp = p_ln_afp, ln_tbil = p_ln_tbil, ln_plt = p_ln_plt,
  ln_tum_pre_cm = p_ln_tum_pre_cm, ln_max_diam_cm = p_ln_max_diam_cm, revlog_alb = p_revlog_alb,
  # 連続（その他）
  afp_l3 = p_afp_l3, age = p_age, alt = p_alt, ast = p_ast, bleed_ml = p_bleed_ml,
  ca19_9 = p_ca19_9, cea = p_cea, che = p_che, icg_r15 = p_icg_r15, lhl15 = p_lhl15,
  n = p_n, op_time_min = p_op_time_min, pivka2 = p_pivka2, pt_inr = p_pt_inr,
  specimen_wt = p_specimen_wt, weight_kg = p_weight_kg, tum_count_pre = p_tum_count,
  # カテゴリ
  b_path = p_b_path, child_pugh = p_child_pugh, fc = p_fc, fc_inf = p_fc_inf,
  fibrosis_score = p_fibrosis, group_rb = p_group_rb, growth_type = p_growth_type,
  hbv = p_hbv, hcv = p_hcv, im = p_im, liver_damage = p_liver_damage, m = p_m,
  sf = p_sf, sm = p_sm, stage = p_stage, t = p_t, sex01 = p_sex01,
  ALBI = p_ALBI, mvi_01 = p_mvi_01, tnum_cat = p_tnum_cat, macro_vi_pre01 = p_macro_preVI
)

uv_pvals <- data.frame(
  var = names(p_map),
  p   = as.numeric(p_map),
  stringsAsFactors = FALSE
)
uv_pvals <- uv_pvals[order(uv_pvals$p), ]
screened_vars <- uv_pvals$var[is.finite(uv_pvals$p) & uv_pvals$p < 0.20]

print(uv_pvals)
cat("\n# screened (p<0.20):\n"); print(screened_vars)

```

```{r}
# ==== CHUNK 6 (REFIT v2) — stage_surg/stage_diag を除外し、安定化して再学習 ====

stopifnot(exists("ds04"))

# 0) 設定（ERASL-post の方針に合わせて p<0.10 を残す）
STOP_P <- 0.10
EPV    <- 20

nevents <- sum(ds04$event2y == 1, na.rm = TRUE)
max_df  <- max(1L, floor(nevents / EPV))
cat("#events =", nevents, " / EPV =", EPV, "→ 許容DF(最大) =", max_df, "\n")

# 1) 候補セット（screened_vars があれば優先）＋ stage_surg/stage_diag を除外
EXCLUDE_TERMS <- c("stage_surg", "stage_diag")
fallback_candidates <- c(
  "t","stage","group_rb","ln_max_diam_cm","ln_tum_pre_cm","im","ln_afp",
  "vp_path","mvi_01","tnum_cat","vv_path","specimen_wt","vp_pre","revlog_alb",
  "ALBI_23","che","vv_pre","ast","liver_damage","alt","pt_inr","op_time_min",
  "icg_r15","child_pugh","age","hh15","weight_kg","bleed_ml","fc_inf","sm",
  "growth_type","ca19_9","pivka2","lhl15","n_pre","hbv","n","va_path","ln_tbil"
)

candidates0 <- if (exists("screened_vars") && length(screened_vars)) screened_vars else fallback_candidates
candidates0 <- setdiff(candidates0, EXCLUDE_TERMS)
candidates  <- intersect(candidates0, names(ds04))
if (!length(candidates)) stop("候補変数が空です。ds04の列名を確認してください。")

# 2) 完全ケースで学習データを固定（以降の再フィットも常にこのデータを使用）
dat_mv <- ds04[, c("time2y","event2y", candidates), drop = FALSE]
dat_mv <- stats::na.omit(dat_mv)

# 2a) 因子の単一水準を自動除外（完全分離・発散の予防）
#     → droplevels() で未使用水準を落とし、実際に「1水準しか残らない因子」を候補から外す
is_fact <- vapply(dat_mv[candidates], is.factor, logical(1))
fact_1lvl <- names(which(is_fact & vapply(dat_mv[candidates][is_fact], function(x) length(unique(x)) < 2, logical(1))))
if (length(fact_1lvl)) {
  cat("単一水準で除外:", paste(fact_1lvl, collapse=", "), "\n")
}
candidates <- setdiff(candidates, fact_1lvl)
dat_mv <- droplevels(dat_mv[, c("time2y","event2y", candidates), drop = FALSE])

# 3) 初期モデル
fm0 <- as.formula(paste0("survival::Surv(time2y, event2y) ~ ", paste(candidates, collapse = " + ")))
fit0 <- survival::coxph(
  fm0, data = dat_mv, ties = "efron",
  control = survival::coxph.control(iter.max = 50)
)

# 4) 後方淘汰（必ず data_df = dat_mv を使って再フィット）
backward_prune <- function(fit, data_df, stop_p = STOP_P, max_df = Inf){
  repeat {
    d1 <- try(drop1(fit, test = "Chisq"), silent = TRUE)
    if (inherits(d1, "try-error")) break
    d1 <- d1[setdiff(rownames(d1), "<none>"), , drop = FALSE]
    if (!nrow(d1)) break

    pcol  <- which(colnames(d1) %in% c("Pr(>Chi)","P(>Chi)","Pr(>Chi|)","Pr(>|Chi|)"))
    dfcol <- which(colnames(d1) %in% c("Df","df","DF"))
    if (!length(pcol) || !length(dfcol)) break

    total_df <- sum(d1[, dfcol], na.rm = TRUE)
    has_na_p <- is.na(d1[, pcol])

    drop_name <- NULL
    if (any(has_na_p)) {
      # pがNA（発散・特異）な項目を優先的に落とす（DFが大きいものから）
      cand <- d1[has_na_p, , drop = FALSE]
      o <- order(-cand[, dfcol])
      drop_name <- rownames(cand)[o][1]
    } else {
      # 最大p（説明力が弱い）を落とす or DF超過時はDFが大きい項目
      worst <- d1[order(d1[, pcol], decreasing = TRUE), , drop = FALSE][1, , drop = FALSE]
      if (is.finite(worst[, pcol]) && (worst[, pcol] > stop_p || total_df > max_df)) {
        drop_name <- rownames(worst)[1]
      }
      if (is.null(drop_name) && total_df > max_df) {
        cand <- d1[order(d1[, dfcol], decreasing = TRUE), , drop = FALSE]
        drop_name <- rownames(cand)[1]
      }
    }

    if (is.null(drop_name)) break

    keep <- setdiff(attr(terms(fit), "term.labels"), drop_name)
    if (!length(keep)) break
    fm_new <- as.formula(paste0("survival::Surv(time2y, event2y) ~ ",
                                paste(keep, collapse = " + ")))
    fit <- survival::coxph(
      fm_new, data = data_df, ties = "efron",
      control = survival::coxph.control(iter.max = 50)
    )
  }
  fit
}

fit_final <- backward_prune(fit0, data_df = dat_mv, stop_p = STOP_P, max_df = max_df)

# 5) 結果確認
cat("\n# fit_final 係数（β）:\n")
print(summary(fit_final)$coef)

cat("\n# 採用された項目:\n")
print(attr(terms(fit_final), "term.labels"))

```



*モデルの開発*
```{r}
# ===== CHUNK 0 — Attach op_date to ds04 (no split yet) =====
stopifnot(exists("ds04"))

# 1) キー列の特定（優先: .id → 代替: id）
key_col <- if (".id" %in% names(ds04)) ".id" else if ("id" %in% names(ds04)) "id" else NA_character_
if (is.na(key_col)) stop("ds04 に .id も id もありません。キー列を用意してください。")

# 2) すでに ds04 に op_date があれば型だけ厳密化
if ("op_date" %in% names(ds04)) {
  ds04 <- ds04 %>%
    mutate(op_date = as.Date(op_date))
} else {
  # 3) ds01_model から op_date を復元（1対1の対応のみ許可）
  if (!exists("ds01_model")) {
    stop("ds01_model が存在しません。op_date を復元できないため、前段で削除しない設定にしてください。")
  }
  src <- ds01_model

  # ソース側キーの特定（.id が無ければ id を使う）
  src_key <- if (".id" %in% names(src)) ".id" else if ("id" %in% names(src)) "id" else NA_character_
  if (is.na(src_key)) stop("ds01_model に .id も id もありません。op_date を復元できません。")

  # 型を揃える
  src <- src %>%
    mutate(
      across(all_of(src_key), as.character),
      op_date = as.Date(op_date)
    )

  # 同一キーに複数の op_date があるかチェック（あれば中断：曖昧joinを禁止）
  dup_tbl <- src %>%
    filter(!is.na(op_date)) %>%
    count(!!sym(src_key), wt = 0, name = "n_dates") %>%
    left_join(
      src %>% distinct(!!sym(src_key), op_date) %>% count(!!sym(src_key), name = "n_unique_dates"),
      by = src_key
    ) %>%
    filter(n_unique_dates > 1)

  if (nrow(dup_tbl) > 0) {
    print(head(dup_tbl, 10))
    stop("同一キーに複数の op_date が存在します。手術単位のキー（例: 手術番号）で結合できるよう前段で列を保持してください。")
  }

  # 1対1 マッピングを作成
  map_op <- src %>%
    filter(!is.na(op_date)) %>%
    distinct(!!sym(src_key), op_date)

  # ds04 側キー型揃え → join
  ds04 <- ds04 %>%
    mutate(across(all_of(key_col), as.character)) %>%
    left_join(map_op, by = setNames(src_key, key_col))
}

# 4) 最終チェック
if (!("op_date" %in% names(ds04))) stop("op_date の付与に失敗しました。")
if (!inherits(ds04$op_date, "Date")) ds04 <- ds04 %>% mutate(op_date = as.Date(op_date))

# 5) time2y / event2y の存在確認（無ければここで作るが、基本は既存を尊重）
if (!all(c("time2y","event2y") %in% names(ds04))) {
  ds04 <- ds04 %>%
    mutate(
      time2y  = ifelse(is.na(time), NA_real_, pmin(time, 24)),
      event2y = case_when(
        !is.na(status) & !is.na(time) & status == 1L & time <= 24 ~ 1L,
        !is.na(status) & !is.na(time)                              ~ 0L,
        TRUE ~ NA_integer_
      )
    )
}

# 6) サマリ（スプリットの前提確認）
cat("ds04 rows:", nrow(ds04), "\n",
    "op_date: ", as.character(min(ds04$op_date, na.rm=TRUE)), "→",
                  as.character(max(ds04$op_date, na.rm=TRUE)), "\n",
    "time2y>0 count:", sum(is.finite(ds04$time2y) & ds04$time2y > 0, na.rm=TRUE), "\n",
    "events@2y:", sum(ds04$event2y == 1, na.rm=TRUE), "\n", sep = "")

# 7) このチャンクでは分割はしない（CHUNK 1 で Temporal split を実施）

```




