---
title: "Data_handling_complete"
author: "Takuto Yoshida"
date: "2025-10-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 必要パッケージの準備
```{r}
# ---- ① Packages ----
ensure_packages <- function(pkgs){
  to_install <- setdiff(pkgs, rownames(installed.packages()))
  if (length(to_install)) install.packages(to_install)
  invisible(lapply(pkgs, require, character.only = TRUE))
}

ensure_packages(c(
  "readxl","readr","tidylog","dplyr","stringr","forcats","lubridate","DataExplorer","tibble"
))
```

# ヘルパー関数の作成
```{r}
# ---- ② Helpers ----

# Excelの「日付・日時」混在（シリアル/文字列）をDateに：参照レベル等は一切変更しない
to_date_excel_mixed <- function(x){
  if (inherits(x,"Date")) return(x)
  s <- trimws(as.character(x))
  s[s %in% c("", "NA", "N/A", "na", "n/a")] <- NA

  # 数値(=Excelシリアル, 1900起算) 優先候補
  num  <- suppressWarnings(as.numeric(s))
  dnum <- as.Date(num, origin = "1899-12-30")

  # 文字列日付 正規化 → ymd
  s2 <- s
  s2 <- stringr::str_replace_all(s2, "[.]", "/")
  s2 <- stringr::str_replace_all(s2, "年|月", "/")
  s2 <- stringr::str_replace_all(s2, "日", "")
  s2 <- stringr::str_replace_all(s2, "/", "-")
  dchr <- suppressWarnings(lubridate::ymd(s2))

  as.Date(dplyr::coalesce(dchr, dnum))
}

# TRUE/FALSE の表記ゆらぎを論理値に（欠損はそのまま）
to_tf <- function(x){
  z <- trimws(as.character(x))
  z <- chartr("＋－", "+-", z)
  rec <- c("TRUE"="TRUE","T"="TRUE","有"="TRUE","Yes"="TRUE","yes"="TRUE","1"="TRUE","+"="TRUE",
           "FALSE"="FALSE","F"="FALSE","無"="FALSE","No"="FALSE","no"="FALSE","0"="FALSE","-"="FALSE")
  as.logical(rec[z])
}

# 手術時間： "H:MM(:SS)" と Excelの「1日を1.0とする小数」を“分”に
to_minutes_from_time <- function(x){
  s <- stringr::str_squish(as.character(x))
  s <- stringr::str_replace_all(s, "：", ":")
  has_colon <- stringr::str_detect(s, ":")
  parts <- stringr::str_split_fixed(s, ":", 3)
  hh <- suppressWarnings(as.numeric(parts[,1]))
  mm <- suppressWarnings(as.numeric(parts[,2]))
  ss <- suppressWarnings(as.numeric(parts[,3]))
  from_colon <- ifelse(has_colon, hh*60 + mm + ifelse(is.na(ss), 0, round(ss/60)), NA_real_)
  num <- suppressWarnings(as.numeric(s))
  from_frac <- ifelse(!has_colon & !is.na(num), num * 1440, NA_real_)
  round(dplyr::coalesce(from_colon, from_frac))
}

```


# データハンドリング
## 下準備
```{r}
# ---- 3-1. Import & priming ----

# 読み込み（列型はreadxlに任せる → 後段で必要な列だけ整形）
ds00_raw <- suppressWarnings(readxl::read_excel('/Users/yoshidatakuto/Dropbox/Hokkaido University/大学院医学院/Borderline HCC/Prediction model_Project1/01_Data/BR分類で生存解析のデータupdate20251016.xlsx', sheet = 1, guess_max = 100000))
ds00     <- readr::type_convert(ds00_raw, locale = readr::locale(encoding = "UTF-8"))

# 参照レベルは触らない前提：ds01 = コピー
ds01 <- ds00

# 列名の空白ゆらぎを最小限整形（全角/連続スペースを半角1つへ）
names(ds01) <- names(ds01) |>
  stringr::str_replace_all("[\u3000\\s]+", " ") |>
  trimws()

# Group → group（値はそのまま）
if ("Group" %in% names(ds00)) ds00 <- dplyr::rename(ds00, group = Group)
if ("group" %in% names(ds00)) ds01$group <- ds00$group

# よく使う別名（ID...3 → id, Num → num 等）：値はそのまま
if ("ID...3" %in% names(ds01)) ds01$id  <- as.character(ds01$`ID...3`)
if ("Num"    %in% names(ds01)) ds01$num <- ds01$Num

```
#名前よせ
```{r}
# ---- 3-2. Alias / harmonization ----
# 合併症など、短い列名→「…順序変数」に寄せる“別名”を作成（存在する時のみ）
if ("再発有無" %in% names(ds01) && !"再発有無TRUE/FALSEの二群" %in% names(ds01)) {
  ds01 <- dplyr::rename(ds01, `再発有無TRUE/FALSEの二群` = `再発有無`)
}
if ("StageI+II or III+IV" %in% names(ds01) &&
    !("StageI+II or III+IV　非癌部肝(旧入力）" %in% names(ds01))) {
  ds01 <- dplyr::rename(ds01, `StageI+II or III+IV　非癌部肝(旧入力）` = `StageI+II or III+IV`)
}
if ("合併症胸水" %in% names(ds01) && !"合併症胸水 0-2の順序変数" %in% names(ds01)) {
  ds01 <- dplyr::rename(ds01, `合併症胸水 0-2の順序変数` = `合併症胸水`)
}
if ("合併症出血" %in% names(ds01) && !"合併症出血 0-2の順序変数" %in% names(ds01)) {
  ds01 <- dplyr::rename(ds01, `合併症出血 0-2の順序変数` = `合併症出血`)
}
if ("合併症胆汁漏" %in% names(ds01) && !"合併症胆汁漏順序変数" %in% names(ds01)) {
  ds01 <- dplyr::rename(ds01, `合併症胆汁漏順序変数` = `合併症胆汁漏`)
}
if ("合併症消化管" %in% names(ds01) && !"合併症消化管順序変数" %in% names(ds01)) {
  ds01 <- dplyr::rename(ds01, `合併症消化管順序変数` = `合併症消化管`)
}
if ("合併症術創" %in% names(ds01) && !"合併症術創順序変数" %in% names(ds01)) {
  ds01 <- dplyr::rename(ds01, `合併症術創順序変数` = `合併症術創`)
}

```


# 基本属性
```{r}
# ---- 3-3. Basics / groups ----
# 手術時/診断時 R/BR1/BR2（列名の空白ゆらぎに強い取得）
c_surg <- grep("手術時群分け\\s*R\\s*/\\s*BR1\\s*/\\s*BR2", names(ds01), value = TRUE, perl = TRUE)
if (length(c_surg))
  ds01 <- ds01 |> dplyr::mutate(stage_surg = factor(.data[[c_surg[1]]], levels = c("R","BR1","BR2")))

c_diag <- grep("診断時群分け\\s*R\\s*/\\s*BR1\\s*/\\s*BR2", names(ds01), value = TRUE, perl = TRUE)
if (length(c_diag))
  ds01 <- ds01 |> dplyr::mutate(stage_diag = factor(.data[[c_diag[1]]], levels = c("R","BR1","BR2")))

# 群分け R/BR（BR1/BR2 を BR に寄せる）
c_rb <- grep("^群分け\\s*R\\s*/\\s*BR", names(ds01), value = TRUE, perl = TRUE)
if (length(c_rb))
  ds01 <- ds01 |> dplyr::mutate(group_rb = {
    x <- stringr::str_squish(as.character(.data[[c_rb[1]]]))
    x <- ifelse(x %in% c("BR1","BR2"), "BR", x)
    factor(x, levels = c("R","BR"))
  })


```

# 治療前パラメーター
```{r}
# ---- 3-4. Pretreatment tumor ----
if ("治療前腫瘍径"   %in% names(ds01)) ds01$tum_diam_pre  <- suppressWarnings(as.numeric(ds01$`治療前腫瘍径`))
if ("治療前腫瘍個数" %in% names(ds01)) ds01$tum_count_pre <- suppressWarnings(as.numeric(ds01$`治療前腫瘍個数`))
if ("治療前Vp" %in% names(ds01)) ds01$vp_pre <- ds01$`治療前Vp`
if ("治療前Vv" %in% names(ds01)) ds01$vv_pre <- ds01$`治療前Vv`
if ("治療前N"  %in% names(ds01)) ds01$n_pre  <- ds01$`治療前N`
if ("治療前M"  %in% names(ds01)) ds01$m_pre  <- ds01$`治療前M`

```

# 予後・日付・イベント
```{r}
# ---- 3-5. Dates & outcomes ----
if ("date of birth" %in% names(ds01)) ds01$dob            <- to_date_excel_mixed(ds01$`date of birth`)
if ("最終確認日"     %in% names(ds01)) ds01$last_followup  <- to_date_excel_mixed(ds01$`最終確認日`)
if ("初診日"         %in% names(ds01)) ds01$first_visit_dt <- to_date_excel_mixed(ds01$`初診日`)
if ("入院日"         %in% names(ds01)) ds01$adm_dt         <- to_date_excel_mixed(ds01$`入院日`)
if ("再発日"         %in% names(ds01)) ds01$recur_date     <- to_date_excel_mixed(ds01$`再発日`)

if ("年齢" %in% names(ds01)) ds01$age <- suppressWarnings(as.numeric(ds01$`年齢`))
if ("60未満、60以上" %in% names(ds01)) ds01$age_grp60 <- ds01$`60未満、60以上`
if ("性別" %in% names(ds01)) ds01$sex <- suppressWarnings(as.factor(ds01$`性別`)) 
if ("全生存期間m" %in% names(ds01)) ds01$os_months <- suppressWarnings(as.numeric(ds01$`全生存期間m`))
if ("生死" %in% names(ds01))    ds01$vital_status <- ds01$`生死`
if ("生1死0" %in% names(ds01))  ds01$vital10      <- ds01$`生1死0`

# 死因4群（欠損→aliver、指定4種→Other）：原データは残す
if ("死因" %in% names(ds01)) {
  y <- stringr::str_squish(as.character(ds01$`死因`))
  other_pat <- "(他病死(（老衰）|\\(老衰\\))?|敗血症|死（原因不明）|死\\(原因不明\\))"
  ds01$death_cause4 <- dplyr::case_when(
    is.na(y) | y == ""                        ~ "aliver",
    stringr::str_detect(y,"癌")               ~ "Cancer",
    stringr::str_detect(y,"肝不全")           ~ "LiverFailure",
    stringr::str_detect(y, other_pat)         ~ "Other",
    TRUE                                      ~ "Other"
  ) |> factor(levels = c("aliver","Cancer","LiverFailure","Other"))
}

if ("再発有無TRUE/FALSEの二群" %in% names(ds01)) ds01$recur_tf   <- to_tf(ds01$`再発有無TRUE/FALSEの二群`)
if ("無再発生存期間" %in% names(ds01))            ds01$rfs_months <- suppressWarnings(as.numeric(ds01$`無再発生存期間`))
if ("再発or死0" %in% names(ds01))                 ds01$eventfree10 <- ds01$`再発or死0`

```

# Lab/BMI/PS
```{r}
# ---- 3-6. Labs & markers & body ----
# Lab
if ("Plt" %in% names(ds01)) ds01$plt <- as.numeric(ds01$Plt)
if ("Alb" %in% names(ds01)) ds01$alb <- as.numeric(ds01$Alb)
if ("Bil" %in% names(ds01)) ds01$tbil<- as.numeric(ds01$Bil)
if ("ChE" %in% names(ds01)) ds01$che <- as.numeric(ds01$ChE)
if ("GOT" %in% names(ds01)) ds01$ast <- as.numeric(ds01$GOT)
if ("GPT" %in% names(ds01)) ds01$alt <- as.numeric(ds01$GPT)
if ("AMN" %in% names(ds01)) ds01$nh3 <- as.numeric(ds01$AMN)
if ("PT"  %in% names(ds01)) ds01$pt_inr <- as.numeric(ds01$PT)

# Virus / ICG / liver function（レベルは触らない）
if ("HB" %in% names(ds01))            ds01$hbv       <- ds01$HB
if ("HB感染既往" %in% names(ds01))    ds01$hbv_past  <- ds01$`HB感染既往`
if ("HCV" %in% names(ds01))           ds01$hcv       <- ds01$HCV
if ("ICG 10%未満" %in% names(ds01))   ds01$icg10_cat <- ds01$`ICG 10%未満`
if ("ICG" %in% names(ds01))           ds01$icg_r15   <- as.numeric(ds01$ICG)
if ("HH15" %in% names(ds01))          ds01$hh15      <- as.numeric(ds01$HH15)
if ("LHL15" %in% names(ds01))         ds01$lhl15     <- as.numeric(ds01$LHL15)
if ("liver_damage" %in% names(ds01))  ds01$liver_damage <- as.factor(ds01$liver_damage)
if ("ChildPugh" %in% names(ds01))     ds01$child_pugh   <- ds01$ChildPugh

# Markers
if ("AFP500以上" %in% names(ds01))    ds01$afp500_cat <- ds01$`AFP500以上`
if ("AFP" %in% names(ds01))           ds01$afp        <- as.numeric(ds01$AFP)
if ("AFP_L3" %in% names(ds01))        ds01$afp_l3     <- as.numeric(ds01$AFP_L3)
if ("PIVKA2 200以上" %in% names(ds01))ds01$pivka200_cat <- ds01$`PIVKA2 200以上`
if ("PIVKA2" %in% names(ds01))        ds01$pivka2     <- as.numeric(ds01$PIVKA2)
if ("CEA" %in% names(ds01))           ds01$cea        <- as.numeric(ds01$CEA)
if ("CA199" %in% names(ds01))         ds01$ca19_9     <- as.numeric(ds01$CA199)

# Body / Scores
if ("身長" %in% names(ds01))          ds01$height_cm <- as.numeric(ds01$`身長`)
if ("体重" %in% names(ds01))          ds01$weight_kg <- as.numeric(ds01$`体重`)
if ("PS" %in% names(ds01))            ds01$ps  <- ds01$PS
if ("ASA" %in% names(ds01))           ds01$asa <- ds01$ASA

```

# 体積/比率
```{r}
# ---- 3-7. Volumes ----
if ("全肝容積" %in% names(ds01))             ds01$liver_vol        <- as.numeric(ds01$`全肝容積`)
if ("腫瘍容積" %in% names(ds01))             ds01$tumor_vol        <- as.numeric(ds01$`腫瘍容積`)
if ("残肝容積" %in% names(ds01))             ds01$remnant_vol      <- as.numeric(ds01$`残肝容積`)
if ("有効肝切率" %in% names(ds01))          ds01$func_resect_rate <- as.numeric(ds01$`有効肝切率`)
if ("PTPE" %in% names(ds01))                 ds01$ptpe             <- to_tf(ds01$PTPE)
if ("前肝容積" %in% names(ds01))             ds01$pre_liver_vol    <- as.numeric(ds01$`前肝容積`)
if ("前腫瘍容積" %in% names(ds01))           ds01$pre_tumor_vol    <- as.numeric(ds01$`前腫瘍容積`)
if ("前残肝容積" %in% names(ds01))           ds01$pre_remnant_vol  <- as.numeric(ds01$`前残肝容積`)
if ("術前機能的肝切除率" %in% names(ds01))  ds01$pre_func_rate    <- as.numeric(ds01$`術前機能的肝切除率`)
if ("2W肝容積" %in% names(ds01))             ds01$w2_liver_vol     <- as.numeric(ds01$`2W肝容積`)
if ("2W腫瘍容積" %in% names(ds01))           ds01$w2_tumor_vol     <- as.numeric(ds01$`2W腫瘍容積`)
if ("2W機能的肝切除率" %in% names(ds01))     ds01$w2_func_rate     <- as.numeric(ds01$`2W機能的肝切除率`)

```

# 手術関連
```{r}
# ---- 3-8. Operation ----
if ("手術日"   %in% names(ds01)) ds01$op_date     <- to_date_excel_mixed(ds01$`手術日`)
if ("手術病名" %in% names(ds01)) ds01$op_dx_txt   <- as.character(ds01$`手術病名`)
if ("術式"     %in% names(ds01)) ds01$op_proc_txt <- as.character(ds01$`術式`)
if ("術式分類" %in% names(ds01)) ds01$op_proc_cat <- ds01$`術式分類`
if ("出血量"   %in% names(ds01)) ds01$bleed_ml    <- as.numeric(ds01$`出血量`)
if ("術者"     %in% names(ds01)) ds01$surgeon_name<- as.character(ds01$`術者`)
if ("Pringle"  %in% names(ds01)) ds01$pringle     <- ds01$Pringle
if ("開胸開腹" %in% names(ds01)) ds01$thoraco_lap <- to_tf(ds01$`開胸開腹`)
if ("切除肝重量" %in% names(ds01)) ds01$specimen_wt <- as.numeric(ds01$`切除肝重量`)
if ("肝再切除"   %in% names(ds01)) ds01$rehepatectomy <- to_tf(ds01$`肝再切除`)
if ("腹腔鏡の使用" %in% names(ds01)) ds01$laparoscopy_use <- ds01$`腹腔鏡の使用`
if ("切除治療時治癒度" %in% names(ds01)) ds01$curability <- ds01$`切除治療時治癒度`

# 手術時間 → 分
if ("手術時間" %in% names(ds01)) ds01$op_time_min <- to_minutes_from_time(ds01$`手術時間`)

```

# 病理
```{r}
# ---- 3-9. Pathology ----
if ("最大径5以下、5~10、10以上" %in% names(ds01))
  ds01$max_diam_cat <- ds01$`最大径5以下、5~10、10以上`
if ("最大径" %in% names(ds01))
  ds01$max_diam_cm <- as.numeric(ds01$`最大径`)
if ("単発or2~3" %in% names(ds01))
  ds01$uni_vs_2to3 <- ds01$`単発or2~3`

for (nm in c("vp","vv","va","b")){
  if (nm %in% names(ds01)) ds01[[paste0(nm,"_path")]] <- ds01[[nm]]
}

if ("発育" %in% names(ds01)) ds01$growth_type <- as.factor(ds01$`発育`)
for (nm in c("fc","fc_inf","sf","sm")) if (nm %in% names(ds01)) ds01[[nm]] <- ds01[[nm]]
if ("im" %in% names(ds01)) ds01$im <- ds01$im
for (nm in c("t","n","m")) if (nm %in% names(ds01)) ds01[[nm]] <- ds01[[nm]]
if ("stage" %in% names(ds01)) ds01$stage <- ds01$stage

# 分化度
if ("分化度(旧入力）" %in% names(ds01)) ds01$grade_old <- ds01$`分化度(旧入力）`
if ("分化度"         %in% names(ds01)) ds01$grade_txt <- as.character(ds01$`分化度`)

# 個数 / 組織型 / sm_mm
if ("個数" %in% names(ds01))    ds01$count         <- suppressWarnings(as.numeric(ds01$`個数`))
if ("組織型" %in% names(ds01))  ds01$histology_txt <- as.character(ds01$`組織型`)
if ("sm_mm" %in% names(ds01))   ds01$sm_mm         <- suppressWarnings(as.numeric(ds01$sm_mm))

# fibrosis / grading（旧・現）
if ("fibrosis score(旧入力）" %in% names(ds01))
  ds01$fibrosis_score_old <- ds01$`fibrosis score(旧入力）`
if ("fibrosis score" %in% names(ds01))
  ds01$fibrosis_score     <- ds01$`fibrosis score`
if ("grading score(旧入力）" %in% names(ds01))
  ds01$grading_score_old  <- ds01$`grading score(旧入力）`
if ("grading score" %in% names(ds01))
  ds01$grading_score      <- ds01$`grading score`

```

# 術後合併症
```{r}
# ---- 3-10. Post-op complications ----
if ("術後TBil値" %in% names(ds01))          ds01$tbil_post_grade <- ds01$`術後TBil値`
if ("術後アンモニア値" %in% names(ds01))    ds01$nh3_post_grade  <- ds01$`術後アンモニア値`
if ("術後肝不全" %in% names(ds01))          ds01$pofil           <- ds01$`術後肝不全`
if ("術後合併症" %in% names(ds01))          ds01$comp_any_grade  <- ds01$`術後合併症`
if ("合併症胸水 0-2の順序変数" %in% names(ds01)) ds01$comp_pleural  <- ds01$`合併症胸水 0-2の順序変数`
if ("合併症呼吸器" %in% names(ds01))        ds01$comp_resp       <- ds01$`合併症呼吸器`
if ("合併症出血 0-2の順序変数" %in% names(ds01)) ds01$comp_bleeding <- ds01$`合併症出血 0-2の順序変数`
if ("合併症腹水" %in% names(ds01))          ds01$comp_ascites    <- ds01$`合併症腹水`
if ("合併症胆汁漏順序変数" %in% names(ds01)) ds01$comp_bile      <- ds01$`合併症胆汁漏順序変数`
if ("合併症消化管順序変数" %in% names(ds01)) ds01$comp_gi        <- ds01$`合併症消化管順序変数`
if ("合併症術創順序変数" %in% names(ds01)) ds01$comp_wound      <- ds01$`合併症術創順序変数`
if ("合併症" %in% names(ds01))              ds01$comp_txt        <- as.character(ds01$`合併症`)

```


```{r}
# ---- 3-11. Build ds01_model ----
sel_cols <- c(
  "id","num","group","stage_surg","stage_diag","group_rb",
  "tum_diam_pre","tum_count_pre","vp_pre","vv_pre","n_pre","m_pre",
  "dob","age","age_grp60","sex", "last_followup","os_months","vital_status","vital10",
  "death_cause4","recur_date","rfs_months","recur_tf","eventfree10",
  "hbv","hbv_past","hcv", "first_visit_dt", "adm_dt", "plt", "alb", "tbil", "che", "ast", "alt", "nh3", "pt_inr", "icg10_cat","icg_r15","hh15","lhl15","liver_damage","child_pugh",
  "afp500_cat","afp","afp_l3","pivka200_cat","pivka2","cea","ca19_9",
  "height_cm","weight_kg","ps","asa",
  "liver_vol","tumor_vol","remnant_vol","func_resect_rate","ptpe",
  "pre_liver_vol","pre_tumor_vol","pre_remnant_vol","pre_func_rate",
  "w2_liver_vol","w2_tumor_vol","w2_func_rate",
  "op_date","op_dx_txt","op_proc_txt","op_proc_cat","op_time_min","bleed_ml",
  "surgeon_name","pringle","thoraco_lap","specimen_wt","rehepatectomy",
  "laparoscopy_use","curability",
  "max_diam_cat","max_diam_cm","grade_old", "grade_txt", "uni_vs_2to3","growth_type",
  "vp_path","vv_path","va_path","b_path","fc","fc_inf","sf","im","sm","sm_mm", "t","n","m","stage",
  "nc_liver_stage_old", "fibrosis_score_old", "fibrosis_score", "grading_score_old", "grading_score", 
  "tbil_post_grade","nh3_post_grade","pofil","comp_any_grade",
  "comp_pleural","comp_resp","comp_bleeding","comp_ascites","comp_bile","comp_gi","comp_wound",
  "comp_txt"
)

missing <- setdiff(sel_cols, names(ds01))
if (length(missing)) message("（通知）存在しない列: ", paste(missing, collapse=", "))

ds01_model <- ds01 |> dplyr::select(dplyr::any_of(sel_cols))

```

# 確認
```{r}
# ---- Q1: 欠けている4列を安全に作る（元の列がある場合のみ） ----
# stage_surg / stage_diag
if (!"stage_surg" %in% names(ds01) && "手術時群分け R/BR1/BR2" %in% names(ds01)) {
  ds01$stage_surg <- ds01$`手術時群分け R/BR1/BR2`
}
if (!"stage_diag" %in% names(ds01) && "診断時群分け R/BR1/BR2" %in% names(ds01)) {
  ds01$stage_diag <- ds01$`診断時群分け R/BR1/BR2`
}

# group_rb：優先順位 = 1) 群分け R/BR → 2) stage_surg → 3) stage_diag
if (!"group_rb" %in% names(ds01)) {
  if ("群分け R/BR" %in% names(ds01)) {
    g <- stringr::str_squish(as.character(ds01$`群分け R/BR`))
    g[g %in% c("BR1","BR2")] <- "BR"
    ds01$group_rb <- g
  } else if ("stage_surg" %in% names(ds01)) {
    g <- as.character(ds01$stage_surg); g[g %in% c("BR1","BR2")] <- "BR"; ds01$group_rb <- g
  } else if ("stage_diag" %in% names(ds01)) {
    g <- as.character(ds01$stage_diag); g[g %in% c("BR1","BR2")] <- "BR"; ds01$group_rb <- g
  }
}

# nc_liver_stage_old：候補名のどれかがあればコピー
cand_nc <- intersect(names(ds01), c("StageI+II or III+IV　非癌部肝(旧入力）", "StageI+II or III+IV"))
if (!"nc_liver_stage_old" %in% names(ds01) && length(cand_nc) >= 1) {
  ds01$nc_liver_stage_old <- ds01[[cand_nc[1]]]
}

# ds01_model を再構築（この4列を sel_cols に追加してから）
sel_cols <- unique(c(sel_cols, "stage_surg","stage_diag","group_rb","nc_liver_stage_old"))
ds01_model <- ds01 |> dplyr::select(dplyr::any_of(sel_cols))

# ざっと確認
c("stage_surg","stage_diag","group_rb","nc_liver_stage_old") %in% names(ds01_model)

```


# 解析用データ

```{r}
# ---- ④ Checks ----

# 行数は落ちていないか
c(n_ds00 = nrow(ds00), n_ds01 = nrow(ds01), n_ds01_model = nrow(ds01_model))

# 代表列の型と先頭確認
dplyr::glimpse(ds01_model[, c(
  "id","num","group","recur_date","op_time_min","tum_diam_pre","tum_count_pre",
  "plt","alb","tbil","afp","afp_l3","pivka2"
) ] |> dplyr::select(dplyr::any_of(names(ds01_model))) )

# 再発日（混在修正が効いているか）
head(ds00$`再発日`, 10)
head(ds01$recur_date, 10)

# 手術時間 → 分
ds01 %>% dplyr::select(`手術時間`, op_time_min) %>% head(10)

# 欠損・カテゴリ・ヒストのざっくり確認（重いなら必要な時だけ）
# DataExplorer::plot_missing(ds01_model)
# DataExplorer::plot_bar(ds01_model)
# DataExplorer::plot_histogram(ds01_model)

```

