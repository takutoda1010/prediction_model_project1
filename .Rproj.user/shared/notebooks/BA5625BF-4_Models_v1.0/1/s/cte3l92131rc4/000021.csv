"0","## ==== CHUNK4b: Model 2 — evaluation on Test (C-index & TD-AUC) ============="
"0","# 汎用の評価ヘルパ（今後の比較用に結果を返す）"
"0","eval_model <- function(fit, newdata, label, times = c(6, 12, 18, 24)){"
"0","  risk <- as.numeric(predict(fit, newdata = newdata, type = ""lp""))  # 大きいほど高リスク"
"0",""
"0","  # Harrell's C（向き補正）＋bootstrap SE/CI"
"0","  d_eval <- newdata; d_eval$risk <- risk"
"0","  cobj   <- survival::concordance(Surv(time2y, event2y) ~ risk, data = d_eval, reverse = TRUE)"
"0","  c_idx  <- as.numeric(cobj$concordance)"
"0",""
"0","  set.seed(20251102); B <- 500"
"0","  c_boot <- replicate(B, {"
"0","    idx <- sample.int(nrow(d_eval), replace = TRUE)"
"0","    survival::concordance(Surv(d_eval$time2y[idx], d_eval$event2y[idx]) ~ d_eval$risk[idx],"
"0","                          data = d_eval[idx, ], reverse = TRUE)$concordance"
"0","  })"
"0","  c_se  <- stats::sd(c_boot, na.rm = TRUE)"
"0","  c_ci  <- c_idx + c(-1, 1) * 1.96 * c_se"
"0",""
"0","  cat(sprintf(""\n[%s] Harrell's C = %.3f (SE=%.3f) 95%%CI [%.3f, %.3f]\n"","
"0","              label, c_idx, c_se, c_ci[1], c_ci[2]))"
"0",""
"0","  # time-dependent AUC（rfs_months があればそちらで、可能な時点のみ）"
"0","  auc_df <- NULL"
"0","  if (""rfs_months"" %in% names(newdata)) {"
"0","    if (""rfs_event"" %in% names(newdata)) {"
"0","      delta_full <- as.integer(newdata$rfs_event == 1)"
"0","    } else if (""recur_event"" %in% names(newdata)) {"
"0","      delta_full <- as.integer(newdata$recur_event == 1)"
"0","    } else {"
"0","      delta_full <- as.integer(newdata$recur_2y == TRUE)"
"0","    }"
"0","    T_full <- as.numeric(newdata$rfs_months)"
"0",""
"0","    ok <- vapply(times, function(t){"
"0","      sum(T_full <= t & delta_full == 1, na.rm = TRUE) > 0 &&"
"0","        sum(T_full >  t,                 na.rm = TRUE) > 0"
"0","    }, logical(1))"
"0",""
"0","    if (any(ok)) {"
"0","      roc <- timeROC(T = T_full, delta = delta_full, marker = risk,"
"0","                     cause = 1, times = times[ok], iid = TRUE)"
"0","      auc_df <- data.frame(model = label, time = roc$times, AUC = roc$AUC)"
"0","      print(auc_df, row.names = FALSE)"
"0","    } else {"
"0","      cat(sprintf(""[%s] TD-AUC: evaluable times not available in Test.\n"", label))"
"0","    }"
"0","  } else {"
"0","    cat(sprintf(""[%s] TD-AUC: rfs_months not available; skipped.\n"", label))"
"0","  }"
"0",""
"0","  list(label = label, risk = risk, c_index = c_idx, c_se = c_se, c_ci = c_ci, auc = auc_df)"
"0","}"
"0",""
"0","# 実行・保存（将来の比較用に蓄積）"
"0","res_m2 <- eval_model(fit_m2, tst, model_name_m2)"
"1","
[M2_StepAIC_backward] Harrell's C = 0.742 (SE=0.032) 95%CI [0.680, 0.805]
"
