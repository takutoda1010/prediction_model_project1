"0","## ==== ROC-2: 複数モデルの ROC を一枚に重ね描き（凡例に AUC と評価時点を表示） ===="
"0","if (!length(roc_list)) {"
"0","  message(""描画できるモデルがありません（riskが未保存か、評価可能時点が無い）。"")"
"0","} else {"
"0","  op <- par(no.readonly = TRUE); on.exit(par(op), add = TRUE)"
"0","  par(mar = c(5,5,3,2))"
"0",""
"0","  models <- names(roc_list)"
"0","  cols <- grDevices::rainbow(length(models))"
"0","  lwd  <- 2"
"0",""
"0","  # 1本目を描画（timeROC の plot メソッドを利用）"
"0","  m1 <- models[1]"
"0","  plot(roc_list[[m1]]$roc, time = roc_list[[m1]]$t_show,"
"0","       col = cols[1], lwd = lwd,"
"0","       xlab = ""False Positive Rate (1 - Specificity)"","
"0","       ylab = ""True Positive Rate (Sensitivity)"","
"0","       title = FALSE)"
"0","  title(main = ""Time-dependent ROC curves on Test set"")"
"0","  abline(0, 1, lty = 3, col = ""gray60"")"
"0",""
"0","  # 2本目以降は add=TRUE で重ねる（もし add が未対応なら後段のフォールバックで描画）"
"0","  add_ok <- TRUE"
"0","  for (i in 2:length(models)) {"
"0","    mi <- models[i]"
"0","    tryCatch({"
"0","      plot(roc_list[[mi]]$roc, time = roc_list[[mi]]$t_show,"
"0","           add = TRUE, col = cols[i], lwd = lwd)"
"0","    }, error = function(e){"
"0","      add_ok <<- FALSE"
"0","    })"
"0","  }"
"0",""
"0","  # フォールバック：手動で FP/TP を抽出して lines()"
"0","  if (!add_ok) {"
"0","    message(""plot.add が使えない環境のため、手動で線を重ねます。"")"
"0","    # すでに1本目は出ているので、2本目以降を FP/TP から線で追加"
"0","    for (i in 2:length(models)) {"
"0","      mi <- models[i]; obj <- roc_list[[mi]]$roc"
"0","      ti <- roc_list[[mi]]$t_show"
"0","      k  <- which(obj$times == ti)"
"0","      # timeROC は FP/TP が列方向に times、行方向に閾値"
"0","      FP <- if (!is.null(obj$FP)) obj$FP[, k] else if (!is.null(obj$FP_t)) obj$FP_t[, k] else NULL"
"0","      TP <- if (!is.null(obj$TP)) obj$TP[, k] else if (!is.null(obj$TP_t)) obj$TP_t[, k] else NULL"
"0","      if (!is.null(FP) && !is.null(TP)) {"
"0","        lines(FP, TP, col = cols[i], lwd = lwd)"
"0","      }"
"0","    }"
"0","  }"
"0",""
"0","  # 凡例（モデル名 + AUC@t）"
"0","  lgd <- vapply(models, function(m){"
"0","    sprintf(""%s  (AUC@%s m = %.3f)"", m, format(roc_list[[m]]$t_show, trim=TRUE), roc_list[[m]]$auc)"
"0","  }, FUN.VALUE = """")"
"0","  legend(""bottomright"", legend = lgd, col = cols, lwd = lwd, cex = 0.8, bg = ""white"")"
"0","}"
"0",""
