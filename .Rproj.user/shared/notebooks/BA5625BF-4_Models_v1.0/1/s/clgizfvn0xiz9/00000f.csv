"0","## ==== AUC表を標準キー 'auc_df' に統一して保存（無ければ再計算） ==============="
"0","suppressPackageStartupMessages(library(timeROC))"
"0",""
"0","# 24m AUCに使う T, Δ はここで統一（あなたが使っているルールに合わせています）"
"0","T_used <- if (""rfs_months"" %in% names(tst)) as.numeric(tst$rfs_months) else as.numeric(tst$time2y)"
"0","Delta  <- if (""rfs_event""  %in% names(tst)) as.integer(tst$rfs_event==1) else as.integer(tst$event2y)"
"0",""
"0","times_try <- c(24, 18, 12, 6)  # 24mが無理な場合は自動で下に落ちます"
"0",""
"0","for (m in names(model_results)){"
"0","  res <- model_results[[m]]"
"0",""
"0","  # 既に auc_df があるならスキップ"
"0","  if (is.data.frame(res$auc_df)) next"
"0",""
"0","  # 1) auc が timeROC ならそこから表を作る"
"0","  if (inherits(res$auc, ""timeROC"")){"
"0","    model_results[[m]]$auc_df <- data.frame(time = res$auc$times, AUC = res$auc$AUC)"
"0","    next"
"0","  }"
"0",""
"0","  # 2) auc が data.frame（time, AUC列がある）ならそのまま採用"
"0","  if (is.data.frame(res$auc)) {"
"0","    tc <- names(res$auc)[grepl(""time|month"", names(res$auc), ignore.case = TRUE)][1]"
"0","    ac <- names(res$auc)[grepl(""^auc$"",      names(res$auc), ignore.case = TRUE)][1]"
"0","    if (!is.na(tc) && !is.na(ac)) {"
"0","      model_results[[m]]$auc_df <- data.frame(time = as.numeric(res$auc[[tc]]),"
"0","                                              AUC  = as.numeric(res$auc[[ac]]))"
"0","      next"
"0","    }"
"0","  }"
"0",""
"0","  # 3) リスクスコアが保存されている場合は、ここで timeROC を再計算して保存"
"0","  if (!is.null(res$risk) && is.numeric(res$risk) && length(res$risk) == length(T_used)) {"
"0","    ok <- vapply(times_try, function(t){"
"0","      sum(T_used <= t & Delta == 1, na.rm = TRUE) > 0 &&"
"0","        sum(T_used >  t,             na.rm = TRUE) > 0"
"0","    }, logical(1))"
"0","    times_ok <- sort(times_try[ok])"
"0","    if (length(times_ok)) {"
"0","      roc <- timeROC(T = T_used, delta = Delta, marker = res$risk,"
"0","                     cause = 1, times = times_ok, iid = TRUE)"
"0","      model_results[[m]]$auc_df <- data.frame(time = roc$times, AUC = roc$AUC)"
"0","    } else {"
"0","      message(sprintf(""[AUC-REPAIR] '%s': 評価可能な時点がありませんでした。"", m))"
"0","    }"
"0","  } else {"
"0","    message(sprintf(""[AUC-REPAIR] '%s': risk が保存されていないため再計算不可。"", m))"
"0","  }"
"0","}"
"0",""
