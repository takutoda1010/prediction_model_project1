"0","## ==== CHUNK M8: Cox with {stage_diag, t, im, ALBIscore} ====================="
"0","model_name_m8 <- ""M8_StageT_IM_ALBI"""
"0","vars_m8 <- c(""stage_diag"",""t"",""im"",""ALBIscore"")"
"0",""
"0","# 存在チェック"
"0","miss <- setdiff(vars_m8, names(trv))"
"0","stopifnot(length(miss) == 0)"
"0",""
"0","# 因子レベルの整合（文字/論理/因子）"
"0","fac_m8 <- vars_m8[vapply(trv[vars_m8], \(x) is.character(x) || is.logical(x) || is.factor(x), TRUE)]"
"0","if (length(fac_m8)){"
"0","  trv[fac_m8] <- lapply(trv[fac_m8], factor)"
"0","  for (v in fac_m8){"
"0","    tst[[v]] <- factor(tst[[v]], levels = levels(trv[[v]]))"
"0","  }"
"0","}"
"0",""
"0","# フォーミュラ & 学習"
"0","form_m8 <- as.formula(sprintf(""Surv(time2y, event2y) ~ %s"", paste(vars_m8, collapse = "" + "")))"
"0","fit_m8  <- coxph(form_m8, data = trv, x = TRUE, y = TRUE)"
"0",""
"0","# Test 予測（線形予測子＝高いほど高リスク）"
"0","risk_m8 <- as.numeric(predict(fit_m8, newdata = tst, type = ""lp""))"
"0",""
"0","# ---- C-index（向き補正） + bootstrap SE/CI ----"
"0","d_eval <- within(tst, { risk <- risk_m8 })"
"0","cobj_m8 <- survival::concordance(Surv(time2y, event2y) ~ risk, data = d_eval, reverse = TRUE)"
"0","c_index_m8 <- as.numeric(cobj_m8$concordance)"
"0",""
"0","set.seed(20251102)"
"0","B <- 500"
"0","c_boot_m8 <- replicate(B, {"
"0","  idx <- sample.int(nrow(d_eval), replace = TRUE)"
"0","  survival::concordance(Surv(d_eval$time2y[idx], d_eval$event2y[idx]) ~ d_eval$risk[idx],"
"0","                        reverse = TRUE)$concordance"
"0","})"
"0","c_se_m8 <- stats::sd(c_boot_m8, na.rm = TRUE)"
"0","c_ci_m8 <- c_index_m8 + c(-1,1)*1.96*c_se_m8"
"0",""
"0","cat(sprintf(""[M8] C-index = %.3f (SE = %.3f), 95%% CI [%.3f, %.3f]\n"","
"0","            c_index_m8, c_se_m8, c_ci_m8[1], c_ci_m8[2]))"
"1","[M8] C-index = 0.704 (SE = 0.034), 95% CI [0.637, 0.771]
"
"0","# ---- Time-dependent AUC（24m優先、無理なら 18/12/6 にフォールバック） ----"
"0","T_used <- if (""rfs_months"" %in% names(tst)) as.numeric(tst$rfs_months) else as.numeric(tst$time2y)"
"0","Delta  <- if (""rfs_event""  %in% names(tst)) as.integer(tst$rfs_event==1) else as.integer(tst$event2y)"
"0",""
"0","times_try <- c(24,18,12,6)"
"0","ok <- vapply(times_try, function(t){"
"0","  sum(T_used <= t & Delta == 1, na.rm = TRUE) > 0 &&"
"0","    sum(T_used >  t,             na.rm = TRUE) > 0"
"0","}, logical(1))"
"0","times_ok <- sort(times_try[ok])"
"0",""
"0","auc_df_m8 <- NULL; auc24_m8 <- NA_real_"
"0","if (length(times_ok)){"
"0","  roc_m8 <- timeROC(T = T_used, delta = Delta, marker = risk_m8,"
"0","                    cause = 1, times = times_ok, iid = TRUE)"
"0","  auc_df_m8 <- data.frame(time = roc_m8$times, AUC = roc_m8$AUC)"
"0","  print(auc_df_m8, row.names = FALSE)"
"0","  if (24 %in% roc_m8$times) {"
"0","    auc24_m8 <- roc_m8$AUC[roc_m8$times == 24]"
"0","  } else {"
"0","    cat(""[M8] Note: 24ヶ月は評価不可。最も近い時点のみ表示しています。\n"")"
"0","  }"
"0","} else {"
"0","  cat(""[M8] TD-AUC: Test セットに評価可能な時点がありません（controls不足/追跡不足）。\n"")"
"0","}"
