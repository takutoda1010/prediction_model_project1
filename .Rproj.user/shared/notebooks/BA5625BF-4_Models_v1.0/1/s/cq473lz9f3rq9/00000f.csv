"0","## ==== CHUNK M7K-3: 目標(4–6親変数)を満たすλをVal C-indexで選択（無ければ範囲拡張） =="
"0","# ValでのC-index（Harrell, reverse=TRUE）を計算する関数"
"0","val_cindex_at <- function(lam){"
"0","  risk <- as.numeric(predict(fit_glmnet, newx = X_val, s = lam, type = ""link""))"
"0","  cobj <- survival::concordance(Surv(val$time2y, val$event2y) ~ risk, data = val, reverse = TRUE)"
"0","  as.numeric(cobj$concordance)"
"0","}"
"0",""
"0","# 範囲を広げながら候補λを探索"
"0","L0 <- k_target[1]; U0 <- k_target[2]"
"0","best <- NULL"
"0","for (wid in 0:6) {  # 最大±6まで緩める（必要なら調整）"
"0","  L <- max(1L, L0 - wid); U <- U0 + wid"
"0","  cand_idx <- which(lambda_grid$n_parent >= L & lambda_grid$n_parent <= U)"
"0","  if (!length(cand_idx)) next"
"0",""
"0","  cand <- lambda_grid[cand_idx, , drop = FALSE]"
"0","  cand$val_c <- vapply(cand$lambda, val_cindex_at, numeric(1))"
"0","  # ↑ 数値が出ない/NAなら外す"
"0","  cand <- cand[is.finite(cand$val_c), , drop = FALSE]"
"0","  if (!nrow(cand)) next"
"0",""
"0","  # 最良：Val C最大。同点はより大きいλ（=スパース）を優先"
"0","  i_best <- with(cand, order(-val_c, -lambda))[1]"
"0","  best <- cand[i_best, , drop = FALSE]"
"0","  attr(best, ""search_range"") <- c(L, U)"
"0","  break"
"0","}"
"0","if (is.null(best)) stop(""候補となる λ が見つかりませんでした。"")"
"0",""
"0","lambda_star <- best$lambda"
"0","n_parent_star <- best$n_parent"
"0","cval_star <- best$val_c"
"0","cat(sprintf(""[M7K] selected λ* = %.6f  (parents=%d within [%d,%d], Val C=%.3f)\n"","
"0","            lambda_star, n_parent_star, attr(best, ""search_range"")[1], attr(best, ""search_range"")[2], cval_star))"
"1","[M7K] selected λ* = 0.116514  (parents=6 within [4,6], Val C=0.725)
"
