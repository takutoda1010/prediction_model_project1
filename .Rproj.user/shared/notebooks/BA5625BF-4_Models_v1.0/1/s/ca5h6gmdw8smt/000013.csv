"0","## ==== CHUNK M7K-1: model.matrix 設計 & 親変数マッピング（Train基準） ========="
"0","# Trainを基準に因子レベルを固定"
"0","to_fac_trn <- vapply(trn[preds], function(x) is.factor(x) || is.character(x) || is.logical(x), logical(1))"
"0","trn[preds[to_fac_trn]] <- lapply(trn[preds[to_fac_trn]], factor)"
"0","val[preds[to_fac_trn]] <- Map(function(x, lev) factor(x, levels = lev),"
"0","                              val[preds[to_fac_trn]], lapply(trn[preds[to_fac_trn]], levels))"
"0","tst[preds[to_fac_trn]] <- Map(function(x, lev) factor(x, levels = lev),"
"0","                              tst[preds[to_fac_trn]], lapply(trn[preds[to_fac_trn]], levels))"
"0",""
"0","form_x  <- as.formula(paste(""~"", paste(preds, collapse = "" + "")))"
"0",""
"0","# model.matrix（切片列は除外）"
"0","mmake <- function(df){"
"0","  mm <- model.matrix(form_x, data = df)"
"0","  mm[, colnames(mm) != ""(Intercept)"", drop = FALSE]"
"0","}"
"0","X_tr  <- mmake(trn)"
"0","X_val <- mmake(val)"
"0",""
"0","# Train列を基準に Val を整列（足りない列は0補完）"
"0","align_to <- function(X_new, X_ref){"
"0","  miss <- setdiff(colnames(X_ref), colnames(X_new))"
"0","  if (length(miss)) {"
"0","    add <- matrix(0, nrow = nrow(X_new), ncol = length(miss), dimnames = list(NULL, miss))"
"0","    X_new <- cbind(X_new, add)"
"0","  }"
"0","  X_new[, colnames(X_ref), drop = FALSE]"
"0","}"
"0","X_val <- align_to(X_val, X_tr)"
"0",""
"0","# 親変数（ダミー→親）対応ベクタ（X_trの列順と一致）"
"0","## ==== FIX for CHUNK M7K-1: parent_by_col を列名付きで作る ===================="
"0","form_x <- as.formula(paste(""~"", paste(preds, collapse = "" + "")))"
"0",""
"0","# 単一の model.matrix から X_tr と assign を同時に取得"
"0","MM_all <- model.matrix(form_x, data = trn)              # (Intercept) 含む"
"0","keep   <- colnames(MM_all) != ""(Intercept)"""
"0","X_tr   <- MM_all[, keep, drop = FALSE]                  # これが学習用デザイン行列"
"0",""
"0","assign_v  <- attr(MM_all, ""assign"")[keep]               # 列ごとの term 番号（切片を除外）"
"0","term_lb   <- attr(terms(form_x), ""term.labels"")"
"0","parent_by_col <- setNames(term_lb[assign_v], colnames(X_tr))  # ★列名を names にセット"
"0",""
"0","# 確認（ここで落ちなければOK）"
"0","stopifnot(identical(colnames(X_tr), names(parent_by_col)))"
"0",""
"0","# 0分散は事前に落とす（稀対策）"
"0","zv <- which(apply(X_tr, 2, sd, na.rm = TRUE) == 0)"
"0","if (length(zv)) {"
"0","  X_tr  <- X_tr[, -zv, drop = FALSE]"
"0","  X_val <- X_val[, colnames(X_tr), drop = FALSE]"
"0","  parent_by_col <- parent_by_col[colnames(X_tr)]"
"0","}"
"0",""
