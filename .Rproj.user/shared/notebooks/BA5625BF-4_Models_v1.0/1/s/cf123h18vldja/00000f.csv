"0","## ==== CHUNK M7-2: fit LASSO path on Train; pick λ by Val C-index ============"
"0","set.seed(20251102)"
"0","y_tr <- with(trn, Surv(time2y, event2y))"
"0",""
"0","# 0分散列を落とす（稀対策）"
"0","zv <- which(apply(X_tr, 2, sd, na.rm = TRUE) == 0)"
"0","if (length(zv)) {"
"0","  X_tr  <- X_tr[, -zv, drop = FALSE]"
"0","  X_val <- X_val[, colnames(X_tr), drop = FALSE]  # 整列"
"0","}"
"0",""
"0","fit_glmnet <- glmnet(x = X_tr, y = y_tr, family = ""cox"", alpha = 1, standardize = TRUE)"
"0",""
"0","# Val の C-index を各 λ で評価（高いほど良い；tieは大きいλ優先でスパースに）"
"0","lams <- fit_glmnet$lambda"
"0","val_c <- sapply(lams, function(s){"
"0","  risk_val <- as.numeric(predict(fit_glmnet, newx = X_val, s = s, type = ""link""))"
"0","  cobj <- survival::concordance(Surv(val$time2y, val$event2y) ~ risk_val,"
"0","                                data = val, reverse = TRUE)"
"0","  as.numeric(cobj$concordance)"
"0","})"
"0",""
"0","best_idx <- which.max(val_c)"
"0","# 同等（±1e-3）ならより大きいλを採用"
"0","eps <- 1e-3"
"0","cand <- which(val_c >= (val_c[best_idx] - eps))"
"0","lambda_star <- max(lams[cand])"
"0","cval_star   <- val_c[which(lams == lambda_star)]"
"0",""
"0","cat(sprintf(""[M7] LASSO selection: best λ = %.6f  (Val C-index = %.3f)\n"","
"0","            lambda_star, cval_star))"
"1","[M7] LASSO selection: best λ = 0.055354  (Val C-index = 0.750)
"
