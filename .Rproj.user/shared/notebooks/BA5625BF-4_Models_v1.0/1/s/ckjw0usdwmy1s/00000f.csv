"0","## ==== ROC-1: timeROC を各モデルで再計算（t=24mを優先, なければ最も近い点） ===="
"0","suppressPackageStartupMessages(library(timeROC))"
"0",""
"0","stopifnot(exists(""model_results""), exists(""tst""))"
"0",""
"0","# 使う時間・イベント（あなたのルールに合わせています）"
"0","T_used <- if (""rfs_months"" %in% names(tst)) as.numeric(tst$rfs_months) else as.numeric(tst$time2y)"
"0","Delta  <- if (""rfs_event""  %in% names(tst)) as.integer(tst$rfs_event==1) else as.integer(tst$event2y)"
"0",""
"0","# まず 24m を試し、無理なら 18/12/6m へフォールバック"
"0","times_try <- c(24, 18, 12, 6)"
"0","tol_near  <- 0.6  # 24mに最も近い点を許可する許容幅（月）"
"0",""
"0","roc_list <- list()"
"0",""
"0","for (m in names(model_results)){"
"0","  res <- model_results[[m]]"
"0","  if (is.null(res$risk) || !is.numeric(res$risk) || length(res$risk) != length(T_used)) {"
"0","    message(sprintf(""[ROC] skip '%s': risk が保存されていません。"", m))"
"0","    next"
"0","  }"
"0","  # 評価可能な時点を決定（cases>0 & controls>0）"
"0","  ok <- vapply(times_try, function(t){"
"0","    sum(T_used <= t & Delta == 1, na.rm = TRUE) > 0 &&"
"0","      sum(T_used >  t,             na.rm = TRUE) > 0"
"0","  }, logical(1))"
"0","  times_ok <- sort(times_try[ok])"
"0","  if (!length(times_ok)) {"
"0","    message(sprintf(""[ROC] skip '%s': 評価可能な時点がありません。"", m))"
"0","    next"
"0","  }"
"0",""
"0","  roc <- timeROC(T = T_used, delta = Delta, marker = res$risk,"
"0","                 cause = 1, times = times_ok, iid = TRUE)"
"0",""
"0","  # 表示に使う時点：24mがあればそれ、なければ最も近い時点（tol以内）"
"0","  if (24 %in% roc$times) {"
"0","    t_show <- 24"
"0","    auc_show <- roc$AUC[roc$times == 24]"
"0","  } else {"
"0","    j <- which.min(abs(roc$times - 24))"
"0","    if (abs(roc$times[j] - 24) <= tol_near) {"
"0","      t_show <- roc$times[j]"
"0","      auc_show <- roc$AUC[j]"
"0","    } else {"
"0","      # 近い点が tol を超えるなら、一番右（最大のt）を採用"
"0","      j <- which.max(roc$times)"
"0","      t_show <- roc$times[j]"
"0","      auc_show <- roc$AUC[j]"
"0","    }"
"0","  }"
"0",""
"0","  roc_list[[m]] <- list(model = m, roc = roc, t_show = t_show, auc = as.numeric(auc_show))"
"0","  # ついでに統一キー auc_df が無ければ保存（以後の表作成で拾える）"
"0","  if (is.null(res$auc_df)) model_results[[m]]$auc_df <- data.frame(time = roc$times, AUC = roc$AUC)"
"0","}"
"0",""
