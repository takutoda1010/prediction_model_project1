"0","# ==== PATCH 2: 評価結果を model_results に保存（CHUNK4 を置き換え） =========="
"0","# 予測スコア（大きいほど高リスク）"
"0","risk_test <- as.numeric(predict(fit_step, newdata = tst, type = ""lp""))"
"0",""
"0","# ---- 1) Harrell's C-index（向き補正） + bootstrap SE/CI ----"
"0","d_eval <- tst"
"0","d_eval$risk <- risk_test"
"0",""
"0","cobj    <- survival::concordance(Surv(time2y, event2y) ~ risk, data = d_eval, reverse = TRUE)"
"0","c_index <- as.numeric(cobj$concordance)"
"0",""
"0","set.seed(20251102)"
"0","B <- 500"
"0","c_boot <- replicate(B, {"
"0","  idx <- sample.int(nrow(d_eval), replace = TRUE)"
"0","  survival::concordance(Surv(time2y[idx], event2y[idx]) ~ risk[idx],"
"0","                        data = d_eval[idx, ], reverse = TRUE)$concordance"
"0","})"
"0","c_se <- stats::sd(c_boot, na.rm = TRUE)"
"0","c_ci <- c_index + c(-1, 1) * 1.96 * c_se"
"0",""
"0","cat(sprintf(""[TEST] Harrell's C-index = %.3f (SE = %.3f), 95%% CI [%.3f, %.3f]\n"","
"0","            c_index, c_se, c_ci[1], c_ci[2]))"
"1","[TEST] Harrell's C-index = 0.732 (SE = 0.046), 95% CI [0.641, 0.822]
"
"0","# ---- 2) Time-dependent AUC（評価可能な時点だけ自動で） ----"
"0","auc_df <- NULL"
"0","if (""rfs_months"" %in% names(tst)) {"
"0","  delta_full <- if (""rfs_event"" %in% names(tst)) as.integer(tst$rfs_event == 1) else"
"0","                if (""recur_event"" %in% names(tst)) as.integer(tst$recur_event == 1) else"
"0","                as.integer(tst$recur_2y == TRUE)"
"0","  T_full <- as.numeric(tst$rfs_months)"
"0",""
"0","  times_try <- c(24, 18, 12, 6)"
"0","  ok <- vapply(times_try, function(t){"
"0","    sum(T_full <= t & delta_full == 1, na.rm = TRUE) > 0 &&"
"0","      sum(T_full >  t,                 na.rm = TRUE) > 0"
"0","  }, logical(1))"
"0","  times_ok <- times_try[ok]"
"0",""
"0","  if (length(times_ok) == 0) {"
"0","    cat(""[TEST] TD-AUC: Test セットに評価可能な時点がありません（追跡不足）。\n"")"
"0","  } else {"
"0","    roc <- timeROC(T = T_full, delta = delta_full, marker = risk_test,"
"0","                   cause = 1, times = sort(times_ok), iid = TRUE)"
"0","    auc_df <- data.frame(time = roc$times, AUC = roc$AUC)"
"0","    print(auc_df, row.names = FALSE)"
"0","    if (!24 %in% times_ok) {"
"0","      cat(""Note: 24ヶ月はcontrols=0のため評価不可。最も近い時点で代替評価を表示しました。\n"")"
"0","    }"
"0","  }"
"0","} else {"
"0","  T_cut <- as.numeric(tst$time2y)"
"0","  delta_cut <- as.integer(tst$event2y)"
"0",""
"0","  times_try <- c(23.9, 18, 12, 6)"
"0","  ok <- vapply(times_try, function(t){"
"0","    sum(T_cut <= t & delta_cut == 1, na.rm = TRUE) > 0 &&"
"0","      sum(T_cut >  t,                 na.rm = TRUE) > 0"
"0","  }, logical(1))"
"0","  times_ok <- times_try[ok]"
"0",""
"0","  if (length(times_ok) == 0) {"
"0","    cat(""[TEST] TD-AUC: time2y でも評価可能な時点がありません（controls不足）。\n"")"
"0","  } else {"
"0","    roc <- timeROC(T = T_cut, delta = delta_cut, marker = risk_test,"
"0","                   cause = 1, times = sort(times_ok), iid = TRUE)"
"0","    auc_df <- data.frame(time = roc$times, AUC = roc$AUC)"
"0","    print(auc_df, row.names = FALSE)"
"0","    if (!any(abs(times_ok - 24) < 1e-6)) {"
"0","      cat(""Note: 24ヶ月は評価不可。最も近い時点で代替評価を表示しました。\n"")"
"0","    }"
"0","  }"
"0","}"
