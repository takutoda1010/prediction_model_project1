"0","## ==== CHUNK M7-1: design matrix helpers & build X for glmnet (Train→Val) ==="
"0","# Trainの因子レベルを基準に Val/Test を整列"
"0","to_fac_trn <- vapply(trn[preds], function(x) is.factor(x) || is.character(x) || is.logical(x), logical(1))"
"0","# factor化（Train）"
"0","trn[preds[to_fac_trn]] <- lapply(trn[preds[to_fac_trn]], factor)"
"0","# Val/Test を Train の levels に揃える"
"0","val[preds[to_fac_trn]] <- Map(function(x, lev) factor(x, levels = lev),"
"0","                              val[preds[to_fac_trn]], lapply(trn[preds[to_fac_trn]], levels))"
"0","tst[preds[to_fac_trn]] <- Map(function(x, lev) factor(x, levels = lev),"
"0","                              tst[preds[to_fac_trn]], lapply(trn[preds[to_fac_trn]], levels))"
"0",""
"0","# model.matrix 生成（Trainで列設計を決める；切片列は除外）"
"0","form_x <- as.formula(paste(""~"", paste(preds, collapse = "" + "")))"
"0","mmake <- function(df){"
"0","  mm <- model.matrix(form_x, data = df)"
"0","  mm[, colnames(mm) != ""(Intercept)"", drop = FALSE]"
"0","}"
"0","X_tr <- mmake(trn)"
"0",""
"0","# Val/Test を Train 列に合わせる（無い列は0で追加・順序を揃える）"
"0","align_to <- function(X_new, X_ref){"
"0","  miss <- setdiff(colnames(X_ref), colnames(X_new))"
"0","  if (length(miss)) {"
"0","    add <- matrix(0, nrow = nrow(X_new), ncol = length(miss),"
"0","                  dimnames = list(NULL, miss))"
"0","    X_new <- cbind(X_new, add)"
"0","  }"
"0","  X_new[, colnames(X_ref), drop = FALSE]"
"0","}"
"0","X_val <- align_to(mmake(val), X_tr)"
"0","# Test は post-LASSO Cox 用なのでここでは不要（後段で eval_model がデータフレームから作る）"
