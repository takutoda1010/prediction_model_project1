"0","## ==== CHUNK2: Predictor set & minimal harmonization ========================="
"0","# 予測子は var_all を使用（存在するものだけ）"
"0","preds <- intersect(var_all, names(trv))"
"0",""
"0","# 定数列があれば落とす（通常は何も落ちない想定）"
"0","const_flag <- vapply(preds, \(v){ x <- trv[[v]]; length(unique(x[!is.na(x)])) <= 1 }, logical(1))"
"0","if (any(const_flag)) preds <- preds[!const_flag]"
"0",""
"0","# 文字/論理は因子化し、Test のレベルを学習側に合わせる"
"0","to_fac <- vapply(trv[preds], \(x) is.character(x) || is.logical(x), logical(1))"
"0","trv[preds[to_fac]] <- lapply(trv[preds[to_fac]], factor)"
"0","tst[preds[to_fac]] <- Map(function(x, lev) factor(x, levels = lev),"
"0","                          tst[preds[to_fac]], lapply(trv[preds[to_fac]], levels))"
