"0","## ==== CHUNK3f-rank: backward LRTで重要度順（除去順）を作る ==================="
"0","preds_rfe <- preds  # 既存predsを使用"
"0","remove_order <- character(0)"
"0","current <- preds_rfe"
"0",""
"0","# 初回フルモデル（失敗したら可能な限りで進める）"
"0","fit_full <- safe_cox(as.formula(paste(""Surv(time2y, event2y) ~"", paste(current, collapse = "" + ""))), trv)"
"0",""
"0","while (length(current) > 0){"
"0","  # 変数ごとの LRT p（その変数を除いたモデル vs 現在モデル）"
"0","  pvec <- setNames(rep(NA_real_, length(current)), current)"
"0",""
"0","  for (v in current){"
"0","    # m_drop: v を除外したモデル"
"0","    kept <- setdiff(current, v)"
"0","    m_drop <- if (length(kept)) safe_cox(as.formula(paste(""Surv(time2y, event2y) ~"","
"0","                                                          paste(kept, collapse = "" + ""))), trv)"
"0","              else safe_cox(Surv(time2y, event2y) ~ 1, trv)"
"0","    m_full <- if (!is.null(fit_full) && setequal(attr(terms(fit_full), ""term.labels""), current)) {"
"0","      fit_full"
"0","    } else {"
"0","      safe_cox(as.formula(paste(""Surv(time2y, event2y) ~"", paste(current, collapse = "" + ""))), trv)"
"0","    }"
"0","    pvec[v] <- lrt_added_p(m_drop, m_full)  # v を""加える価値"""
"0","  }"
"0",""
"0","  # 最も寄与が小さい（pが最大 or NA）ものを1つ除去"
"0","  worst <- names(which.max(ifelse(is.finite(pvec), pvec, Inf)))"
"0","  remove_order <- c(remove_order, worst)"
"0","  current <- setdiff(current, worst)"
"0",""
"0","  # 現在集合のフルモデルを更新"
"0","  fit_full <- if (length(current)) safe_cox(as.formula(paste(""Surv(time2y, event2y) ~"","
"0","                                                             paste(current, collapse = "" + ""))), trv) else NULL"
"0","}"
"0","# remove_order が「落とす順」。サブセットkは：preds_rfe から先頭(m-k)個を除いたもの。"
"0","m <- length(preds_rfe)"
"0",""
