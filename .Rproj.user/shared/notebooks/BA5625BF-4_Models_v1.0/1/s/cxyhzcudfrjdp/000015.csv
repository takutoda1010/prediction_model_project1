"0","## ==== CHUNK: Temporal split ds09 -> ds09_train/val/test (60/20/20) ===="
"0","stopifnot(exists(""ds09""))"
"0","suppressPackageStartupMessages({ library(dplyr) })"
"0",""
"0","d <- ds09 %>%"
"0","  mutate(op_date = as.Date(op_date)) %>%"
"0","  filter(!is.na(op_date)) %>%"
"0","  arrange(op_date)"
"0",""
"0","od_num <- as.numeric(d$op_date)"
"0","q1 <- as.Date(stats::quantile(od_num, probs = 0.60, na.rm = TRUE, type = 7), origin = ""1970-01-01"")"
"0","q2 <- as.Date(stats::quantile(od_num, probs = 0.80, na.rm = TRUE, type = 7), origin = ""1970-01-01"")"
"0",""
"0","# 同日が多い場合など q1>=q2 の保険（最小限）"
"0","if (!is.finite(q1) || !is.finite(q2) || q1 >= q2) {"
"0","  u <- sort(unique(d$op_date))"
"0","  pos <- which(u >= q1)[1]"
"0","  if (!is.na(pos) && pos < length(u)) q2 <- u[pos + 1]"
"0","}"
"0",""
"0","ds09_train <- d %>% filter(op_date <= q1)"
"0","ds09_val   <- d %>% filter(op_date >  q1 & op_date <= q2)"
"0","ds09_test  <- d %>% filter(op_date >  q2)"
"0",""
"0","summarize_split <- function(d, name) {"
"0","  cat(sprintf(""%s: n=%d, events=%d, first=%s, last=%s\n"","
"0","              name, nrow(d), sum(d$event != 0, na.rm = TRUE),"
"0","              ifelse(nrow(d)>0, as.character(min(d$op_date)), NA),"
"0","              ifelse(nrow(d)>0, as.character(max(d$op_date)), NA)))"
"0","}"
"0","summarize_split(ds09_train, ""ds09_train"")"
"2","Warning: Unknown or uninitialised column: `event`."
"1","ds09_train: n=587, events=0, first=2000-01-04, last=2015-07-10
"
"0","summarize_split(ds09_val,   ""ds09_val"")"
"2","Warning: Unknown or uninitialised column: `event`."
"1","ds09_val: n=196, events=0, first=2015-07-14, last=2019-12-24
"
"0","summarize_split(ds09_test,  ""ds09_test"")"
"2","Warning: Unknown or uninitialised column: `event`."
"1","ds09_test: n=196, events=0, first=2019-12-26, last=2024-12-20
"
