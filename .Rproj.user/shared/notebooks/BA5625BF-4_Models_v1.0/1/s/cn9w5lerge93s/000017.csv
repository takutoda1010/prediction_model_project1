"0","## ==== CHUNK SUM-1: 取り出しヘルパ & サマリー表の作成 ========================="
"0","stopifnot(exists(""model_results""))"
"0",""
"0","# 数値を安全に取り出すヘルパ"
"0","get_num <- function(x, keys, default = NA_real_) {"
"0","  for (k in keys) {"
"0","    if (!is.null(x[[k]]) && is.numeric(x[[k]]) && length(x[[k]]) >= 1) {"
"0","      v <- as.numeric(x[[k]][1])"
"0","      if (is.finite(v)) return(v)"
"0","    }"
"0","  }"
"0","  default"
"0","}"
"0","get_ci <- function(x) {"
"0","  # c_ci (長さ2) or c_lo/c_hi 形式を吸収"
"0","  if (!is.null(x$c_ci) && is.numeric(x$c_ci) && length(x$c_ci) >= 2) {"
"0","    c(as.numeric(x$c_ci[1]), as.numeric(x$c_ci[2]))"
"0","  } else if (!is.null(x$c_lo) && !is.null(x$c_hi)) {"
"0","    c(as.numeric(x$c_lo), as.numeric(x$c_hi))"
"0","  } else {"
"0","    c(NA_real_, NA_real_)"
"0","  }"
"0","}"
"0","# AUCテーブル（列名が time/AUC でなくても拾う）"
"0","get_auc_tbl <- function(x) {"
"0","  cand <- c(""auc_df"",""td_auc"",""auc_tbl"",""time_auc"",""roc_tbl"")"
"0","  for (k in cand) {"
"0","    df <- x[[k]]"
"0","    if (is.data.frame(df) && nrow(df) > 0) {"
"0","      # time 列を推定"
"0","      tc <- names(df)[grepl(""time"", names(df), ignore.case = TRUE)][1]"
"0","      ac <- names(df)[grepl(""^auc$"", names(df), ignore.case = TRUE)][1]"
"0","      if (!is.na(tc) && !is.na(ac)) {"
"0","        out <- data.frame(time = as.numeric(df[[tc]]),"
"0","                          AUC  = as.numeric(df[[ac]]))"
"0","        return(out)"
"0","      }"
"0","    }"
"0","  }"
"0","  NULL"
"0","}"
"0","# AUC@24m（無ければ最も近い点、±0.6月以内のみ。なければ NA）"
"0","get_auc24 <- function(x) {"
"0","  df <- get_auc_tbl(x)"
"0","  if (is.null(df)) return(NA_real_)"
"0","  idx_exact <- which(abs(df$time - 24) < 1e-6)"
"0","  if (length(idx_exact)) return(df$AUC[idx_exact[1]])"
"0","  # 近い点（±0.6m）だけ許可"
"0","  j <- which.min(abs(df$time - 24))"
"0","  if (length(j) && abs(df$time[j] - 24) <= 0.6) return(df$AUC[j])"
"0","  NA_real_"
"0","}"
"0",""
"0","# まとめる"
"0","mods <- names(model_results)"
"0","summ_rows <- lapply(mods, function(m){"
"0","  res <- model_results[[m]]"
"0","  cidx <- get_num(res, c(""c_index"",""cidx"",""concordance""))"
"0","  se   <- get_num(res, c(""c_se"",""se"",""std.err""))"
"0","  ci   <- get_ci(res)"
"0","  # SE が無ければ CI から逆算"
"0","  if (!is.finite(se) && all(is.finite(ci))) se <- (ci[2] - ci[1]) / (2*1.96)"
"0","  auc24 <- get_auc24(res)"
"0","  data.frame("
"0","    model = m,"
"0","    c_index = cidx,"
"0","    c_se = se,"
"0","    c_lo = if (is.finite(cidx) && is.finite(se)) cidx - 1.96*se else ci[1],"
"0","    c_hi = if (is.finite(cidx) && is.finite(se)) cidx + 1.96*se else ci[2],"
"0","    auc24 = auc24,"
"0","    stringsAsFactors = FALSE"
"0","  )"
"0","})"
"0","model_summary <- do.call(rbind, summ_rows)"
"0",""
"0","# 並べ替え（AUC@24 → C-index）"
"0","ord <- order(-ifelse(is.finite(model_summary$auc24), model_summary$auc24, -Inf),"
"0","             -ifelse(is.finite(model_summary$c_index), model_summary$c_index, -Inf))"
"0","model_summary <- model_summary[ord, ]"
"0","row.names(model_summary) <- NULL"
"0",""
"0","print(model_summary)"
