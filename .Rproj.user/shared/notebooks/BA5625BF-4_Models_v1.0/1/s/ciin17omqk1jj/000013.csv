"0",""
"0","# 2) 前進選択：現在モデル vs 追加モデル の LRT で最良 p < 0.05 を採用"
"0","included  <- character(0)"
"0","remaining <- screened"
"0",""
"0","repeat {"
"0","  # 現在モデル"
"0","  m0 <- if (length(included)) {"
"0","    coxph(as.formula(paste(""Surv(time2y, event2y) ~"", paste(included, collapse = "" + ""))),"
"0","          data = trv, x = TRUE, y = TRUE)"
"0","  } else {"
"0","    coxph(Surv(time2y, event2y) ~ 1, data = trv, x = TRUE, y = TRUE)"
"0","  }"
"0",""
"0","  best_var <- NULL; best_p <- 1"
"0","  for (v in remaining) {"
"0","    f1 <- as.formula(paste(""Surv(time2y, event2y) ~"", paste(c(included, v), collapse = "" + "")))"
"0","    m1 <- tryCatch(coxph(f1, data = trv, x = TRUE, y = TRUE), error = function(e) NULL)"
"0","    p_add <- tryCatch({"
"0","      a <- anova(m0, m1, test = ""Chisq"")"
"0","      as.numeric(a[2, ncol(a)])  # 2行目のP値（追加モデル）"
"0","    }, error = function(e) NA_real_)"
"0","    if (is.finite(p_add) && p_add < best_p) { best_p <- p_add; best_var <- v }"
"0","  }"
"0","  if (!is.null(best_var) && best_p < 0.05) {"
"0","    included  <- c(included, best_var)"
"0","    remaining <- setdiff(remaining, best_var)"
"0","  } else {"
"0","    break"
"0","  }"
"0","}"
"0",""
"0","# 3) 後向きクリーンアップ：入っている各項目の LRT p を再確認し p>=0.05 を除外"
"0","repeat {"
"0","  if (!length(included)) break"
"0","  f_now <- as.formula(paste(""Surv(time2y, event2y) ~"", paste(included, collapse = "" + "")))"
"0","  m_now <- coxph(f_now, data = trv, x = TRUE, y = TRUE)"
"0","  # drop1 は環境差が出るので anova(除外)で判定"
"0","  pvec <- sapply(included, function(v){"
"0","    f_drop <- as.formula(paste(""Surv(time2y, event2y) ~"","
"0","                               paste(setdiff(included, v), collapse = "" + "")))"
"0","    m_drop <- if (length(setdiff(included, v))) coxph(f_drop, data = trv, x = TRUE, y = TRUE)"
"0","              else coxph(Surv(time2y, event2y) ~ 1, data = trv, x = TRUE, y = TRUE)"
"0","    a <- tryCatch(anova(m_drop, m_now, test = ""Chisq""), error = function(e) NULL)"
"0","    if (is.null(a)) NA_real_ else as.numeric(a[2, ncol(a)])"
"0","  })"
"0","  worst <- names(which.max(pvec))"
"0","  if (is.finite(pvec[worst]) && pvec[worst] >= 0.05) {"
"0","    included <- setdiff(included, worst)"
"0","  } else break"
"0","}"
"0",""
"0","# 4) 最終モデルのフィット"
"0","if (length(included)) {"
"0","  f_final <- as.formula(paste(""Surv(time2y, event2y) ~"", paste(included, collapse = "" + "")))"
"0","  fit_m5r <- coxph(f_final, data = trv, x = TRUE, y = TRUE)"
"0","} else {"
"0","  fit_m5r <- coxph(Surv(time2y, event2y) ~ 1, data = trv, x = TRUE, y = TRUE)"
"0","  message(sprintf(""[%s] No variables selected; fitted Null model."", model_name_m5))"
"0","}"
"0","cat(sprintf(""\n[%s] Selected terms:\n"", model_name_m5)); print(included)"
"1","
[M5_Uni0.1_then_Step_p0.05_robust] Selected terms:
"
"1","[1]"
"1"," ""t""                "
"1"," ""ALBIscore""        "
"1"," ""macroVI""          "
"1"," ""alt_log1p""        "
"1"," ""im""               "
"1","
"
"1","[6]"
"1"," ""BMI""              "
"1"," ""icg_r15_log1p""    "
"1"," ""max_diam_cm_log1p"""
"1","
"
