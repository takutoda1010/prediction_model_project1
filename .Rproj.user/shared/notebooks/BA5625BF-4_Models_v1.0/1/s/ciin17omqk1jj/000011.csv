"0","# *モデル5* Univariate screening (p<0.1, robust) → Stepwise selection (stop p<0.05)"
"0","## ==== CHUNK3e_fix: robust univariate screen + forward LRT stepwise =========="
"0","model_name_m5 <- ""M5_Uni0.1_then_Step_p0.05_robust"""
"0",""
"0","# 単変量 p：まず Cox の LRT、ダメなら因子のみ log-rank で代替"
"0","get_uni_p <- function(v){"
"0","  x <- trv[[v]]"
"0","  frm <- as.formula(paste(""Surv(time2y, event2y) ~"", v))"
"0","  # Cox 単変量"
"0","  p <- tryCatch({"
"0","    fit <- coxph(frm, data = trv, x = TRUE, y = TRUE)"
"0","    as.numeric(summary(fit)$logtest[3])  # LRT の p"
"0","  }, error = function(e) NA_real_)"
"0","  # フォールバック：因子で分離などにより p が NA のときは log-rank"
"0","  if (!is.finite(p) && is.factor(x)) {"
"0","    p <- tryCatch({"
"0","      sd <- survdiff(Surv(trv$time2y, trv$event2y) ~ x, rho = 0)"
"0","      stats::pchisq(sd$chisq, df = length(sd$n) - 1, lower.tail = FALSE)"
"0","    }, error = function(e) NA_real_)"
"0","  }"
"0","  p"
"0","}"
"0",""
"0","# 1) 単変量スクリーニング（p<0.10）"
"0","uni_p2   <- setNames(vapply(preds, get_uni_p, numeric(1)), preds)"
"0","uni_tbl2 <- data.frame(var = names(uni_p2), p = uni_p2) %>% dplyr::arrange(p)"
"0","screened <- uni_tbl2$var[is.finite(uni_tbl2$p) & uni_tbl2$p < 0.10]"
"0","if (!length(screened)) screened <- head(uni_tbl2$var[is.finite(uni_tbl2$p)], 5)"
"0",""
"0","cat(sprintf(""\n[%s] Univariate screen: %d passed (p<0.10)\n"", model_name_m5, length(screened)))"
"1","
[M5_Uni0.1_then_Step_p0.05_robust] Univariate screen: 32 passed (p<0.10)
"
"0","print(head(uni_tbl2, 20), row.names = FALSE)"
