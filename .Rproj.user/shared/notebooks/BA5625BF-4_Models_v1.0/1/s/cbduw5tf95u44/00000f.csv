"0","# *モデル6* Recursive Feature Elimination (Cox, CV by C-index)"
"0","## ==== CHUNK3f-helpers: safe fit / C-index / folds ==========================="
"0","model_name_m6 <- ""M6_RFE_Cox"""
"0",""
"0","safe_cox <- function(formula, data){"
"0","  tryCatch(coxph(formula, data = data, x = TRUE, y = TRUE), error = function(e) NULL)"
"0","}"
"0",""
"0","lrt_added_p <- function(m0, m1){"
"0","  tryCatch({"
"0","    a <- anova(m0, m1, test = ""Chisq"")"
"0","    as.numeric(a[2, ncol(a)])  # 2行目のP"
"0","  }, error = function(e) NA_real_)"
"0","}"
"0",""
"0","cindex_on <- function(fit, df_val){"
"0","  if (is.null(fit)) return(NA_real_)"
"0","  risk <- tryCatch(as.numeric(predict(fit, newdata = df_val, type = ""lp"")), error = function(e) NA_real_)"
"0","  if (!all(is.finite(risk))) return(NA_real_)"
"0","  cobj <- tryCatch(survival::concordance(Surv(df_val$time2y, df_val$event2y) ~ risk,"
"0","                                         data = df_val, reverse = TRUE),"
"0","                   error = function(e) NULL)"
"0","  if (is.null(cobj)) return(NA_real_)"
"0","  as.numeric(cobj$concordance)"
"0","}"
"0",""
"0","make_folds <- function(df, K = 5, seed = 20251102){"
"0","  set.seed(seed)"
"0","  f <- integer(nrow(df))"
"0","  idx1 <- which(df$event2y == 1); idx0 <- which(df$event2y == 0)"
"0","  f[idx1] <- sample(rep(1:K, length.out = length(idx1)))"
"0","  f[idx0] <- sample(rep(1:K, length.out = length(idx0)))"
"0","  f"
"0","}"
