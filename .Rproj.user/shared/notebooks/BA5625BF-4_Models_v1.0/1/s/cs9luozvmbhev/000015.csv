"0","## ==== EXPORT-SETUP ==========================================================="
"0","out_dir <- ""/Users/yoshidatakuto/Dropbox/Hokkaido University/大学院医学院/Borderline HCC/Prediction model_Project1/03_Output"""
"0","dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)"
"0",""
"0","## ==== 1) 各モデルの “最終的に使われた変数” を抽出 → CSV ======================="
"0","# できる限り汎用に：selected_terms / selected_vars / selected_parents / coxph係数名 を探索"
"0","extract_vars_used <- function(res){"
"0","  v <- NULL"
"0","  if (is.character(res$selected_terms))   v <- res$selected_terms"
"0","  if (is.null(v) && is.character(res$selected_vars))      v <- res$selected_vars"
"0","  if (is.null(v) && is.character(res$selected_parents))   v <- res$selected_parents"
"0","  if (is.null(v) && inherits(res$fit, ""coxph""))           v <- names(stats::coef(res$fit))"
"0","  if (is.null(v) && inherits(res$fit_post, ""coxph""))      v <- names(stats::coef(res$fit_post))"
"0","  if (is.null(v) && is.numeric(res$coef) && !is.null(names(res$coef))){"
"0","    v <- names(res$coef)[is.finite(res$coef) & res$coef != 0]"
"0","  }"
"0","  v <- unique(v[!is.na(v) & nzchar(v)])"
"0","  v"
"0","}"
"0",""
"0","stopifnot(exists(""model_results""))"
"0","vars_long <- do.call(rbind, lapply(names(model_results), function(m){"
"0","  vv <- extract_vars_used(model_results[[m]])"
"0","  if (length(vv)) data.frame(model = m, variable = vv, stringsAsFactors = FALSE)"
"0","}))"
"0","if (is.null(vars_long) || nrow(vars_long) == 0) {"
"0","  warning(""変数一覧を抽出できませんでした（model_results に選択情報が保存されているか確認してください）。"")"
"0","} else {"
"0","  write.csv(vars_long, file = file.path(out_dir, ""final_vars_by_model.csv""), row.names = FALSE)"
"0","}"
"0",""
"0","## ==== 2) model_summary を CSV へ（無ければ最小限で再構成） ===================="
"0","if (!exists(""model_summary"")) {"
"0","  # 簡易再構成（c_index / c_se / c_ci / auc_df から）"
"0","  get_auc24 <- function(res){"
"0","    if (is.data.frame(res$auc_df) && nrow(res$auc_df)){"
"0","      j <- which(abs(res$auc_df$time - 24) < 1e-6)"
"0","      if (length(j)) return(as.numeric(res$auc_df$AUC[j[1]]))"
"0","      k <- which.min(abs(res$auc_df$time - 24))"
"0","      if (length(k) && abs(res$auc_df$time[k] - 24) <= 0.6) return(as.numeric(res$auc_df$AUC[k]))"
"0","    }"
"0","    NA_real_"
"0","  }"
"0","  model_summary <- do.call(rbind, lapply(names(model_results), function(m){"
"0","    r <- model_results[[m]]"
"0","    cidx <- as.numeric(r$c_index); se <- as.numeric(r$c_se)"
"0","    if (!is.finite(se) && is.numeric(r$c_ci) && length(r$c_ci) >= 2) {"
"0","      se <- (r$c_ci[2] - r$c_ci[1])/(2*1.96)"
"0","    }"
"0","    lo <- if (all(is.finite(c(cidx, se)))) cidx - 1.96*se else if (!is.null(r$c_ci)) r$c_ci[1] else NA_real_"
"0","    hi <- if (all(is.finite(c(cidx, se)))) cidx + 1.96*se else if (!is.null(r$c_ci)) r$c_ci[2] else NA_real_"
"0","    data.frame(model = m, c_index = cidx, c_se = se, c_lo = lo, c_hi = hi,"
"0","               auc24 = get_auc24(r), stringsAsFactors = FALSE)"
"0","  }))"
"0","}"
"0","write.csv(model_summary, file = file.path(out_dir, ""model_summary.csv""), row.names = FALSE)"
"0",""
"0","## ==== 3) ROC カーブ（重ね書き）を保存（PNG/PDF） ============================="
"0","suppressPackageStartupMessages(library(timeROC))"
"0","stopifnot(exists(""tst""))"
"0",""
"0","# 使う時間・イベント（あなたのルール）"
"0","T_used <- if (""rfs_months"" %in% names(tst)) as.numeric(tst$rfs_months) else as.numeric(tst$time2y)"
"0","Delta  <- if (""rfs_event""  %in% names(tst)) as.integer(tst$rfs_event==1) else as.integer(tst$event2y)"
"0",""
"0","# risk が無いモデルは fit/fit_post から補完"
"0","for (m in names(model_results)){"
"0","  res <- model_results[[m]]"
"0","  if (is.null(res$risk) || length(res$risk) != nrow(tst)){"
"0","    if (inherits(res$fit, ""coxph"")) {"
"0","      model_results[[m]]$risk <- as.numeric(predict(res$fit, newdata = tst, type = ""lp""))"
"0","    } else if (inherits(res$fit_post, ""coxph"")) {"
"0","      model_results[[m]]$risk <- as.numeric(predict(res$fit_post, newdata = tst, type = ""lp""))"
"0","    }"
"0","  }"
"0","}"
"0",""
"0","# timeROC を 24m優先で作成"
"0","times_try <- c(24, 18, 12, 6); tol_near <- 0.6"
"0","roc_list <- list()"
"0","for (m in names(model_results)){"
"0","  r <- model_results[[m]]$risk"
"0","  if (!is.numeric(r) || length(r) != length(T_used)) next"
"0","  ok <- vapply(times_try, function(t){"
"0","    sum(T_used <= t & Delta == 1, na.rm = TRUE) > 0 &&"
"0","      sum(T_used >  t,             na.rm = TRUE) > 0"
"0","  }, logical(1))"
"0","  t_ok <- sort(times_try[ok]); if (!length(t_ok)) next"
"0","  roc <- timeROC(T = T_used, delta = Delta, marker = r, cause = 1, times = t_ok, iid = TRUE)"
"0","  if (24 %in% roc$times) {"
"0","    t_show <- 24; auc_show <- roc$AUC[roc$times == 24]"
"0","  } else {"
"0","    j <- which.min(abs(roc$times - 24))"
"0","    if (abs(roc$times[j] - 24) <= tol_near) { t_show <- roc$times[j]; auc_show <- roc$AUC[j] }"
"0","    else { j <- which.max(roc$times); t_show <- roc$times[j]; auc_show <- roc$AUC[j] }"
"0","  }"
"0","  roc_list[[m]] <- list(roc = roc, t_show = t_show, auc = as.numeric(auc_show))"
"0","  if (is.null(model_results[[m]]$auc_df)) {"
"0","    model_results[[m]]$auc_df <- data.frame(time = roc$times, AUC = roc$AUC)"
"0","  }"
"0","}"
"0",""
"0","plot_roc_overlay <- function(roc_list, main_title = ""Time-dependent ROC curves (Test)""){"
"0","  if (!length(roc_list)) { plot.new(); title(""No models to plot""); return(invisible()) }"
"0","  models <- names(roc_list); cols <- grDevices::rainbow(length(models)); lwd <- 2"
"0","  # 1本目"
"0","  m1 <- models[1]"
"0","  plot(roc_list[[m1]]$roc, time = roc_list[[m1]]$t_show,"
"0","       col = cols[1], lwd = lwd,"
"0","       xlab = ""False Positive Rate (1 - Specificity)"","
"0","       ylab = ""True Positive Rate (Sensitivity)"", title = FALSE)"
"0","  title(main = main_title)"
"0","  abline(0,1,lty=3,col=""gray60"")"
"0","  # 以降重ね"
"0","  for (i in 2:length(models)){"
"0","    plot(roc_list[[models[i]]]$roc, time = roc_list[[models[i]]]$t_show,"
"0","         add = TRUE, col = cols[i], lwd = lwd)"
"0","  }"
"0","  lgd <- vapply(models, function(m){"
"0","    sprintf(""%s  (AUC@%s m = %.3f)"", m,"
"0","            format(roc_list[[m]]$t_show, trim=TRUE), roc_list[[m]]$auc)"
"0","  }, """")"
"0","  legend(""bottomright"", legend = lgd, col = cols, lwd = lwd, cex = 0.8, bg = ""white"")"
"0","}"
"0",""
"0","# PNG"
"0","png(file.path(out_dir, ""roc_curves_test_overlay.png""), width = 1800, height = 1400, res = 200)"
"0","plot_roc_overlay(roc_list)"
