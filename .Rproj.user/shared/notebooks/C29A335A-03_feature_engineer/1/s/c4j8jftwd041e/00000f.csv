"0","################################################################################"
"0","# 03_feature_engineer.R - ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã¨æ´¾ç”Ÿå¤‰æ•°ä½œæˆ"
"0","# "
"0","# Description: "
"0","#   æ´¾ç”Ÿå¤‰æ•°ã®ä½œæˆï¼ˆALBIã€BMIã€microVIã€macroVIç­‰ï¼‰"
"0","#   å¤‰æ•°å¤‰æ›ï¼ˆå¯¾æ•°å¤‰æ›ã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰"
"0","#   æ¬ æå€¤å‡¦ç†"
"0","#"
"0","# Author: Takuto Yoshida"
"0","# Date: 2024-11-07"
"0","################################################################################"
"0",""
"0","# ========================================================================"
"0","# 1. åŒ»å­¦çš„ã‚¹ã‚³ã‚¢ã®è¨ˆç®—"
"0","# ========================================================================"
"0",""
"0","#' ALBIã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @return ALBIã‚¹ã‚³ã‚¢ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","compute_albi_score <- function(df) {"
"0","  "
"0","  if (all(c(""tbil"", ""alb"") %in% names(df))) {"
"0","    message(""\nğŸ“Š Computing ALBI score..."")"
"0","    "
"0","    # å˜ä½ç¢ºèªã¨å¤‰æ›"
"0","    # tbil: mg/dL â†’ Î¼mol/L (Ã—17.1)"
"0","    # alb: g/dL â†’ g/L (Ã—10)"
"0","    "
"0","    bil_umol <- df$tbil * 17.1"
"0","    alb_gl <- df$alb * 10"
"0","    "
"0","    # ALBIã‚¹ã‚³ã‚¢è¨ˆç®—"
"0","    df$ALBIscore <- dplyr::case_when("
"0","      !is.na(bil_umol) & bil_umol > 0 & !is.na(alb_gl) ~ "
"0","        (log10(bil_umol) * 0.66) + (alb_gl * -0.085),"
"0","      TRUE ~ NA_real_"
"0","    )"
"0","    "
"0","    # ALBIã‚°ãƒ¬ãƒ¼ãƒ‰"
"0","    df$ALBIgrade <- dplyr::case_when("
"0","      is.na(df$ALBIscore) ~ NA_character_,"
"0","      df$ALBIscore <= -2.60 ~ ""1"","
"0","      df$ALBIscore <= -1.39 ~ ""2"","
"0","      TRUE ~ ""3"""
"0","    ) %>% factor(levels = c(""1"", ""2"", ""3""))"
"0","    "
"0","    # çµ±è¨ˆã‚µãƒãƒªãƒ¼"
"0","    albi_summary <- summary(df$ALBIscore)"
"0","    message(sprintf(""  âœ“ ALBI score: median = %.2f, range = [%.2f, %.2f]"","
"0","                   median(df$ALBIscore, na.rm = TRUE),"
"0","                   min(df$ALBIscore, na.rm = TRUE),"
"0","                   max(df$ALBIscore, na.rm = TRUE)))"
"0","    "
"0","    # ã‚°ãƒ¬ãƒ¼ãƒ‰åˆ†å¸ƒ"
"0","    grade_table <- table(df$ALBIgrade, useNA = ""ifany"")"
"0","    message(""  âœ“ ALBI grade distribution:"")"
"0","    for (i in seq_along(grade_table)) {"
"0","      message(sprintf(""    Grade %s: %d (%.1f%%)"", "
"0","                     names(grade_table)[i], "
"0","                     grade_table[i],"
"0","                     100 * grade_table[i] / sum(grade_table)))"
"0","    }"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","#' BMIã‚’è¨ˆç®—"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @return BMIãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","compute_bmi <- function(df) {"
"0","  "
"0","  if (all(c(""height_cm"", ""weight_kg"") %in% names(df))) {"
"0","    message(""\nğŸ“ Computing BMI..."")"
"0","    "
"0","    df$BMI <- dplyr::case_when("
"0","      !is.na(df$weight_kg) & !is.na(df$height_cm) & df$height_cm > 0 ~ "
"0","        df$weight_kg / ((df$height_cm / 100)^2),"
"0","      TRUE ~ NA_real_"
"0","    )"
"0","    "
"0","    # BMIã‚«ãƒ†ã‚´ãƒªï¼ˆWHOåŸºæº–ï¼‰"
"0","    df$BMI_category <- dplyr::case_when("
"0","      is.na(df$BMI) ~ NA_character_,"
"0","      df$BMI < 18.5 ~ ""Underweight"","
"0","      df$BMI < 25 ~ ""Normal"","
"0","      df$BMI < 30 ~ ""Overweight"","
"0","      TRUE ~ ""Obese"""
"0","    ) %>% factor(levels = c(""Underweight"", ""Normal"", ""Overweight"", ""Obese""))"
"0","    "
"0","    # ã‚µãƒãƒªãƒ¼"
"0","    bmi_summary <- summary(df$BMI)"
"0","    message(sprintf(""  âœ“ BMI: median = %.1f, range = [%.1f, %.1f]"","
"0","                   median(df$BMI, na.rm = TRUE),"
"0","                   min(df$BMI, na.rm = TRUE),"
"0","                   max(df$BMI, na.rm = TRUE)))"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 2. è„ˆç®¡ä¾µè¥²å¤‰æ•°ã®ä½œæˆ"
"0","# ========================================================================"
"0",""
"0","#' microVIã¨macroVIã‚’ä½œæˆï¼ˆä¿®æ­£ç‰ˆå®šç¾©ï¼‰"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @return VIå¤‰æ•°ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","create_vascular_invasion_variables <- function(df) {"
"0","  "
"0","  message(""\nğŸ”¬ Creating vascular invasion variables..."")"
"0","  "
"0","  # æ•°å€¤ã«å¤‰æ›ï¼ˆå®‰å…¨ã«ï¼‰"
"0","  get_numeric_vi <- function(x) {"
"0","    suppressWarnings(as.numeric(as.character(x)))"
"0","  }"
"0","  "
"0","  # microVI: è¡“å‰Vp/Vv=0 ã‹ã¤ è¡“å¾ŒVp/Vv/Va/b>0"
"0","  if (all(c(""vp_pre"", ""vv_pre"") %in% names(df))) {"
"0","    "
"0","    vp_pre_num <- get_numeric_vi(df$vp_pre)"
"0","    vv_pre_num <- get_numeric_vi(df$vv_pre)"
"0","    "
"0","    # è¡“å¾Œã®è„ˆç®¡ä¾µè¥²"
"0","    post_vi <- FALSE"
"0","    if (""vp_path"" %in% names(df)) {"
"0","      vp_path_num <- get_numeric_vi(df$vp_path)"
"0","      post_vi <- post_vi | (!is.na(vp_path_num) & vp_path_num > 0)"
"0","    }"
"0","    if (""vv_path"" %in% names(df)) {"
"0","      vv_path_num <- get_numeric_vi(df$vv_path)"
"0","      post_vi <- post_vi | (!is.na(vv_path_num) & vv_path_num > 0)"
"0","    }"
"0","    if (""va_path"" %in% names(df)) {"
"0","      va_path_num <- get_numeric_vi(df$va_path)"
"0","      post_vi <- post_vi | (!is.na(va_path_num) & va_path_num > 0)"
"0","    }"
"0","    if (""b_path"" %in% names(df)) {"
"0","      b_path_num <- get_numeric_vi(df$b_path)"
"0","      post_vi <- post_vi | (!is.na(b_path_num) & b_path_num > 0)"
"0","    }"
"0","    "
"0","    # microVIåˆ¤å®š"
"0","    df$microVI <- (vp_pre_num == 0 & vv_pre_num == 0) & post_vi"
"0","    "
"0","    message(sprintf(""  âœ“ microVI: %d cases (%.1f%%)"","
"0","                   sum(df$microVI, na.rm = TRUE),"
"0","                   100 * mean(df$microVI, na.rm = TRUE)))"
"0","  }"
"0","  "
"0","  # macroVI: è¡“å‰Vp/Vv>=1 ã‹ã¤ è¡“å¾ŒVp/Vv>=1"
"0","  if (all(c(""vp_pre"", ""vv_pre"", ""vp_path"", ""vv_path"") %in% names(df))) {"
"0","    "
"0","    vp_pre_num <- get_numeric_vi(df$vp_pre)"
"0","    vv_pre_num <- get_numeric_vi(df$vv_pre)"
"0","    vp_path_num <- get_numeric_vi(df$vp_path)"
"0","    vv_path_num <- get_numeric_vi(df$vv_path)"
"0","    "
"0","    # macroVIåˆ¤å®š"
"0","    df$macroVI <- ((vp_pre_num >= 1 | vv_pre_num >= 1) & "
"0","                   (vp_path_num >= 1 | vv_path_num >= 1))"
"0","    "
"0","    message(sprintf(""  âœ“ macroVI: %d cases (%.1f%%)"","
"0","                   sum(df$macroVI, na.rm = TRUE),"
"0","                   100 * mean(df$macroVI, na.rm = TRUE)))"
"0","  }"
"0","  "
"0","  # è«–ç†ãƒã‚§ãƒƒã‚¯"
"0","  if (all(c(""microVI"", ""macroVI"") %in% names(df))) {"
"0","    both_true <- sum(df$microVI == TRUE & df$macroVI == TRUE, na.rm = TRUE)"
"0","    if (both_true > 0) {"
"0","      warning(sprintf(""  âš  %d cases have both microVI and macroVI = TRUE"", both_true))"
"0","    }"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 3. æ™‚é–“é–¢é€£å¤‰æ•°ã®ä½œæˆ"
"0","# ========================================================================"
"0",""
"0","#' 2å¹´å†ç™ºãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå¤‰æ•°ã‚’ä½œæˆ"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @return æ™‚é–“å¤‰æ•°ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","create_time_variables <- function(df) {"
"0","  "
"0","  message(""\nâ±ï¸ Creating time-related variables..."")"
"0","  "
"0","  # 2å¹´å†ç™º (recur_2y)"
"0","  if (all(c(""recur_tf"", ""rfs_months"") %in% names(df))) {"
"0","    "
"0","    # recur_tfã‚’è«–ç†å€¤ã«å¤‰æ›"
"0","    recur_logical <- dplyr::case_when("
"0","      as.character(df$recur_tf) %in% c(""TRUE"", ""1"", ""Yes"", ""æœ‰"") ~ TRUE,"
"0","      as.character(df$recur_tf) %in% c(""FALSE"", ""0"", ""No"", ""ç„¡"") ~ FALSE,"
"0","      TRUE ~ NA"
"0","    )"
"0","    "
"0","    df$recur_2y <- dplyr::case_when("
"0","      recur_logical & df$rfs_months <= 24 ~ TRUE,"
"0","      recur_logical & df$rfs_months > 24 ~ FALSE,"
"0","      !recur_logical ~ FALSE,"
"0","      TRUE ~ NA"
"0","    )"
"0","    "
"0","    message(sprintf(""  âœ“ recur_2y: %d events (%.1f%%)"","
"0","                   sum(df$recur_2y, na.rm = TRUE),"
"0","                   100 * mean(df$recur_2y, na.rm = TRUE)))"
"0","  }"
"0","  "
"0","  # 2å¹´ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒªãƒ¼ç”Ÿå­˜ (eventfree_2y)"
"0","  if (all(c(""rfs_months"", ""os_months"", ""vital_status"") %in% names(df))) {"
"0","    "
"0","    # æ­»äº¡ãƒ•ãƒ©ã‚°"
"0","    is_dead <- df$vital_status %in% ""æ­»"" | df$vital10 %in% c(""FALSE"", ""0"")"
"0","    "
"0","    # 2å¹´ä»¥å†…å†ç™º"
"0","    rec_2y <- !is.na(df$rfs_months) & df$rfs_months <= 24 & "
"0","              df$recur_tf %in% c(""TRUE"", ""1"")"
"0","    "
"0","    # 2å¹´ä»¥å†…æ­»äº¡"
"0","    death_2y <- is_dead & !is.na(df$os_months) & df$os_months <= 24"
"0","    "
"0","    df$eventfree_2y <- dplyr::case_when("
"0","      rec_2y | death_2y ~ FALSE,"
"0","      (!is.na(df$rfs_months) & df$rfs_months > 24) &"
"0","      (!is.na(df$os_months) & df$os_months > 24) ~ TRUE,"
"0","      TRUE ~ NA"
"0","    )"
"0","    "
"0","    message(sprintf(""  âœ“ eventfree_2y: %d event-free (%.1f%%)"","
"0","                   sum(df$eventfree_2y == TRUE, na.rm = TRUE),"
"0","                   100 * mean(df$eventfree_2y == TRUE, na.rm = TRUE)))"
"0","  }"
"0","  "
"0","  # 2å¹´ç”Ÿå­˜ (vital_2y)"
"0","  if (all(c(""os_months"", ""vital_status"") %in% names(df))) {"
"0","    "
"0","    is_dead <- df$vital_status %in% ""æ­»"" | df$vital10 %in% c(""FALSE"", ""0"")"
"0","    "
"0","    df$vital_2y <- dplyr::case_when("
"0","      !is.na(df$os_months) & df$os_months <= 24 & is_dead ~ FALSE,"
"0","      !is.na(df$os_months) & df$os_months > 24 ~ TRUE,"
"0","      TRUE ~ NA"
"0","    )"
"0","    "
"0","    message(sprintf(""  âœ“ vital_2y: %d alive at 2y (%.1f%%)"","
"0","                   sum(df$vital_2y == TRUE, na.rm = TRUE),"
"0","                   100 * mean(df$vital_2y == TRUE, na.rm = TRUE)))"
"0","  }"
"0","  "
"0","  # 2å¹´æ‰“ã¡åˆ‡ã‚Šæ™‚é–“ (time2y)"
"0","  if (any(c(""rfs_months"", ""os_months"") %in% names(df))) {"
"0","    "
"0","    time_base <- df$rfs_months"
"0","    if (!""rfs_months"" %in% names(df)) {"
"0","      time_base <- df$os_months"
"0","    } else {"
"0","      # RFSãŒNAã®å ´åˆã¯OSã‚’ä½¿ç”¨"
"0","      time_base <- dplyr::coalesce(df$rfs_months, df$os_months)"
"0","    }"
"0","    "
"0","    df$time2y <- pmin(time_base, 24, na.rm = FALSE)"
"0","    "
"0","    message(sprintf(""  âœ“ time2y: median = %.1f months"","
"0","                   median(df$time2y, na.rm = TRUE)))"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 4. å¤‰æ•°å¤‰æ›ï¼ˆå¯¾æ•°å¤‰æ›ç­‰ï¼‰"
"0","# ========================================================================"
"0",""
"0","#' æ­ªã‚“ã å¤‰æ•°ã®å¤‰æ›"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ"
"0","#' @param threshold æ­ªåº¦ã®é–¾å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1.0ï¼‰"
"0","#' @return å¤‰æ›å¤‰æ•°ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","transform_skewed_variables <- function(df, variables = NULL, threshold = 1.0) {"
"0","  "
"0","  message(""\nğŸ“ˆ Transforming skewed variables..."")"
"0","  "
"0","  # å¤‰æ›å€™è£œã®å–å¾—"
"0","  transform_candidates <- character()"
"0","  "
"0","  if (!is.null(variables) && !is.null(variables$transformations$log_transform$candidates)) {"
"0","    transform_candidates <- variables$transformations$log_transform$candidates"
"0","  } else {"
"0","    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¤‰æ›å€™è£œ"
"0","    transform_candidates <- c("
"0","      ""afp"", ""afp_l3"", ""pivka2"", ""cea"", ""ca19_9"","
"0","      ""ast"", ""alt"", ""tbil"", ""plt"","
"0","      ""icg_r15"", ""lhl15"", ""hh15"","
"0","      ""tum_diam_pre"", ""tum_count_pre"","
"0","      ""max_diam_cm"", ""count"","
"0","      ""bleed_ml"", ""specimen_wt"""
"0","    )"
"0","  }"
"0","  "
"0","  # æ­ªåº¦è¨ˆç®—é–¢æ•°"
"0","  skewness <- function(x) {"
"0","    x <- x[is.finite(x)]"
"0","    if (length(x) < 3) return(NA_real_)"
"0","    m <- mean(x)"
"0","    s <- sd(x)"
"0","    if (!is.finite(s) || s == 0) return(NA_real_)"
"0","    mean((x - m)^3) / (s^3)"
"0","  }"
"0","  "
"0","  # å¤‰æ›å®Ÿè¡Œ"
"0","  transformed_count <- 0"
"0","  "
"0","  for (var in transform_candidates) {"
"0","    if (var %in% names(df) && is.numeric(df[[var]])) {"
"0","      "
"0","      # æ­ªåº¦ãƒã‚§ãƒƒã‚¯"
"0","      skew <- skewness(df[[var]])"
"0","      "
"0","      if (is.finite(skew) && abs(skew) > threshold) {"
"0","        "
"0","        # å¤‰æ›ã‚¿ã‚¤ãƒ—ã®æ±ºå®š"
"0","        x <- df[[var]]"
"0","        min_val <- min(x, na.rm = TRUE)"
"0","        "
"0","        if (!is.finite(min_val)) next"
"0","        "
"0","        if (skew > 0) {  # å³æ­ªã¿"
"0","          if (min_val >= 0) {"
"0","            # log1på¤‰æ›"
"0","            df[[paste0(var, ""_log1p"")]] <- log1p(x)"
"0","            transformed_count <- transformed_count + 1"
"0","            message(sprintf(""  âœ“ %s_log1p: created (skew = %.2f)"", var, skew))"
"0","          } else {"
"0","            # asinhå¤‰æ›ï¼ˆè² å€¤å¯¾å¿œï¼‰"
"0","            df[[paste0(var, ""_asinh"")]] <- asinh(x)"
"0","            transformed_count <- transformed_count + 1"
"0","            message(sprintf(""  âœ“ %s_asinh: created (skew = %.2f)"", var, skew))"
"0","          }"
"0","        } else {  # å·¦æ­ªã¿"
"0","          max_val <- max(x, na.rm = TRUE)"
"0","          if (is.finite(max_val)) {"
"0","            # åè»¢log1på¤‰æ›"
"0","            df[[paste0(var, ""_reflog1p"")]] <- log1p(pmax(max_val - x, 0))"
"0","            transformed_count <- transformed_count + 1"
"0","            message(sprintf(""  âœ“ %s_reflog1p: created (skew = %.2f)"", var, skew))"
"0","          }"
"0","        }"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  message(sprintf(""  Total transformations: %d"", transformed_count))"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 5. æ¬ æå€¤å‡¦ç†"
"0","# ========================================================================"
"0",""
"0","#' æ¬ æå€¤ã®å‡¦ç†"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @param method è£œå®Œæ–¹æ³•ï¼ˆ""median"", ""mode"", ""forward"", ""none""ï¼‰"
"0","#' @return æ¬ æå‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","handle_missing_values <- function(df, config = NULL, method = ""median"") {"
"0","  "
"0","  message(""\nğŸ”§ Handling missing values..."")"
"0","  "
"0","  # æ¬ æç‡ã®è¨ˆç®—"
"0","  missing_rates <- colMeans(is.na(df))"
"0","  "
"0","  # é«˜æ¬ æå¤‰æ•°ã®é™¤å¤–é–¾å€¤"
"0","  threshold <- 0.30  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30%"
"0","  if (!is.null(config) && !is.null(config$data_processing$missing_threshold)) {"
"0","    threshold <- config$data_processing$missing_threshold"
"0","  }"
"0","  "
"0","  # é«˜æ¬ æå¤‰æ•°ã®ç‰¹å®šï¼ˆãŸã ã—é‡è¦å¤‰æ•°ã¯ä¿æŒï¼‰"
"0","  keep_always <- c(""recur_date"", ""recur_2y"", ""death_cause"", ""death_cause4"")"
"0","  high_missing <- names(missing_rates)[missing_rates > threshold]"
"0","  to_remove <- setdiff(high_missing, keep_always)"
"0","  "
"0","  if (length(to_remove) > 0) {"
"0","    message(sprintf(""  âš  Removing %d variables with >%.0f%% missing:"","
"0","                   length(to_remove), threshold * 100))"
"0","    for (var in head(to_remove, 5)) {"
"0","      message(sprintf(""    - %s (%.1f%% missing)"", "
"0","                     var, 100 * missing_rates[var]))"
"0","    }"
"0","    if (length(to_remove) > 5) {"
"0","      message(sprintf(""    ... and %d more"", length(to_remove) - 5))"
"0","    }"
"0","    "
"0","    df <- df[, !names(df) %in% to_remove, drop = FALSE]"
"0","  }"
"0","  "
"0","  # å˜ä¸€è£œå®Œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
"0","  if (method != ""none"") {"
"0","    message(sprintf(""\n  Applying %s imputation..."", method))"
"0","    "
"0","    if (method == ""median"") {"
"0","      # æ•°å€¤å¤‰æ•°ã®ä¸­å¤®å€¤è£œå®Œ"
"0","      numeric_vars <- names(df)[sapply(df, is.numeric)]"
"0","      "
"0","      for (var in numeric_vars) {"
"0","        if (any(is.na(df[[var]]))) {"
"0","          med_val <- median(df[[var]], na.rm = TRUE)"
"0","          if (is.finite(med_val)) {"
"0","            n_imputed <- sum(is.na(df[[var]]))"
"0","            df[[var]][is.na(df[[var]])] <- med_val"
"0","            message(sprintf(""    %s: %d values imputed (median = %.2f)"","
"0","                           var, n_imputed, med_val))"
"0","          }"
"0","        }"
"0","      }"
"0","      "
"0","    } else if (method == ""mode"") {"
"0","      # ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ã®æœ€é »å€¤è£œå®Œ"
"0","      factor_vars <- names(df)[sapply(df, function(x) is.factor(x) || is.character(x))]"
"0","      "
"0","      for (var in factor_vars) {"
"0","        if (any(is.na(df[[var]]))) {"
"0","          # æœ€é »å€¤ã®è¨ˆç®—"
"0","          tab <- table(df[[var]], useNA = ""no"")"
"0","          if (length(tab) > 0) {"
"0","            mode_val <- names(tab)[which.max(tab)]"
"0","            n_imputed <- sum(is.na(df[[var]]))"
"0","            df[[var]][is.na(df[[var]])] <- mode_val"
"0","            message(sprintf(""    %s: %d values imputed (mode = %s)"","
"0","                           var, n_imputed, mode_val))"
"0","          }"
"0","        }"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # æœ€çµ‚çš„ãªæ¬ æçŠ¶æ³"
"0","  final_missing <- colMeans(is.na(df))"
"0","  remaining_missing <- sum(final_missing > 0)"
"0","  "
"0","  message(sprintf(""\n  Final status: %d variables with remaining missing values"","
"0","                 remaining_missing))"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 6. å¤‰æ•°é¸æŠã®æº–å‚™"
"0","# ========================================================================"
"0",""
"0","#' ãƒ¢ãƒ‡ãƒ«æŠ•å…¥ç”¨ã®å¤‰æ•°ã‚»ãƒƒãƒˆã‚’æº–å‚™"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ"
"0","#' @param set_name ä½¿ç”¨ã™ã‚‹å¤‰æ•°ã‚»ãƒƒãƒˆå"
"0","#' @return é¸æŠã•ã‚ŒãŸå¤‰æ•°ã®ãƒ™ã‚¯ãƒˆãƒ«"
"0","prepare_variable_sets <- function(df, variables = NULL, set_name = ""model_all_candidates"") {"
"0","  "
"0","  message(""\nğŸ“‹ Preparing variable sets..."")"
"0","  "
"0","  # å¤‰æ•°ã‚»ãƒƒãƒˆã®å–å¾—"
"0","  var_set <- NULL"
"0","  "
"0","  if (!is.null(variables) && !is.null(variables$variable_sets[[set_name]])) {"
"0","    var_set <- variables$variable_sets[[set_name]]"
"0","  } else {"
"0","    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒãƒˆ"
"0","    message(""  Using default variable set"")"
"0","    var_set <- c("
"0","      ""age"", ""sex"", ""plt"", ""alb"", ""tbil"", ""ast"", ""alt"","
"0","      ""afp_log1p"", ""pivka2_log1p"","
"0","      ""max_diam_cm_log1p"", ""count"","
"0","      ""vp_path"", ""vv_path"", ""t"", ""n"", ""m"","
"0","      ""ALBIscore"", ""microVI"", ""macroVI"""
"0","    )"
"0","  }"
"0","  "
"0","  # å®Ÿåœ¨ã™ã‚‹å¤‰æ•°ã®ã¿é¸æŠ"
"0","  available_vars <- intersect(var_set, names(df))"
"0","  missing_vars <- setdiff(var_set, names(df))"
"0","  "
"0","  message(sprintf(""  Variable set '%s':"", set_name))"
"0","  message(sprintf(""    Requested: %d variables"", length(var_set)))"
"0","  message(sprintf(""    Available: %d variables"", length(available_vars)))"
"0","  "
"0","  if (length(missing_vars) > 0 && length(missing_vars) <= 10) {"
"0","    message(sprintf(""    Missing: %s"", paste(missing_vars, collapse = "", "")))"
"0","  } else if (length(missing_vars) > 10) {"
"0","    message(sprintf(""    Missing: %d variables"", length(missing_vars)))"
"0","  }"
"0","  "
"0","  return(available_vars)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 7. çµ±åˆç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°"
"0","# ========================================================================"
"0",""
"0","#' ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³"
"0","#' @param dm DatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ"
"0","#' @return æ›´æ–°ã•ã‚ŒãŸDatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","feature_engineering_pipeline <- function(dm, config = NULL, variables = NULL) {"
"0","  "
"0","  message(""\n========================================"")"
"0","  message(""Starting Feature Engineering Pipeline"")"
"0","  message(""========================================"")"
"0","  "
"0","  # ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"
"0","  df <- dm$get_current()"
"0","  current_version <- dm$current_version"
"0","  "
"0","  # 1. ALBIã‚¹ã‚³ã‚¢è¨ˆç®—"
"0","  df_albi <- compute_albi_score(df)"
"0","  dm$add_version(df_albi, version = current_version + 1)"
"0","  "
"0","  # 2. BMIè¨ˆç®—"
"0","  df_bmi <- compute_bmi(df_albi)"
"0","  dm$add_version(df_bmi, version = current_version + 2)"
"0","  "
"0","  # 3. è„ˆç®¡ä¾µè¥²å¤‰æ•°ä½œæˆ"
"0","  df_vi <- create_vascular_invasion_variables(df_bmi)"
"0","  dm$add_version(df_vi, version = current_version + 3)"
"0","  "
"0","  # 4. æ™‚é–“é–¢é€£å¤‰æ•°ä½œæˆ"
"0","  df_time <- create_time_variables(df_vi)"
"0","  dm$add_version(df_time, version = current_version + 4)"
"0","  "
"0","  # 5. å¤‰æ•°å¤‰æ›"
"0","  df_transformed <- transform_skewed_variables(df_time, variables)"
"0","  dm$add_version(df_transformed, version = current_version + 5)"
"0","  "
"0","  # 6. æ¬ æå€¤å‡¦ç†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
"0","  if (!is.null(config) && config$runtime$save_intermediate) {"
"0","    # æ¬ æå‡¦ç†å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿å­˜"
"0","    dm$add_version(df_transformed, version = current_version + 6)"
"0","  }"
"0","  "
"0","  # 7. å¤‰æ•°ã‚»ãƒƒãƒˆã®æº–å‚™ï¼ˆç¢ºèªã®ã¿ï¼‰"
"0","  available_vars <- prepare_variable_sets(df_transformed, variables)"
"0","  "
"0","  # ã‚µãƒãƒªãƒ¼è¡¨ç¤º"
"0","  dm$summary()"
"0","  "
"0","  # ç‰¹å¾´é‡ã®ã‚µãƒãƒªãƒ¼"
"0","  message(""\nğŸ“Š Feature Engineering Summary:"")"
"0","  message(sprintf(""  Total variables: %d"", ncol(df_transformed)))"
"0","  message(sprintf(""  Numeric variables: %d"", sum(sapply(df_transformed, is.numeric))))"
"0","  message(sprintf(""  Factor variables: %d"", sum(sapply(df_transformed, is.factor))))"
"0","  message(sprintf(""  Derived variables created: %d"", "
"0","                 length(grep(""(_log1p|_asinh|_reflog1p|ALBI|BMI|microVI|macroVI|_2y|time2y)"", "
"0","                            names(df_transformed)))))"
"0","  "
"0","  message(""\nâœ… Feature engineering pipeline completed!"")"
"0","  message(""========================================\n"")"
"0","  "
"0","  return(dm)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 8. ç‰¹å¾´é‡ã®å“è³ªãƒã‚§ãƒƒã‚¯"
"0","# ========================================================================"
"0",""
"0","#' ä½œæˆã•ã‚ŒãŸç‰¹å¾´é‡ã®å“è³ªãƒã‚§ãƒƒã‚¯"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @return ãƒã‚§ãƒƒã‚¯çµæœ"
"0","check_feature_quality <- function(df) {"
"0","  "
"0","  message(""\nğŸ” Checking feature quality..."")"
"0","  "
"0","  issues <- list()"
"0","  "
"0","  # 1. microVI/macroVIã®è«–ç†ãƒã‚§ãƒƒã‚¯"
"0","  if (all(c(""microVI"", ""macroVI"") %in% names(df))) {"
"0","    both_true <- which(df$microVI == TRUE & df$macroVI == TRUE)"
"0","    if (length(both_true) > 0) {"
"0","      issues$vi_conflict <- both_true"
"0","      message(sprintf(""  âš  VI conflict: %d cases with both micro/macroVI = TRUE"","
"0","                     length(both_true)))"
"0","    }"
"0","  }"
"0","  "
"0","  # 2. ALBIã‚¹ã‚³ã‚¢ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯"
"0","  if (""ALBIscore"" %in% names(df)) {"
"0","    albi_range <- range(df$ALBIscore, na.rm = TRUE)"
"0","    if (albi_range[1] < -4 || albi_range[2] > 2) {"
"0","      message(sprintf(""  âš  ALBI score out of expected range: [%.2f, %.2f]"","
"0","                     albi_range[1], albi_range[2]))"
"0","    }"
"0","  }"
"0","  "
"0","  # 3. æ™‚é–“å¤‰æ•°ã®è«–ç†ãƒã‚§ãƒƒã‚¯"
"0","  if (all(c(""recur_2y"", ""rfs_months"") %in% names(df))) {"
"0","    # 2å¹´è¶…ãªã®ã«2å¹´å†ç™ºã¨ã•ã‚Œã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹"
"0","    illogical <- which(df$recur_2y == TRUE & df$rfs_months > 24)"
"0","    if (length(illogical) > 0) {"
"0","      issues$time_conflict <- illogical"
"0","      message(sprintf(""  âš  Time conflict: %d cases with recur_2y=TRUE but RFS>24m"","
"0","                     length(illogical)))"
"0","    }"
"0","  }"
"0","  "
"0","  # 4. å¤‰æ›å¤‰æ•°ã®ç„¡é™å€¤ãƒã‚§ãƒƒã‚¯"
"0","  log_vars <- grep(""_log1p|_asinh|_reflog1p"", names(df), value = TRUE)"
"0","  for (var in log_vars) {"
"0","    if (any(is.infinite(df[[var]]))) {"
"0","      n_inf <- sum(is.infinite(df[[var]]))"
"0","      issues[[paste0(""inf_"", var)]] <- which(is.infinite(df[[var]]))"
"0","      message(sprintf(""  âš  Infinite values in %s: %d cases"", var, n_inf))"
"0","    }"
"0","  }"
"0","  "
"0","  if (length(issues) == 0) {"
"0","    message(""  âœ… All feature quality checks passed"")"
"0","  }"
"0","  "
"0","  return(issues)"
"0","}"
