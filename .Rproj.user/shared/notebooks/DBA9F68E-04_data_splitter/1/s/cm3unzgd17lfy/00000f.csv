"0","################################################################################"
"0","# 04_data_splitter.R - ãƒ‡ãƒ¼ã‚¿åˆ†å‰²å‡¦ç†"
"0","# "
"0","# Description: "
"0","#   è¨“ç·´ãƒ»æ¤œè¨¼ãƒ»ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²"
"0","#   æ™‚é–“çš„åˆ†å‰²ï¼ˆäºˆæ¸¬æœŸé–“ã‚’è€ƒæ…®ï¼‰ã€ãƒ©ãƒ³ãƒ€ãƒ åˆ†å‰²ã€å±¤åˆ¥åŒ–åˆ†å‰²"
"0","#   ã‚¯ãƒ­ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨åˆ†å‰²"
"0","#"
"0","# Author: Takuto Yoshida"
"0","# Date: 2024-11-07"
"0","# Revised: 2024-11-07 - äºˆæ¸¬æœŸé–“ã‚’è€ƒæ…®ã—ãŸæ™‚é–“çš„åˆ†å‰²ã‚’è¿½åŠ "
"0","################################################################################"
"0",""
"0","# ========================================================================"
"0","# 1. æ™‚é–“çš„åˆ†å‰²ï¼ˆäºˆæ¸¬æœŸé–“ã‚’è€ƒæ…®ï¼‰"
"0","# ========================================================================"
"0",""
"0","#' äºˆæ¸¬æœŸé–“ã‚’è€ƒæ…®ã—ãŸæ™‚é–“çš„ãƒ‡ãƒ¼ã‚¿åˆ†å‰²"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param date_col åˆ†å‰²åŸºæº–ã¨ãªã‚‹æ—¥ä»˜åˆ—åï¼ˆæ‰‹è¡“æ—¥ãªã©ï¼‰"
"0","#' @param prediction_months äºˆæ¸¬æœŸé–“ï¼ˆæœˆæ•°ï¼‰"
"0","#' @param reference_date åŸºæº–æ—¥ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šä»Šæ—¥ï¼‰"
"0","#' @param train_ratio è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã®å‰²åˆ"
"0","#' @param val_ratio æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã®å‰²åˆ"
"0","#' @param test_ratio ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å‰²åˆ"
"0","#' @return åˆ†å‰²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ"
"0","temporal_split <- function(df, "
"0","                          date_col = ""op_date"","
"0","                          prediction_months = 24,"
"0","                          reference_date = Sys.Date(),"
"0","                          train_ratio = 0.60,"
"0","                          val_ratio = 0.20,"
"0","                          test_ratio = 0.20) {"
"0","  "
"0","  message(""\nğŸ“… Performing temporal split with prediction window..."")"
"0","  "
"0","  # æ¯”ç‡ã®æ¤œè¨¼"
"0","  if (abs(train_ratio + val_ratio + test_ratio - 1.0) > 0.001) {"
"0","    stop(""Split ratios must sum to 1.0"")"
"0","  }"
"0","  "
"0","  # æ—¥ä»˜åˆ—ã®ç¢ºèª"
"0","  if (!date_col %in% names(df)) {"
"0","    stop(sprintf(""Date column '%s' not found in data"", date_col))"
"0","  }"
"0","  "
"0","  # ã‚«ãƒƒãƒˆã‚ªãƒ•æ—¥ã®è¨ˆç®—ï¼ˆäºˆæ¸¬æœŸé–“åˆ†é¡ã‚‹ï¼‰"
"0","  cutoff_date <- reference_date - (prediction_months * 30.44)  # æœˆã‚’æ—¥ã«å¤‰æ›"
"0","  "
"0","  message(sprintf(""  Reference date: %s"", reference_date))"
"0","  message(sprintf(""  Prediction window: %d months"", prediction_months))"
"0","  message(sprintf(""  Cutoff date: %s"", cutoff_date))"
"0","  "
"0","  # é©æ ¼ç—‡ä¾‹ã®é¸æŠï¼ˆæ‰‹è¡“æ—¥ãŒã‚«ãƒƒãƒˆã‚ªãƒ•ä»¥å‰ï¼‰"
"0","  df_eligible <- df[df[[date_col]] <= cutoff_date & !is.na(df[[date_col]]), ]"
"0","  "
"0","  # é™¤å¤–ç—‡ä¾‹ã®æƒ…å ±"
"0","  n_excluded <- nrow(df) - nrow(df_eligible)"
"0","  if (n_excluded > 0) {"
"0","    excluded_dates <- df[[date_col]][df[[date_col]] > cutoff_date & !is.na(df[[date_col]])]"
"0","    message(sprintf(""  âš  Excluded %d cases with %s after cutoff"", "
"0","                   length(excluded_dates), date_col))"
"0","    "
"0","    if (length(excluded_dates) <= 5) {"
"0","      message(sprintf(""    Excluded dates: %s"", "
"0","                     paste(excluded_dates, collapse = "", "")))"
"0","    } else {"
"0","      message(sprintf(""    Date range of excluded: %s to %s"","
"0","                     min(excluded_dates), max(excluded_dates)))"
"0","    }"
"0","  }"
"0","  "
"0","  # NAã®å‡¦ç†"
"0","  n_na <- sum(is.na(df[[date_col]]))"
"0","  if (n_na > 0) {"
"0","    message(sprintf(""  âš  %d rows with missing %s were excluded"", n_na, date_col))"
"0","  }"
"0","  "
"0","  # æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ"
"0","  df_sorted <- df_eligible[order(df_eligible[[date_col]]), ]"
"0","  "
"0","  n_total <- nrow(df_sorted)"
"0","  "
"0","  if (n_total == 0) {"
"0","    stop(""No eligible cases after applying cutoff date"")"
"0","  }"
"0","  "
"0","  # åˆ†å‰²æ•°ã®è¨ˆç®—"
"0","  n_train <- floor(n_total * train_ratio)"
"0","  n_val <- floor(n_total * val_ratio)"
"0","  n_test <- n_total - n_train - n_val"
"0","  "
"0","  # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ"
"0","  train_idx <- 1:n_train"
"0","  val_idx <- (n_train + 1):(n_train + n_val)"
"0","  test_idx <- (n_train + n_val + 1):n_total"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²"
"0","  result <- list("
"0","    train = df_sorted[train_idx, ],"
"0","    val = df_sorted[val_idx, ],"
"0","    test = df_sorted[test_idx, ],"
"0","    "
"0","    # é™¤å¤–ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜ï¼ˆå‚è€ƒç”¨ï¼‰"
"0","    excluded = df[df[[date_col]] > cutoff_date | is.na(df[[date_col]]), ],"
"0","    "
"0","    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚‚ä¿å­˜"
"0","    indices = list("
"0","      train = train_idx,"
"0","      val = val_idx,"
"0","      test = test_idx"
"0","    ),"
"0","    "
"0","    # ãƒ¡ã‚¿æƒ…å ±"
"0","    meta = list("
"0","      method = ""temporal"","
"0","      date_col = date_col,"
"0","      prediction_months = prediction_months,"
"0","      reference_date = reference_date,"
"0","      cutoff_date = cutoff_date,"
"0","      train_ratio = train_ratio,"
"0","      val_ratio = val_ratio,"
"0","      test_ratio = test_ratio,"
"0","      n_total = n_total,"
"0","      n_train = n_train,"
"0","      n_val = n_val,"
"0","      n_test = n_test,"
"0","      n_excluded = n_excluded"
"0","    )"
"0","  )"
"0","  "
"0","  # æ—¥ä»˜ç¯„å›²ã®è¡¨ç¤º"
"0","  train_range <- range(result$train[[date_col]], na.rm = TRUE)"
"0","  val_range <- range(result$val[[date_col]], na.rm = TRUE)"
"0","  test_range <- range(result$test[[date_col]], na.rm = TRUE)"
"0","  "
"0","  message(sprintf(""\n  âœ“ Eligible cases: %d (before %s)"", n_total, cutoff_date))"
"0","  message(sprintf(""  âœ“ Train: n=%d (%s to %s)"", "
"0","                 n_train, train_range[1], train_range[2]))"
"0","  message(sprintf(""  âœ“ Val:   n=%d (%s to %s)"", "
"0","                 n_val, val_range[1], val_range[2]))"
"0","  message(sprintf(""  âœ“ Test:  n=%d (%s to %s)"", "
"0","                 n_test, test_range[1], test_range[2]))"
"0","  "
"0","  # å„ã‚»ãƒƒãƒˆãŒäºˆæ¸¬æœŸé–“ã®è¦ä»¶ã‚’æº€ãŸã™ã‹ç¢ºèª"
"0","  verify_prediction_window(result, date_col, reference_date, prediction_months)"
"0","  "
"0","  class(result) <- c(""data_split"", ""list"")"
"0","  return(result)"
"0","}"
"0",""
"0","#' äºˆæ¸¬æœŸé–“ã®è¦ä»¶ã‚’ç¢ºèª"
"0","#' @param split_result åˆ†å‰²çµæœ"
"0","#' @param date_col æ—¥ä»˜åˆ—å"
"0","#' @param reference_date åŸºæº–æ—¥"
"0","#' @param prediction_months äºˆæ¸¬æœŸé–“"
"0","verify_prediction_window <- function(split_result, date_col, reference_date, prediction_months) {"
"0","  "
"0","  message(""\n  Verifying prediction window coverage:"")"
"0","  "
"0","  for (set_name in c(""train"", ""val"", ""test"")) {"
"0","    set_data <- split_result[[set_name]]"
"0","    "
"0","    # æœ€æ–°ã®æ‰‹è¡“æ—¥ã‹ã‚‰ã®çµŒéæœŸé–“"
"0","    latest_date <- max(set_data[[date_col]], na.rm = TRUE)"
"0","    months_elapsed <- as.numeric(reference_date - latest_date) / 30.44"
"0","    "
"0","    if (months_elapsed >= prediction_months) {"
"0","      message(sprintf(""    %s: âœ“ Latest case has %.1f months follow-up (>= %d months)"","
"0","                     stringr::str_to_title(set_name), "
"0","                     months_elapsed, "
"0","                     prediction_months))"
"0","    } else {"
"0","      warning(sprintf(""    %s: âš  Latest case has only %.1f months follow-up (< %d months)"","
"0","                     stringr::str_to_title(set_name), "
"0","                     months_elapsed, "
"0","                     prediction_months))"
"0","    }"
"0","  }"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 2. ãƒ©ãƒ³ãƒ€ãƒ åˆ†å‰²"
"0","# ========================================================================"
"0",""
"0","#' ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ‡ãƒ¼ã‚¿åˆ†å‰²ï¼ˆäºˆæ¸¬æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ä»˜ãï¼‰"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param date_col ãƒ•ã‚£ãƒ«ã‚¿ç”¨ã®æ—¥ä»˜åˆ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
"0","#' @param prediction_months äºˆæ¸¬æœŸé–“ï¼ˆæœˆæ•°ï¼‰"
"0","#' @param reference_date åŸºæº–æ—¥"
"0","#' @param train_ratio è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã®å‰²åˆ"
"0","#' @param val_ratio æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã®å‰²åˆ"
"0","#' @param test_ratio ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å‰²åˆ"
"0","#' @param seed ä¹±æ•°ã‚·ãƒ¼ãƒ‰"
"0","#' @return åˆ†å‰²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ"
"0","random_split <- function(df,"
"0","                        date_col = NULL,"
"0","                        prediction_months = NULL,"
"0","                        reference_date = Sys.Date(),"
"0","                        train_ratio = 0.60,"
"0","                        val_ratio = 0.20,"
"0","                        test_ratio = 0.20,"
"0","                        seed = NULL) {"
"0","  "
"0","  message(""\nğŸ² Performing random split..."")"
"0","  "
"0","  # æ¯”ç‡ã®æ¤œè¨¼"
"0","  if (abs(train_ratio + val_ratio + test_ratio - 1.0) > 0.001) {"
"0","    stop(""Split ratios must sum to 1.0"")"
"0","  }"
"0","  "
"0","  # äºˆæ¸¬æœŸé–“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
"0","  df_to_split <- df"
"0","  n_excluded <- 0"
"0","  cutoff_date <- NULL"
"0","  "
"0","  if (!is.null(date_col) && !is.null(prediction_months)) {"
"0","    cutoff_date <- reference_date - (prediction_months * 30.44)"
"0","    df_to_split <- df[df[[date_col]] <= cutoff_date & !is.na(df[[date_col]]), ]"
"0","    n_excluded <- nrow(df) - nrow(df_to_split)"
"0","    "
"0","    message(sprintf(""  Applied prediction window filter:""))"
"0","    message(sprintf(""    Cutoff date: %s"", cutoff_date))"
"0","    message(sprintf(""    Excluded: %d cases"", n_excluded))"
"0","  }"
"0","  "
"0","  # ä¹±æ•°ã‚·ãƒ¼ãƒ‰ã®è¨­å®š"
"0","  if (!is.null(seed)) {"
"0","    set.seed(seed)"
"0","    message(sprintf(""  Random seed: %d"", seed))"
"0","  }"
"0","  "
"0","  n_total <- nrow(df_to_split)"
"0","  "
"0","  if (n_total == 0) {"
"0","    stop(""No cases available for splitting"")"
"0","  }"
"0","  "
"0","  n_train <- floor(n_total * train_ratio)"
"0","  n_val <- floor(n_total * val_ratio)"
"0","  n_test <- n_total - n_train - n_val"
"0","  "
"0","  # ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹"
"0","  shuffled_idx <- sample(n_total)"
"0","  "
"0","  train_idx <- shuffled_idx[1:n_train]"
"0","  val_idx <- shuffled_idx[(n_train + 1):(n_train + n_val)]"
"0","  test_idx <- shuffled_idx[(n_train + n_val + 1):n_total]"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²"
"0","  result <- list("
"0","    train = df_to_split[train_idx, ],"
"0","    val = df_to_split[val_idx, ],"
"0","    test = df_to_split[test_idx, ],"
"0","    "
"0","    # é™¤å¤–ãƒ‡ãƒ¼ã‚¿ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰"
"0","    excluded = if(n_excluded > 0) df[df[[date_col]] > cutoff_date | is.na(df[[date_col]]), ] else NULL,"
"0","    "
"0","    indices = list("
"0","      train = train_idx,"
"0","      val = val_idx,"
"0","      test = test_idx"
"0","    ),"
"0","    "
"0","    meta = list("
"0","      method = ""random"","
"0","      date_col = date_col,"
"0","      prediction_months = prediction_months,"
"0","      reference_date = reference_date,"
"0","      cutoff_date = cutoff_date,"
"0","      seed = seed,"
"0","      train_ratio = train_ratio,"
"0","      val_ratio = val_ratio,"
"0","      test_ratio = test_ratio,"
"0","      n_total = n_total,"
"0","      n_train = n_train,"
"0","      n_val = n_val,"
"0","      n_test = n_test,"
"0","      n_excluded = n_excluded"
"0","    )"
"0","  )"
"0","  "
"0","  message(sprintf(""  âœ“ Train: n=%d (%.1f%%)"", n_train, 100 * train_ratio))"
"0","  message(sprintf(""  âœ“ Val:   n=%d (%.1f%%)"", n_val, 100 * val_ratio))"
"0","  message(sprintf(""  âœ“ Test:  n=%d (%.1f%%)"", n_test, 100 * test_ratio))"
"0","  "
"0","  class(result) <- c(""data_split"", ""list"")"
"0","  return(result)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 3. å±¤åˆ¥åŒ–åˆ†å‰²ï¼ˆäºˆæ¸¬æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ä»˜ãï¼‰"
"0","# ========================================================================"
"0",""
"0","#' ã‚¢ã‚¦ãƒˆã‚«ãƒ ã§å±¤åˆ¥åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿åˆ†å‰²"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param outcome_col ã‚¢ã‚¦ãƒˆã‚«ãƒ åˆ—å"
"0","#' @param date_col ãƒ•ã‚£ãƒ«ã‚¿ç”¨ã®æ—¥ä»˜åˆ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
"0","#' @param prediction_months äºˆæ¸¬æœŸé–“ï¼ˆæœˆæ•°ï¼‰"
"0","#' @param reference_date åŸºæº–æ—¥"
"0","#' @param train_ratio è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã®å‰²åˆ"
"0","#' @param val_ratio æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã®å‰²åˆ"
"0","#' @param test_ratio ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å‰²åˆ"
"0","#' @param seed ä¹±æ•°ã‚·ãƒ¼ãƒ‰"
"0","#' @return åˆ†å‰²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ"
"0","stratified_split <- function(df,"
"0","                            outcome_col = ""recur_2y"","
"0","                            date_col = NULL,"
"0","                            prediction_months = NULL,"
"0","                            reference_date = Sys.Date(),"
"0","                            train_ratio = 0.60,"
"0","                            val_ratio = 0.20,"
"0","                            test_ratio = 0.20,"
"0","                            seed = NULL) {"
"0","  "
"0","  message(""\nâš–ï¸ Performing stratified split..."")"
"0","  "
"0","  # æ¯”ç‡ã®æ¤œè¨¼"
"0","  if (abs(train_ratio + val_ratio + test_ratio - 1.0) > 0.001) {"
"0","    stop(""Split ratios must sum to 1.0"")"
"0","  }"
"0","  "
"0","  # ã‚¢ã‚¦ãƒˆã‚«ãƒ åˆ—ã®ç¢ºèª"
"0","  if (!outcome_col %in% names(df)) {"
"0","    stop(sprintf(""Outcome column '%s' not found"", outcome_col))"
"0","  }"
"0","  "
"0","  # äºˆæ¸¬æœŸé–“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
"0","  df_to_split <- df"
"0","  n_excluded <- 0"
"0","  cutoff_date <- NULL"
"0","  "
"0","  if (!is.null(date_col) && !is.null(prediction_months)) {"
"0","    cutoff_date <- reference_date - (prediction_months * 30.44)"
"0","    df_to_split <- df[df[[date_col]] <= cutoff_date & !is.na(df[[date_col]]), ]"
"0","    n_excluded <- nrow(df) - nrow(df_to_split)"
"0","    "
"0","    message(sprintf(""  Applied prediction window filter:""))"
"0","    message(sprintf(""    Cutoff date: %s"", cutoff_date))"
"0","    message(sprintf(""    Excluded: %d cases"", n_excluded))"
"0","  }"
"0","  "
"0","  # ä¹±æ•°ã‚·ãƒ¼ãƒ‰è¨­å®š"
"0","  if (!is.null(seed)) {"
"0","    set.seed(seed)"
"0","    message(sprintf(""  Random seed: %d"", seed))"
"0","  }"
"0","  "
"0","  # ã‚¢ã‚¦ãƒˆã‚«ãƒ ã®ãƒ¬ãƒ™ãƒ«åˆ¥ã«åˆ†å‰²"
"0","  outcome <- df_to_split[[outcome_col]]"
"0","  "
"0","  # NAå‡¦ç†"
"0","  if (any(is.na(outcome))) {"
"0","    message(sprintf(""  âš  %d rows with missing outcome will be handled separately"","
"0","                   sum(is.na(outcome))))"
"0","  }"
"0","  "
"0","  # å„å±¤ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹"
"0","  levels_outcome <- unique(outcome[!is.na(outcome)])"
"0","  train_idx <- c()"
"0","  val_idx <- c()"
"0","  test_idx <- c()"
"0","  "
"0","  for (level in levels_outcome) {"
"0","    level_idx <- which(outcome == level)"
"0","    n_level <- length(level_idx)"
"0","    "
"0","    # å„å±¤å†…ã§ã®åˆ†å‰²æ•°"
"0","    n_train_level <- floor(n_level * train_ratio)"
"0","    n_val_level <- floor(n_level * val_ratio)"
"0","    n_test_level <- n_level - n_train_level - n_val_level"
"0","    "
"0","    # ã‚·ãƒ£ãƒƒãƒ•ãƒ«"
"0","    shuffled <- sample(level_idx)"
"0","    "
"0","    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å‰²ã‚Šå½“ã¦"
"0","    train_idx <- c(train_idx, shuffled[1:n_train_level])"
"0","    val_idx <- c(val_idx, shuffled[(n_train_level + 1):(n_train_level + n_val_level)])"
"0","    test_idx <- c(test_idx, shuffled[(n_train_level + n_val_level + 1):n_level])"
"0","  }"
"0","  "
"0","  # NAè¡Œã®å‡¦ç†ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã«å‰²ã‚Šå½“ã¦ï¼‰"
"0","  na_idx <- which(is.na(outcome))"
"0","  if (length(na_idx) > 0) {"
"0","    n_na <- length(na_idx)"
"0","    n_train_na <- floor(n_na * train_ratio)"
"0","    n_val_na <- floor(n_na * val_ratio)"
"0","    "
"0","    shuffled_na <- sample(na_idx)"
"0","    train_idx <- c(train_idx, shuffled_na[1:n_train_na])"
"0","    val_idx <- c(val_idx, shuffled_na[(n_train_na + 1):(n_train_na + n_val_na)])"
"0","    test_idx <- c(test_idx, shuffled_na[(n_train_na + n_val_na + 1):n_na])"
"0","  }"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²"
"0","  result <- list("
"0","    train = df_to_split[train_idx, ],"
"0","    val = df_to_split[val_idx, ],"
"0","    test = df_to_split[test_idx, ],"
"0","    "
"0","    # é™¤å¤–ãƒ‡ãƒ¼ã‚¿ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰"
"0","    excluded = if(n_excluded > 0) df[df[[date_col]] > cutoff_date | is.na(df[[date_col]]), ] else NULL,"
"0","    "
"0","    indices = list("
"0","      train = train_idx,"
"0","      val = val_idx,"
"0","      test = test_idx"
"0","    ),"
"0","    "
"0","    meta = list("
"0","      method = ""stratified"","
"0","      outcome_col = outcome_col,"
"0","      date_col = date_col,"
"0","      prediction_months = prediction_months,"
"0","      reference_date = reference_date,"
"0","      cutoff_date = cutoff_date,"
"0","      seed = seed,"
"0","      train_ratio = train_ratio,"
"0","      val_ratio = val_ratio,"
"0","      test_ratio = test_ratio,"
"0","      n_total = nrow(df_to_split),"
"0","      n_train = length(train_idx),"
"0","      n_val = length(val_idx),"
"0","      n_test = length(test_idx),"
"0","      n_excluded = n_excluded"
"0","    )"
"0","  )"
"0","  "
"0","  # å±¤åˆ¥åŒ–ã®ç¢ºèª"
"0","  check_stratification(result, outcome_col)"
"0","  "
"0","  class(result) <- c(""data_split"", ""list"")"
"0","  return(result)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 4. ã‚¯ãƒ­ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨åˆ†å‰²"
"0","# ========================================================================"
"0",""
"0","#' k-fold ã‚¯ãƒ­ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ†å‰²"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆæ—¢ã«ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ã‚’æƒ³å®šï¼‰"
"0","#' @param k ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰æ•°"
"0","#' @param stratified å±¤åˆ¥åŒ–ã™ã‚‹ã‹"
"0","#' @param outcome_col å±¤åˆ¥åŒ–ç”¨ã®ã‚¢ã‚¦ãƒˆã‚«ãƒ åˆ—"
"0","#' @param seed ä¹±æ•°ã‚·ãƒ¼ãƒ‰"
"0","#' @return CVåˆ†å‰²ã®ãƒªã‚¹ãƒˆ"
"0","create_cv_folds <- function(df,"
"0","                           k = 5,"
"0","                           stratified = TRUE,"
"0","                           outcome_col = ""recur_2y"","
"0","                           seed = NULL) {"
"0","  "
"0","  message(sprintf(""\nğŸ”„ Creating %d-fold cross-validation splits..."", k))"
"0","  "
"0","  # ä¹±æ•°ã‚·ãƒ¼ãƒ‰è¨­å®š"
"0","  if (!is.null(seed)) {"
"0","    set.seed(seed)"
"0","    message(sprintf(""  Random seed: %d"", seed))"
"0","  }"
"0","  "
"0","  n_total <- nrow(df)"
"0","  "
"0","  if (stratified && outcome_col %in% names(df)) {"
"0","    # å±¤åˆ¥åŒ–CV"
"0","    message(""  Using stratified CV"")"
"0","    "
"0","    outcome <- df[[outcome_col]]"
"0","    folds <- vector(""list"", k)"
"0","    "
"0","    # å„ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–"
"0","    for (i in 1:k) {"
"0","      folds[[i]] <- integer()"
"0","    }"
"0","    "
"0","    # å„å±¤ã”ã¨ã«åˆ†å‰²"
"0","    for (level in unique(outcome[!is.na(outcome)])) {"
"0","      level_idx <- which(outcome == level)"
"0","      level_idx <- sample(level_idx)  # ã‚·ãƒ£ãƒƒãƒ•ãƒ«"
"0","      "
"0","      # å„ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã«å‡ç­‰ã«å‰²ã‚Šå½“ã¦"
"0","      fold_assignments <- rep(1:k, length.out = length(level_idx))"
"0","      "
"0","      for (i in 1:k) {"
"0","        folds[[i]] <- c(folds[[i]], level_idx[fold_assignments == i])"
"0","      }"
"0","    }"
"0","    "
"0","    # NAè¡Œã®å‡¦ç†"
"0","    na_idx <- which(is.na(outcome))"
"0","    if (length(na_idx) > 0) {"
"0","      na_idx <- sample(na_idx)"
"0","      fold_assignments <- rep(1:k, length.out = length(na_idx))"
"0","      for (i in 1:k) {"
"0","        folds[[i]] <- c(folds[[i]], na_idx[fold_assignments == i])"
"0","      }"
"0","    }"
"0","    "
"0","  } else {"
"0","    # é€šå¸¸ã®CV"
"0","    message(""  Using standard CV"")"
"0","    "
"0","    # ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«"
"0","    shuffled_idx <- sample(n_total)"
"0","    "
"0","    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã«åˆ†å‰²"
"0","    folds <- split(shuffled_idx, cut(seq_along(shuffled_idx), k, labels = FALSE))"
"0","  }"
"0","  "
"0","  # CVåˆ†å‰²ã®ä½œæˆ"
"0","  cv_splits <- vector(""list"", k)"
"0","  "
"0","  for (i in 1:k) {"
"0","    test_idx <- folds[[i]]"
"0","    train_idx <- unlist(folds[-i])"
"0","    "
"0","    cv_splits[[i]] <- list("
"0","      train = df[train_idx, ],"
"0","      test = df[test_idx, ],"
"0","      fold = i,"
"0","      train_idx = train_idx,"
"0","      test_idx = test_idx"
"0","    )"
"0","  }"
"0","  "
"0","  # çµæœã®æ§‹é€ åŒ–"
"0","  result <- list("
"0","    splits = cv_splits,"
"0","    k = k,"
"0","    n_total = n_total,"
"0","    stratified = stratified,"
"0","    outcome_col = outcome_col,"
"0","    seed = seed,"
"0","    "
"0","    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã‚µã‚¤ã‚ºã®æƒ…å ±"
"0","    fold_sizes = sapply(cv_splits, function(x) length(x$test_idx))"
"0","  )"
"0","  "
"0","  # ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã‚µã‚¤ã‚ºã®è¡¨ç¤º"
"0","  message(sprintf(""  âœ“ Created %d folds"", k))"
"0","  message(sprintf(""  âœ“ Fold sizes: min=%d, max=%d, mean=%.1f"","
"0","                 min(result$fold_sizes),"
"0","                 max(result$fold_sizes),"
"0","                 mean(result$fold_sizes)))"
"0","  "
"0","  if (stratified && outcome_col %in% names(df)) {"
"0","    # å„ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã®ã‚¢ã‚¦ãƒˆã‚«ãƒ åˆ†å¸ƒã‚’ç¢ºèª"
"0","    check_cv_stratification(cv_splits, outcome_col)"
"0","  }"
"0","  "
"0","  class(result) <- c(""cv_folds"", ""list"")"
"0","  return(result)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 5. åˆ†å‰²ã®æ¤œè¨¼ãƒ»è©•ä¾¡é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' å±¤åˆ¥åŒ–ã®ç¢ºèª"
"0","#' @param split_result åˆ†å‰²çµæœ"
"0","#' @param outcome_col ã‚¢ã‚¦ãƒˆã‚«ãƒ åˆ—å"
"0","check_stratification <- function(split_result, outcome_col) {"
"0","  "
"0","  message(""\n  Checking stratification balance:"")"
"0","  "
"0","  # å„ã‚»ãƒƒãƒˆã®ã‚¢ã‚¦ãƒˆã‚«ãƒ åˆ†å¸ƒ"
"0","  train_dist <- table(split_result$train[[outcome_col]], useNA = ""ifany"")"
"0","  val_dist <- table(split_result$val[[outcome_col]], useNA = ""ifany"")"
"0","  test_dist <- table(split_result$test[[outcome_col]], useNA = ""ifany"")"
"0","  "
"0","  # æ¯”ç‡ã®è¨ˆç®—"
"0","  train_prop <- prop.table(train_dist)"
"0","  val_prop <- prop.table(val_dist)"
"0","  test_prop <- prop.table(test_dist)"
"0","  "
"0","  # è¡¨ç¤ºç”¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ä½œæˆ"
"0","  levels_all <- unique(c(names(train_prop), names(val_prop), names(test_prop)))"
"0","  "
"0","  for (level in levels_all) {"
"0","    train_p <- ifelse(level %in% names(train_prop), "
"0","                      sprintf(""%.1f%%"", 100 * train_prop[level]), ""0.0%"")"
"0","    val_p <- ifelse(level %in% names(val_prop), "
"0","                    sprintf(""%.1f%%"", 100 * val_prop[level]), ""0.0%"")"
"0","    test_p <- ifelse(level %in% names(test_prop), "
"0","                     sprintf(""%.1f%%"", 100 * test_prop[level]), ""0.0%"")"
"0","    "
"0","    message(sprintf(""    %s: Train=%s, Val=%s, Test=%s"","
"0","                   ifelse(is.na(level), ""NA"", level),"
"0","                   train_p, val_p, test_p))"
"0","  }"
"0","}"
"0",""
"0","#' CVå±¤åˆ¥åŒ–ã®ç¢ºèª"
"0","#' @param cv_splits CVåˆ†å‰²ãƒªã‚¹ãƒˆ"
"0","#' @param outcome_col ã‚¢ã‚¦ãƒˆã‚«ãƒ åˆ—å"
"0","check_cv_stratification <- function(cv_splits, outcome_col) {"
"0","  "
"0","  message(""  CV stratification check:"")"
"0","  "
"0","  # å„ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆç‡"
"0","  event_rates <- sapply(cv_splits, function(fold) {"
"0","    outcome <- fold$test[[outcome_col]]"
"0","    if (is.logical(outcome) || is.numeric(outcome)) {"
"0","      mean(outcome == TRUE | outcome == 1, na.rm = TRUE)"
"0","    } else {"
"0","      NA"
"0","    }"
"0","  })"
"0","  "
"0","  if (any(!is.na(event_rates))) {"
"0","    message(sprintf(""    Event rates: mean=%.1f%%, sd=%.1f%%"","
"0","                   100 * mean(event_rates, na.rm = TRUE),"
"0","                   100 * sd(event_rates, na.rm = TRUE)))"
"0","  }"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 6. åˆ†å‰²çµæœã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿"
"0","# ========================================================================"
"0",""
"0","#' åˆ†å‰²çµæœã‚’ä¿å­˜"
"0","#' @param split_result åˆ†å‰²çµæœ"
"0","#' @param file_path ä¿å­˜å…ˆãƒ‘ã‚¹"
"0","save_split <- function(split_result, file_path) {"
"0","  "
"0","  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ"
"0","  dir_path <- dirname(file_path)"
"0","  if (!dir.exists(dir_path)) {"
"0","    dir.create(dir_path, recursive = TRUE, showWarnings = FALSE)"
"0","  }"
"0","  "
"0","  # RDSå½¢å¼ã§ä¿å­˜"
"0","  saveRDS(split_result, file = file_path)"
"0","  message(sprintf(""  âœ“ Split saved to: %s"", file_path))"
"0","}"
"0",""
"0","#' åˆ†å‰²çµæœã‚’èª­ã¿è¾¼ã¿"
"0","#' @param file_path ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹"
"0","#' @return åˆ†å‰²çµæœ"
"0","load_split <- function(file_path) {"
"0","  "
"0","  if (!file.exists(file_path)) {"
"0","    stop(sprintf(""Split file not found: %s"", file_path))"
"0","  }"
"0","  "
"0","  split_result <- readRDS(file_path)"
"0","  message(sprintf(""  âœ“ Split loaded from: %s"", file_path))"
"0","  "
"0","  return(split_result)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 7. çµ±åˆåˆ†å‰²é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' ãƒ‡ãƒ¼ã‚¿åˆ†å‰²ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @param method åˆ†å‰²æ–¹æ³•ï¼ˆ""temporal"", ""random"", ""stratified""ï¼‰"
"0","#' @param prediction_months äºˆæ¸¬æœŸé–“ï¼ˆæœˆæ•°ï¼‰"
"0","#' @param reference_date åŸºæº–æ—¥"
"0","#' @param create_cv CVãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã‚‚ä½œæˆã™ã‚‹ã‹"
"0","#' @return åˆ†å‰²çµæœ"
"0","split_data_pipeline <- function(df,"
"0","                               config = NULL,"
"0","                               method = ""temporal"","
"0","                               prediction_months = 24,"
"0","                               reference_date = Sys.Date(),"
"0","                               create_cv = TRUE) {"
"0","  "
"0","  message(""\n========================================"")"
"0","  message(""Starting Data Splitting Pipeline"")"
"0","  message(""========================================"")"
"0","  "
"0","  # è¨­å®šã®å–å¾—"
"0","  if (!is.null(config)) {"
"0","    train_ratio <- config$model$train_ratio"
"0","    val_ratio <- config$model$val_ratio"
"0","    test_ratio <- config$model$test_ratio"
"0","    seed <- config$model$seed"
"0","    cv_folds <- config$model$cv_folds"
"0","    "
"0","    # äºˆæ¸¬æ™‚é–“ã®å–å¾—ï¼ˆè¨­å®šã«ã‚ã‚Œã°ï¼‰"
"0","    if (!is.null(config$model$prediction_time)) {"
"0","      prediction_months <- config$model$prediction_time"
"0","    }"
"0","  } else {"
"0","    train_ratio <- 0.60"
"0","    val_ratio <- 0.20"
"0","    test_ratio <- 0.20"
"0","    seed <- 20251102"
"0","    cv_folds <- 5"
"0","  }"
"0","  "
"0","  # ãƒ¡ã‚¤ãƒ³åˆ†å‰²"
"0","  if (method == ""temporal"") {"
"0","    split_result <- temporal_split("
"0","      df,"
"0","      date_col = ""op_date"","
"0","      prediction_months = prediction_months,"
"0","      reference_date = reference_date,"
"0","      train_ratio = train_ratio,"
"0","      val_ratio = val_ratio,"
"0","      test_ratio = test_ratio"
"0","    )"
"0","    "
"0","  } else if (method == ""random"") {"
"0","    split_result <- random_split("
"0","      df,"
"0","      date_col = ""op_date"",  # ãƒ•ã‚£ãƒ«ã‚¿ç”¨"
"0","      prediction_months = prediction_months,"
"0","      reference_date = reference_date,"
"0","      train_ratio = train_ratio,"
"0","      val_ratio = val_ratio,"
"0","      test_ratio = test_ratio,"
"0","      seed = seed"
"0","    )"
"0","    "
"0","  } else if (method == ""stratified"") {"
"0","    split_result <- stratified_split("
"0","      df,"
"0","      outcome_col = ""recur_2y"","
"0","      date_col = ""op_date"",  # ãƒ•ã‚£ãƒ«ã‚¿ç”¨"
"0","      prediction_months = prediction_months,"
"0","      reference_date = reference_date,"
"0","      train_ratio = train_ratio,"
"0","      val_ratio = val_ratio,"
"0","      test_ratio = test_ratio,"
"0","      seed = seed"
"0","    )"
"0","    "
"0","  } else {"
"0","    stop(sprintf(""Unknown split method: %s"", method))"
"0","  }"
"0","  "
"0","  # CVåˆ†å‰²ï¼ˆè¨“ç·´ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ï¼‰"
"0","  if (create_cv && nrow(split_result$train) > 0) {"
"0","    message(""\nğŸ“Š Creating CV folds for training data..."")"
"0","    "
"0","    cv_result <- create_cv_folds("
"0","      split_result$train,"
"0","      k = cv_folds,"
"0","      stratified = TRUE,"
"0","      outcome_col = ""recur_2y"","
"0","      seed = seed"
"0","    )"
"0","    "
"0","    split_result$cv <- cv_result"
"0","  }"
"0","  "
"0","  # ã‚µãƒãƒªãƒ¼è¡¨ç¤º"
"0","  message(""\nğŸ“ˆ Split Summary:"")"
"0","  message(sprintf(""  Method: %s"", method))"
"0","  message(sprintf(""  Prediction window: %d months"", prediction_months))"
"0","  message(sprintf(""  Reference date: %s"", reference_date))"
"0","  message(sprintf(""  Total samples: %d"", nrow(df)))"
"0","  "
"0","  if (!is.null(split_result$meta$n_excluded) && split_result$meta$n_excluded > 0) {"
"0","    message(sprintf(""  Excluded (too recent): %d"", split_result$meta$n_excluded))"
"0","  }"
"0","  "
"0","  message(sprintf(""  Training: %d (%.1f%%)"", "
"0","                 nrow(split_result$train), "
"0","                 100 * nrow(split_result$train) / "
"0","                   (nrow(df) - ifelse(is.null(split_result$meta$n_excluded), 0, split_result$meta$n_excluded))))"
"0","  message(sprintf(""  Validation: %d (%.1f%%)"", "
"0","                 nrow(split_result$val),"
"0","                 100 * nrow(split_result$val) / "
"0","                   (nrow(df) - ifelse(is.null(split_result$meta$n_excluded), 0, split_result$meta$n_excluded))))"
"0","  message(sprintf(""  Test: %d (%.1f%%)"", "
"0","                 nrow(split_result$test),"
"0","                 100 * nrow(split_result$test) / "
"0","                   (nrow(df) - ifelse(is.null(split_result$meta$n_excluded), 0, split_result$meta$n_excluded))))"
"0","  "
"0","  if (create_cv) {"
"0","    message(sprintf(""  CV folds: %d"", cv_folds))"
"0","  }"
"0","  "
"0","  message(""\nâœ… Data splitting completed!"")"
"0","  message(""========================================\n"")"
"0","  "
"0","  return(split_result)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 8. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' åˆ†å‰²ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å¯è¦–åŒ–"
"0","#' @param split_result åˆ†å‰²çµæœ"
"0","#' @param variables ç¢ºèªã™ã‚‹å¤‰æ•°åã®ãƒ™ã‚¯ãƒˆãƒ«"
"0","plot_split_balance <- function(split_result, "
"0","                              variables = c(""recur_2y"", ""stage_diag"", ""age"")) {"
"0","  "
"0","  if (!requireNamespace(""ggplot2"", quietly = TRUE)) {"
"0","    message(""ggplot2 not available for plotting"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # å„ã‚»ãƒƒãƒˆã«ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ "
"0","  train_df <- split_result$train"
"0","  train_df$split <- ""Train"""
"0","  "
"0","  val_df <- split_result$val"
"0","  val_df$split <- ""Val"""
"0","  "
"0","  test_df <- split_result$test"
"0","  test_df$split <- ""Test"""
"0","  "
"0","  # çµåˆ"
"0","  combined <- rbind(train_df, val_df, test_df)"
"0","  combined$split <- factor(combined$split, levels = c(""Train"", ""Val"", ""Test""))"
"0","  "
"0","  # ãƒ—ãƒ­ãƒƒãƒˆä½œæˆ"
"0","  plots <- list()"
"0","  "
"0","  for (var in variables) {"
"0","    if (var %in% names(combined)) {"
"0","      if (is.numeric(combined[[var]])) {"
"0","        # æ•°å€¤å¤‰æ•°ï¼šãƒœãƒƒã‚¯ã‚¹ãƒ—ãƒ­ãƒƒãƒˆ"
"0","        p <- ggplot(combined, aes_string(x = ""split"", y = var, fill = ""split"")) +"
"0","          geom_boxplot(alpha = 0.7) +"
"0","          theme_minimal() +"
"0","          labs(title = sprintf(""Distribution of %s"", var)) +"
"0","          theme(legend.position = ""none"")"
"0","        "
"0","      } else {"
"0","        # ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ï¼šæ£’ã‚°ãƒ©ãƒ•"
"0","        p <- ggplot(combined, aes_string(x = ""split"", fill = var)) +"
"0","          geom_bar(position = ""fill"") +"
"0","          theme_minimal() +"
"0","          labs(title = sprintf(""Distribution of %s"", var), y = ""Proportion"") +"
"0","          scale_y_continuous(labels = scales::percent)"
"0","      }"
"0","      "
"0","      plots[[var]] <- p"
"0","    }"
"0","  }"
"0","  "
"0","  return(plots)"
"0","}"
"0",""
"0","#' åˆ†å‰²ã‚µãƒãƒªãƒ¼ã®è©³ç´°è¡¨ç¤º"
"0","#' @param split_result åˆ†å‰²çµæœ"
"0","print_split_summary <- function(split_result) {"
"0","  "
"0","  message(""\n========================================"")"
"0","  message(""Detailed Split Summary"")"
"0","  message(""========================================"")"
"0","  "
"0","  # ãƒ¡ã‚¿æƒ…å ±"
"0","  meta <- split_result$meta"
"0","  message(sprintf(""\nMethod: %s"", meta$method))"
"0","  "
"0","  if (!is.null(meta$prediction_months)) {"
"0","    message(sprintf(""Prediction window: %d months"", meta$prediction_months))"
"0","  }"
"0","  "
"0","  if (!is.null(meta$cutoff_date)) {"
"0","    message(sprintf(""Cutoff date: %s"", meta$cutoff_date))"
"0","  }"
"0","  "
"0","  if (!is.null(meta$reference_date)) {"
"0","    message(sprintf(""Reference date: %s"", meta$reference_date))"
"0","  }"
"0","  "
"0","  # å„ã‚»ãƒƒãƒˆã®è©³ç´°"
"0","  sets <- c(""train"", ""val"", ""test"")"
"0","  "
"0","  for (set_name in sets) {"
"0","    set_data <- split_result[[set_name]]"
"0","    message(sprintf(""\n%s Set:"", stringr::str_to_title(set_name)))"
"0","    message(sprintf(""  N = %d"", nrow(set_data)))"
"0","    "
"0","    # æ—¥ä»˜ç¯„å›²ï¼ˆop_dateãŒã‚ã‚‹å ´åˆï¼‰"
"0","    if (""op_date"" %in% names(set_data)) {"
"0","      date_range <- range(set_data$op_date, na.rm = TRUE)"
"0","      message(sprintf(""  Date range: %s to %s"", date_range[1], date_range[2]))"
"0","    }"
"0","    "
"0","    # ã‚¢ã‚¦ãƒˆã‚«ãƒ åˆ†å¸ƒï¼ˆrecur_2yãŒã‚ã‚‹å ´åˆï¼‰"
"0","    if (""recur_2y"" %in% names(set_data)) {"
"0","      outcome_dist <- table(set_data$recur_2y, useNA = ""ifany"")"
"0","      event_rate <- mean(set_data$recur_2y == TRUE, na.rm = TRUE)"
"0","      message(sprintf(""  Event rate: %.1f%%"", 100 * event_rate))"
"0","    }"
"0","  }"
"0","  "
"0","  # é™¤å¤–ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ã‚‹å ´åˆï¼‰"
"0","  if (!is.null(split_result$excluded) && nrow(split_result$excluded) > 0) {"
"0","    message(sprintf(""\nExcluded Cases: %d"", nrow(split_result$excluded)))"
"0","    if (""op_date"" %in% names(split_result$excluded)) {"
"0","      exc_dates <- range(split_result$excluded$op_date, na.rm = TRUE)"
"0","      message(sprintf(""  Date range: %s to %s"", exc_dates[1], exc_dates[2]))"
"0","    }"
"0","  }"
"0","  "
"0","  message(""\n========================================\n"")"
"0","}"
