"0","################################################################################"
"0","# 06_model_evaluator.R - ãƒ¢ãƒ‡ãƒ«è©•ä¾¡å‡¦ç†"
"0","# "
"0","# Description: "
"0","#   ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ã®åŒ…æ‹¬çš„è©•ä¾¡"
"0","#   C-index, æ™‚é–“ä¾å­˜AUC, ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³, DCA, Brier Score"
"0","#   ç«¶åˆãƒªã‚¹ã‚¯è©•ä¾¡"
"0","#"
"0","# Author: Takuto Yoshida"
"0","# Date: 2024-11-07"
"0","################################################################################"
"0",""
"0","# ========================================================================"
"0","# 1. äºˆæ¸¬å€¤ã®è¨ˆç®—"
"0","# ========================================================================"
"0",""
"0","#' ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰äºˆæ¸¬å€¤ã‚’å–å¾—"
"0","#' @param model ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param newdata äºˆæ¸¬ç”¨ãƒ‡ãƒ¼ã‚¿"
"0","#' @param time_point äºˆæ¸¬æ™‚ç‚¹ï¼ˆæœˆï¼‰"
"0","#' @return äºˆæ¸¬ç¢ºç‡"
"0","get_predictions <- function(model, newdata, time_point = 24) {"
"0","  "
"0","  # ãƒ¢ãƒ‡ãƒ«ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š"
"0","  model_class <- class(model)[1]"
"0","  "
"0","  if (model_class == ""coxph"") {"
"0","    # é€šå¸¸ã®Coxãƒ¢ãƒ‡ãƒ«"
"0","    "
"0","    # ç·šå½¢äºˆæ¸¬å­"
"0","    lp <- predict(model, newdata = newdata, type = ""lp"")"
"0","    "
"0","    # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç”Ÿå­˜é–¢æ•°"
"0","    baseline <- survival::survfit(model, newdata = newdata[1, ])"
"0","    "
"0","    # æŒ‡å®šæ™‚ç‚¹ã«æœ€ã‚‚è¿‘ã„æ™‚é–“ã‚’è¦‹ã¤ã‘ã‚‹"
"0","    time_idx <- which.min(abs(baseline$time - time_point))"
"0","    baseline_surv <- baseline$surv[time_idx]"
"0","    "
"0","    # äºˆæ¸¬ç¢ºç‡ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç¢ºç‡ï¼‰"
"0","    pred_prob <- 1 - baseline_surv^exp(lp)"
"0","    "
"0","  } else if (model_class == ""lasso_cox"") {"
"0","    # LASSOãƒ¢ãƒ‡ãƒ«"
"0","    "
"0","    # ãƒ‡ãƒ¼ã‚¿è¡Œåˆ—ã®æº–å‚™"
"0","    X_new <- model.matrix(~ . - 1, "
"0","                         data = newdata[, colnames(model$X), drop = FALSE])"
"0","    "
"0","    # ç·šå½¢äºˆæ¸¬å­"
"0","    lp <- predict(model$glmnet_model, newx = X_new, s = model$lambda_min, type = ""link"")"
"0","    "
"0","    # ç°¡æ˜“çš„ãªç¢ºç‡å¤‰æ›ï¼ˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒã‚¶ãƒ¼ãƒ‰ã‚’ä»®å®šï¼‰"
"0","    pred_prob <- 1 - exp(-exp(lp) * time_point / 12)  # å˜ç´”åŒ–"
"0","    "
"0","  } else if (model_class == ""univariate_cox"") {"
"0","    # å˜å¤‰é‡ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«"
"0","    "
"0","    if (!is.null(model$model)) {"
"0","      lp <- predict(model$model, newdata = newdata, type = ""lp"")"
"0","      "
"0","      # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ç”Ÿå­˜é–¢æ•°"
"0","      baseline <- survival::survfit(model$model, newdata = newdata[1, ])"
"0","      time_idx <- which.min(abs(baseline$time - time_point))"
"0","      baseline_surv <- baseline$surv[time_idx]"
"0","      "
"0","      pred_prob <- 1 - baseline_surv^exp(lp)"
"0","    } else {"
"0","      pred_prob <- rep(NA, nrow(newdata))"
"0","    }"
"0","    "
"0","  } else if (model_class == ""rfe_cox"") {"
"0","    # RFEãƒ¢ãƒ‡ãƒ«"
"0","    "
"0","    if (!is.null(model$model)) {"
"0","      lp <- predict(model$model, newdata = newdata, type = ""lp"")"
"0","      "
"0","      baseline <- survival::survfit(model$model, newdata = newdata[1, ])"
"0","      time_idx <- which.min(abs(baseline$time - time_point))"
"0","      baseline_surv <- baseline$surv[time_idx]"
"0","      "
"0","      pred_prob <- 1 - baseline_surv^exp(lp)"
"0","    } else {"
"0","      pred_prob <- rep(NA, nrow(newdata))"
"0","    }"
"0","    "
"0","  } else {"
"0","    warning(sprintf(""Unknown model class: %s"", model_class))"
"0","    pred_prob <- rep(NA, nrow(newdata))"
"0","  }"
"0","  "
"0","  return(as.numeric(pred_prob))"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 2. C-indexè¨ˆç®—"
"0","# ========================================================================"
"0",""
"0","#' C-indexã‚’è¨ˆç®—"
"0","#' @param model ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param data è©•ä¾¡ç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆsurv_objåˆ—ã‚’å«ã‚€ï¼‰"
"0","#' @param newdata äºˆæ¸¬ç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆNULLæ™‚ã¯dataã‚’ä½¿ç”¨ï¼‰"
"0","#' @return C-indexå€¤ã¨ä¿¡é ¼åŒºé–“"
"0","calculate_c_index <- function(model, data, newdata = NULL) {"
"0","  "
"0","  if (is.null(newdata)) {"
"0","    newdata <- data"
"0","  }"
"0","  "
"0","  # äºˆæ¸¬å€¤ã®å–å¾—"
"0","  if (inherits(model, ""coxph"")) {"
"0","    # Coxãƒ¢ãƒ‡ãƒ«ã®å ´åˆ"
"0","    pred <- predict(model, newdata = newdata, type = ""risk"")"
"0","    "
"0","    # concordanceé–¢æ•°ã‚’ä½¿ç”¨"
"0","    c_result <- survival::concordance("
"0","      data$surv_obj ~ pred,"
"0","      reverse = TRUE"
"0","    )"
"0","    "
"0","    c_index <- c_result$concordance"
"0","    se <- sqrt(c_result$var)"
"0","    "
"0","  } else if (inherits(model, ""lasso_cox"")) {"
"0","    # LASSOãƒ¢ãƒ‡ãƒ«"
"0","    X_new <- model.matrix(~ . - 1, "
"0","                         data = newdata[, colnames(model$X), drop = FALSE])"
"0","    pred <- predict(model$glmnet_model, newx = X_new, "
"0","                   s = model$lambda_min, type = ""link"")[, 1]"
"0","    "
"0","    c_result <- survival::concordance("
"0","      data$surv_obj ~ pred,"
"0","      reverse = TRUE"
"0","    )"
"0","    "
"0","    c_index <- c_result$concordance"
"0","    se <- sqrt(c_result$var)"
"0","    "
"0","  } else {"
"0","    # ãã®ä»–ã®ãƒ¢ãƒ‡ãƒ«"
"0","    pred <- get_predictions(model, newdata)"
"0","    "
"0","    if (all(is.na(pred))) {"
"0","      return(list(c_index = NA, lower = NA, upper = NA, se = NA))"
"0","    }"
"0","    "
"0","    c_result <- survival::concordance("
"0","      data$surv_obj ~ pred,"
"0","      reverse = FALSE"
"0","    )"
"0","    "
"0","    c_index <- c_result$concordance"
"0","    se <- sqrt(c_result$var)"
"0","  }"
"0","  "
"0","  # 95%ä¿¡é ¼åŒºé–“"
"0","  lower <- c_index - 1.96 * se"
"0","  upper <- c_index + 1.96 * se"
"0","  "
"0","  return(list("
"0","    c_index = c_index,"
"0","    lower = max(0, lower),"
"0","    upper = min(1, upper),"
"0","    se = se"
"0","  ))"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 3. æ™‚é–“ä¾å­˜AUC"
"0","# ========================================================================"
"0",""
"0","#' æ™‚é–“ä¾å­˜AUCã‚’è¨ˆç®—"
"0","#' @param model ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param data è©•ä¾¡ç”¨ãƒ‡ãƒ¼ã‚¿"
"0","#' @param times è©•ä¾¡æ™‚ç‚¹ã®ãƒ™ã‚¯ãƒˆãƒ«"
"0","#' @return æ™‚é–“ä¾å­˜AUC"
"0","calculate_time_dependent_auc <- function(model, data, times = c(6, 12, 18, 24)) {"
"0","  "
"0","  if (!requireNamespace(""timeROC"", quietly = TRUE)) {"
"0","    warning(""timeROC package not available"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # äºˆæ¸¬å€¤ã®å–å¾—ï¼ˆãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ï¼‰"
"0","  if (inherits(model, ""coxph"")) {"
"0","    marker <- predict(model, newdata = data, type = ""lp"")"
"0","  } else if (inherits(model, ""lasso_cox"")) {"
"0","    X_new <- model.matrix(~ . - 1, "
"0","                         data = data[, colnames(model$X), drop = FALSE])"
"0","    marker <- predict(model$glmnet_model, newx = X_new, "
"0","                     s = model$lambda_min, type = ""link"")[, 1]"
"0","  } else {"
"0","    # äºˆæ¸¬ç¢ºç‡ã‚’ä½¿ç”¨"
"0","    marker <- get_predictions(model, data, time_point = max(times))"
"0","    if (all(is.na(marker))) {"
"0","      return(NULL)"
"0","    }"
"0","  }"
"0","  "
"0","  # timeROCã®å®Ÿè¡Œ"
"0","  roc_result <- timeROC::timeROC("
"0","    T = data$time2y,"
"0","    delta = as.numeric(data$recur_2y),"
"0","    marker = marker,"
"0","    cause = 1,"
"0","    weighting = ""marginal"","
"0","    times = times,"
"0","    iid = TRUE"
"0","  )"
"0","  "
"0","  # çµæœã®æ•´ç†"
"0","  auc_df <- data.frame("
"0","    time = times,"
"0","    AUC = roc_result$AUC,"
"0","    AUC_lower = roc_result$AUC - 1.96 * roc_result$inference$vect_sd_1,"
"0","    AUC_upper = roc_result$AUC + 1.96 * roc_result$inference$vect_sd_1"
"0","  )"
"0","  "
"0","  auc_df$AUC_lower <- pmax(0, auc_df$AUC_lower)"
"0","  auc_df$AUC_upper <- pmin(1, auc_df$AUC_upper)"
"0","  "
"0","  return(list("
"0","    auc_table = auc_df,"
"0","    roc_object = roc_result"
"0","  ))"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 4. ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡"
"0","# ========================================================================"
"0",""
"0","#' ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è©•ä¾¡"
"0","#' @param model ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param data è©•ä¾¡ç”¨ãƒ‡ãƒ¼ã‚¿"
"0","#' @param n_groups ãƒ‡ã‚·ãƒ«åˆ†å‰²æ•°"
"0","#' @param time_point è©•ä¾¡æ™‚ç‚¹"
"0","#' @return ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ±è¨ˆé‡"
"0","assess_calibration <- function(model, data, n_groups = 10, time_point = 24) {"
"0","  "
"0","  # äºˆæ¸¬ç¢ºç‡"
"0","  pred_prob <- get_predictions(model, data, time_point)"
"0","  "
"0","  if (all(is.na(pred_prob))) {"
"0","    return(list("
"0","      slope = NA,"
"0","      intercept = NA,"
"0","      groups = NULL"
"0","    ))"
"0","  }"
"0","  "
"0","  # ãƒ‡ã‚·ãƒ«åˆ†å‰²"
"0","  pred_groups <- cut(pred_prob, "
"0","                    breaks = quantile(pred_prob, probs = seq(0, 1, 1/n_groups), na.rm = TRUE),"
"0","                    include.lowest = TRUE,"
"0","                    labels = FALSE)"
"0","  "
"0","  # å„ã‚°ãƒ«ãƒ¼ãƒ—ã®è¦³å¯Ÿãƒ»æœŸå¾…ã‚¤ãƒ™ãƒ³ãƒˆç‡"
"0","  calibration_data <- data.frame()"
"0","  "
"0","  for (g in 1:n_groups) {"
"0","    idx <- which(pred_groups == g)"
"0","    if (length(idx) > 0) {"
"0","      # Kaplan-Meieræ¨å®š"
"0","      km_fit <- survival::survfit("
"0","        survival::Surv(time2y, recur_2y) ~ 1, "
"0","        data = data[idx, ]"
"0","      )"
"0","      "
"0","      # æŒ‡å®šæ™‚ç‚¹ã§ã®è¦³å¯Ÿã‚¤ãƒ™ãƒ³ãƒˆç‡"
"0","      time_idx <- which.min(abs(km_fit$time - time_point))"
"0","      if (length(time_idx) > 0) {"
"0","        observed <- 1 - km_fit$surv[time_idx]"
"0","      } else {"
"0","        observed <- NA"
"0","      }"
"0","      "
"0","      # æœŸå¾…ã‚¤ãƒ™ãƒ³ãƒˆç‡ï¼ˆäºˆæ¸¬å€¤ã®å¹³å‡ï¼‰"
"0","      expected <- mean(pred_prob[idx], na.rm = TRUE)"
"0","      "
"0","      calibration_data <- rbind(calibration_data, data.frame("
"0","        group = g,"
"0","        n = length(idx),"
"0","        expected = expected,"
"0","        observed = observed,"
"0","        pred_mean = expected,"
"0","        pred_min = min(pred_prob[idx], na.rm = TRUE),"
"0","        pred_max = max(pred_prob[idx], na.rm = TRUE)"
"0","      ))"
"0","    }"
"0","  }"
"0","  "
"0","  # Calibration slope & intercept"
"0","  if (nrow(calibration_data) > 2 && !any(is.na(calibration_data$observed))) {"
"0","    cal_model <- lm(observed ~ expected, data = calibration_data, weights = n)"
"0","    slope <- coef(cal_model)[""expected""]"
"0","    intercept <- coef(cal_model)[""(Intercept)""]"
"0","  } else {"
"0","    slope <- NA"
"0","    intercept <- NA"
"0","  }"
"0","  "
"0","  return(list("
"0","    slope = slope,"
"0","    intercept = intercept,"
"0","    groups = calibration_data"
"0","  ))"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 5. Decision Curve Analysis (DCA)"
"0","# ========================================================================"
"0",""
"0","#' Decision Curve Analysis"
"0","#' @param model ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param data è©•ä¾¡ç”¨ãƒ‡ãƒ¼ã‚¿"
"0","#' @param thresholds é–¾å€¤ã®ç¯„å›²"
"0","#' @param time_point è©•ä¾¡æ™‚ç‚¹"
"0","#' @return DCAçµæœ"
"0","perform_dca <- function(model, data, "
"0","                       thresholds = seq(0.01, 0.50, by = 0.01),"
"0","                       time_point = 24) {"
"0","  "
"0","  # äºˆæ¸¬ç¢ºç‡"
"0","  pred_prob <- get_predictions(model, data, time_point)"
"0","  "
"0","  if (all(is.na(pred_prob))) {"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # å®Ÿéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ™‚é–“ã‚’è€ƒæ…®ï¼‰"
"0","  event_occurred <- (data$recur_2y == TRUE) & (data$time2y <= time_point)"
"0","  "
"0","  # DCAè¨ˆç®—"
"0","  dca_results <- data.frame("
"0","    threshold = thresholds,"
"0","    net_benefit_model = numeric(length(thresholds)),"
"0","    net_benefit_all = numeric(length(thresholds)),"
"0","    net_benefit_none = 0"
"0","  )"
"0","  "
"0","  n_total <- nrow(data)"
"0","  "
"0","  for (i in seq_along(thresholds)) {"
"0","    thresh <- thresholds[i]"
"0","    "
"0","    # ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹ä»‹å…¥"
"0","    treat_model <- pred_prob >= thresh"
"0","    tp_model <- sum(treat_model & event_occurred, na.rm = TRUE)"
"0","    fp_model <- sum(treat_model & !event_occurred, na.rm = TRUE)"
"0","    "
"0","    # Net benefitè¨ˆç®—"
"0","    net_benefit_model <- (tp_model / n_total) - "
"0","                        (fp_model / n_total) * (thresh / (1 - thresh))"
"0","    "
"0","    # å…¨å“¡æ²»ç™‚"
"0","    tp_all <- sum(event_occurred, na.rm = TRUE)"
"0","    fp_all <- sum(!event_occurred, na.rm = TRUE)"
"0","    net_benefit_all <- (tp_all / n_total) - "
"0","                      (fp_all / n_total) * (thresh / (1 - thresh))"
"0","    "
"0","    dca_results$net_benefit_model[i] <- net_benefit_model"
"0","    dca_results$net_benefit_all[i] <- net_benefit_all"
"0","  }"
"0","  "
"0","  return(dca_results)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 6. Brier Score"
"0","# ========================================================================"
"0",""
"0","#' Brier Scoreã‚’è¨ˆç®—"
"0","#' @param model ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param data è©•ä¾¡ç”¨ãƒ‡ãƒ¼ã‚¿"
"0","#' @param time_point è©•ä¾¡æ™‚ç‚¹"
"0","#' @return Brier Score"
"0","calculate_brier_score <- function(model, data, time_point = 24) {"
"0","  "
"0","  # äºˆæ¸¬ç¢ºç‡"
"0","  pred_prob <- get_predictions(model, data, time_point)"
"0","  "
"0","  if (all(is.na(pred_prob))) {"
"0","    return(list(brier_score = NA, scaled_brier = NA))"
"0","  }"
"0","  "
"0","  # å®Ÿéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ™‚é–“ã‚’è€ƒæ…®ï¼‰"
"0","  event_occurred <- (data$recur_2y == TRUE) & (data$time2y <= time_point)"
"0","  "
"0","  # Brier Score"
"0","  brier_score <- mean((pred_prob - as.numeric(event_occurred))^2, na.rm = TRUE)"
"0","  "
"0","  # Scaled Brier Scoreï¼ˆå‚ç…§ï¼šã‚¤ãƒ™ãƒ³ãƒˆç‡ï¼‰"
"0","  event_rate <- mean(event_occurred, na.rm = TRUE)"
"0","  max_brier <- event_rate * (1 - event_rate)"
"0","  scaled_brier <- 1 - (brier_score / max_brier)"
"0","  "
"0","  return(list("
"0","    brier_score = brier_score,"
"0","    scaled_brier = scaled_brier,"
"0","    event_rate = event_rate"
"0","  ))"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 7. çµ±åˆè©•ä¾¡é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' ãƒ¢ãƒ‡ãƒ«ã®åŒ…æ‹¬çš„è©•ä¾¡"
"0","#' @param model ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param train_data è¨“ç·´ãƒ‡ãƒ¼ã‚¿"
"0","#' @param val_data æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿"
"0","#' @param test_data ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿"
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @return è©•ä¾¡çµæœã®ãƒªã‚¹ãƒˆ"
"0","evaluate_model_comprehensive <- function(model, "
"0","                                        train_data, "
"0","                                        val_data = NULL, "
"0","                                        test_data = NULL,"
"0","                                        config = NULL) {"
"0","  "
"0","  # è©•ä¾¡æ™‚ç‚¹ã®å–å¾—"
"0","  if (!is.null(config) && !is.null(config$evaluation$time_points)) {"
"0","    time_points <- config$evaluation$time_points"
"0","  } else {"
"0","    time_points <- c(6, 12, 18, 24)"
"0","  }"
"0","  "
"0","  primary_time <- ifelse(!is.null(config$evaluation$primary_time_point),"
"0","                        config$evaluation$primary_time_point, 24)"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿æº–å‚™"
"0","  datasets <- list(train = train_data)"
"0","  if (!is.null(val_data)) datasets$val <- val_data"
"0","  if (!is.null(test_data)) datasets$test <- test_data"
"0","  "
"0","  # çµæœæ ¼ç´ç”¨"
"0","  results <- list()"
"0","  "
"0","  for (set_name in names(datasets)) {"
"0","    message(sprintf(""\n  Evaluating on %s set..."", set_name))"
"0","    "
"0","    data <- datasets[[set_name]]"
"0","    "
"0","    # surv_objãŒãªã„å ´åˆã¯ä½œæˆ"
"0","    if (!""surv_obj"" %in% names(data)) {"
"0","      data$surv_obj <- survival::Surv("
"0","        time = data$time2y,"
"0","        event = as.numeric(data$recur_2y)"
"0","      )"
"0","    }"
"0","    "
"0","    # C-index"
"0","    c_result <- calculate_c_index(model, data)"
"0","    message(sprintf(""    C-index: %.3f (95%% CI: %.3f-%.3f)"", "
"0","                   c_result$c_index, c_result$lower, c_result$upper))"
"0","    "
"0","    # æ™‚é–“ä¾å­˜AUC"
"0","    auc_result <- calculate_time_dependent_auc(model, data, time_points)"
"0","    if (!is.null(auc_result)) {"
"0","      auc_primary <- auc_result$auc_table[auc_result$auc_table$time == primary_time, ""AUC""]"
"0","      message(sprintf(""    AUC at %d months: %.3f"", primary_time, auc_primary))"
"0","    }"
"0","    "
"0","    # ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
"0","    cal_result <- assess_calibration(model, data, time_point = primary_time)"
"0","    if (!is.na(cal_result$slope)) {"
"0","      message(sprintf(""    Calibration slope: %.3f, intercept: %.3f"", "
"0","                     cal_result$slope, cal_result$intercept))"
"0","    }"
"0","    "
"0","    # Brier Score"
"0","    brier_result <- calculate_brier_score(model, data, time_point = primary_time)"
"0","    if (!is.na(brier_result$brier_score)) {"
"0","      message(sprintf(""    Brier score: %.3f (scaled: %.3f)"", "
"0","                     brier_result$brier_score, brier_result$scaled_brier))"
"0","    }"
"0","    "
"0","    # DCAï¼ˆãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆã®ã¿ï¼‰"
"0","    if (set_name == ""test"") {"
"0","      dca_result <- perform_dca(model, data, time_point = primary_time)"
"0","    } else {"
"0","      dca_result <- NULL"
"0","    }"
"0","    "
"0","    # çµæœã‚’ä¿å­˜"
"0","    results[[set_name]] <- list("
"0","      c_index = c_result,"
"0","      time_auc = auc_result,"
"0","      calibration = cal_result,"
"0","      brier = brier_result,"
"0","      dca = dca_result"
"0","    )"
"0","  }"
"0","  "
"0","  return(results)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 8. å…¨ãƒ¢ãƒ‡ãƒ«è©•ä¾¡"
"0","# ========================================================================"
"0",""
"0","#' å…¨ãƒ¢ãƒ‡ãƒ«ã‚’è©•ä¾¡"
"0","#' @param models ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ"
"0","#' @param split_data åˆ†å‰²ãƒ‡ãƒ¼ã‚¿"
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @return è©•ä¾¡çµæœ"
"0","evaluate_all_models <- function(models, split_data, config = NULL) {"
"0","  "
"0","  message(""\n========================================"")"
"0","  message(""Evaluating All Models"")"
"0","  message(""========================================"")"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿æº–å‚™"
"0","  train_data <- prepare_model_data(split_data$train, config = config)"
"0","  val_data <- prepare_model_data(split_data$val, config = config)"
"0","  test_data <- prepare_model_data(split_data$test, config = config)"
"0","  "
"0","  # çµæœæ ¼ç´"
"0","  all_results <- list()"
"0","  summary_table <- data.frame()"
"0","  "
"0","  for (model_name in names(models)) {"
"0","    "
"0","    model <- models[[model_name]]"
"0","    "
"0","    if (!is.null(model)) {"
"0","      message(sprintf(""\n--- Model: %s ---"", model_name))"
"0","      "
"0","      tryCatch({"
"0","        # åŒ…æ‹¬çš„è©•ä¾¡"
"0","        eval_result <- evaluate_model_comprehensive("
"0","          model,"
"0","          train_data,"
"0","          val_data,"
"0","          test_data,"
"0","          config"
"0","        )"
"0","        "
"0","        all_results[[model_name]] <- eval_result"
"0","        "
"0","        # ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ "
"0","        summary_row <- data.frame("
"0","          model = model_name,"
"0","          n_vars = attr(model, ""n_vars""),"
"0","          c_index_train = eval_result$train$c_index$c_index,"
"0","          c_index_val = ifelse(!is.null(eval_result$val), "
"0","                              eval_result$val$c_index$c_index, NA),"
"0","          c_index_test = ifelse(!is.null(eval_result$test), "
"0","                               eval_result$test$c_index$c_index, NA),"
"0","          brier_test = ifelse(!is.null(eval_result$test), "
"0","                             eval_result$test$brier$brier_score, NA)"
"0","        )"
"0","        "
"0","        summary_table <- rbind(summary_table, summary_row)"
"0","        "
"0","      }, error = function(e) {"
"0","        message(sprintf(""  âŒ Error evaluating %s: %s"", model_name, e$message))"
"0","        all_results[[model_name]] <- NULL"
"0","      })"
"0","    }"
"0","  }"
"0","  "
"0","  # ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’C-indexã§ã‚½ãƒ¼ãƒˆ"
"0","  if (nrow(summary_table) > 0) {"
"0","    summary_table <- summary_table[order(summary_table$c_index_test, decreasing = TRUE), ]"
"0","    rownames(summary_table) <- NULL"
"0","    "
"0","    message(""\nğŸ“Š Model Performance Summary:"")"
"0","    print(summary_table, digits = 3)"
"0","  }"
"0","  "
"0","  message(""\nâœ… Model evaluation completed!"")"
"0","  message(""========================================\n"")"
"0","  "
"0","  # çµæœã‚’è¿”ã™"
"0","  return(list("
"0","    results = all_results,"
"0","    summary = summary_table,"
"0","    data = list("
"0","      train = train_data,"
"0","      val = val_data,"
"0","      test = test_data"
"0","    )"
"0","  ))"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 9. è©•ä¾¡çµæœã®ä¿å­˜"
"0","# ========================================================================"
"0",""
"0","#' è©•ä¾¡çµæœã‚’ä¿å­˜"
"0","#' @param evaluation_results è©•ä¾¡çµæœ"
"0","#' @param file_path ä¿å­˜å…ˆãƒ‘ã‚¹"
"0","#' @param format ä¿å­˜å½¢å¼ï¼ˆ""rds"", ""csv""ï¼‰"
"0","save_evaluation_results <- function(evaluation_results, "
"0","                                   file_path, "
"0","                                   format = ""rds"") {"
"0","  "
"0","  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ"
"0","  dir_path <- dirname(file_path)"
"0","  if (!dir.exists(dir_path)) {"
"0","    dir.create(dir_path, recursive = TRUE, showWarnings = FALSE)"
"0","  }"
"0","  "
"0","  if (format == ""rds"") {"
"0","    saveRDS(evaluation_results, file = file_path)"
"0","    message(sprintf(""  âœ“ Results saved to: %s"", file_path))"
"0","    "
"0","  } else if (format == ""csv"") {"
"0","    # ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿CSVä¿å­˜"
"0","    write.csv(evaluation_results$summary, "
"0","             file = file_path, "
"0","             row.names = FALSE)"
"0","    message(sprintf(""  âœ“ Summary saved to: %s"", file_path))"
"0","  }"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 10. ãƒ¢ãƒ‡ãƒ«æ¯”è¼ƒ"
"0","# ========================================================================"
"0",""
"0","#' ãƒ¢ãƒ‡ãƒ«ã®çµ±è¨ˆçš„æ¯”è¼ƒ"
"0","#' @param results è©•ä¾¡çµæœ"
"0","#' @param metric æ¯”è¼ƒæŒ‡æ¨™ï¼ˆ""c_index"", ""auc"", ""brier""ï¼‰"
"0","#' @param dataset ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåï¼ˆ""test"", ""val""ï¼‰"
"0","#' @return æ¯”è¼ƒçµæœ"
"0","compare_models_statistically <- function(results, "
"0","                                        metric = ""c_index"","
"0","                                        dataset = ""test"") {"
"0","  "
"0","  message(""\nğŸ“Š Statistical Model Comparison"")"
"0","  message(sprintf(""  Metric: %s, Dataset: %s"", metric, dataset))"
"0","  "
"0","  # æ¯”è¼ƒç”¨ã®ãƒ‡ãƒ¼ã‚¿æŠ½å‡º"
"0","  comparison_data <- data.frame()"
"0","  "
"0","  for (model_name in names(results$results)) {"
"0","    model_result <- results$results[[model_name]]"
"0","    "
"0","    if (!is.null(model_result) && !is.null(model_result[[dataset]])) {"
"0","      "
"0","      if (metric == ""c_index"") {"
"0","        value <- model_result[[dataset]]$c_index$c_index"
"0","        se <- model_result[[dataset]]$c_index$se"
"0","        "
"0","      } else if (metric == ""brier"") {"
"0","        value <- model_result[[dataset]]$brier$brier_score"
"0","        se <- NA  # Brier scoreã®æ¨™æº–èª¤å·®ã¯é€šå¸¸è¨ˆç®—ã—ãªã„"
"0","        "
"0","      } else {"
"0","        value <- NA"
"0","        se <- NA"
"0","      }"
"0","      "
"0","      comparison_data <- rbind(comparison_data, data.frame("
"0","        model = model_name,"
"0","        value = value,"
"0","        se = se"
"0","      ))"
"0","    }"
"0","  }"
"0","  "
"0","  # ãƒ©ãƒ³ã‚­ãƒ³ã‚°"
"0","  comparison_data <- comparison_data[order(comparison_data$value, "
"0","                                         decreasing = (metric == ""c_index"")), ]"
"0","  comparison_data$rank <- 1:nrow(comparison_data)"
"0","  "
"0","  # æœ€è‰¯ãƒ¢ãƒ‡ãƒ«"
"0","  best_model <- comparison_data$model[1]"
"0","  best_value <- comparison_data$value[1]"
"0","  "
"0","  message(sprintf(""\n  Best model: %s (%s = %.3f)"", "
"0","                 best_model, metric, best_value))"
"0","  "
"0","  # ä¸Šä½5ãƒ¢ãƒ‡ãƒ«"
"0","  message(""\n  Top 5 models:"")"
"0","  for (i in 1:min(5, nrow(comparison_data))) {"
"0","    message(sprintf(""    %d. %s: %.3f"", "
"0","                   i, "
"0","                   comparison_data$model[i],"
"0","                   comparison_data$value[i]))"
"0","  }"
"0","  "
"0","  return(comparison_data)"
"0","}"
