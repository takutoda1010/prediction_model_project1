"0","# ---- 欠損・外れ値 IDリスト（別チャンク） --------------------------------"
"0","suppressMessages({ library(dplyr) })"
"0",""
"0","# 出力先"
"0","out_dir <- ""/Users/yoshidatakuto/Dropbox/Hokkaido University/大学院医学院/Borderline HCC/Prediction model_Project1/03_Output"""
"0","if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)"
"0",""
"0","# 解析に必要な変数（ユーザー指定）"
"0","varmap <- c("
"0","  tumor_size_cm        = ""max_diam_cm"",     # 最大腫瘍径[cm]"
"0","  tumor_count          = ""count"",           # 腫瘍個数（数値）"
"0","  mvi                  = ""mvi"",             # 微小血管侵襲（0/1 or カテゴリ）"
"0","  intrahepatic_met     = ""im"",              # 肝内転移（0/1 or カテゴリ）"
"0","  differentiation      = ""grade_txt"",       # 分化度（Well/Mod/Poor 等）"
"0","  portal_vein_invasion = ""vp_path"",         # 門脈浸潤（0/1 or カテゴリ）"
"0","  margin_positive      = ""sm"",              # 断端陽性（0/1 or カテゴリ）"
"0","  tumor_volume         = ""tumor_vol"",       # 腫瘍体積（存在すれば数値）"
"0","  cirrhosis            = ""cirrhosis"",       # 肝硬変（0/1 or カテゴリ）"
"0","  albi                 = ""albi"",            # ALBIスコア（数値）"
"0","  platelets            = ""plt"",             # 血小板"
"0","  albumin              = ""alb"",             # アルブミン"
"0","  afp                  = ""afp"",             # AFP"
"0","  recurrence           = ""eventfree10"",     # 再発の有無（0/1 or カテゴリ）"
"0","  rfs_months           = ""rfs_months""       # 無再発生存期間（月）"
"0",")"
"0",""
"0","df <- ds01_model"
"0",""
"0","# ID列を推定（無ければ連番を付与）"
"0","id_candidates <- c(""id"",""ID"",""patient_id"",""case_id"",""record_id"",""study_id"")"
"0","id_var <- intersect(id_candidates, names(df))"
"0","id_var <- if (length(id_var)) id_var[1] else NULL"
"0","if (is.null(id_var)) { df$row_id <- seq_len(nrow(df)); id_var <- ""row_id"" }"
"0",""
"0","# 実在する列のみ抽出し、キー名（varmap左側）に統一"
"0","keep_raw <- varmap[varmap %in% names(df)]"
"0","df_sub <- df %>%"
"0","  dplyr::select(dplyr::all_of(id_var), dplyr::any_of(unname(keep_raw))) %>%"
"0","  dplyr::rename(!!!setNames(unname(keep_raw), names(keep_raw)))  # new = old"
"0",""
"0","# 数値とみなす候補（ここだけは明示）"
"0","numeric_expected <- c(""tumor_size_cm"",""tumor_count"",""tumor_volume"",""albi"",""platelets"",""albumin"",""afp"",""rfs_months"")"
"0","num_vars <- intersect(numeric_expected, setdiff(names(df_sub), id_var))"
"0",""
"0","# 可能なら数値化（文字→数値は抑制的に。非数はNA）"
"0","for (v in num_vars) {"
"0","  if (!is.numeric(df_sub[[v]])) {"
"0","    df_sub[[v]] <- suppressWarnings(as.numeric(df_sub[[v]]))"
"0","  }"
"0","}"
"0",""
"0","# 欠損レコード（全対象変数）"
"0","make_missing_rows <- function(v){"
"0","  x <- df_sub[[v]]"
"0","  idx <- which(is.na(x))"
"0","  if (!length(idx)) return(NULL)"
"0","  data.frame("
"0","    id = df_sub[[id_var]][idx],"
"0","    variable = v,"
"0","    value = NA,"
"0","    flag = ""missing"","
"0","    stringsAsFactors = FALSE"
"0","  )"
"0","}"
"0",""
"0","# 外れ値（数値のみ；Tukey IQR 法）"
"0","make_outlier_rows <- function(v){"
"0","  x <- df_sub[[v]]"
"0","  x_ok <- x[!is.na(x)]"
"0","  if (!length(x_ok)) return(NULL)"
"0","  q1 <- as.numeric(stats::quantile(x_ok, 0.25, na.rm=TRUE))"
"0","  q3 <- as.numeric(stats::quantile(x_ok, 0.75, na.rm=TRUE))"
"0","  iqr <- q3 - q1"
"0","  lower <- q1 - 1.5*iqr"
"0","  upper <- q3 + 1.5*iqr"
"0","  idx <- which(!is.na(x) & (x < lower | x > upper))"
"0","  if (!length(idx)) return(NULL)"
"0","  data.frame("
"0","    id = df_sub[[id_var]][idx],"
"0","    variable = v,"
"0","    value = x[idx],"
"0","    flag = ""outlier"","
"0","    stringsAsFactors = FALSE"
"0","  )"
"0","}"
"0",""
"0","issue_list <- list()"
"0",""
"0","# 欠損（IDを除く全対象変数）"
"0","for (v in setdiff(names(df_sub), id_var)) {"
"0","  issue_list[[paste0(""miss_"", v)]] <- make_missing_rows(v)"
"0","}"
"0",""
"0","# 外れ値（数値変数のみ）"
"0","for (v in num_vars) {"
"0","  issue_list[[paste0(""out_"", v)]] <- make_outlier_rows(v)"
"0","}"
"0",""
"0","issues_df <- dplyr::bind_rows(issue_list)"
"0","if (is.null(issues_df) || !nrow(issues_df)) {"
"0","  message(""欠損・外れ値は検出されませんでした。"")"
"0","  issues_df <- data.frame(id=NA, variable=NA, value=NA, flag=NA)[0,]"
"0","} else {"
"0","  issues_df <- issues_df %>% dplyr::arrange(variable, id)"
"0","}"
"0",""
"0","# 出力（カルテ点検用リスト）"
"0","write.csv(issues_df, file.path(out_dir, ""anomaly_check.csv""), row.names = FALSE)"
"0",""
"0","# 確認用の先頭表示"
"0","print(head(issues_df, 30), row.names = FALSE)"
