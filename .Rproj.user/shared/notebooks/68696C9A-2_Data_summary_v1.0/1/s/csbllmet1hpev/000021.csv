"0","# ========= Skewness チェック：right / left skew の一覧を作成 ========="
"0","suppressMessages({ library(dplyr) })"
"0",""
"0","# 解析対象データ（df_std があれば優先、なければ ds01_model）"
"0","stopifnot(exists(""ds01_model""))"
"0","dat <- if (exists(""df_std"")) df_std else ds01_model"
"0",""
"0","# 数値列の抽出（id 等は除外したい場合はここで指定）"
"0","exclude_cols <- c(""id"")"
"0","num_cols <- names(dat)[sapply(dat, function(x) is.numeric(x) || inherits(x, ""integer""))]"
"0","num_cols <- setdiff(num_cols, exclude_cols)"
"0",""
"0","# 歪度（skewness）の手計算（パッケージ不要：モーメント比）"
"0","skewness_moment <- function(x){"
"0","  x <- x[is.finite(x)]"
"0","  n <- length(x)"
"0","  if (n < 3) return(NA_real_)"
"0","  mu <- mean(x)"
"0","  m2 <- mean((x - mu)^2)"
"0","  if (m2 <= 0) return(NA_real_)"
"0","  m3 <- mean((x - mu)^3)"
"0","  m3 / (m2^(3/2))"
"0","}"
"0",""
"0","# 判定しきい値（調整可）"
"0","thr_moderate <- 0.5   # |skew| >= 0.5 で「やや歪み」"
"0","thr_strong   <- 1.0   # |skew| >= 1.0 で「強い歪み」"
"0",""
"0","# 推奨変換のヒント"
"0","suggest_transform <- function(sk, x_min){"
"0","  if (is.na(sk)) return(NA_character_)"
"0","  if (sk > 0) {"
"0","    # 右裾重（right skew）"
"0","    if (is.finite(x_min) && x_min > 0) return(""log(x) or sqrt(x)"")"
"0","    if (is.finite(x_min) && x_min >= 0) return(""log1p(x) or sqrt(x)"")"
"0","    return(""Yeo-Johnson / Box-Cox (shift)"")"
"0","  } else if (sk < 0) {"
"0","    # 左裾重（left skew）"
"0","    if (is.finite(x_min) && x_min >= 0) return(""square(x) or reflect+log"")"
"0","    return(""reflect+log (e.g., log(max+1 - x))"")"
"0","  } else return(""none"")"
"0","}"
"0",""
"0","# 集計"
"0","skew_tbl <- lapply(num_cols, function(v){"
"0","  x <- dat[[v]]"
"0","  x_use <- x[is.finite(x)]"
"0","  n <- length(x_use)"
"0","  if (!n) {"
"0","    return(data.frame("
"0","      variable = v, n = 0, skewness = NA_real_, direction = NA_character_,"
"0","      magnitude = NA_character_, min = NA_real_, max = NA_real_, recommend = NA_character_,"
"0","      stringsAsFactors = FALSE"
"0","    ))"
"0","  }"
"0","  sk <- skewness_moment(x_use)"
"0","  dir <- ifelse(is.na(sk), NA_character_,"
"0","                ifelse(sk > 0, ""right"", ifelse(sk < 0, ""left"", ""symmetric"")))"
"0","  mag <- ifelse(is.na(sk), NA_character_,"
"0","                ifelse(abs(sk) >= thr_strong,  ""strong"","
"0","                       ifelse(abs(sk) >= thr_moderate, ""moderate"", ""weak/none"")))"
"0","  rec <- suggest_transform(sk, suppressWarnings(min(x_use)))"
"0","  data.frame("
"0","    variable = v,"
"0","    n = n,"
"0","    skewness = unname(sk),"
"0","    direction = dir,"
"0","    magnitude = mag,"
"0","    min = suppressWarnings(min(x_use)),"
"0","    max = suppressWarnings(max(x_use)),"
"0","    recommend = rec,"
"0","    stringsAsFactors = FALSE"
"0","  )"
"0","}) %>% dplyr::bind_rows() %>%"
"0","  dplyr::arrange(dplyr::desc(abs(skewness)))"
"0",""
"0","# 結果の確認"
"0","print(skew_tbl, row.names = FALSE)"
