"0","df <- ds01_model"
"0",""
"0","# ------------------------ 変数マッピング -------------------------------------"
"0","# 左辺=標準名（この名前に統一します） / 右辺=元データ列名"
"0","varmap <- c("
"0","  # 術後（病理）"
"0","  tumor_size_cm_post   = ""max_diam_cm"","
"0","  tumor_count_post     = ""count"","
"0","  # 術前（画像）"
"0","  tumor_size_cm_pre    = ""tum_diam_pre"","
"0","  tumor_count_pre      = ""tum_count_pre"","
"0","  # その他臨床"
"0","  mvi                  = ""mvi"","
"0","  intrahepatic_met     = ""im"","
"0","  differentiation      = ""grade_txt"","
"0","  portal_vein_invasion = ""vp_path"","
"0","  margin_positive      = ""sm"","
"0","  tumor_volume         = ""tumor_vol"","
"0","  fibrosis             = ""fibrosis"","
"0","  platelets            = ""plt"","
"0","  albumin              = ""alb"",      # g/dL"
"0","  tbil                 = ""tbil"",     # mg/dL"
"0","  afp                  = ""afp"","
"0","  sex                  = ""sex"","
"0","  recurrence           = ""eventfree10"","
"0","  rfs_months           = ""rfs_months"""
"0",")"
"0",""
"0","# 実在列だけ抽出し、標準名に統一"
"0","# 実在列だけ抽出し、標準名にリネーム（←ここを修正）"
"0","keep_raw <- varmap[varmap %in% names(df)]"
"0",""
"0","df_std <- df %>%"
"0","  dplyr::select(id, dplyr::any_of(unname(keep_raw))) %>%"
"0","  dplyr::rename(!!!stats::setNames(unname(keep_raw), names(keep_raw)))  # new = old"
"0",""
"0",""
"0","# ------------------------ 派生変数（ALBI/ln/二値化） -------------------------"
"0","to_num <- function(x) suppressWarnings(as.numeric(x))"
"0","to_pos_log <- function(x) ifelse(!is.na(x) & x > 0, log(x), NA_real_)"
"0",""
"0","# ALBI（日本の単位に合わせた式）"
"0","if (all(c(""tbil"",""albumin"") %in% names(df_std))) {"
"0","  tbil_mgdl <- to_num(df_std$tbil)"
"0","  alb_gdl   <- to_num(df_std$albumin)"
"0","  df_std$albi_score <- ifelse("
"0","    is.na(tbil_mgdl) | is.na(alb_gdl) | tbil_mgdl <= 0,"
"0","    NA_real_,"
"0","    (log10(tbil_mgdl * 17.1) * 0.66) + (alb_gdl * 10 * -0.085)"
"0","  )"
"0","  df_std$albi_grade <- ifelse("
"0","    is.na(df_std$albi_score), NA_integer_,"
"0","    ifelse(df_std$albi_score <= -2.60, 1L,"
"0","           ifelse(df_std$albi_score <= -1.39, 2L, 3L))"
"0","  )"
"0","}"
"0",""
"0","# ln 変換（自然対数）"
"0","if (""afp"" %in% names(df_std))                df_std$ln_afp             <- to_pos_log(to_num(df_std$afp))"
"0","if (""tumor_size_cm_pre"" %in% names(df_std))  df_std$ln_tumor_size_pre  <- to_pos_log(to_num(df_std$tumor_size_cm_pre))"
"0","if (""tumor_size_cm_post"" %in% names(df_std)) df_std$ln_tumor_size_post <- to_pos_log(to_num(df_std$tumor_size_cm_post))"
"0",""
"0","# 二値派生：>5 cm（術前/術後）、多発（>=2、術前/術後）、AFP>=400"
"0","if (""tumor_size_cm_pre"" %in% names(df_std))  df_std$tumor_size_pre_gt5  <- as.integer(to_num(df_std$tumor_size_cm_pre)  > 5)"
"0","if (""tumor_size_cm_post"" %in% names(df_std)) df_std$tumor_size_post_gt5 <- as.integer(to_num(df_std$tumor_size_cm_post) > 5)"
"0","if (""tumor_count_pre""  %in% names(df_std))   df_std$multifocal_pre      <- as.integer(to_num(df_std$tumor_count_pre)    >= 2)"
"0","if (""tumor_count_post"" %in% names(df_std))   df_std$multifocal_post     <- as.integer(to_num(df_std$tumor_count_post)   >= 2)"
"0","if (""afp"" %in% names(df_std))                df_std$afp_ge400           <- as.integer(to_num(df_std$afp)                >= 400)"
"0",""
"0","# ------------------------ 記述統計 + 外れ値（IQR法） -------------------------"
"0","cat_candidates <- c("
"0","  ""tumor_size_pre_gt5"",""tumor_size_post_gt5"",""multifocal_pre"",""multifocal_post"",""afp_ge400"","
"0","  ""mvi"",""intrahepatic_met"",""differentiation"",""portal_vein_invasion"",""margin_positive"","
"0","  ""cirrhosis"",""recurrence"",""sex"",""albi_grade"""
"0",")"
"0","cat_vars <- intersect(cat_candidates, names(df_std))"
"0",""
"0","num_vars <- names(df_std)[sapply(df_std, is.numeric)]"
"0","num_vars <- setdiff(num_vars, c(""id"", cat_vars))  # 二値派生はカテゴリ扱いへ"
"0",""
"0","# 数値 記述統計＋外れ値"
"0","num_summary <- if (length(num_vars)) {"
"0","  do.call(rbind, lapply(num_vars, function(v){"
"0","    x <- df_std[[v]]"
"0","    n_tot <- length(x); n <- sum(!is.na(x)); miss <- n_tot - n"
"0","    if (n == 0) {"
"0","      data.frame(var=v, n=0, missing_n=miss, missing_pct=100,"
"0","                 mean=NA, sd=NA, median=NA, q1=NA, q3=NA, IQR=NA,"
"0","                 min=NA, max=NA, outlier_n=NA, outlier_pct=NA, stringsAsFactors=FALSE)"
"0","    } else {"
"0","      q1 <- as.numeric(stats::quantile(x, 0.25, na.rm=TRUE))"
"0","      q3 <- as.numeric(stats::quantile(x, 0.75, na.rm=TRUE))"
"0","      iqr <- q3 - q1; lower <- q1 - 1.5*iqr; upper <- q3 + 1.5*iqr"
"0","      out_n <- sum(x < lower | x > upper, na.rm = TRUE)"
"0","      data.frame("
"0","        var=v, n=n, missing_n=miss, missing_pct=round(100*miss/n_tot,1),"
"0","        mean=mean(x, na.rm=TRUE), sd=stats::sd(x, na.rm=TRUE),"
"0","        median=stats::median(x, na.rm=TRUE),"
"0","        q1=q1, q3=q3, IQR=iqr,"
"0","        min=suppressWarnings(min(x, na.rm=TRUE)),"
"0","        max=suppressWarnings(max(x, na.rm=TRUE)),"
"0","        outlier_n=out_n, outlier_pct=round(100*out_n/n,1),"
"0","        stringsAsFactors=FALSE"
"0","      )"
"0","    }"
"0","  }))"
"0","} else data.frame()"
"0",""
"0","# カテゴリ 頻度・割合"
"0","cat_summary <- if (length(cat_vars)) {"
"0","  do.call(rbind, lapply(cat_vars, function(v){"
"0","    x <- df_std[[v]]"
"0","    if (is.numeric(x)) x <- factor(x)"
"0","    tbl <- as.data.frame(table(x, useNA = ""ifany""), stringsAsFactors = FALSE)"
"0","    names(tbl) <- c(""level"",""n"")"
"0","    tbl$var <- v"
"0","    tbl %>%"
"0","      dplyr::mutate(pct = round(100 * n / sum(n), 1)) %>%"
"0","      dplyr::select(var, level, n, pct)"
"0","  }))"
"0","} else data.frame()"
"0",""
"0",""
"0","# 欠損サマリ"
"0","missingness <- data.frame("
"0","  var = setdiff(names(df_std), ""id""),"
"0","  missing_n = sapply(df_std[ , setdiff(names(df_std), ""id""), drop=FALSE], function(x) sum(is.na(x))),"
"0","  missing_pct = round(100 * sapply(df_std[ , setdiff(names(df_std), ""id""), drop=FALSE], function(x) mean(is.na(x))), 1),"
"0","  stringsAsFactors = FALSE"
"0",") %>% arrange(desc(missing_pct), var)"
"0",""
"0","# 表示＆保存"
"0","message(""■ 数値記述統計""); print(num_summary, row.names = FALSE)"
"2","■ 数値記述統計
"
