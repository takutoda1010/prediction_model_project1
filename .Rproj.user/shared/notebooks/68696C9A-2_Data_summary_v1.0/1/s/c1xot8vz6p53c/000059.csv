"0",""
"0","# ------------------------ ERASL-pre / ERASL-post 特徴量 ----------------------"
"0","# sex_male 生成（男=1, 女=0）"
"0","sex_to01 <- function(z){"
"0","  if (is.null(z)) return(rep(NA_integer_, nrow(df_std)))"
"0","  if (is.numeric(z)) {"
"0","    u <- sort(unique(na.omit(as.numeric(z))))"
"0","    if (length(u) == 2) return(as.integer(as.numeric(z) == max(u)))"
"0","    return(as.integer(z))"
"0","  } else {"
"0","    s <- tolower(as.character(z))"
"0","    out <- ifelse(s %in% c(""m"",""male"",""man"",""boy"",""1"",""男性"",""男""), 1L,"
"0","             ifelse(s %in% c(""f"",""female"",""woman"",""girl"",""0"",""女性"",""女""), 0L, NA_integer_))"
"0","    return(as.integer(out))"
"0","  }"
"0","}"
"0","mvi_to01 <- function(z){"
"0","  if (is.null(z)) return(rep(NA_integer_, nrow(df_std)))"
"0","  if (is.numeric(z)) return(as.integer(z))"
"0","  s <- tolower(as.character(z))"
"0","  out <- ifelse(s %in% c(""1"",""yes"",""y"",""positive"",""pos"",""present"",""あり"",""有"",""陽性""), 1L,"
"0","           ifelse(s %in% c(""0"",""no"",""n"",""negative"",""neg"",""absent"",""なし"",""無"",""陰性""), 0L, NA_integer_))"
"0","  as.integer(out)"
"0","}"
"0",""
"0","sex_male <- if (""sex"" %in% names(df_std)) sex_to01(df_std$sex) else rep(NA_integer_, nrow(df_std))"
"0",""
"0","# ERASL-pre = sex_male, albi_grade, ln(AFP), ln(腫瘍径_術前), 腫瘍個数_術前"
"0","feat_ERASL_pre <- data.frame("
"0","  id = df_std$id,"
"0","  sex_male = sex_male,"
"0","  albi_grade = if (""albi_grade"" %in% names(df_std)) df_std$albi_grade else NA,"
"0","  ln_afp = if (""ln_afp"" %in% names(df_std)) df_std$ln_afp else NA,"
"0","  ln_tumor_size_cm = if (""ln_tumor_size_pre"" %in% names(df_std)) df_std$ln_tumor_size_pre else NA,"
"0","  tumor_count = if (""tumor_count_pre"" %in% names(df_std)) to_num(df_std$tumor_count_pre) else NA"
"0",")"
"0",""
"0","miss_mat_pre <- sapply(feat_ERASL_pre[,-1, drop=FALSE], function(x) is.na(x))"
"0","miss_any_pre <- if (is.null(dim(miss_mat_pre))) miss_mat_pre else apply(miss_mat_pre, 1, any)"
"0","miss_cols_pre <- apply(as.data.frame(miss_mat_pre), 1, function(r) paste(names(r)[which(r)], collapse=""|""))"
"0","missing_ids_ERASL_pre <- data.frame(id = feat_ERASL_pre$id[miss_any_pre], missing_cols = miss_cols_pre[miss_any_pre])"
"0",""
"0","write.csv(feat_ERASL_pre,          file.path(out_dir, ""features_ERASL_pre.csv""),         row.names = FALSE)"
"0","write.csv(missing_ids_ERASL_pre,   file.path(out_dir, ""missing_ids_ERASL_pre.csv""),      row.names = FALSE)"
"0",""
"0","# ERASL-post = ERASL-pre + MVI（術後情報を含む）"
"0","feat_ERASL_post <- data.frame("
"0","  id = df_std$id,"
"0","  sex_male = sex_male,"
"0","  albi_grade = if (""albi_grade"" %in% names(df_std)) df_std$albi_grade else NA,"
"0","  ln_afp = if (""ln_afp"" %in% names(df_std)) df_std$ln_afp else NA,"
"0","  ln_tumor_size_cm = if (""ln_tumor_size_post"" %in% names(df_std)) df_std$ln_tumor_size_post else NA,"
"0","  tumor_count = if (""tumor_count_post"" %in% names(df_std)) to_num(df_std$tumor_count_post) else NA,"
"0","  mvi = if (""mvi"" %in% names(df_std)) mvi_to01(df_std$mvi) else NA"
"0",")"
"0",""
"0","miss_mat_post <- sapply(feat_ERASL_post[,-1, drop=FALSE], function(x) is.na(x))"
"0","miss_any_post <- if (is.null(dim(miss_mat_post))) miss_mat_post else apply(miss_mat_post, 1, any)"
"0","miss_cols_post <- apply(as.data.frame(miss_mat_post), 1, function(r) paste(names(r)[which(r)], collapse=""|""))"
"0","missing_ids_ERASL_post <- data.frame(id = feat_ERASL_post$id[miss_any_post], missing_cols = miss_cols_post[miss_any_post])"
"0",""
"0","write.csv(feat_ERASL_post,         file.path(out_dir, ""features_ERASL_post.csv""),        row.names = FALSE)"
"0","write.csv(missing_ids_ERASL_post,  file.path(out_dir, ""missing_ids_ERASL_post.csv""),     row.names = FALSE)"
"0",""
"0","message(""出力ファイル："","
"0","        ""\n- num_summary.csv, cat_summary.csv, missingness.csv"","
"0","        ""\n- anomaly_check.csv"","
"0","        ""\n- features_ERASL_pre.csv / missing_ids_ERASL_pre.csv"","
"0","        ""\n- features_ERASL_post.csv / missing_ids_ERASL_post.csv"")"
"2","出力ファイル：
- num_summary.csv, cat_summary.csv, missingness.csv
- anomaly_check.csv
- features_ERASL_pre.csv / missing_ids_ERASL_pre.csv
- features_ERASL_post.csv / missing_ids_ERASL_post.csv
"
"0","# ============================================================================"
"0",""
"0",""
