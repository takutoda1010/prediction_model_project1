"0","write.csv(num_summary, file.path(out_dir, ""num_summary.csv""),  row.names = FALSE)"
"0","write.csv(cat_summary, file.path(out_dir, ""cat_summary.csv""),  row.names = FALSE)"
"0","write.csv(missingness, file.path(out_dir, ""missingness.csv""),  row.names = FALSE)"
"0",""
"0","# ------------------------ 欠損/外れ値 ID リスト ------------------------------"
"0","# 数値として扱う標準名（術前/術後の腫瘍径・個数を含む）"
"0","numeric_expected <- c("
"0","  ""tumor_size_cm_pre"",""tumor_count_pre"",""tumor_size_cm_post"",""tumor_count_post"","
"0","  ""tumor_volume"",""platelets"",""albumin"",""tbil"",""afp"",""rfs_months"","
"0","  ""albi_score"",""ln_afp"",""ln_tumor_size_pre"",""ln_tumor_size_post"""
"0",")"
"0","num_vars2 <- intersect(numeric_expected, names(df_std))"
"0",""
"0","make_missing_rows <- function(v){"
"0","  x <- df_std[[v]]"
"0","  idx <- which(is.na(x))"
"0","  if (!length(idx)) return(NULL)"
"0","  data.frame(id = df_std$id[idx], variable = v, value = NA, flag = ""missing"", stringsAsFactors = FALSE)"
"0","}"
"0","make_outlier_rows <- function(v){"
"0","  x <- df_std[[v]]; x_ok <- x[!is.na(x)]"
"0","  if (!length(x_ok)) return(NULL)"
"0","  q1 <- as.numeric(stats::quantile(x_ok, 0.25, na.rm=TRUE))"
"0","  q3 <- as.numeric(stats::quantile(x_ok, 0.75, na.rm=TRUE))"
"0","  iqr <- q3 - q1; lower <- q1 - 1.5*iqr; upper <- q3 + 1.5*iqr"
"0","  idx <- which(!is.na(x) & (x < lower | x > upper))"
"0","  if (!length(idx)) return(NULL)"
"0","  data.frame(id = df_std$id[idx], variable = v, value = x[idx], flag = ""outlier"", stringsAsFactors = FALSE)"
"0","}"
"0",""
"0","issue_list <- list()"
"0","for (v in setdiff(names(df_std), ""id"")) issue_list[[paste0(""miss_"", v)]] <- make_missing_rows(v)"
"0","for (v in num_vars2)                   issue_list[[paste0(""out_"", v)]]  <- make_outlier_rows(v)"
"0",""
"0","issues_df <- dplyr::bind_rows(issue_list)"
"0","if (is.null(issues_df) || !nrow(issues_df)) {"
"0","  message(""欠損・外れ値は検出されませんでした。"")"
"0","  issues_df <- data.frame(id=NA, variable=NA, value=NA, flag=NA)[0,]"
"0","} else {"
"0","  issues_df <- issues_df %>% dplyr::arrange(variable, id)"
"0","}"
"0","write.csv(issues_df, file.path(out_dir, ""anomaly_check.csv""), row.names = FALSE)"
"0","print(head(issues_df, 30), row.names = FALSE)"
