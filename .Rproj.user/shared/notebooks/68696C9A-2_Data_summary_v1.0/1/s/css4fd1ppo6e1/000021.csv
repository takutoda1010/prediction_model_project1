"0","# ---- 記述統計 / EDA（既存チャンクを更新） -------------------------------"
"0",""
"0","# 依存：dplyr, tidyr（普段お使いの tidyverse が読み込み済みなら追加不要）"
"0","suppressMessages({"
"0","  library(dplyr); library(tidyr)"
"0","})"
"0",""
"0","# 1) 変数マッピング（あなたの列名に合わせて必要なところだけ直してください）"
"0","varmap <- c("
"0","  tumor_size_cm        = ""max_diam_cm"",     # 最大腫瘍径[cm]"
"0","  tumor_count          = ""count"",    # 腫瘍個数（数値）"
"0","  mvi                  = ""mvi"",              # 微小血管侵襲（0/1 or カテゴリ）"
"0","  intrahepatic_met     = ""im"",           # 肝内転移（0/1 or カテゴリ）"
"0","  differentiation      = ""grade_txt"",             # 分化度（Well/Mod/Poor 等）"
"0","  portal_vein_invasion = ""vp_path"",           # 門脈浸潤（0/1 or カテゴリ）"
"0","  margin_positive      = ""sm"",       # 断端陽性（0/1 or カテゴリ）"
"0","  tumor_volume         = ""tumor_vol"",          # 腫瘍体積（存在すれば数値）"
"0","  cirrhosis            = ""cirrhosis"",        # 肝硬変（0/1 or カテゴリ）"
"0","  albi                 = ""albi"",             # ALBIスコア（数値）※グレードは別名なら後述で追加"
"0","  platelets            = ""plt"",              # 血小板"
"0","  albumin              = ""alb"",              # アルブミン"
"0","  tbil                 = ""tbil"",             # T-bil "
"0","  afp                  = ""afp"",              # AFP"
"0","  recurrence           = ""eventfree10"",         # 再発の有無（0/1 or カテゴリ）"
"0","  rfs_months           = ""rfs_months""        # 無再発生存期間（月）"
"0",")"
"0",""
"0","df <- ds01_model"
"0",""
"0","# 2) 実在する列だけ抽出し、必要な二値派生を作る（>5cm、多発、AFP≧400）"
"0","exist_cols <- unname(varmap[varmap %in% names(df)])"
"0","df_sub <- df[, exist_cols, drop = FALSE]"
"0",""
"0","# 安全に列を取り出すヘルパ（存在しなければ NULL）"
"0","col_ <- function(name) if (name %in% names(df)) df[[name]] else NULL"
"0",""
"0","# >5cm"
"0","if (varmap[""tumor_size_cm""] %in% names(df)) {"
"0","  x <- col_(varmap[""tumor_size_cm""])"
"0","  df_sub$tumor_size_gt5 <- ifelse(is.na(x), NA_integer_, as.integer(x > 5))"
"0","}"
"0",""
"0","# 多発（個数 >= 2）"
"0","if (varmap[""tumor_count""] %in% names(df)) {"
"0","  x <- col_(varmap[""tumor_count""])"
"0","  df_sub$multifocal <- ifelse(is.na(x), NA_integer_, as.integer(x >= 2))"
"0","}"
"0",""
"0","# AFP ≥ 400"
"0","if (varmap[""afp""] %in% names(df)) {"
"0","  x <- col_(varmap[""afp""])"
"0","  df_sub$afp_ge400 <- ifelse(is.na(x), NA_integer_, as.integer(x >= 400))"
"0","}"
"0",""
"0","# 3) 数値・カテゴリを仕分け（明示的にカテゴリ扱いしたい変数を指定）"
"0","cat_candidates <- c("
"0","  ""tumor_size_gt5"",""multifocal"",""afp_ge400"","
"0","  varmap[""mvi""], varmap[""intrahepatic_met""], varmap[""differentiation""],"
"0","  varmap[""portal_vein_invasion""], varmap[""margin_positive""],"
"0","  varmap[""cirrhosis""], varmap[""recurrence""]"
"0",")"
"0","cat_vars <- intersect(cat_candidates, names(df_sub))"
"0",""
"0","# 数値候補（上記カテゴリ以外で数値のもの）"
"0","num_vars <- names(df_sub)[sapply(df_sub, is.numeric)]"
"0","num_vars <- setdiff(num_vars, cat_vars)  # 0/1の二値派生はカテゴリ側へ"
"0",""
"0","# 4) 数値記述統計＋外れ値集計（IQR法）"
"0","num_summary <- if (length(num_vars)) {"
"0","  do.call(rbind, lapply(num_vars, function(v){"
"0","    x <- df_sub[[v]]"
"0","    n_tot <- length(x); n <- sum(!is.na(x)); miss <- n_tot - n"
"0","    if (n == 0) {"
"0","      data.frame("
"0","        var = v, n = 0, missing_n = miss, missing_pct = 100,"
"0","        mean = NA, sd = NA, median = NA, q1 = NA, q3 = NA, IQR = NA,"
"0","        min = NA, max = NA, outlier_n = NA, outlier_pct = NA,"
"0","        stringsAsFactors = FALSE"
"0","      )"
"0","    } else {"
"0","      q1  <- as.numeric(stats::quantile(x, 0.25, na.rm = TRUE))"
"0","      q3  <- as.numeric(stats::quantile(x, 0.75, na.rm = TRUE))"
"0","      iqr <- q3 - q1"
"0","      lower <- q1 - 1.5 * iqr"
"0","      upper <- q3 + 1.5 * iqr"
"0","      out_n <- sum(x < lower | x > upper, na.rm = TRUE)"
"0","      data.frame("
"0","        var = v,"
"0","        n = n,"
"0","        missing_n = miss,"
"0","        missing_pct = round(100 * miss / n_tot, 1),"
"0","        mean = mean(x, na.rm = TRUE),"
"0","        sd = stats::sd(x, na.rm = TRUE),"
"0","        median = stats::median(x, na.rm = TRUE),"
"0","        q1 = q1, q3 = q3, IQR = iqr,"
"0","        min = suppressWarnings(min(x, na.rm = TRUE)),"
"0","        max = suppressWarnings(max(x, na.rm = TRUE)),"
"0","        outlier_n = out_n,"
"0","        outlier_pct = round(100 * out_n / n, 1),"
"0","        stringsAsFactors = FALSE"
"0","      )"
"0","    }"
"0","  }))"
"0","} else {"
"0","  data.frame()"
"0","}"
"0",""
"0","# 5) カテゴリ頻度・割合（NA も一緒に出す）"
"0","cat_summary <- if (length(cat_vars)) {"
"0","  do.call(rbind, lapply(cat_vars, function(v){"
"0","    x <- df_sub[[v]]"
"0","    # 0/1 でも factor 化してラベルは「0」「1」に統一"
"0","    if (is.numeric(x)) x <- factor(x)"
"0","    tbl <- as.data.frame(table(x, useNA = ""ifany""), stringsAsFactors = FALSE)"
"0","    names(tbl) <- c(""level"",""n"")"
"0","    tbl$var <- v"
"0","    tbl <- tbl %>%"
"0","      dplyr::mutate(pct = round(100 * n / sum(n), 1)) %>%"
"0","      dplyr::select(var, level, n, pct)"
"0","    tbl"
"0","  }))"
"0","} else {"
"0","  data.frame()"
"0","}"
"0",""
"0","# 6) 欠損サマリ（対象変数のみ）"
"0","missingness <- data.frame("
"0","  var = names(df_sub),"
"0","  missing_n = sapply(df_sub, function(x) sum(is.na(x))),"
"0","  missing_pct = round(100 * sapply(df_sub, function(x) mean(is.na(x))), 1),"
"0","  stringsAsFactors = FALSE"
"0",") %>% arrange(desc(missing_pct), var)"
"0",""
"0","# 7) 表示（必要なら write.csv で保存も可）"
"0","message(""■ 数値記述統計（mean, sd, median, IQR, 外れ値など）"")"
"2","■ 数値記述統計（mean, sd, median, IQR, 外れ値など）
"
"0","print(num_summary, row.names = FALSE)"
