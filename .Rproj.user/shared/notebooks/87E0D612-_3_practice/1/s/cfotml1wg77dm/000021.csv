"0","# ===== CHUNK 3 — 2年再発（早期再発）に対する単変量Cox：p<0.20抽出（右スキューはログ/Albは反転ログ） ====="
"0","stopifnot(exists(""ds03""))"
"0",""
"0","# ---- 2年アウトカム（ERASLと同義）----"
"0","ds04 <- ds03 %>%"
"0","  dplyr::mutate("
"0","    time2y  = ifelse(is.na(time), NA_real_, pmin(time, 24)),"
"0","    event2y = dplyr::case_when("
"0","      !is.na(status) & !is.na(time) & status==1L & time <= 24 ~ 1L,"
"0","      !is.na(status) & !is.na(time)                            ~ 0L,"
"0","      TRUE                                                    ~ NA_integer_"
"0","    )"
"0","  )"
"0",""
"0","# ---- p値（LRT）を1本ずつ返す関数（因子は項目全体のp）----"
"0","cox_p <- function(formula_obj){"
"0","  fit <- try(survival::coxph(formula_obj, data = ds04, ties = ""efron""), silent = TRUE)"
"0","  if (inherits(fit, ""try-error"")) return(NA_real_)"
"0","  a <- try(anova(fit, test = ""Chisq""), silent = TRUE)"
"0","  if (inherits(a, ""try-error"")) return(NA_real_)"
"0","  pcol <- which(colnames(a) %in% c(""Pr(>|Chi|)"", ""P(>|Chi|)""))"
"0","  if (length(pcol) == 0) return(NA_real_)"
"0","  as.numeric(tail(a[[pcol]], 1))"
"0","}"
"0",""
"0","# ===== 連続（ログ/反転ログのみ採用するもの） ====="
"0","p_ln_afp         <- if (""ln_afp"" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ ln_afp)         else NA_real_"
"0","p_ln_tbil        <- if (""ln_tbil"" %in% names(ds04))        cox_p(Surv(time2y, event2y) ~ ln_tbil)        else NA_real_"
"0","p_ln_plt         <- if (""ln_plt"" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ ln_plt)         else NA_real_"
"0","p_ln_tum_pre_cm  <- if (""ln_tum_pre_cm"" %in% names(ds04))  cox_p(Surv(time2y, event2y) ~ ln_tum_pre_cm)  else NA_real_"
"0","p_ln_max_diam_cm <- if (""ln_max_diam_cm"" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ ln_max_diam_cm) else NA_real_"
"0","p_revlog_alb     <- if (""revlog_alb"" %in% names(ds04))     cox_p(Surv(time2y, event2y) ~ revlog_alb)     else NA_real_"
"0",""
"0","# ===== 連続（ログ化不要な候補） ====="
"0","p_afp_l3      <- if (""afp_l3"" %in% names(ds04))      cox_p(Surv(time2y, event2y) ~ afp_l3)      else NA_real_"
"0","p_age         <- if (""age"" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ age)         else NA_real_"
"0","p_alt         <- if (""alt"" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ alt)         else NA_real_"
"0","p_ast         <- if (""ast"" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ ast)         else NA_real_"
"0","p_bleed_ml    <- if (""bleed_ml"" %in% names(ds04))    cox_p(Surv(time2y, event2y) ~ bleed_ml)    else NA_real_"
"0","p_ca19_9      <- if (""ca19_9"" %in% names(ds04))      cox_p(Surv(time2y, event2y) ~ ca19_9)      else NA_real_"
"0","p_cea         <- if (""cea"" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ cea)         else NA_real_"
"0","p_che         <- if (""che"" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ che)         else NA_real_"
"0","p_icg_r15     <- if (""icg_r15"" %in% names(ds04))     cox_p(Surv(time2y, event2y) ~ icg_r15)     else NA_real_"
"0","p_lhl15       <- if (""lhl15"" %in% names(ds04))       cox_p(Surv(time2y, event2y) ~ lhl15)       else NA_real_"
"0","p_n           <- if (""n"" %in% names(ds04))           cox_p(Surv(time2y, event2y) ~ n)           else NA_real_"
"0","p_op_time_min <- if (""op_time_min"" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ op_time_min) else NA_real_"
"0","p_pivka2      <- if (""pivka2"" %in% names(ds04))      cox_p(Surv(time2y, event2y) ~ pivka2)      else NA_real_"
"0","p_pt_inr      <- if (""pt_inr"" %in% names(ds04))      cox_p(Surv(time2y, event2y) ~ pt_inr)      else NA_real_"
"0","p_specimen_wt <- if (""specimen_wt"" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ specimen_wt) else NA_real_"
"0","p_weight_kg   <- if (""weight_kg"" %in% names(ds04))   cox_p(Surv(time2y, event2y) ~ weight_kg)   else NA_real_"
"0","p_tum_count   <- if (""tum_count_pre"" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ tum_count_pre) else NA_real_"
"0",""
"0","# ===== カテゴリ ====="
"0","p_b_path       <- if (""b_path"" %in% names(ds04))       cox_p(Surv(time2y, event2y) ~ factor(b_path))       else NA_real_"
"0","p_child_pugh   <- if (""child_pugh"" %in% names(ds04))   cox_p(Surv(time2y, event2y) ~ factor(child_pugh))   else NA_real_"
"0","p_fc           <- if (""fc"" %in% names(ds04))           cox_p(Surv(time2y, event2y) ~ factor(fc))           else NA_real_"
"0","p_fc_inf       <- if (""fc_inf"" %in% names(ds04))       cox_p(Surv(time2y, event2y) ~ factor(fc_inf))       else NA_real_"
"0","p_fibrosis     <- if (""fibrosis_score"" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ factor(fibrosis_score)) else NA_real_"
"0","p_group_rb     <- if (""group_rb"" %in% names(ds04))     cox_p(Surv(time2y, event2y) ~ factor(group_rb))     else NA_real_"
"0","p_growth_type  <- if (""growth_type"" %in% names(ds04))  cox_p(Surv(time2y, event2y) ~ factor(growth_type))  else NA_real_"
"0","p_hbv          <- if (""hbv"" %in% names(ds04))          cox_p(Surv(time2y, event2y) ~ factor(hbv))          else NA_real_"
"0","p_hcv          <- if (""hcv"" %in% names(ds04))          cox_p(Surv(time2y, event2y) ~ factor(hcv))          else NA_real_"
"0","p_im           <- if (""im"" %in% names(ds04))           cox_p(Surv(time2y, event2y) ~ factor(im))           else NA_real_"
"2","Warning: Loglik converged before variable  1,2,3,4,5 ; coefficient may be infinite. "
"0","p_liver_damage <- if (""liver_damage"" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ factor(liver_damage)) else NA_real_"
"2","Warning: Loglik converged before variable  1,2 ; coefficient may be infinite. "
"0","p_m            <- if (""m"" %in% names(ds04))            cox_p(Surv(time2y, event2y) ~ factor(m))            else NA_real_"
"0","p_sf           <- if (""sf"" %in% names(ds04))           cox_p(Surv(time2y, event2y) ~ factor(sf))           else NA_real_"
"0","p_sm           <- if (""sm"" %in% names(ds04))           cox_p(Surv(time2y, event2y) ~ factor(sm))           else NA_real_"
"0","p_stage        <- if (""stage"" %in% names(ds04))        cox_p(Surv(time2y, event2y) ~ factor(stage))        else NA_real_"
"2","Warning: Loglik converged before variable  1,2,3,4,5 ; coefficient may be infinite. "
"0","p_t            <- if (""t"" %in% names(ds04))            cox_p(Surv(time2y, event2y) ~ factor(t))            else NA_real_"
"2","Warning: Loglik converged before variable  1,2,3,4 ; coefficient may be infinite. "
"0","p_sex01        <- if (""sex01"" %in% names(ds04))        cox_p(Surv(time2y, event2y) ~ sex01)                else NA_real_"
"0","p_ALBI         <- if (""ALBI"" %in% names(ds04))         cox_p(Surv(time2y, event2y) ~ ALBI)                 else NA_real_"
"0","p_mvi_01       <- if (""mvi_01"" %in% names(ds04))       cox_p(Surv(time2y, event2y) ~ mvi_01)               else NA_real_"
"0","p_tnum_cat     <- if (""tnum_cat"" %in% names(ds04))     cox_p(Surv(time2y, event2y) ~ tnum_cat)             else NA_real_"
"0","p_macro_preVI  <- if (""macro_vi_pre01"" %in% names(ds04)) cox_p(Surv(time2y, event2y) ~ macro_vi_pre01)     else NA_real_"
"0",""
"0","# ---- p値一覧 → p<0.20を抽出 ----"
"0","p_map <- c("
"0","  # 連続（ログ/反転ログ）"
"0","  ln_afp = p_ln_afp, ln_tbil = p_ln_tbil, ln_plt = p_ln_plt,"
"0","  ln_tum_pre_cm = p_ln_tum_pre_cm, ln_max_diam_cm = p_ln_max_diam_cm, revlog_alb = p_revlog_alb,"
"0","  # 連続（その他）"
"0","  afp_l3 = p_afp_l3, age = p_age, alt = p_alt, ast = p_ast, bleed_ml = p_bleed_ml,"
"0","  ca19_9 = p_ca19_9, cea = p_cea, che = p_che, icg_r15 = p_icg_r15, lhl15 = p_lhl15,"
"0","  n = p_n, op_time_min = p_op_time_min, pivka2 = p_pivka2, pt_inr = p_pt_inr,"
"0","  specimen_wt = p_specimen_wt, weight_kg = p_weight_kg, tum_count_pre = p_tum_count,"
"0","  # カテゴリ"
"0","  b_path = p_b_path, child_pugh = p_child_pugh, fc = p_fc, fc_inf = p_fc_inf,"
"0","  fibrosis_score = p_fibrosis, group_rb = p_group_rb, growth_type = p_growth_type,"
"0","  hbv = p_hbv, hcv = p_hcv, im = p_im, liver_damage = p_liver_damage, m = p_m,"
"0","  sf = p_sf, sm = p_sm, stage = p_stage, t = p_t, sex01 = p_sex01,"
"0","  ALBI = p_ALBI, mvi_01 = p_mvi_01, tnum_cat = p_tnum_cat, macro_vi_pre01 = p_macro_preVI"
"0",")"
"0",""
"0","uv_pvals <- data.frame("
"0","  var = names(p_map),"
"0","  p   = as.numeric(p_map),"
"0","  stringsAsFactors = FALSE"
"0",")"
"0","uv_pvals <- uv_pvals[order(uv_pvals$p), ]"
"0","screened_vars <- uv_pvals$var[is.finite(uv_pvals$p) & uv_pvals$p < 0.20]"
"0",""
"0","print(uv_pvals)"
