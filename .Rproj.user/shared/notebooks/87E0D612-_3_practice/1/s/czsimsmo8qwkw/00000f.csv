"0","# ===== 書き直しコード1：ds02 作成（行・列フィルタ）＋ 変数一覧出力 ====="
"0","# 前提：ds01_model が存在"
"0","stopifnot(exists(""ds01_model""))"
"0",""
"0","# 出力先"
"0","out_dir <- ""/Users/yoshidatakuto/Dropbox/Hokkaido University/大学院医学院/Borderline HCC/Prediction model_Project1/03_Output"""
"0","if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)"
"0",""
"0","# 不要列リスト"
"0","drop_vars <- c("
"0","  ""adm_dt"",""age_grp60"",""afp500_cat"",""comp_any_grade"",""comp_ascites"",""comp_bile"",""comp_bleeding"","
"0","  ""comp_gi"",""comp_pleural"",""comp_resp"",""comp_txt"",""comp_wound"",""curability"",""dob"","
"0","  ""fibrosis_score_old"",""first_visit_dt"",""func_resect_rate"",""grade_old"",""grade_txt"","
"0","  ""grading_score_old"",""group"",""hbv_past"",""icg10_cat"",""nc_liver_stage_old"",""nh3"","
"0","  ""num"",""op_date"",""op_dx_txt"",""op_proc_cat"",""op_proc_txt"",""pivka200_cat"",""pofil"","
"0","  ""pre_func_rate"",""pre_liver_vol"",""pre_remnant_vol"",""pre_tumor_vol"",""pringle"",""ps"","
"0","  ""ptpe"",""rehepatectomy"",""surgeon_name"",""tbil_post_grade"",""thoraco_lap"",""uni_vs_2to3"","
"0","  ""w2_func_rate"",""w2_liver_vol"",""w2_tumor_vol"",""stage_diag"",""stage_surg"",""tnum_cat"""
"0",")"
"0",""
"0","# 1) 行フィルタ：group が ""Con"" または ""NAC"" を除外"
"0","df <- ds01_model"
"0","if (""group"" %in% names(df)) {"
"0","  df <- df[ !(tolower(df$group) %in% c(""con"",""nac"")), , drop = FALSE ]"
"0","}"
"0",""
"0","# 2) 欠測30%以上の列を削除"
"0","miss_frac <- sapply(df, function(x) mean(is.na(x)))"
"0","df <- df[ , miss_frac < 0.30 | is.na(miss_frac), drop = FALSE ]"
"0",""
"0","# 3) 指定の不要列を削除（存在するものだけ）"
"0","df <- df[ , setdiff(names(df), drop_vars), drop = FALSE ]"
"0",""
"0","# 4) 完成データ"
"0","ds02 <- df"
"0",""
"0","# 5) 変数一覧CSV出力"
"0","n  <- nrow(ds02)"
"0","nm <- names(ds02)"
"0","cls <- sapply(ds02, function(x) class(x)[1])"
"0","n_miss <- sapply(ds02, function(x) sum(is.na(x)))"
"0","pct_miss <- round(100 * n_miss / max(n,1), 1)"
"0","n_unique <- sapply(ds02, function(x) length(unique(x[!is.na(x)])))"
"0","example <- sapply(ds02, function(x){"
"0","  v <- x[!is.na(x)]"
"0","  if (!length(v)) """" else paste(head(as.character(v), 3), collapse = "", "")"
"0","})"
"0","out <- data.frame("
"0","  name = nm, class = cls, n = n, n_miss = n_miss,"
"0","  pct_miss = pct_miss, n_unique = n_unique, example = example,"
"0","  stringsAsFactors = FALSE"
"0",")"
"0","out <- out[order(out$name), ]"
"0","outfile <- file.path(out_dir, ""ds02_variables.csv"")"
"0","utils::write.csv(out, outfile, row.names = FALSE, fileEncoding = ""UTF-8"")"
"0","cat(""Saved ds02_variables.csv to: "", outfile, ""\n"")"
"1","Saved ds02_variables.csv to: "
"1"," "
"1","/Users/yoshidatakuto/Dropbox/Hokkaido University/大学院医学院/Borderline HCC/Prediction model_Project1/03_Output/ds02_variables.csv"
"1"," "
"1","
"
