"0","# ===== 書き直しコード2：CHUNK1 — ds02→ds03（ALBI/MVI/MacroVI作成＋対数変換まで） ====="
"0","stopifnot(exists(""ds02""))"
"0",""
"0","# ---- Helpers ----"
"0","log_safely <- function(x, eps = 1e-6) log(pmax(as.numeric(x), eps))"
"0","mk_tnum_cat <- function(k){"
"0","  k <- suppressWarnings(as.integer(k))"
"0","  dplyr::case_when("
"0","    is.na(k)    ~ NA_integer_,"
"0","    k <= 1      ~ 0L,"
"0","    k %in% 2:3  ~ 1L,"
"0","    k >= 4      ~ 2L"
"0","  )"
"0","}"
"0","sex_to01 <- function(s){"
"0","  x <- as.character(s); x <- trimws(x)"
"0","  out <- rep(NA_real_, length(x))"
"0","  out[grepl(""^(M|Male|male|m|1)$"", x)] <- 1"
"0","  out[grepl(""^(F|Female|female|f|0)$"", x)] <- 0"
"0","  suppressWarnings({"
"0","    xn <- as.numeric(x)"
"0","    out[is.na(out) & !is.na(xn)] <- ifelse(xn >= 1, 1, 0)"
"0","  })"
"0","  out"
"0","}"
"0","bin_to01 <- function(v){   # ""+""/""pos""/""陽性""/1 →1,  ""−""/""neg""/""陰性""/0 →0"
"0","  x <- as.character(v); x <- trimws(x)"
"0","  out <- rep(NA_integer_, length(x))"
"0","  out[grepl(""^(1|\\+|pos|positive|yes|true|陽性)$"", x, ignore.case = TRUE)] <- 1L"
"0","  out[grepl(""^(0|-|neg|negative|no|false|陰性)$"",   x, ignore.case = TRUE)] <- 0L"
"0","  suppressWarnings({"
"0","    xn <- as.numeric(x)"
"0","    out[is.na(out) & !is.na(xn)] <- as.integer(xn > 0)"
"0","  })"
"0","  out"
"0","}"
"0","calc_albi <- function(alb_g_dl, tbil_mg_dl){"
"0","  alb_g_l   <- alb_g_dl * 10"
"0","  tbil_umol <- tbil_mg_dl * 17.1"
"0","  score <- 0.66*log10(pmax(tbil_umol, 1e-6)) - 0.085*alb_g_l"
"0","  grade <- dplyr::case_when("
"0","    is.na(score)     ~ NA_integer_,"
"0","    score <= -2.60   ~ 1L,"
"0","    score <= -1.39   ~ 2L,"
"0","    TRUE             ~ 3L"
"0","  )"
"0","  tibble::tibble(albi_score = score, albi_grade = grade)"
"0","}"
"0",""
"0","# ---- 前処理：必要列の型そろえ ----"
"0","ds02 <- ds02 %>%"
"0","  dplyr::mutate("
"0","    alb  = suppressWarnings(as.numeric(alb)),"
"0","    tbil = suppressWarnings(as.numeric(tbil))"
"0","  )"
"0",""
"0","# ---- ALBI（無ければ作成） ----"
"0","if (!all(c(""albi_score"",""albi_grade"") %in% names(ds02)) || all(is.na(ds02$albi_score))) {"
"0","  albi_tmp <- calc_albi(ds02$alb, ds02$tbil)"
"0","  ds02 <- dplyr::bind_cols(ds02, albi_tmp)"
"0","}"
"0",""
"0","# ---- MVI（無ければ作成：pre陰性 & path陽性 →1）----"
"0","if (!(""mvi_01"" %in% names(ds02))) {"
"0","  ds02 <- ds02 %>%"
"0","    dplyr::mutate("
"0","      vp_pre  = suppressWarnings(as.integer(vp_pre)),"
"0","      vv_pre  = suppressWarnings(as.integer(vv_pre)),"
"0","      vp_path = suppressWarnings(as.integer(vp_path)),"
"0","      vv_path = suppressWarnings(as.integer(vv_path)),"
"0","      mvi_01 = dplyr::case_when("
"0","        (!is.na(vp_pre) & vp_pre==0L & !is.na(vp_path) & vp_path >= 1L) ~ 1L,"
"0","        (!is.na(vv_pre) & vv_pre==0L & !is.na(vv_path) & vv_path >= 1L) ~ 1L,"
"0","        (!is.na(vp_pre) & vp_pre==0L & !is.na(vp_path) & vp_path==0L &"
"0","         !is.na(vv_pre) & vv_pre==0L & !is.na(vv_path) & vv_path==0L)   ~ 0L,"
"0","        TRUE ~ NA_integer_"
"0","      )"
"0","    )"
"0","}"
"0",""
"0","# ---- Macro vascular invasion（新規追加：Vp_pre / Va_pre / Vv_pre のいずれか陽性で1）----"
"0","vp_pre_x <- if (""vp_pre"" %in% names(ds02)) bin_to01(ds02$vp_pre) else rep(NA_integer_, nrow(ds02))"
"0","va_pre_x <- if (""va_pre"" %in% names(ds02)) bin_to01(ds02$va_pre) else rep(NA_integer_, nrow(ds02))"
"0","vv_pre_x <- if (""vv_pre"" %in% names(ds02)) bin_to01(ds02$vv_pre) else rep(NA_integer_, nrow(ds02))"
"0","pos_any  <- (vp_pre_x == 1L) | (va_pre_x == 1L) | (vv_pre_x == 1L)"
"0","all_zero <- (vp_pre_x %in% 0L | is.na(vp_pre_x)) &"
"0","            (va_pre_x %in% 0L | is.na(va_pre_x)) &"
"0","            (vv_pre_x %in% 0L | is.na(vv_pre_x))"
"0","macro_vi_pre01 <- ifelse(pos_any, 1L, ifelse(all_zero, 0L, NA_integer_))"
"0","ds02$macro_vi_pre01 <- macro_vi_pre01"
"0",""
"0","# ---- ds03：解析用の整形＋対数変換 ----"
"0","ds03 <- ds02 %>%"
"0","  dplyr::mutate("
"0","    .id    = id,"
"0","    time   = as.numeric(rfs_months),"
"0","    status = as.integer(recur_tf),"
"0",""
"0","    afp          = suppressWarnings(as.numeric(afp)),"
"0","    afp_l3       = suppressWarnings(as.numeric(afp_l3)),"
"0","    age          = suppressWarnings(as.numeric(age)),"
"0","    alb          = suppressWarnings(as.numeric(alb)),"
"0","    alt          = suppressWarnings(as.numeric(alt)),"
"0","    ast          = suppressWarnings(as.numeric(ast)),"
"0","    bleed_ml     = suppressWarnings(as.numeric(bleed_ml)),"
"0","    ca19_9       = suppressWarnings(as.numeric(ca19_9)),"
"0","    cea          = suppressWarnings(as.numeric(cea)),"
"0","    che          = suppressWarnings(as.numeric(che)),"
"0","    icg_r15      = suppressWarnings(as.numeric(icg_r15)),"
"0","    lhl15        = suppressWarnings(as.numeric(lhl15)),"
"0","    max_diam_cm  = suppressWarnings(as.numeric(max_diam_cm)),"
"0","    n            = suppressWarnings(as.numeric(n)),"
"0","    op_time_min  = suppressWarnings(as.numeric(op_time_min)),"
"0","    pivka2       = suppressWarnings(as.numeric(pivka2)),"
"0","    plt          = suppressWarnings(as.numeric(plt)),"
"0","    pt_inr       = suppressWarnings(as.numeric(pt_inr)),"
"0","    specimen_wt  = suppressWarnings(as.numeric(specimen_wt)),"
"0","    tbil         = suppressWarnings(as.numeric(tbil)),"
"0","    tum_count_pre= suppressWarnings(as.integer(tum_count_pre)),"
"0","    tum_diam_pre = suppressWarnings(as.numeric(tum_diam_pre)),"
"0","    weight_kg    = suppressWarnings(as.numeric(weight_kg)),"
"0",""
"0","    sex01        = sex_to01(sex),"
"0",""
"0","    ALBI     = suppressWarnings(as.numeric(albi_score)),"
"0","    ALBI_g   = suppressWarnings(as.integer(albi_grade)),"
"0","    ALBI_23  = dplyr::if_else(is.na(ALBI_g), NA_integer_, dplyr::if_else(ALBI_g==1L, 0L, 1L)),"
"0","    mvi_01   = suppressWarnings(as.integer(mvi_01)),"
"0",""
"0","    ln_afp         = log_safely(afp),"
"0","    ln_tbil        = log_safely(tbil),"
"0","    ln_plt         = log_safely(plt),"
"0","    ln_tum_pre_cm  = log_safely(tum_diam_pre),"
"0","    ln_max_diam_cm = log_safely(max_diam_cm),"
"0",""
"0","    revlog_alb = { mx <- suppressWarnings(max(alb, na.rm = TRUE)); log_safely(mx + 1 - alb) },"
"0",""
"0","    tnum_cat = mk_tnum_cat(tum_count_pre)"
"0","  ) %>%"
"0","  dplyr::select(dplyr::any_of(c("
"0","    # アウトカム"
"0","    "".id"",""time"",""status"","
"0","    # 原候補（連続）"
"0","    ""afp"",""afp_l3"",""age"",""alb"",""alt"",""ast"",""bleed_ml"",""ca19_9"",""cea"",""che"","
"0","    ""icg_r15"",""lhl15"",""max_diam_cm"",""n"",""op_time_min"",""pivka2"",""plt"",""pt_inr"","
"0","    ""specimen_wt"",""tbil"",""tum_count_pre"",""tum_diam_pre"",""weight_kg"","
"0","    # 原候補（カテゴリ）"
"0","    ""b_path"",""child_pugh"",""fc"",""fc_inf"",""fibrosis_score"",""group_rb"",""growth_type"","
"0","    ""hbv"",""hcv"",""im"",""liver_damage"",""m"",""sf"",""sm"",""stage"",""t"","
"0","    # 追加：Macro VI（pre）"
"0","    ""macro_vi_pre01"","
"0","    # 置換/派生"
"0","    ""sex01"",""ALBI"",""ALBI_g"",""ALBI_23"",""mvi_01"",""tnum_cat"","
"0","    ""ln_afp"",""ln_tbil"",""ln_plt"",""ln_tum_pre_cm"",""ln_max_diam_cm"",""revlog_alb"""
"0","  ))) %>%"
"0","  dplyr::mutate("
"0","    status   = dplyr::if_else(is.na(status), NA_integer_, as.integer(status == 1L)),"
"0","    tnum_cat = factor(tnum_cat, levels = c(0,1,2), labels = c(""single"",""two_three"",""ge4""))"
"0","  )"
"0",""
"0","# 確認（不足カラム表示）"
"0","needed <- c("
"0","  ""afp"",""afp_l3"",""age"",""alb"",""alt"",""ast"",""bleed_ml"",""ca19_9"",""cea"",""che"","
"0","  ""icg_r15"",""lhl15"",""max_diam_cm"",""n"",""op_time_min"",""pivka2"",""plt"",""pt_inr"","
"0","  ""specimen_wt"",""tbil"",""tum_count_pre"",""tum_diam_pre"",""weight_kg"","
"0","  ""b_path"",""child_pugh"",""fc"",""fc_inf"",""fibrosis_score"",""group_rb"",""growth_type"","
"0","  ""hbv"",""hcv"",""im"",""liver_damage"",""m"",""sf"",""sm"",""stage"",""t"","
"0","  ""sex01"",""ALBI"",""mvi_01"",""macro_vi_pre01"",""tnum_cat"","
"0","  ""ln_afp"",""ln_tbil"",""ln_plt"",""ln_tum_pre_cm"",""ln_max_diam_cm"",""revlog_alb"""
"0",")"
"0","miss <- setdiff(needed, names(ds03))"
"0","if(length(miss)) message(""Missing in ds03: "", paste(miss, collapse="", ""))"
"0",""
