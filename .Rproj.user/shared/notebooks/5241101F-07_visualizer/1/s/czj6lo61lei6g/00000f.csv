"0","################################################################################"
"0","# 07_visualizer.R - å¯è¦–åŒ–å‡¦ç†"
"0","# "
"0","# Description: "
"0","#   ãƒ¢ãƒ‡ãƒ«è©•ä¾¡çµæœã®å¯è¦–åŒ–"
"0","#   ROCæ›²ç·šã€ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒƒãƒˆã€DCAã€ç”Ÿå­˜æ›²ç·šã€å¤‰æ•°é‡è¦åº¦"
"0","#   ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ"
"0","#"
"0","# Author: Takuto Yoshida"
"0","# Date: 2024-11-07"
"0","################################################################################"
"0",""
"0","# ========================================================================"
"0","# 1. ROCæ›²ç·š"
"0","# ========================================================================"
"0",""
"0","#' ROCæ›²ç·šã‚’ãƒ—ãƒ­ãƒƒãƒˆ"
"0","#' @param evaluation_results è©•ä¾¡çµæœ"
"0","#' @param dataset ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåï¼ˆ""test"", ""val"", ""train""ï¼‰"
"0","#' @param time_point è©•ä¾¡æ™‚ç‚¹"
"0","#' @param save_path ä¿å­˜å…ˆãƒ‘ã‚¹ï¼ˆNULLæ™‚ã¯ä¿å­˜ã—ãªã„ï¼‰"
"0","#' @return ggplotã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","plot_roc_curves <- function(evaluation_results, "
"0","                           dataset = ""test"","
"0","                           time_point = 24,"
"0","                           save_path = NULL) {"
"0","  "
"0","  message(""\nğŸ“Š Plotting ROC curves..."")"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿æº–å‚™"
"0","  roc_data <- data.frame()"
"0","  auc_values <- data.frame()"
"0","  "
"0","  # å„ãƒ¢ãƒ‡ãƒ«ã®ROCãƒ‡ãƒ¼ã‚¿åé›†"
"0","  for (model_name in names(evaluation_results$results)) {"
"0","    model_result <- evaluation_results$results[[model_name]]"
"0","    "
"0","    if (!is.null(model_result) && !is.null(model_result[[dataset]]$time_auc)) {"
"0","      roc_obj <- model_result[[dataset]]$time_auc$roc_object"
"0","      "
"0","      if (!is.null(roc_obj)) {"
"0","        # æŒ‡å®šæ™‚ç‚¹ã®ROC"
"0","        time_idx <- which(roc_obj$times == time_point)"
"0","        "
"0","        if (length(time_idx) > 0) {"
"0","          # ROCæ›²ç·šã®ãƒã‚¤ãƒ³ãƒˆ"
"0","          fpr <- c(0, roc_obj$FP[, time_idx], 1)"
"0","          tpr <- c(0, roc_obj$TP[, time_idx], 1)"
"0","          "
"0","          roc_data <- rbind(roc_data, data.frame("
"0","            model = model_name,"
"0","            fpr = fpr,"
"0","            tpr = tpr"
"0","          ))"
"0","          "
"0","          # AUCå€¤"
"0","          auc_val <- roc_obj$AUC[time_idx]"
"0","          auc_values <- rbind(auc_values, data.frame("
"0","            model = model_name,"
"0","            auc = auc_val"
"0","          ))"
"0","        }"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # AUCã§ã‚½ãƒ¼ãƒˆ"
"0","  if (nrow(auc_values) > 0) {"
"0","    model_order <- auc_values[order(auc_values$auc, decreasing = TRUE), ""model""]"
"0","    roc_data$model <- factor(roc_data$model, levels = model_order)"
"0","    "
"0","    # ãƒ©ãƒ™ãƒ«ã«AUCã‚’è¿½åŠ "
"0","    auc_labels <- sapply(model_order, function(m) {"
"0","      auc <- auc_values[auc_values$model == m, ""auc""]"
"0","      sprintf(""%s (AUC=%.3f)"", m, auc)"
"0","    })"
"0","    levels(roc_data$model) <- auc_labels"
"0","  }"
"0","  "
"0","  # ãƒ—ãƒ­ãƒƒãƒˆä½œæˆ"
"0","  p <- ggplot(roc_data, aes(x = fpr, y = tpr, color = model)) +"
"0","    geom_line(size = 1) +"
"0","    geom_abline(intercept = 0, slope = 1, linetype = ""dashed"", color = ""gray50"") +"
"0","    scale_x_continuous(limits = c(0, 1), expand = c(0.01, 0.01)) +"
"0","    scale_y_continuous(limits = c(0, 1), expand = c(0.01, 0.01)) +"
"0","    labs("
"0","      title = sprintf(""ROC Curves at %d Months - %s Set"", time_point, stringr::str_to_title(dataset)),"
"0","      x = ""False Positive Rate (1 - Specificity)"","
"0","      y = ""True Positive Rate (Sensitivity)"","
"0","      color = ""Model"""
"0","    ) +"
"0","    theme_minimal(base_size = 12) +"
"0","    theme("
"0","      legend.position = ""bottom"","
"0","      legend.direction = ""vertical"","
"0","      plot.title = element_text(face = ""bold"", hjust = 0.5),"
"0","      panel.grid.minor = element_blank()"
"0","    ) +"
"0","    scale_color_brewer(palette = ""Set1"")"
"0","  "
"0","  # ä¿å­˜"
"0","  if (!is.null(save_path)) {"
"0","    ggsave(save_path, plot = p, width = 8, height = 8, dpi = 300)"
"0","    message(sprintf(""  âœ“ ROC plot saved to: %s"", save_path))"
"0","  }"
"0","  "
"0","  return(p)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 2. ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒƒãƒˆ"
"0","# ========================================================================"
"0",""
"0","#' ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒƒãƒˆ"
"0","#' @param evaluation_results è©•ä¾¡çµæœ"
"0","#' @param model_names ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ãƒ¢ãƒ‡ãƒ«åï¼ˆNULLæ™‚ã¯ä¸Šä½3ãƒ¢ãƒ‡ãƒ«ï¼‰"
"0","#' @param dataset ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå"
"0","#' @param save_path ä¿å­˜å…ˆãƒ‘ã‚¹"
"0","#' @return ggplotã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","plot_calibration <- function(evaluation_results,"
"0","                            model_names = NULL,"
"0","                            dataset = ""test"","
"0","                            save_path = NULL) {"
"0","  "
"0","  message(""\nğŸ“Š Plotting calibration curves..."")"
"0","  "
"0","  # ãƒ¢ãƒ‡ãƒ«é¸æŠ"
"0","  if (is.null(model_names)) {"
"0","    # C-indexã®ä¸Šä½3ãƒ¢ãƒ‡ãƒ«"
"0","    summary_df <- evaluation_results$summary"
"0","    col_name <- paste0(""c_index_"", dataset)"
"0","    if (col_name %in% names(summary_df)) {"
"0","      summary_df <- summary_df[order(summary_df[[col_name]], decreasing = TRUE), ]"
"0","      model_names <- head(summary_df$model, 3)"
"0","    } else {"
"0","      model_names <- names(evaluation_results$results)[1:min(3, length(evaluation_results$results))]"
"0","    }"
"0","  }"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿æº–å‚™"
"0","  cal_data <- data.frame()"
"0","  "
"0","  for (model_name in model_names) {"
"0","    model_result <- evaluation_results$results[[model_name]]"
"0","    "
"0","    if (!is.null(model_result) && !is.null(model_result[[dataset]]$calibration$groups)) {"
"0","      groups <- model_result[[dataset]]$calibration$groups"
"0","      groups$model <- model_name"
"0","      cal_data <- rbind(cal_data, groups)"
"0","    }"
"0","  }"
"0","  "
"0","  if (nrow(cal_data) == 0) {"
"0","    warning(""No calibration data available"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # ãƒ—ãƒ­ãƒƒãƒˆä½œæˆ"
"0","  p <- ggplot(cal_data, aes(x = expected, y = observed)) +"
"0","    geom_point(aes(size = n, color = model), alpha = 0.7) +"
"0","    geom_smooth(aes(color = model), method = ""loess"", se = TRUE, alpha = 0.2) +"
"0","    geom_abline(intercept = 0, slope = 1, linetype = ""dashed"", color = ""gray50"") +"
"0","    scale_x_continuous(limits = c(0, max(cal_data$expected) * 1.1), "
"0","                      labels = scales::percent) +"
"0","    scale_y_continuous(limits = c(0, max(cal_data$observed, na.rm = TRUE) * 1.1), "
"0","                      labels = scales::percent) +"
"0","    labs("
"0","      title = sprintf(""Calibration Plot - %s Set"", stringr::str_to_title(dataset)),"
"0","      x = ""Expected Event Rate"","
"0","      y = ""Observed Event Rate"","
"0","      color = ""Model"","
"0","      size = ""Sample Size"""
"0","    ) +"
"0","    theme_minimal(base_size = 12) +"
"0","    theme("
"0","      legend.position = ""bottom"","
"0","      plot.title = element_text(face = ""bold"", hjust = 0.5),"
"0","      panel.grid.minor = element_blank()"
"0","    ) +"
"0","    scale_color_brewer(palette = ""Set1"")"
"0","  "
"0","  # ä¿å­˜"
"0","  if (!is.null(save_path)) {"
"0","    ggsave(save_path, plot = p, width = 8, height = 6, dpi = 300)"
"0","    message(sprintf(""  âœ“ Calibration plot saved to: %s"", save_path))"
"0","  }"
"0","  "
"0","  return(p)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 3. Decision Curve Analysis ãƒ—ãƒ­ãƒƒãƒˆ"
"0","# ========================================================================"
"0",""
"0","#' DCAãƒ—ãƒ­ãƒƒãƒˆ"
"0","#' @param evaluation_results è©•ä¾¡çµæœ"
"0","#' @param model_names ãƒ—ãƒ­ãƒƒãƒˆã™ã‚‹ãƒ¢ãƒ‡ãƒ«å"
"0","#' @param threshold_range é–¾å€¤ã®ç¯„å›²"
"0","#' @param save_path ä¿å­˜å…ˆãƒ‘ã‚¹"
"0","#' @return ggplotã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","plot_dca <- function(evaluation_results,"
"0","                    model_names = NULL,"
"0","                    threshold_range = c(0.05, 0.30),"
"0","                    save_path = NULL) {"
"0","  "
"0","  message(""\nğŸ“Š Plotting Decision Curve Analysis..."")"
"0","  "
"0","  # ãƒ¢ãƒ‡ãƒ«é¸æŠ"
"0","  if (is.null(model_names)) {"
"0","    # ä¸Šä½3ãƒ¢ãƒ‡ãƒ«"
"0","    summary_df <- evaluation_results$summary"
"0","    summary_df <- summary_df[order(summary_df$c_index_test, decreasing = TRUE), ]"
"0","    model_names <- head(summary_df$model, 3)"
"0","  }"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿æº–å‚™"
"0","  dca_data <- data.frame()"
"0","  "
"0","  for (model_name in model_names) {"
"0","    model_result <- evaluation_results$results[[model_name]]"
"0","    "
"0","    if (!is.null(model_result) && !is.null(model_result$test$dca)) {"
"0","      dca <- model_result$test$dca"
"0","      dca <- dca[dca$threshold >= threshold_range[1] & "
"0","                 dca$threshold <= threshold_range[2], ]"
"0","      "
"0","      # Long format"
"0","      dca_long <- rbind("
"0","        data.frame("
"0","          model = model_name,"
"0","          threshold = dca$threshold,"
"0","          net_benefit = dca$net_benefit_model,"
"0","          strategy = model_name"
"0","        )"
"0","      )"
"0","      "
"0","      dca_data <- rbind(dca_data, dca_long)"
"0","    }"
"0","  }"
"0","  "
"0","  # Treat all/noneè¿½åŠ ï¼ˆ1ã¤ã®ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰ï¼‰"
"0","  if (nrow(dca_data) > 0) {"
"0","    first_model <- evaluation_results$results[[model_names[1]]]$test$dca"
"0","    first_model <- first_model[first_model$threshold >= threshold_range[1] & "
"0","                              first_model$threshold <= threshold_range[2], ]"
"0","    "
"0","    dca_data <- rbind("
"0","      dca_data,"
"0","      data.frame("
"0","        model = ""All"","
"0","        threshold = first_model$threshold,"
"0","        net_benefit = first_model$net_benefit_all,"
"0","        strategy = ""Treat All"""
"0","      ),"
"0","      data.frame("
"0","        model = ""None"","
"0","        threshold = first_model$threshold,"
"0","        net_benefit = first_model$net_benefit_none,"
"0","        strategy = ""Treat None"""
"0","      )"
"0","    )"
"0","  }"
"0","  "
"0","  # ãƒ—ãƒ­ãƒƒãƒˆä½œæˆ"
"0","  p <- ggplot(dca_data, aes(x = threshold, y = net_benefit, color = strategy)) +"
"0","    geom_line(size = 1.2) +"
"0","    scale_x_continuous(limits = threshold_range, labels = scales::percent) +"
"0","    labs("
"0","      title = ""Decision Curve Analysis"","
"0","      x = ""Threshold Probability"","
"0","      y = ""Net Benefit"","
"0","      color = ""Strategy"""
"0","    ) +"
"0","    theme_minimal(base_size = 12) +"
"0","    theme("
"0","      legend.position = ""bottom"","
"0","      plot.title = element_text(face = ""bold"", hjust = 0.5),"
"0","      panel.grid.minor = element_blank()"
"0","    ) +"
"0","    scale_color_manual(values = c("
"0","      RColorBrewer::brewer.pal(length(model_names), ""Set1""),"
"0","      ""gray50"", ""gray70"""
"0","    ))"
"0","  "
"0","  # ä¿å­˜"
"0","  if (!is.null(save_path)) {"
"0","    ggsave(save_path, plot = p, width = 8, height = 6, dpi = 300)"
"0","    message(sprintf(""  âœ“ DCA plot saved to: %s"", save_path))"
"0","  }"
"0","  "
"0","  return(p)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 4. ç”Ÿå­˜æ›²ç·šï¼ˆãƒªã‚¹ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ï¼‰"
"0","# ========================================================================"
"0",""
"0","#' ãƒªã‚¹ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ç”Ÿå­˜æ›²ç·š"
"0","#' @param model ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param data ãƒ‡ãƒ¼ã‚¿"
"0","#' @param n_groups ãƒªã‚¹ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—æ•°"
"0","#' @param save_path ä¿å­˜å…ˆãƒ‘ã‚¹"
"0","#' @return survminerãƒ—ãƒ­ãƒƒãƒˆ"
"0","plot_survival_curves <- function(model, "
"0","                                data,"
"0","                                n_groups = 3,"
"0","                                save_path = NULL) {"
"0","  "
"0","  message(""\nğŸ“Š Plotting survival curves by risk groups..."")"
"0","  "
"0","  if (!requireNamespace(""survminer"", quietly = TRUE)) {"
"0","    warning(""survminer package not available"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ã®è¨ˆç®—"
"0","  if (inherits(model, ""coxph"")) {"
"0","    risk_score <- predict(model, newdata = data, type = ""risk"")"
"0","  } else {"
"0","    # äºˆæ¸¬ç¢ºç‡ã‚’ä½¿ç”¨"
"0","    risk_score <- get_predictions(model, data, time_point = 24)"
"0","  }"
"0","  "
"0","  # ãƒªã‚¹ã‚¯ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ"
"0","  if (n_groups == 2) {"
"0","    risk_groups <- cut(risk_score, "
"0","                      breaks = c(-Inf, median(risk_score, na.rm = TRUE), Inf),"
"0","                      labels = c(""Low Risk"", ""High Risk""))"
"0","  } else if (n_groups == 3) {"
"0","    tertiles <- quantile(risk_score, probs = c(0, 1/3, 2/3, 1), na.rm = TRUE)"
"0","    risk_groups <- cut(risk_score, "
"0","                      breaks = tertiles,"
"0","                      labels = c(""Low Risk"", ""Intermediate Risk"", ""High Risk""),"
"0","                      include.lowest = TRUE)"
"0","  } else {"
"0","    quantiles <- quantile(risk_score, "
"0","                         probs = seq(0, 1, length.out = n_groups + 1), "
"0","                         na.rm = TRUE)"
"0","    risk_groups <- cut(risk_score, "
"0","                      breaks = quantiles,"
"0","                      labels = paste0(""Group "", 1:n_groups),"
"0","                      include.lowest = TRUE)"
"0","  }"
"0","  "
"0","  data$risk_group <- risk_groups"
"0","  "
"0","  # Kaplan-Meierç”Ÿå­˜æ›²ç·š"
"0","  km_fit <- survival::survfit("
"0","    survival::Surv(time2y, recur_2y) ~ risk_group, "
"0","    data = data"
"0","  )"
"0","  "
"0","  # ãƒ—ãƒ­ãƒƒãƒˆ"
"0","  p <- survminer::ggsurvplot("
"0","    km_fit,"
"0","    data = data,"
"0","    risk.table = TRUE,"
"0","    risk.table.height = 0.25,"
"0","    pval = TRUE,"
"0","    pval.method = TRUE,"
"0","    conf.int = TRUE,"
"0","    xlim = c(0, 24),"
"0","    break.time.by = 6,"
"0","    xlab = ""Time (months)"","
"0","    ylab = ""Recurrence-free Probability"","
"0","    title = ""Survival Curves by Risk Groups"","
"0","    palette = ""jco"","
"0","    legend.title = ""Risk Group"","
"0","    legend.labs = levels(risk_groups),"
"0","    ggtheme = theme_minimal(base_size = 12)"
"0","  )"
"0","  "
"0","  # ä¿å­˜"
"0","  if (!is.null(save_path)) {"
"0","    pdf(save_path, width = 10, height = 8)"
"0","    print(p)"
"0","    dev.off()"
"0","    message(sprintf(""  âœ“ Survival plot saved to: %s"", save_path))"
"0","  }"
"0","  "
"0","  return(p)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 5. å¤‰æ•°é‡è¦åº¦ãƒ—ãƒ­ãƒƒãƒˆ"
"0","# ========================================================================"
"0",""
"0","#' å¤‰æ•°é‡è¦åº¦ã‚’ãƒ—ãƒ­ãƒƒãƒˆ"
"0","#' @param models ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ"
"0","#' @param top_n è¡¨ç¤ºã™ã‚‹ä¸Šä½å¤‰æ•°æ•°"
"0","#' @param save_path ä¿å­˜å…ˆãƒ‘ã‚¹"
"0","#' @return ggplotã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","plot_variable_importance <- function(models, "
"0","                                    top_n = 20,"
"0","                                    save_path = NULL) {"
"0","  "
"0","  message(""\nğŸ“Š Plotting variable importance..."")"
"0","  "
"0","  # å„ãƒ¢ãƒ‡ãƒ«ã‹ã‚‰å¤‰æ•°é‡è¦åº¦ã‚’æŠ½å‡º"
"0","  importance_data <- data.frame()"
"0","  "
"0","  for (model_name in names(models)) {"
"0","    model <- models[[model_name]]"
"0","    "
"0","    if (!is.null(model)) {"
"0","      # Coxãƒ¢ãƒ‡ãƒ«"
"0","      if (inherits(model, ""coxph"")) {"
"0","        coef_summary <- summary(model)$coefficients"
"0","        importance <- data.frame("
"0","          model = model_name,"
"0","          variable = rownames(coef_summary),"
"0","          importance = abs(coef_summary[, ""z""]),"
"0","          coefficient = coef_summary[, ""coef""],"
"0","          hr = exp(coef_summary[, ""coef""])"
"0","        )"
"0","        "
"0","      # LASSOãƒ¢ãƒ‡ãƒ«"
"0","      } else if (inherits(model, ""lasso_cox"")) {"
"0","        coef_matrix <- as.matrix(coef(model$glmnet_model, s = model$lambda_min))"
"0","        non_zero <- which(coef_matrix[, 1] != 0)"
"0","        if (length(non_zero) > 0) {"
"0","          importance <- data.frame("
"0","            model = model_name,"
"0","            variable = rownames(coef_matrix)[non_zero],"
"0","            importance = abs(coef_matrix[non_zero, 1]),"
"0","            coefficient = coef_matrix[non_zero, 1],"
"0","            hr = exp(coef_matrix[non_zero, 1])"
"0","          )"
"0","        }"
"0","        "
"0","      # ãã®ä»–ã®ãƒ¢ãƒ‡ãƒ«"
"0","      } else {"
"0","        selected_vars <- attr(model, ""selected_vars"")"
"0","        if (!is.null(selected_vars)) {"
"0","          importance <- data.frame("
"0","            model = model_name,"
"0","            variable = selected_vars,"
"0","            importance = 1,"
"0","            coefficient = NA,"
"0","            hr = NA"
"0","          )"
"0","        }"
"0","      }"
"0","      "
"0","      if (exists(""importance"")) {"
"0","        importance_data <- rbind(importance_data, importance)"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # å¤‰æ•°ã®å‡ºç¾é »åº¦ã‚’è¨ˆç®—"
"0","  var_freq <- table(importance_data$variable)"
"0","  var_freq <- sort(var_freq, decreasing = TRUE)"
"0","  "
"0","  # ä¸Šä½å¤‰æ•°ã‚’é¸æŠ"
"0","  top_vars <- names(head(var_freq, top_n))"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°"
"0","  plot_data <- importance_data[importance_data$variable %in% top_vars, ]"
"0","  "
"0","  # å¹³å‡é‡è¦åº¦ã§ä¸¦ã¹æ›¿ãˆ"
"0","  var_order <- aggregate(importance ~ variable, data = plot_data, FUN = mean)"
"0","  var_order <- var_order[order(var_order$importance, decreasing = TRUE), ]"
"0","  plot_data$variable <- factor(plot_data$variable, levels = rev(var_order$variable))"
"0","  "
"0","  # ãƒ—ãƒ­ãƒƒãƒˆä½œæˆ"
"0","  p <- ggplot(plot_data, aes(x = variable, y = importance, fill = model)) +"
"0","    geom_bar(stat = ""identity"", position = ""dodge"") +"
"0","    coord_flip() +"
"0","    labs("
"0","      title = sprintf(""Top %d Variable Importance Across Models"", min(top_n, length(unique(plot_data$variable)))),"
"0","      x = ""Variable"","
"0","      y = ""Importance (|z-score| or |coefficient|)"","
"0","      fill = ""Model"""
"0","    ) +"
"0","    theme_minimal(base_size = 12) +"
"0","    theme("
"0","      legend.position = ""bottom"","
"0","      plot.title = element_text(face = ""bold"", hjust = 0.5),"
"0","      panel.grid.minor = element_blank()"
"0","    ) +"
"0","    scale_fill_brewer(palette = ""Set1"")"
"0","  "
"0","  # ä¿å­˜"
"0","  if (!is.null(save_path)) {"
"0","    ggsave(save_path, plot = p, width = 10, height = 8, dpi = 300)"
"0","    message(sprintf(""  âœ“ Variable importance plot saved to: %s"", save_path))"
"0","  }"
"0","  "
"0","  return(p)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 6. ãƒ¢ãƒ‡ãƒ«æ¯”è¼ƒã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«"
"0","# ========================================================================"
"0",""
"0","#' ç¾ã—ã„ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ"
"0","#' @param evaluation_results è©•ä¾¡çµæœ"
"0","#' @param output_path ä¿å­˜å…ˆãƒ‘ã‚¹"
"0","#' @return gtãƒ†ãƒ¼ãƒ–ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","create_summary_table <- function(evaluation_results, "
"0","                                output_path = NULL) {"
"0","  "
"0","  message(""\nğŸ“Š Creating summary table..."")"
"0","  "
"0","  if (!requireNamespace(""gt"", quietly = TRUE)) {"
"0","    warning(""gt package not available"")"
"0","    return(evaluation_results$summary)"
"0","  }"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿æº–å‚™"
"0","  summary_df <- evaluation_results$summary"
"0","  "
"0","  # åˆ—åã‚’æ•´å½¢"
"0","  names(summary_df) <- c("
"0","    ""Model"", ""N Variables"","
"0","    ""C-index (Train)"", ""C-index (Val)"", ""C-index (Test)"","
"0","    ""Brier Score"""
"0","  )"
"0","  "
"0","  # gtãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ"
"0","  gt_table <- gt::gt(summary_df) %>%"
"0","    gt::tab_header("
"0","      title = ""Model Performance Comparison"","
"0","      subtitle = ""2-Year Recurrence Prediction"""
"0","    ) %>%"
"0","    gt::fmt_number("
"0","      columns = c(""C-index (Train)"", ""C-index (Val)"", ""C-index (Test)"", ""Brier Score""),"
"0","      decimals = 3"
"0","    ) %>%"
"0","    gt::fmt_number("
"0","      columns = ""N Variables"","
"0","      decimals = 0"
"0","    ) %>%"
"0","    gt::data_color("
"0","      columns = ""C-index (Test)"","
"0","      colors = scales::col_numeric("
"0","        palette = c(""white"", ""lightgreen""),"
"0","        domain = c(0.5, 1)"
"0","      )"
"0","    ) %>%"
"0","    gt::data_color("
"0","      columns = ""Brier Score"","
"0","      colors = scales::col_numeric("
"0","        palette = c(""lightgreen"", ""white""),"
"0","        domain = c(0, 0.5)"
"0","      )"
"0","    ) %>%"
"0","    gt::tab_style("
"0","      style = gt::cell_text(weight = ""bold""),"
"0","      locations = gt::cells_body("
"0","        columns = ""Model"","
"0","        rows = 1  # æœ€è‰¯ãƒ¢ãƒ‡ãƒ«"
"0","      )"
"0","    ) %>%"
"0","    gt::tab_footnote("
"0","      footnote = ""Bold indicates best performing model on test set"","
"0","      locations = gt::cells_column_labels(columns = ""Model"")"
"0","    )"
"0","  "
"0","  # ä¿å­˜"
"0","  if (!is.null(output_path)) {"
"0","    gt::gtsave(gt_table, output_path)"
"0","    message(sprintf(""  âœ“ Summary table saved to: %s"", output_path))"
"0","  }"
"0","  "
"0","  return(gt_table)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 7. çµ±åˆå¯è¦–åŒ–é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' å…¨è©•ä¾¡çµæœã‚’å¯è¦–åŒ–"
"0","#' @param evaluation_results è©•ä¾¡çµæœ"
"0","#' @param models ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ"
"0","#' @param output_dir å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @return ãƒ—ãƒ­ãƒƒãƒˆã®ãƒªã‚¹ãƒˆ"
"0","visualize_all_results <- function(evaluation_results,"
"0","                                 models,"
"0","                                 output_dir = ""03_Output/figures"","
"0","                                 config = NULL) {"
"0","  "
"0","  message(""\n========================================"")"
"0","  message(""Creating All Visualizations"")"
"0","  message(""========================================"")"
"0","  "
"0","  # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ"
"0","  if (!dir.exists(output_dir)) {"
"0","    dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)"
"0","  }"
"0","  "
"0","  plots <- list()"
"0","  "
"0","  # 1. ROCæ›²ç·š"
"0","  tryCatch({"
"0","    plots$roc <- plot_roc_curves("
"0","      evaluation_results,"
"0","      dataset = ""test"","
"0","      time_point = 24,"
"0","      save_path = file.path(output_dir, ""roc_curves.pdf"")"
"0","    )"
"0","  }, error = function(e) {"
"0","    message(sprintf(""  âŒ Error in ROC plot: %s"", e$message))"
"0","  })"
"0","  "
"0","  # 2. ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
"0","  tryCatch({"
"0","    plots$calibration <- plot_calibration("
"0","      evaluation_results,"
"0","      dataset = ""test"","
"0","      save_path = file.path(output_dir, ""calibration.pdf"")"
"0","    )"
"0","  }, error = function(e) {"
"0","    message(sprintf(""  âŒ Error in calibration plot: %s"", e$message))"
"0","  })"
"0","  "
"0","  # 3. DCA"
"0","  tryCatch({"
"0","    plots$dca <- plot_dca("
"0","      evaluation_results,"
"0","      save_path = file.path(output_dir, ""dca.pdf"")"
"0","    )"
"0","  }, error = function(e) {"
"0","    message(sprintf(""  âŒ Error in DCA plot: %s"", e$message))"
"0","  })"
"0","  "
"0","  # 4. å¤‰æ•°é‡è¦åº¦"
"0","  tryCatch({"
"0","    plots$importance <- plot_variable_importance("
"0","      models,"
"0","      top_n = 20,"
"0","      save_path = file.path(output_dir, ""variable_importance.pdf"")"
"0","    )"
"0","  }, error = function(e) {"
"0","    message(sprintf(""  âŒ Error in importance plot: %s"", e$message))"
"0","  })"
"0","  "
"0","  # 5. ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«"
"0","  tryCatch({"
"0","    plots$table <- create_summary_table("
"0","      evaluation_results,"
"0","      output_path = file.path(output_dir, ""summary_table.html"")"
"0","    )"
"0","  }, error = function(e) {"
"0","    message(sprintf(""  âŒ Error in summary table: %s"", e$message))"
"0","  })"
"0","  "
"0","  # 6. æœ€è‰¯ãƒ¢ãƒ‡ãƒ«ã®ç”Ÿå­˜æ›²ç·š"
"0","  if (!is.null(evaluation_results$summary) && nrow(evaluation_results$summary) > 0) {"
"0","    best_model_name <- evaluation_results$summary[1, ""model""]"
"0","    best_model <- models[[best_model_name]]"
"0","    "
"0","    if (!is.null(best_model)) {"
"0","      tryCatch({"
"0","        plots$survival <- plot_survival_curves("
"0","          best_model,"
"0","          evaluation_results$data$test,"
"0","          n_groups = 3,"
"0","          save_path = file.path(output_dir, sprintf(""survival_curves_%s.pdf"", best_model_name))"
"0","        )"
"0","        message(sprintf(""  Created survival curves for best model: %s"", best_model_name))"
"0","      }, error = function(e) {"
"0","        message(sprintf(""  âŒ Error in survival plot: %s"", e$message))"
"0","      })"
"0","    }"
"0","  }"
"0","  "
"0","  message(""\nâœ… Visualization completed!"")"
"0","  message(""========================================\n"")"
"0","  "
"0","  return(plots)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒãƒ—ãƒ­ãƒƒãƒˆ"
"0","# ========================================================================"
"0",""
"0","#' ãƒ¢ãƒ‡ãƒ«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ¯”è¼ƒãƒ—ãƒ­ãƒƒãƒˆ"
"0","#' @param evaluation_results è©•ä¾¡çµæœ"
"0","#' @param save_path ä¿å­˜å…ˆãƒ‘ã‚¹"
"0","#' @return ggplotã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","plot_model_comparison <- function(evaluation_results,"
"0","                                 save_path = NULL) {"
"0","  "
"0","  message(""\nğŸ“Š Plotting model performance comparison..."")"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿æº–å‚™"
"0","  summary_df <- evaluation_results$summary"
"0","  "
"0","  # Long formatå¤‰æ›"
"0","  comparison_data <- tidyr::pivot_longer("
"0","    summary_df,"
"0","    cols = starts_with(""c_index""),"
"0","    names_to = ""dataset"","
"0","    values_to = ""c_index"""
"0","  )"
"0","  "
"0","  comparison_data$dataset <- gsub(""c_index_"", """", comparison_data$dataset)"
"0","  comparison_data$dataset <- factor("
"0","    comparison_data$dataset, "
"0","    levels = c(""train"", ""val"", ""test"")"
"0","  )"
"0","  "
"0","  # ãƒ—ãƒ­ãƒƒãƒˆ"
"0","  p <- ggplot(comparison_data, aes(x = model, y = c_index, fill = dataset)) +"
"0","    geom_bar(stat = ""identity"", position = ""dodge"") +"
"0","    geom_hline(yintercept = 0.5, linetype = ""dashed"", color = ""red"") +"
"0","    scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.1)) +"
"0","    labs("
"0","      title = ""Model Performance Comparison"","
"0","      subtitle = ""C-index across different datasets"","
"0","      x = ""Model"","
"0","      y = ""C-index"","
"0","      fill = ""Dataset"""
"0","    ) +"
"0","    theme_minimal(base_size = 12) +"
"0","    theme("
"0","      axis.text.x = element_text(angle = 45, hjust = 1),"
"0","      legend.position = ""top"","
"0","      plot.title = element_text(face = ""bold"", hjust = 0.5)"
"0","    ) +"
"0","    scale_fill_brewer(palette = ""Set2"")"
"0","  "
"0","  # ä¿å­˜"
"0","  if (!is.null(save_path)) {"
"0","    ggsave(save_path, plot = p, width = 12, height = 6, dpi = 300)"
"0","    message(sprintf(""  âœ“ Comparison plot saved to: %s"", save_path))"
"0","  }"
"0","  "
"0","  return(p)"
"0","}"
