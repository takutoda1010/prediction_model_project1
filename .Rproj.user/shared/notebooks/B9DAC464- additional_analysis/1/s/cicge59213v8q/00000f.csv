"0","# ========================================"
"0","# 問題の診断"
"0","# ========================================"
"0",""
"0","message(""\n=== Diagnosis of Evaluation Issues ==="")"
"2","
=== Diagnosis of Evaluation Issues ===
"
"0","# 1. モデルに含まれる変数を確認"
"0","check_model_variables <- function(model, model_name) {"
"0","  message(sprintf(""\n%s:"", model_name))"
"0","  "
"0","  if (is.null(model)) {"
"0","    message(""  Model is NULL"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # モデルタイプに応じて変数を取得"
"0","  if (inherits(model, ""coxph"")) {"
"0","    vars <- names(coef(model))"
"0","    message(sprintf(""  Variables in model: %d"", length(vars)))"
"0","    message(sprintf(""  Variables: %s"", paste(head(vars, 10), collapse = "", "")))"
"0","  } else if (inherits(model, ""list"") && ""selected_vars"" %in% names(model)) {"
"0","    vars <- model$selected_vars"
"0","    message(sprintf(""  Selected variables: %d"", length(vars)))"
"0","    message(sprintf(""  Variables: %s"", paste(head(vars, 10), collapse = "", "")))"
"0","  }"
"0","  "
"0","  return(vars)"
"0","}"
"0",""
"0","# 各モデルの変数を確認"
"0","model_vars <- list()"
"0","for (name in names(models)) {"
"0","  model_vars[[name]] <- check_model_variables(models[[name]], name)"
"0","}"
"2","
m1_stepaic_forward:
"
"2","  Variables in model: 18
"
"2","  Variables: t, ALBIscore, afp_l3_log1p, sm1, fc_inf1, alt_log1p, liver_damageB, liver_damageC, macroVITRUE, m
"
"2","
m2_stepaic_backward:
"
"2","  Variables in model: 19
"
"2","  Variables: alb, child_pughB, child_pughC, liver_damageB, liver_damageC, stage_diagBR1, stage_diagBR2, ALBIscore, microVITRUE, macroVITRUE
"
"2","
m3_stepbic_forward:
"
"2","  Variables in model: 2
"
"2","  Variables: t, ALBIscore
"
"2","
m4_stepbic_backward:
"
"2","  Variables in model: 4
"
"2","  Variables: alb, ALBIscore, tbil_log1p, t
"
"2","
m5_univariate_screen:
"
"2","  Selected variables: 19
"
"2","  Variables: t, stage_diag, count, macroVI, max_diam_cm, max_diam_cm_log1p, ALBIscore, alb, afp_log1p, pivka2_log1p
"
"2","
m6_rfe:
"
"2","  Selected variables: 35
"
"2","  Variables: age, sex, alb, che, hbv, hh15, child_pugh, liver_damage, max_diam_cm, count
"
"2","
m7_lasso:
"
"2","  Selected variables: 7
"
"2","  Variables: count, stage_diagBR2, ALBIscore, macroVITRUE, afp_l3_log1p, ast_log1p, t
"
"2","
m7k_lasso_constrained:
"
"2","  Selected variables: 6
"
"2","  Variables: count, stage_diagBR2, ALBIscore, macroVITRUE, afp_l3_log1p, t
"
"2","
m8_predefined:
"
"2","  Variables in model: 4
"
"2","  Variables: stage_diagBR1, stage_diagBR2, t, ALBIscore
"
"0","# 2. データセットに存在する変数を確認"
"0","message(""\n=== Variables in datasets ==="")"
"2","
=== Variables in datasets ===
"
"0","message(""Train columns:"", paste(names(split_data_clean$train)[1:20], collapse = "", ""), ""..."")"
"2","Train columns:Num, Group, ID, date_of_birth, HB, HCV, Plt, Alb, Bil, ChE, GOT, GPT, PT, ICG, HH15, LHL15, liver_damage, ChildPugh, AFP, AFP_L3...
"
"0","message(""Val columns:"", paste(names(split_data_clean$val)[1:20], collapse = "", ""), ""..."")"
"2","Val columns:Num, Group, ID, date_of_birth, HB, HCV, Plt, Alb, Bil, ChE, GOT, GPT, PT, ICG, HH15, LHL15, liver_damage, ChildPugh, AFP, AFP_L3...
"
"0","message(""Test columns:"", paste(names(split_data_clean$test)[1:20], collapse = "", ""), ""..."")"
"2","Test columns:Num, Group, ID, date_of_birth, HB, HCV, Plt, Alb, Bil, ChE, GOT, GPT, PT, ICG, HH15, LHL15, liver_damage, ChildPugh, AFP, AFP_L3...
"
"0","# 3. microVI/macroVIの存在確認"
"0","message(""\n=== microVI/macroVI check ==="")"
"2","
=== microVI/macroVI check ===
"
"0","for (dataset_name in c(""train"", ""val"", ""test"")) {"
"0","  data <- split_data_clean[[dataset_name]]"
"0","  message(sprintf(""\n%s set:"", dataset_name))"
"0","  "
"0","  for (var in c(""microVI"", ""macroVI"")) {"
"0","    if (var %in% names(data)) {"
"0","      tab <- table(data[[var]], useNA = ""always"")"
"0","      message(sprintf(""  %s: Present (TRUE=%d, FALSE=%d, NA=%d)"", "
"0","                     var, "
"0","                     tab[""TRUE""], "
"0","                     tab[""FALSE""], "
"0","                     sum(is.na(data[[var]]))))"
"0","    } else {"
"0","      message(sprintf(""  %s: NOT FOUND"", var))"
"0","    }"
"0","  }"
"0","}"
"2","
train set:
"
"2","  microVI: Present (TRUE=102, FALSE=465, NA=0)
"
"2","  macroVI: Present (TRUE=84, FALSE=483, NA=0)
"
"2","
val set:
"
"2","  microVI: Present (TRUE=51, FALSE=138, NA=0)
"
"2","  macroVI: Present (TRUE=31, FALSE=158, NA=0)
"
"2","
test set:
"
"2","  microVI: Present (TRUE=50, FALSE=139, NA=0)
"
"2","  macroVI: Present (TRUE=20, FALSE=169, NA=0)
"
"0","# 4. 問題のあるモデルの詳細確認"
"0","message(""\n=== Problem models detail ==="")"
"2","
=== Problem models detail ===
"
"0","# m2_stepaic_backward"
"0","if (!is.null(models$m2_stepaic_backward)) {"
"0","  message(""\nm2_stepaic_backward:"")"
"0","  if (""microVI"" %in% names(coef(models$m2_stepaic_backward))) {"
"0","    message(""  microVI is in model coefficients"")"
"0","  }"
"0","  message(""  Model formula:"", deparse(formula(models$m2_stepaic_backward)))"
"0","}"
"2","
m2_stepaic_backward:
"
"2","  Model formula:surv_obj ~ alb + child_pugh + liver_damage + stage_diag + ALBIscore +     microVI + macroVI + afp_log1p + tbil_log1p + plt_log1p +     icg_r15_log1p + fc_inf + sm + t + m + fibrosis_score
"
"0","# LASSO系モデル"
"0","if (!is.null(models$m7_lasso)) {"
"0","  message(""\nm7_lasso:"")"
"0","  if (inherits(models$m7_lasso, ""list"")) {"
"0","    message(""  Model structure: "", paste(names(models$m7_lasso), collapse = "", ""))"
"0","  }"
"0","}"
"2","
m7_lasso:
"
"2","  Model structure: glmnet_model, cv_fit, selected_vars, lambda_min, lambda_1se, X, y
"
