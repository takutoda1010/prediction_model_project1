"0","# ========================================================================"
"0","# 3. Decision Curve Analysis (DCA) - 修正版"
"0","# ========================================================================"
"0",""
"0","message(""\n3. Creating Decision Curve Analysis"")"
"2","
3. Creating Decision Curve Analysis
"
"0","message(""----------------------------------------"")"
"2","----------------------------------------
"
"0","perform_dca_fixed <- function(models, data, time_point = 24, output_file = NULL) {"
"0","  "
"0","  # 閾値の範囲"
"0","  thresholds <- seq(0.01, 0.50, by = 0.01)"
"0","  "
"0","  dca_results <- data.frame()"
"0","  "
"0","  # モデルリスト"
"0","  model_list <- list("
"0","    ""Best Model"" = best_model,"
"0","    ""TNM Model"" = tnm_model"
"0","  )"
"0","  "
"0","  for (model_name in names(model_list)) {"
"0","    model <- model_list[[model_name]]"
"0","    "
"0","    if (!is.null(model)) {"
"0","      # リスクスコアから予測確率を計算"
"0","      if (inherits(model, ""coxph"")) {"
"0","        lp <- predict(model, newdata = data, type = ""lp"")"
"0","        # ベースラインハザードから確率を推定"
"0","        surv_obj <- survfit(model, newdata = data[1,])"
"0","        time_idx <- which.min(abs(surv_obj$time - time_point))"
"0","        baseline_surv <- surv_obj$surv[time_idx]"
"0","        pred_prob <- 1 - baseline_surv^exp(lp)"
"0","      } else {"
"0","        next"
"0","      }"
"0","      "
"0","      # 実際のイベント"
"0","      event_occurred <- (data$recur_2y == TRUE) & (data$time2y <= time_point)"
"0","      "
"0","      # 各閾値でのNet Benefit計算"
"0","      for (thresh in thresholds) {"
"0","        treat <- pred_prob >= thresh"
"0","        tp <- sum(treat & event_occurred, na.rm = TRUE)"
"0","        fp <- sum(treat & !event_occurred, na.rm = TRUE)"
"0","        n <- length(event_occurred)"
"0","        "
"0","        net_benefit <- (tp/n) - (fp/n) * (thresh/(1-thresh))"
"0","        "
"0","        dca_results <- rbind(dca_results, data.frame("
"0","          model = model_name,"
"0","          threshold = thresh,"
"0","          net_benefit = net_benefit"
"0","        ))"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # Treat All/None の追加"
"0","  event_rate <- mean((data$recur_2y == TRUE) & (data$time2y <= time_point))"
"0","  "
"0","  for (thresh in thresholds) {"
"0","    # Treat All"
"0","    net_benefit_all <- event_rate - (1-event_rate) * (thresh/(1-thresh))"
"0","    dca_results <- rbind(dca_results, data.frame("
"0","      model = ""Treat All"","
"0","      threshold = thresh,"
"0","      net_benefit = net_benefit_all"
"0","    ))"
"0","    "
"0","    # Treat None"
"0","    dca_results <- rbind(dca_results, data.frame("
"0","      model = ""Treat None"", "
"0","      threshold = thresh,"
"0","      net_benefit = 0"
"0","    ))"
"0","  }"
"0","  "
"0","  # プロット作成"
"0","  p <- ggplot(dca_results, aes(x = threshold, y = net_benefit, color = model)) +"
"0","    geom_line(size = 1.2) +"
"0","    scale_color_manual(values = c("
"0","      ""Best Model"" = cb_palette[1],"
"0","      ""TNM Model"" = cb_palette[2],"
"0","      ""Treat All"" = ""gray60"","
"0","      ""Treat None"" = ""gray80"""
"0","    )) +"
"0","    scale_x_continuous(limits = c(0, 0.5), breaks = seq(0, 0.5, 0.1)) +"
"0","    labs("
"0","      title = ""Decision Curve Analysis"","
"0","      subtitle = sprintf(""Net benefit at %d months"", time_point),"
"0","      x = ""Threshold Probability"","
"0","      y = ""Net Benefit"","
"0","      color = ""Strategy"""
"0","    ) +"
"0","    theme_minimal(base_size = 12) +"
"0","    theme("
"0","      legend.position = ""bottom"","
"0","      panel.grid.minor = element_blank()"
"0","    ) +"
"0","    geom_hline(yintercept = 0, linetype = ""dotted"", color = ""black"")"
"0","  "
"0","  if (!is.null(output_file)) {"
"0","    ggsave(output_file, plot = p, width = 10, height = 8, dpi = 300)"
"0","    message(sprintf(""  ✓ DCA plot saved to: %s"", basename(output_file)))"
"0","  }"
"0","  "
"0","  return(p)"
"0","}"
"0",""
"0","# DCAプロット実行"
"0","dca_plot <- perform_dca_fixed("
"0","  models = models,"
"0","  data = split_data_fixed$test,"
"0","  time_point = 24,"
"0","  output_file = file.path(paths$output_figures, ""dca_comparison.pdf"")"
"0",")"
"0",""
