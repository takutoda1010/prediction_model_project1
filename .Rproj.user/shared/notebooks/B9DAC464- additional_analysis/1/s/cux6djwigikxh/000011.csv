"0","# ========================================================================"
"0","# 4. キャリブレーションプロット（修正版）"
"0","# ========================================================================"
"0",""
"0","message(""\n3. Creating Calibration Plot"")"
"2","
3. Creating Calibration Plot
"
"0","message(""----------------------------------------"")"
"2","----------------------------------------
"
"0","if (!is.null(best_calibration) && nrow(best_calibration$data) > 0) {"
"0","  "
"0","  cal_data <- best_calibration$data"
"0","  "
"0","  # プロット作成"
"0","  cal_plot <- ggplot(cal_data, aes(x = expected, y = observed)) +"
"0","    # 理想的なキャリブレーションライン"
"0","    geom_abline(intercept = 0, slope = 1, linetype = ""dashed"", color = ""gray50"", size = 1) +"
"0","    # 実際のキャリブレーションライン（データが十分な場合のみ）"
"0","    {if(nrow(cal_data) >= 3) "
"0","      geom_smooth(method = ""lm"", se = TRUE, color = cb_palette[1], fill = cb_palette[1], alpha = 0.2)"
"0","    } +"
"0","    # データポイント"
"0","    geom_point(aes(size = n), color = cb_palette[2], alpha = 0.7) +"
"0","    # エラーバー（二項分布の95%CI）"
"0","    geom_errorbar("
"0","      aes(ymin = observed - 1.96*sqrt(observed*(1-observed)/n),"
"0","          ymax = observed + 1.96*sqrt(observed*(1-observed)/n)),"
"0","      width = 0.02, color = cb_palette[2], alpha = 0.5"
"0","    ) +"
"0","    # ラベル"
"0","    labs("
"0","      title = sprintf(""Calibration Plot - %s"", best_model_name),"
"0","      subtitle = sprintf(""Calibration slope = %.3f, Intercept = %.3f"","
"0","                        ifelse(is.na(best_calibration$slope), NA, best_calibration$slope),"
"0","                        ifelse(is.na(best_calibration$intercept), NA, best_calibration$intercept)),"
"0","      x = ""Expected Event Probability"","
"0","      y = ""Observed Event Probability"","
"0","      size = ""Sample Size"""
"0","    ) +"
"0","    scale_x_continuous(limits = c(0, 1), labels = scales::percent) +"
"0","    scale_y_continuous(limits = c(0, 1), labels = scales::percent) +"
"0","    theme_minimal(base_size = 12) +"
"0","    theme("
"0","      legend.position = ""bottom"","
"0","      panel.grid.minor = element_blank()"
"0","    ) +"
"0","    coord_equal()"
"0","  "
"0","  # 保存"
"0","  ggsave("
"0","    file.path(paths$output_figures, ""calibration_plot.pdf""),"
"0","    plot = cal_plot,"
"0","    width = 8,"
"0","    height = 8,"
"0","    dpi = 300"
"0","  )"
"0","  message(""  ✓ Calibration plot saved"")"
"0","  "
"0","} else {"
"0","  message(""  ⚠ Calibration plot could not be created due to insufficient data"")"
"0","  cal_plot <- NULL"
"0","}"
"0",""
