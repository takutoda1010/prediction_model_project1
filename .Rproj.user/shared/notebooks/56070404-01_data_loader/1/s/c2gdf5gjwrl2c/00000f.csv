"0","################################################################################"
"0","# 01_data_loader.R - ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨åˆæœŸå‡¦ç†"
"0","# "
"0","# Description: "
"0","#   Excelãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã€åˆ—åãƒãƒƒãƒ”ãƒ³ã‚°ã€åŸºæœ¬çš„ãªå‰å‡¦ç†"
"0","#   ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ï¼ˆds00, ds01, ds02...ï¼‰"
"0","#"
"0","# Author: Takuto Yoshida"
"0","# Date: 2024-11-07"
"0","################################################################################"
"0",""
"0","# ========================================================================"
"0","# 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' Excelãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€"
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆï¼ˆYAMLã‹ã‚‰èª­ã¿è¾¼ã‚“ã ã‚‚ã®ï¼‰"
"0","#' @param sheet ã‚·ãƒ¼ãƒˆç•ªå·ã¾ãŸã¯åå‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1ï¼‰"
"0","#' @param guess_max å‹æ¨å®šã«ä½¿ç”¨ã™ã‚‹æœ€å¤§è¡Œæ•°"
"0","#' @return ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","load_raw_data <- function(config, sheet = NULL, guess_max = 100000) {"
"0","  "
"0","  # è¨­å®šã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ§‹ç¯‰"
"0","  if (is.null(sheet)) {"
"0","    sheet <- ifelse(!is.null(config$paths$sheet), config$paths$sheet, 1)"
"0","  }"
"0","  "
"0","  data_path <- file.path("
"0","    config$paths$base_dir,"
"0","    config$paths$data_dir,"
"0","    config$paths$main_data"
"0","  )"
"0","  "
"0","  # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª"
"0","  if (!file.exists(data_path)) {"
"0","    stop(sprintf(""Data file not found: %s"", data_path))"
"0","  }"
"0","  "
"0","  message(sprintf(""\nğŸ“ Loading data from: %s"", basename(data_path)))"
"0","  "
"0","  # Excelãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿"
"0","  tryCatch({"
"0","    df_raw <- suppressWarnings("
"0","      readxl::read_excel("
"0","        path = data_path,"
"0","        sheet = sheet,"
"0","        guess_max = guess_max,"
"0","        .name_repair = ""minimal"""
"0","      )"
"0","    )"
"0","    "
"0","    message(sprintf(""âœ… Data loaded: %d rows Ã— %d columns"", "
"0","                   nrow(df_raw), ncol(df_raw)))"
"0","    "
"0","    return(df_raw)"
"0","    "
"0","  }, error = function(e) {"
"0","    stop(sprintf(""Error loading Excel file: %s"", e$message))"
"0","  })"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 2. ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç†ã‚¯ãƒ©ã‚¹"
"0","# ========================================================================"
"0",""
"0","#' ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç®¡ç†ç”¨ã®S3ã‚¯ãƒ©ã‚¹"
"0","#' @description ds00, ds01, ds02...ã®å½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ç®¡ç†"
"0","DatasetManager <- function(base_data = NULL) {"
"0","  "
"0","  # å†…éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸"
"0","  datasets <- list()"
"0","  current_version <- -1"
"0","  "
"0","  # ãƒ™ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã° ds00 ã¨ã—ã¦ä¿å­˜"
"0","  if (!is.null(base_data)) {"
"0","    datasets[[""ds00""]] <- base_data"
"0","    current_version <- 0"
"0","  }"
"0","  "
"0","  # ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ "
"0","  structure("
"0","    list("
"0","      datasets = datasets,"
"0","      current_version = current_version,"
"0","      "
"0","      # ãƒ¡ã‚½ãƒƒãƒ‰å®šç¾©"
"0","      add_version = function(data, version = NULL) {"
"0","        if (is.null(version)) {"
"0","          version <- current_version + 1"
"0","        }"
"0","        ds_name <- sprintf(""ds%02d"", version)"
"0","        datasets[[ds_name]] <<- data"
"0","        current_version <<- version"
"0","        message(sprintf(""ğŸ“Œ Created dataset: %s"", ds_name))"
"0","        invisible(data)"
"0","      },"
"0","      "
"0","      get_version = function(version = NULL) {"
"0","        if (is.null(version)) {"
"0","          version <- current_version"
"0","        }"
"0","        ds_name <- sprintf(""ds%02d"", version)"
"0","        if (ds_name %in% names(datasets)) {"
"0","          return(datasets[[ds_name]])"
"0","        } else {"
"0","          stop(sprintf(""Dataset %s not found"", ds_name))"
"0","        }"
"0","      },"
"0","      "
"0","      list_versions = function() {"
"0","        names(datasets)"
"0","      },"
"0","      "
"0","      get_current = function() {"
"0","        if (current_version >= 0) {"
"0","          return(datasets[[sprintf(""ds%02d"", current_version)]])"
"0","        } else {"
"0","          stop(""No dataset available"")"
"0","        }"
"0","      },"
"0","      "
"0","      get_all = function() {"
"0","        datasets"
"0","      },"
"0","      "
"0","      summary = function() {"
"0","        if (length(datasets) == 0) {"
"0","          cat(""No datasets loaded\n"")"
"0","        } else {"
"0","          cat(""\n=== Dataset Summary ===\n"")"
"0","          for (ds_name in names(datasets)) {"
"0","            df <- datasets[[ds_name]]"
"0","            cat(sprintf(""%s: %d rows Ã— %d columns\n"", "
"0","                       ds_name, nrow(df), ncol(df)))"
"0","          }"
"0","          cat(sprintf(""\nCurrent version: ds%02d\n"", current_version))"
"0","        }"
"0","      }"
"0","    ),"
"0","    class = ""DatasetManager"""
"0","  )"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 3. åˆ—åå‡¦ç†é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' åˆ—åã®æ­£è¦åŒ–"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @return åˆ—åãŒæ­£è¦åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","normalize_column_names <- function(df) {"
"0","  "
"0","  # å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã¨é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ã‚’åŠè§’ã‚¹ãƒšãƒ¼ã‚¹1ã¤ã«å¤‰æ›"
"0","  names(df) <- names(df) %>%"
"0","    stringr::str_replace_all(""[\u3000\\s]+"", "" "" ) %>%"
"0","    stringr::str_trim()"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","#' åˆ—åãƒãƒƒãƒ”ãƒ³ã‚°ã®é©ç”¨"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param variables å¤‰æ•°å®šç¾©ï¼ˆvariables.yamlã‹ã‚‰èª­ã¿è¾¼ã‚“ã ã‚‚ã®ï¼‰"
"0","#' @return ãƒãƒƒãƒ”ãƒ³ã‚°é©ç”¨å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","apply_column_mapping <- function(df, variables) {"
"0","  "
"0","  if (is.null(variables$column_mappings)) {"
"0","    warning(""No column mappings found in variables configuration"")"
"0","    return(df)"
"0","  }"
"0","  "
"0","  # ãƒãƒƒãƒ”ãƒ³ã‚°ã®é©ç”¨"
"0","  mapping_applied <- 0"
"0","  mapping_failed <- character()"
"0","  "
"0","  for (orig_name in names(variables$column_mappings)) {"
"0","    mapping_info <- variables$column_mappings[[orig_name]]"
"0","    new_name <- mapping_info$name"
"0","    "
"0","    if (orig_name %in% names(df)) {"
"0","      # æ–°ã—ã„åˆ—ã‚’ä½œæˆï¼ˆå…ƒã®åˆ—ã‚‚ä¿æŒï¼‰"
"0","      df[[new_name]] <- df[[orig_name]]"
"0","      mapping_applied <- mapping_applied + 1"
"0","    } else {"
"0","      mapping_failed <- c(mapping_failed, orig_name)"
"0","    }"
"0","  }"
"0","  "
"0","  message(sprintf(""ğŸ“‹ Column mapping: %d applied, %d not found"", "
"0","                 mapping_applied, length(mapping_failed)))"
"0","  "
"0","  if (length(mapping_failed) > 0 && length(mapping_failed) <= 10) {"
"0","    message(""   Not found: "", paste(mapping_failed, collapse = "", ""))"
"0","  } else if (length(mapping_failed) > 10) {"
"0","    message(sprintf(""   Not found: %d columns (too many to display)"", "
"0","                   length(mapping_failed)))"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 4. å‹å¤‰æ›é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' ãƒ‡ãƒ¼ã‚¿å‹ã®è‡ªå‹•èª¿æ•´"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param variables å¤‰æ•°å®šç¾©"
"0","#' @return å‹èª¿æ•´å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","adjust_data_types <- function(df, variables = NULL) {"
"0","  "
"0","  # readrã«ã‚ˆã‚‹è‡ªå‹•å‹æ¨å®š"
"0","  df_converted <- suppressMessages("
"0","    readr::type_convert(df, locale = readr::locale(encoding = ""UTF-8""))"
"0","  )"
"0","  "
"0","  # å¤‰æ•°å®šç¾©ã«åŸºã¥ãå‹ã®èª¿æ•´"
"0","  if (!is.null(variables) && !is.null(variables$column_mappings)) {"
"0","    "
"0","    for (mapping in variables$column_mappings) {"
"0","      col_name <- mapping$name"
"0","      col_type <- mapping$type"
"0","      "
"0","      if (col_name %in% names(df_converted)) {"
"0","        "
"0","        # å‹ã«å¿œã˜ãŸå¤‰æ›"
"0","        if (col_type == ""character"") {"
"0","          df_converted[[col_name]] <- as.character(df_converted[[col_name]])"
"0","          "
"0","        } else if (col_type == ""numeric"") {"
"0","          df_converted[[col_name]] <- suppressWarnings("
"0","            as.numeric(df_converted[[col_name]])"
"0","          )"
"0","          "
"0","        } else if (col_type == ""integer"") {"
"0","          df_converted[[col_name]] <- suppressWarnings("
"0","            as.integer(df_converted[[col_name]])"
"0","          )"
"0","          "
"0","        } else if (col_type == ""logical"") {"
"0","          # ã‚«ã‚¹ã‚¿ãƒ å¤‰æ›é–¢æ•°ã‚’ä½¿ç”¨ï¼ˆ00_setup.Rã‹ã‚‰ï¼‰"
"0","          if (exists(""to_tf"")) {"
"0","            df_converted[[col_name]] <- to_tf(df_converted[[col_name]])"
"0","          }"
"0","          "
"0","        } else if (col_type == ""date"") {"
"0","          # ã‚«ã‚¹ã‚¿ãƒ å¤‰æ›é–¢æ•°ã‚’ä½¿ç”¨"
"0","          if (exists(""to_date_excel_mixed"")) {"
"0","            df_converted[[col_name]] <- to_date_excel_mixed(df_converted[[col_name]])"
"0","          }"
"0","          "
"0","        } else if (col_type %in% c(""factor"", ""ordered"")) {"
"0","          df_converted[[col_name]] <- factor(df_converted[[col_name]])"
"0","          "
"0","          # ãƒ¬ãƒ™ãƒ«ã®è¨­å®š"
"0","          if (!is.null(mapping$levels)) {"
"0","            df_converted[[col_name]] <- factor("
"0","              df_converted[[col_name]], "
"0","              levels = mapping$levels"
"0","            )"
"0","          }"
"0","          "
"0","          # é †åºå› å­ã®å ´åˆ"
"0","          if (col_type == ""ordered"") {"
"0","            df_converted[[col_name]] <- ordered(df_converted[[col_name]])"
"0","          }"
"0","        }"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  return(df_converted)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 5. åˆ—åã‚¨ã‚¤ãƒªã‚¢ã‚¹å‡¦ç†"
"0","# ========================================================================"
"0",""
"0","#' åˆ—åã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®é©ç”¨"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @return ã‚¨ã‚¤ãƒªã‚¢ã‚¹é©ç”¨å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","apply_column_aliases <- function(df) {"
"0","  "
"0","  # ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®å®šç¾©"
"0","  aliases <- list("
"0","    ""å†ç™ºæœ‰ç„¡"" = ""å†ç™ºæœ‰ç„¡TRUE/FALSEã®äºŒç¾¤"","
"0","    ""StageI+II or III+IV"" = ""StageI+II or III+IVã€€éç™Œéƒ¨è‚(æ—§å…¥åŠ›ï¼‰"","
"0","    ""åˆä½µç—‡èƒ¸æ°´"" = ""åˆä½µç—‡èƒ¸æ°´ 0-2ã®é †åºå¤‰æ•°"","
"0","    ""åˆä½µç—‡å‡ºè¡€"" = ""åˆä½µç—‡å‡ºè¡€ 0-2ã®é †åºå¤‰æ•°"","
"0","    ""åˆä½µç—‡èƒ†æ±æ¼"" = ""åˆä½µç—‡èƒ†æ±æ¼é †åºå¤‰æ•°"","
"0","    ""åˆä½µç—‡æ¶ˆåŒ–ç®¡"" = ""åˆä½µç—‡æ¶ˆåŒ–ç®¡é †åºå¤‰æ•°"","
"0","    ""åˆä½µç—‡è¡“å‰µ"" = ""åˆä½µç—‡è¡“å‰µé †åºå¤‰æ•°"""
"0","  )"
"0","  "
"0","  # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®é©ç”¨"
"0","  for (short_name in names(aliases)) {"
"0","    long_name <- aliases[[short_name]]"
"0","    "
"0","    if (short_name %in% names(df) && !long_name %in% names(df)) {"
"0","      names(df)[names(df) == short_name] <- long_name"
"0","    }"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 6. ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬çš„ãªæ¤œè¨¼"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param required_cols å¿…é ˆåˆ—ã®ãƒ™ã‚¯ãƒˆãƒ«"
"0","#' @return æ¤œè¨¼çµæœï¼ˆè«–ç†å€¤ï¼‰"
"0","validate_data <- function(df, required_cols = NULL) {"
"0","  "
"0","  validation_passed <- TRUE"
"0","  messages <- character()"
"0","  "
"0","  # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®ç¢ºèª"
"0","  if (!is.data.frame(df)) {"
"0","    messages <- c(messages, ""âŒ Input is not a data frame"")"
"0","    validation_passed <- FALSE"
"0","  }"
"0","  "
"0","  # ç©ºã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ãƒã‚§ãƒƒã‚¯"
"0","  if (nrow(df) == 0) {"
"0","    messages <- c(messages, ""âŒ Data frame has no rows"")"
"0","    validation_passed <- FALSE"
"0","  }"
"0","  "
"0","  if (ncol(df) == 0) {"
"0","    messages <- c(messages, ""âŒ Data frame has no columns"")"
"0","    validation_passed <- FALSE"
"0","  }"
"0","  "
"0","  # å¿…é ˆåˆ—ã®ç¢ºèª"
"0","  if (!is.null(required_cols)) {"
"0","    missing_cols <- setdiff(required_cols, names(df))"
"0","    if (length(missing_cols) > 0) {"
"0","      messages <- c(messages, "
"0","                   sprintf(""âŒ Missing required columns: %s"", "
"0","                          paste(missing_cols, collapse = "", "")))"
"0","      validation_passed <- FALSE"
"0","    }"
"0","  }"
"0","  "
"0","  # çµæœã®è¡¨ç¤º"
"0","  if (validation_passed) {"
"0","    message(""âœ… Data validation passed"")"
"0","  } else {"
"0","    message(""Data validation failed:"")"
"0","    for (msg in messages) {"
"0","      message(""  "", msg)"
"0","    }"
"0","  }"
"0","  "
"0","  return(validation_passed)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 7. çµ±åˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³"
"0","#' @param config_path è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹"
"0","#' @param variables_path å¤‰æ•°å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹"
"0","#' @return DatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","load_and_prepare_data <- function(config_path = ""config/settings.yaml"","
"0","                                  variables_path = ""config/variables.yaml"") {"
"0","  "
"0","  message(""\n========================================"")"
"0","  message(""Starting Data Loading Pipeline"")"
"0","  message(""========================================"")"
"0","  "
"0","  # 1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿"
"0","  message(""\nğŸ“„ Loading configuration files..."")"
"0","  config <- yaml::read_yaml(config_path)"
"0","  variables <- yaml::read_yaml(variables_path)"
"0","  "
"0","  # 2. DatasetManagerã®åˆæœŸåŒ–"
"0","  dm <- DatasetManager()"
"0","  "
"0","  # 3. ç”Ÿãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ (ds00)"
"0","  message(""\nğŸ“Š Loading raw data..."")"
"0","  df_raw <- load_raw_data(config)"
"0","  dm$add_version(df_raw, version = 0)"
"0","  "
"0","  # 4. åˆ—åã®æ­£è¦åŒ– (ds01)"
"0","  message(""\nğŸ”§ Normalizing column names..."")"
"0","  df_normalized <- normalize_column_names(df_raw)"
"0","  df_normalized <- apply_column_aliases(df_normalized)"
"0","  dm$add_version(df_normalized, version = 1)"
"0","  "
"0","  # 5. åˆ—åãƒãƒƒãƒ”ãƒ³ã‚°ã®é©ç”¨ (ds02)"
"0","  message(""\nğŸ”„ Applying column mapping..."")"
"0","  df_mapped <- apply_column_mapping(df_normalized, variables)"
"0","  dm$add_version(df_mapped, version = 2)"
"0","  "
"0","  # 6. ãƒ‡ãƒ¼ã‚¿å‹ã®èª¿æ•´ (ds03)"
"0","  message(""\nğŸ“ Adjusting data types..."")"
"0","  df_typed <- adjust_data_types(df_mapped, variables)"
"0","  dm$add_version(df_typed, version = 3)"
"0","  "
"0","  # 7. ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼"
"0","  message(""\nâœ”ï¸ Validating data..."")"
"0","  "
"0","  # å¿…é ˆåˆ—ã®å®šç¾©ï¼ˆvariables.yamlã‹ã‚‰å–å¾—ï¼‰"
"0","  required_cols <- NULL"
"0","  if (!is.null(variables$variable_sets$essential)) {"
"0","    required_cols <- variables$variable_sets$essential"
"0","  }"
"0","  "
"0","  validate_data(df_typed, required_cols)"
"0","  "
"0","  # 8. ã‚µãƒãƒªãƒ¼è¡¨ç¤º"
"0","  dm$summary()"
"0","  "
"0","  message(""\nâœ… Data loading pipeline completed!"")"
"0","  message(""========================================\n"")"
"0","  "
"0","  return(dm)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 8. ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆå…ƒã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ç§»æ¤ï¼‰"
"0","# ========================================================================"
"0",""
"0","#' Excelæ—¥ä»˜ã®å¤‰æ›"
"0","#' @param x æ—¥ä»˜åˆ—"
"0","#' @return Dateå‹ã®ãƒ™ã‚¯ãƒˆãƒ«"
"0","to_date_excel_mixed <- function(x) {"
"0","  if (inherits(x, ""Date"")) return(x)"
"0","  "
"0","  s <- trimws(as.character(x))"
"0","  s[s %in% c("""", ""NA"", ""N/A"", ""na"", ""n/a"")] <- NA"
"0","  "
"0","  # Excelã‚·ãƒªã‚¢ãƒ«å€¤"
"0","  num <- suppressWarnings(as.numeric(s))"
"0","  dnum <- as.Date(num, origin = ""1899-12-30"")"
"0","  "
"0","  # æ–‡å­—åˆ—æ—¥ä»˜ã®æ­£è¦åŒ–"
"0","  s2 <- s %>%"
"0","    stringr::str_replace_all(""[.]"", ""/"") %>%"
"0","    stringr::str_replace_all(""å¹´|æœˆ"", ""/"") %>%"
"0","    stringr::str_replace_all(""æ—¥"", """") %>%"
"0","    stringr::str_replace_all(""/"", ""-"")"
"0","  "
"0","  dchr <- suppressWarnings(lubridate::ymd(s2))"
"0","  "
"0","  as.Date(dplyr::coalesce(dchr, dnum))"
"0","}"
"0",""
"0","#' TRUE/FALSEå¤‰æ›"
"0","#' @param x è«–ç†å€¤ã‚’è¡¨ã™åˆ—"
"0","#' @return logicalå‹ã®ãƒ™ã‚¯ãƒˆãƒ«"
"0","to_tf <- function(x) {"
"0","  z <- trimws(as.character(x))"
"0","  z <- chartr(""ï¼‹ï¼"", ""+-"", z)"
"0","  "
"0","  rec <- c("
"0","    ""TRUE"" = ""TRUE"", ""T"" = ""TRUE"", ""æœ‰"" = ""TRUE"", "
"0","    ""Yes"" = ""TRUE"", ""yes"" = ""TRUE"", ""1"" = ""TRUE"", ""+"" = ""TRUE"","
"0","    ""FALSE"" = ""FALSE"", ""F"" = ""FALSE"", ""ç„¡"" = ""FALSE"", "
"0","    ""No"" = ""FALSE"", ""no"" = ""FALSE"", ""0"" = ""FALSE"", ""-"" = ""FALSE"""
"0","  )"
"0","  "
"0","  as.logical(rec[z])"
"0","}"
"0",""
"0","#' æ™‚é–“ã‚’åˆ†ã«å¤‰æ›"
"0","#' @param x æ™‚é–“ã‚’è¡¨ã™åˆ—"
"0","#' @return åˆ†å˜ä½ã®æ•°å€¤ãƒ™ã‚¯ãƒˆãƒ«"
"0","to_minutes_from_time <- function(x) {"
"0","  s <- stringr::str_squish(as.character(x))"
"0","  s <- stringr::str_replace_all(s, ""ï¼š"", "":"")"
"0","  "
"0","  has_colon <- stringr::str_detect(s, "":"")"
"0","  "
"0","  parts <- stringr::str_split_fixed(s, "":"", 3)"
"0","  hh <- suppressWarnings(as.numeric(parts[, 1]))"
"0","  mm <- suppressWarnings(as.numeric(parts[, 2]))"
"0","  ss <- suppressWarnings(as.numeric(parts[, 3]))"
"0","  "
"0","  from_colon <- ifelse("
"0","    has_colon, "
"0","    hh * 60 + mm + ifelse(is.na(ss), 0, round(ss / 60)), "
"0","    NA_real_"
"0","  )"
"0","  "
"0","  num <- suppressWarnings(as.numeric(s))"
"0","  from_frac <- ifelse(!has_colon & !is.na(num), num * 1440, NA_real_)"
"0","  "
"0","  round(dplyr::coalesce(from_colon, from_frac))"
"0","}"
