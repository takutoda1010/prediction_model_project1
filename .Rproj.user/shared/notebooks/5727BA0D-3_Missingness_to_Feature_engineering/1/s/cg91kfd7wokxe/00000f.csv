"0","# ---- CHUNK: make ds03 from ds02 (explicit recodes, no loops) ----"
"0","ds03 <- ds02 |>"
"0","  # R/BR系"
"0","  dplyr::mutate(stage_surg = factor(stage_surg, levels = c(""R"",""BR1"",""BR2""))) |>"
"0","  dplyr::mutate(stage_diag = factor(stage_diag, levels = c(""R"",""BR1"",""BR2""))) |>"
"0","  dplyr::mutate(group_rb   = factor(group_rb,   levels = c(""R"",""BR"")))         |>"
"0","  # 画像・臨床（術前）"
"0","  dplyr::mutate(vp_pre = factor(vp_pre, levels = c(0,1,2,3,4))) |>"
"0","  dplyr::mutate(vv_pre = factor(vv_pre, levels = c(0,1,2,3,4))) |>"
"0","  dplyr::mutate(n_pre  = factor(n_pre,  levels = c(FALSE, TRUE))) |>"
"0","  dplyr::mutate(m_pre  = factor(m_pre,  levels = c(FALSE, TRUE))) |>"
"0","  # 基本属性"
"0","  dplyr::mutate(sex = factor(sex, levels = c(""F"",""M""))) |>"
"0","  # 予後系"
"0","  dplyr::mutate(vital_status = factor(vital_status, levels = c(""生"",""死""))) |>"
"0","  dplyr::mutate(vital10      = factor(vital10,      levels = c(TRUE, FALSE))) |>"
"0","  dplyr::mutate(recur_tf     = factor(recur_tf,     levels = c(FALSE, TRUE))) |>"
"0","  dplyr::mutate(eventfree10  = factor(eventfree10,  levels = c(FALSE, TRUE))) |>"
"0","  dplyr::mutate(hbv          = factor(hbv, levels = c(""-"",""±"",""+"",""*""))) |>"
"0","  dplyr::mutate(hcv          = factor(hcv, levels = c(FALSE, TRUE))) |>"
"0","  # スコア類"
"0","  dplyr::mutate(ps  = factor(ps,  levels = c(0,1,2,3,4))) |>"
"0","  dplyr::mutate(asa = factor(asa, levels = c(1,2,3,4,5,6))) |>"
"0","  # 体積系は「0/非0」の二値化（参照=0）。連続値のままカテゴリ化するとレベル過多になるため"
"0","  dplyr::mutate(liver_vol        = factor(dplyr::case_when(is.na(liver_vol)        ~ NA_real_, liver_vol        > 0 ~ 1, TRUE ~ 0), levels = c(0,1))) |>"
"0","  dplyr::mutate(tumor_vol        = factor(dplyr::case_when(is.na(tumor_vol)        ~ NA_real_, tumor_vol        > 0 ~ 1, TRUE ~ 0), levels = c(0,1))) |>"
"0","  dplyr::mutate(remnant_vol      = factor(dplyr::case_when(is.na(remnant_vol)      ~ NA_real_, remnant_vol      > 0 ~ 1, TRUE ~ 0), levels = c(0,1))) |>"
"0","  dplyr::mutate(func_resect_rate = factor(dplyr::case_when(is.na(func_resect_rate) ~ NA_real_, func_resect_rate > 0 ~ 1, TRUE ~ 0), levels = c(0,1))) |>"
"0","  # 病理（血管侵襲等）"
"0","  dplyr::mutate(vp_path = factor(vp_path, levels = c(0,1,2,3,4))) |>"
"0","  dplyr::mutate(vv_path = factor(vv_path, levels = c(0,1,2,3,4))) |>"
"0","  dplyr::mutate(va_path = factor(va_path, levels = c(0,1,2,3,4))) |>"
"0","  dplyr::mutate(b_path  = factor(b_path,  levels = c(0,1,2,3,4))) |>"
"0","  # 陰陽（-,+）→ 0/1"
"0","  dplyr::mutate(fc     = factor(dplyr::recode(fc,     ""-"" = 0, ""+"" = 1, .default = NA_real_), levels = c(0,1))) |>"
"0","  dplyr::mutate(fc_inf = factor(dplyr::recode(fc_inf, ""-"" = 0, ""+"" = 1, .default = NA_real_), levels = c(0,1))) |>"
"0","  dplyr::mutate(sf     = factor(dplyr::recode(sf,     ""-"" = 0, ""+"" = 1, .default = NA_real_), levels = c(0,1))) |>"
"0","  dplyr::mutate(sm     = factor(dplyr::recode(sm,     ""-"" = 0, ""+"" = 1, .default = NA_real_), levels = c(0,1))) |>"
"0","  # im は 0を基準、それ以外(1/2/3/+)は1、S/Xは欠損扱い"
"0","  dplyr::mutate(im = factor(dplyr::case_when("
"0","    is.na(im)              ~ NA_real_,"
"0","    im %in% c(""S"",""X"")     ~ NA_real_,"
"0","    im %in% c(""0"")         ~ 0,"
"0","    im %in% c(""1"",""2"",""3"",""+"") ~ 1,"
"0","    TRUE                   ~ NA_real_"
"0","  ), levels = c(0,1))) |>"
"0","  # TNM/Stage"
"0","  dplyr::mutate(t = factor(t, levels = c(0,1,2,3,4))) |>"
"0","  dplyr::mutate(n = factor(n, levels = c(FALSE, TRUE))) |>"
"0","  dplyr::mutate(m = factor(m, levels = c(FALSE, TRUE))) |>"
"0","  dplyr::mutate(stage = factor(stage, levels = c(""1"",""2"",""3"",""4A"",""4B"",""0"",""X""))) |>"
"0","  # 線維化・分化スコア（ref=1）"
"0","  dplyr::mutate(fibrosis_score = factor(fibrosis_score, levels = c(1,0,2,3,4))) |>"
"0","  dplyr::mutate(grading_score  = factor(grading_score,  levels = c(1,0,2,3))) |>"
"0","  # 合併症（参照=0）"
"0","  dplyr::mutate(comp_any_grade = factor(comp_any_grade, levels = c(0,1,2,3))) |>"
"0","  dplyr::mutate(comp_pleural   = factor(comp_pleural,   levels = c(0,1,2,3))) |>"
"0","  dplyr::mutate(comp_resp      = factor(comp_resp,      levels = c(FALSE, TRUE))) |>"
"0","  dplyr::mutate(comp_bleeding  = factor(comp_bleeding,  levels = c(0,1,2,3))) |>"
"0","  dplyr::mutate(comp_ascites   = factor(comp_ascites,   levels = c(0,1,2,3)))"
"0",""
