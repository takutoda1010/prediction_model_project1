"0","# ③ カテゴリカル（factor/ordered）の単一補完：観測比率で確率的代入"
"0","set.seed(20251102)"
"0",""
"0","impute_factor_prop <- function(x){"
"0","  if (!is.factor(x)) return(x)"
"0","  if (all(is.na(x))) return(x)                 # 参照分布が無い場合は未処理のまま"
"0","  idx <- which(is.na(x)); if (!length(idx)) return(x)"
"0","  obs <- x[!is.na(x)]"
"0","  tab <- table(obs)"
"0","  probs <- as.numeric(tab) / sum(tab)"
"0","  vals  <- names(tab)"
"0","  sampled <- sample(vals, length(idx), replace = TRUE, prob = probs)"
"0","  x[idx] <- factor(sampled, levels = levels(x), ordered = is.ordered(x))"
"0","  x"
"0","}"
"0",""
"0","ds07 <- ds07 |>"
"0","  dplyr::mutate("
"0","    dplyr::across("
"0","      .cols = where(is.factor) | where(is.ordered),"
"0","      .fns  = impute_factor_prop"
"0","    )"
"0","  )"
