"0","################################################################################"
"0","# 05_model_builder.R - ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰å‡¦ç†"
"0","# "
"0","# Description: "
"0","#   å„ç¨®å¤‰æ•°é¸æŠæ‰‹æ³•ã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰"
"0","#   Stepwise, LASSO, RFE, å˜å¤‰é‡ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°, äº‹å‰å®šç¾©ãƒ¢ãƒ‡ãƒ«"
"0","#   Coxæ¯”ä¾‹ãƒã‚¶ãƒ¼ãƒ‰ãƒ¢ãƒ‡ãƒ«ãƒ™ãƒ¼ã‚¹"
"0","#"
"0","# Author: Takuto Yoshida"
"0","# Date: 2024-11-07"
"0","################################################################################"
"0",""
"0","# ========================================================================"
"0","# 1. ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰ã®æº–å‚™"
"0","# ========================================================================"
"0",""
"0","#' ãƒ¢ãƒ‡ãƒ«ç”¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param outcome_time æ™‚é–“å¤‰æ•°å"
"0","#' @param outcome_event ã‚¤ãƒ™ãƒ³ãƒˆå¤‰æ•°å"
"0","#' @param variables ä½¿ç”¨ã™ã‚‹å¤‰æ•°ãƒªã‚¹ãƒˆ"
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @return ãƒ¢ãƒ‡ãƒ«ç”¨ãƒ‡ãƒ¼ã‚¿"
"0","prepare_model_data <- function(df, "
"0","                              outcome_time = ""time2y"","
"0","                              outcome_event = ""recur_2y"","
"0","                              variables = NULL,  # â† ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹å¤‰æ•°ãƒªã‚¹ãƒˆã¨ã—ã¦ä½¿ã†"
"0","                              config = NULL) {"
"0","  "
"0","  message(""\nğŸ“Š Preparing model data..."")"
"0","  "
"0","  # ã‚¢ã‚¦ãƒˆã‚«ãƒ ã®ç¢ºèªï¼ˆæ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ç¶­æŒï¼‰"
"0","  if (!outcome_time %in% names(df)) {"
"0","    if (""rfs_months"" %in% names(df)) {"
"0","      df$time2y <- pmin(df$rfs_months, 24, na.rm = FALSE)"
"0","      message(""  Created time2y from rfs_months"")"
"0","    } else {"
"0","      stop(sprintf(""Time variable '%s' not found"", outcome_time))"
"0","    }"
"0","  }"
"0","  "
"0","  if (!outcome_event %in% names(df)) {"
"0","    if (all(c(""recur_tf"", ""rfs_months"") %in% names(df))) {"
"0","      df$recur_2y <- (df$recur_tf == TRUE | df$recur_tf == ""TRUE"" | df$recur_tf == 1) & "
"0","                     (df$rfs_months <= 24)"
"0","      message(""  Created recur_2y from recur_tf and rfs_months"")"
"0","    } else {"
"0","      stop(sprintf(""Event variable '%s' not found"", outcome_event))"
"0","    }"
"0","  }"
"0","  "
"0","  # ===== é‡è¦ãªä¿®æ­£: variablesãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã®ã¿ã‚’ä½¿ç”¨ ====="
"0","  if (!is.null(variables) && length(variables) > 0) {"
"0","    # æŒ‡å®šã•ã‚ŒãŸå¤‰æ•°ã®ã¿ã‚’ä½¿ç”¨"
"0","    use_vars <- intersect(variables, names(df))"
"0","    missing_vars <- setdiff(variables, names(df))"
"0","    "
"0","    message(sprintf(""  Using %d specified variables (missing: %d)"", "
"0","                   length(use_vars), length(missing_vars)))"
"0","    "
"0","    # å¿…è¦ãªåˆ—ã®ã¿é¸æŠ"
"0","    model_data <- df[, c(outcome_time, outcome_event, use_vars), drop = FALSE]"
"0","    "
"0","  } else {"
"0","    # æ—¢å­˜ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‡¦ç†"
"0","    numeric_vars <- names(df)[sapply(df, is.numeric)]"
"0","    factor_vars <- names(df)[sapply(df, is.factor)]"
"0","    "
"0","    exclude_patterns <- c(""id"", ""num"", ""date"", ""time2y"", ""recur_2y"", "
"0","                         ""os_months"", ""rfs_months"", ""vital"", ""death"")"
"0","    "
"0","    use_vars <- setdiff("
"0","      c(numeric_vars, factor_vars),"
"0","      grep(paste(exclude_patterns, collapse = ""|""), "
"0","           c(numeric_vars, factor_vars), "
"0","           value = TRUE, ignore.case = TRUE)"
"0","    )"
"0","    "
"0","    model_data <- df[, c(outcome_time, outcome_event, use_vars), drop = FALSE]"
"0","  }"
"0","  "
"0","  # å®Œå…¨ã‚±ãƒ¼ã‚¹ã®ã¿ï¼ˆæ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ï¼‰"
"0","  n_before <- nrow(model_data)"
"0","  model_data <- na.omit(model_data)"
"0","  n_after <- nrow(model_data)"
"0","  "
"0","  if (n_before > n_after) {"
"0","    message(sprintf(""  Removed %d rows with missing values"", n_before - n_after))"
"0","  }"
"0","  "
"0","  # Survivalã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ"
"0","  model_data$surv_obj <- survival::Surv("
"0","    time = model_data[[outcome_time]],"
"0","    event = as.numeric(model_data[[outcome_event]])"
"0","  )"
"0","  "
"0","  # çµæœã®å±æ€§"
"0","  attr(model_data, ""outcome_time"") <- outcome_time"
"0","  attr(model_data, ""outcome_event"") <- outcome_event"
"0","  attr(model_data, ""variables"") <- use_vars  # â† use_varsã«å¤‰æ›´"
"0","  attr(model_data, ""n_complete"") <- n_after"
"0","  "
"0","  message(sprintf(""  Final dataset: %d rows Ã— %d variables"", "
"0","                 nrow(model_data), length(use_vars)))"
"0","  "
"0","  return(model_data)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 2. Stepwise Selection (Forward/Backward)"
"0","# ========================================================================"
"0",""
"0","#' Stepwiseå¤‰æ•°é¸æŠã«ã‚ˆã‚‹Coxãƒ¢ãƒ‡ãƒ«"
"0","#' @param train_data è¨“ç·´ãƒ‡ãƒ¼ã‚¿"
"0","#' @param direction æ–¹å‘ï¼ˆ""forward"", ""backward"", ""both""ï¼‰"
"0","#' @param criterion åŸºæº–ï¼ˆ""AIC"", ""BIC""ï¼‰"
"0","#' @param trace çµŒéè¡¨ç¤º"
"0","#' @return ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","build_stepwise_model <- function(train_data,"
"0","                                direction = ""both"","
"0","                                criterion = ""AIC"","
"0","                                trace = FALSE) {"
"0","  "
"0","  message(sprintf(""\nğŸ”„ Building Stepwise Cox model (%s, %s)..."", "
"0","                 direction, criterion))"
"0","  "
"0","  # å¤‰æ•°ãƒªã‚¹ãƒˆ"
"0","  variables <- attr(train_data, ""variables"")"
"0","  "
"0","  # ãƒ•ã‚©ãƒ¼ãƒŸãƒ¥ãƒ©ã®ä½œæˆ"
"0","  if (direction == ""forward"") {"
"0","    # Null model ã‹ã‚‰é–‹å§‹"
"0","    null_formula <- as.formula(""surv_obj ~ 1"")"
"0","    full_formula <- as.formula(paste(""surv_obj ~"", paste(variables, collapse = "" + "")))"
"0","    "
"0","    null_model <- survival::coxph(null_formula, data = train_data)"
"0","    "
"0","    # Stepwise forward"
"0","    k <- ifelse(criterion == ""BIC"", log(nrow(train_data)), 2)"
"0","    "
"0","    final_model <- MASS::stepAIC("
"0","      null_model,"
"0","      scope = list(lower = null_formula, upper = full_formula),"
"0","      direction = ""forward"","
"0","      k = k,"
"0","      trace = trace"
"0","    )"
"0","    "
"0","  } else if (direction == ""backward"") {"
"0","    # Full model ã‹ã‚‰é–‹å§‹"
"0","    full_formula <- as.formula(paste(""surv_obj ~"", paste(variables, collapse = "" + "")))"
"0","    "
"0","    full_model <- survival::coxph(full_formula, data = train_data)"
"0","    "
"0","    # Stepwise backward"
"0","    k <- ifelse(criterion == ""BIC"", log(nrow(train_data)), 2)"
"0","    "
"0","    final_model <- MASS::stepAIC("
"0","      full_model,"
"0","      direction = ""backward"","
"0","      k = k,"
"0","      trace = trace"
"0","    )"
"0","    "
"0","  } else {  # both"
"0","    # Null model ã‹ã‚‰é–‹å§‹"
"0","    null_formula <- as.formula(""surv_obj ~ 1"")"
"0","    full_formula <- as.formula(paste(""surv_obj ~"", paste(variables, collapse = "" + "")))"
"0","    "
"0","    null_model <- survival::coxph(null_formula, data = train_data)"
"0","    "
"0","    # Stepwise both"
"0","    k <- ifelse(criterion == ""BIC"", log(nrow(train_data)), 2)"
"0","    "
"0","    final_model <- MASS::stepAIC("
"0","      null_model,"
"0","      scope = list(lower = null_formula, upper = full_formula),"
"0","      direction = ""both"","
"0","      k = k,"
"0","      trace = trace"
"0","    )"
"0","  }"
"0","  "
"0","  # é¸æŠã•ã‚ŒãŸå¤‰æ•°"
"0","  selected_vars <- names(coef(final_model))"
"0","  message(sprintf(""  Selected %d variables: %s"", "
"0","                 length(selected_vars),"
"0","                 paste(head(selected_vars, 5), collapse = "", "")))"
"0","  "
"0","  if (length(selected_vars) > 5) {"
"0","    message(sprintf(""    ... and %d more"", length(selected_vars) - 5))"
"0","  }"
"0","  "
"0","  # ãƒ¢ãƒ‡ãƒ«æƒ…å ±ã‚’å±æ€§ã¨ã—ã¦è¿½åŠ "
"0","  attr(final_model, ""method"") <- paste0(""stepwise_"", direction, ""_"", tolower(criterion))"
"0","  attr(final_model, ""selected_vars"") <- selected_vars"
"0","  attr(final_model, ""n_vars"") <- length(selected_vars)"
"0","  "
"0","  return(final_model)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 3. LASSO Regression"
"0","# ========================================================================"
"0",""
"0","#' LASSO Coxå›å¸°ãƒ¢ãƒ‡ãƒ«"
"0","#' @param train_data è¨“ç·´ãƒ‡ãƒ¼ã‚¿"
"0","#' @param alpha Elastic Netãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆ1=LASSO, 0=Ridgeï¼‰"
"0","#' @param standardize æ¨™æº–åŒ–ã™ã‚‹ã‹"
"0","#' @param nfolds CVåˆ†å‰²æ•°"
"0","#' @param type.measure è©•ä¾¡æŒ‡æ¨™"
"0","#' @return ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","build_lasso_model <- function(train_data,"
"0","                             alpha = 1.0,"
"0","                             standardize = TRUE,"
"0","                             nfolds = 5,"
"0","                             type.measure = ""deviance"") {"
"0","  "
"0","  message(sprintf(""\nğŸ¯ Building LASSO Cox model (alpha=%.1f)..."", alpha))"
"0","  "
"0","  # å¤‰æ•°ãƒªã‚¹ãƒˆ"
"0","  variables <- attr(train_data, ""variables"")"
"0","  "
"0","  # è¡Œåˆ—å½¢å¼ã«å¤‰æ›"
"0","  X <- model.matrix(~ . - 1, data = train_data[, variables, drop = FALSE])"
"0","  "
"0","  # Survivalã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","  y <- train_data$surv_obj"
"0","  "
"0","  # Cross-validation"
"0","  set.seed(123)  # å†ç¾æ€§ã®ãŸã‚"
"0","  cv_fit <- glmnet::cv.glmnet("
"0","    x = X,"
"0","    y = y,"
"0","    family = ""cox"","
"0","    alpha = alpha,"
"0","    standardize = standardize,"
"0","    nfolds = nfolds,"
"0","    type.measure = type.measure"
"0","  )"
"0","  "
"0","  # æœ€é©ãªlambdaã§ã®ãƒ¢ãƒ‡ãƒ«"
"0","  final_model <- glmnet::glmnet("
"0","    x = X,"
"0","    y = y,"
"0","    family = ""cox"","
"0","    alpha = alpha,"
"0","    lambda = cv_fit$lambda.min,"
"0","    standardize = standardize"
"0","  )"
"0","  "
"0","  # ä¿‚æ•°ã®å–å¾—"
"0","  coef_matrix <- as.matrix(coef(final_model))"
"0","  selected_vars <- rownames(coef_matrix)[coef_matrix[, 1] != 0]"
"0","  "
"0","  message(sprintf(""  Optimal lambda: %.4f"", cv_fit$lambda.min))"
"0","  message(sprintf(""  Selected %d variables: %s"", "
"0","                 length(selected_vars),"
"0","                 paste(head(selected_vars, 5), collapse = "", "")))"
"0","  "
"0","  if (length(selected_vars) > 5) {"
"0","    message(sprintf(""    ... and %d more"", length(selected_vars) - 5))"
"0","  }"
"0","  "
"0","  # çµæœã®æ§‹é€ åŒ–"
"0","  result <- list("
"0","    glmnet_model = final_model,"
"0","    cv_fit = cv_fit,"
"0","    selected_vars = selected_vars,"
"0","    lambda_min = cv_fit$lambda.min,"
"0","    lambda_1se = cv_fit$lambda.1se,"
"0","    X = X,"
"0","    y = y"
"0","  )"
"0","  "
"0","  attr(result, ""method"") <- paste0(""lasso_alpha"", alpha)"
"0","  attr(result, ""selected_vars"") <- selected_vars"
"0","  attr(result, ""n_vars"") <- length(selected_vars)"
"0","  "
"0","  class(result) <- c(""lasso_cox"", ""list"")"
"0","  "
"0","  return(result)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 4. LASSO with Constraint (å¤‰æ•°æ•°åˆ¶ç´„ç‰ˆ)"
"0","# ========================================================================"
"0",""
"0","#' å¤‰æ•°æ•°åˆ¶ç´„ä»˜ãLASSO"
"0","#' @param train_data è¨“ç·´ãƒ‡ãƒ¼ã‚¿"
"0","#' @param target_nvars ç›®æ¨™å¤‰æ•°æ•°"
"0","#' @param max_nvars æœ€å¤§å¤‰æ•°æ•°"
"0","#' @return ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","build_lasso_constrained <- function(train_data,"
"0","                                   target_nvars = 5,"
"0","                                   max_nvars = 6) {"
"0","  "
"0","  message(sprintf(""\nğŸ¯ Building constrained LASSO (target=%d vars)..."", "
"0","                 target_nvars))"
"0","  "
"0","  # å¤‰æ•°ãƒªã‚¹ãƒˆ"
"0","  variables <- attr(train_data, ""variables"")"
"0","  "
"0","  # è¡Œåˆ—å½¢å¼ã«å¤‰æ›"
"0","  X <- model.matrix(~ . - 1, data = train_data[, variables, drop = FALSE])"
"0","  y <- train_data$surv_obj"
"0","  "
"0","  # Lambdaç³»åˆ—ã§å®Œå…¨ãƒ‘ã‚¹ã‚’è¨ˆç®—"
"0","  full_fit <- glmnet::glmnet("
"0","    x = X,"
"0","    y = y,"
"0","    family = ""cox"","
"0","    alpha = 1,"
"0","    standardize = TRUE"
"0","  )"
"0","  "
"0","  # å„lambdaã§ã®å¤‰æ•°æ•°ã‚’ç¢ºèª"
"0","  n_vars <- apply(coef(full_fit), 2, function(x) sum(x != 0))"
"0","  "
"0","  # ç›®æ¨™å¤‰æ•°æ•°ã«æœ€ã‚‚è¿‘ã„lambdaã‚’é¸æŠ"
"0","  target_idx <- which.min(abs(n_vars - target_nvars))"
"0","  "
"0","  # å¤‰æ•°æ•°ãŒç¯„å›²å†…ã®lambdaã‚’æ¢ã™"
"0","  valid_idx <- which(n_vars >= target_nvars & n_vars <= max_nvars)"
"0","  "
"0","  if (length(valid_idx) > 0) {"
"0","    # Cross-validationã‚¹ã‚³ã‚¢ã§æœ€è‰¯ã‚’é¸æŠ"
"0","    cv_fit <- glmnet::cv.glmnet("
"0","      x = X,"
"0","      y = y,"
"0","      family = ""cox"","
"0","      alpha = 1,"
"0","      lambda = full_fit$lambda[valid_idx],"
"0","      standardize = TRUE,"
"0","      nfolds = 5"
"0","    )"
"0","    "
"0","    optimal_lambda <- cv_fit$lambda.min"
"0","  } else {"
"0","    # ç¯„å›²å†…ãŒãªã„å ´åˆã¯æœ€ã‚‚è¿‘ã„ã‚‚ã®ã‚’ä½¿ç”¨"
"0","    optimal_lambda <- full_fit$lambda[target_idx]"
"0","  }"
"0","  "
"0","  # æœ€çµ‚ãƒ¢ãƒ‡ãƒ«"
"0","  final_model <- glmnet::glmnet("
"0","    x = X,"
"0","    y = y,"
"0","    family = ""cox"","
"0","    alpha = 1,"
"0","    lambda = optimal_lambda,"
"0","    standardize = TRUE"
"0","  )"
"0","  "
"0","  # ä¿‚æ•°ã®å–å¾—"
"0","  coef_matrix <- as.matrix(coef(final_model))"
"0","  selected_vars <- rownames(coef_matrix)[coef_matrix[, 1] != 0]"
"0","  "
"0","  message(sprintf(""  Selected %d variables: %s"", "
"0","                 length(selected_vars),"
"0","                 paste(selected_vars, collapse = "", "")))"
"0","  "
"0","  # çµæœã®æ§‹é€ åŒ–"
"0","  result <- list("
"0","    glmnet_model = final_model,"
"0","    selected_vars = selected_vars,"
"0","    lambda = optimal_lambda,"
"0","    X = X,"
"0","    y = y"
"0","  )"
"0","  "
"0","  attr(result, ""method"") <- ""lasso_constrained"""
"0","  attr(result, ""selected_vars"") <- selected_vars"
"0","  attr(result, ""n_vars"") <- length(selected_vars)"
"0","  attr(result, ""target_nvars"") <- target_nvars"
"0","  "
"0","  class(result) <- c(""lasso_cox"", ""list"")"
"0","  "
"0","  return(result)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 5. Univariate Screening"
"0","# ========================================================================"
"0",""
"0","#' å˜å¤‰é‡ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°"
"0","#' @param train_data è¨“ç·´ãƒ‡ãƒ¼ã‚¿"
"0","#' @param p_threshold på€¤ã®é–¾å€¤"
"0","#' @param stop_p åœæ­¢på€¤"
"0","#' @param max_vars æœ€å¤§å¤‰æ•°æ•°"
"0","#' @return ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","build_univariate_screen_model <- function(train_data,"
"0","                                         p_threshold = 0.10,"
"0","                                         stop_p = 0.05,"
"0","                                         max_vars = 20) {"
"0","  "
"0","  message(sprintf(""\nğŸ” Building Univariate Screening model (p<%.2f)..."", "
"0","                 p_threshold))"
"0","  "
"0","  variables <- attr(train_data, ""variables"")"
"0","  "
"0","  # å„å¤‰æ•°ã®å˜å¤‰é‡è§£æ"
"0","  univariate_results <- data.frame("
"0","    variable = character(),"
"0","    coef = numeric(),"
"0","    hr = numeric(),"
"0","    se = numeric(),"
"0","    z = numeric(),"
"0","    p_value = numeric(),"
"0","    stringsAsFactors = FALSE"
"0","  )"
"0","  "
"0","  for (var in variables) {"
"0","    # å˜å¤‰é‡Coxãƒ¢ãƒ‡ãƒ«"
"0","    formula <- as.formula(paste(""surv_obj ~"", var))"
"0","    "
"0","    tryCatch({"
"0","      uni_model <- survival::coxph(formula, data = train_data)"
"0","      summary_uni <- summary(uni_model)"
"0","      "
"0","      # çµæœã®ä¿å­˜"
"0","      coef_info <- summary_uni$coefficients"
"0","      "
"0","      # å› å­å¤‰æ•°ã®å ´åˆã¯è¤‡æ•°è¡Œ"
"0","      if (nrow(coef_info) > 0) {"
"0","        for (i in 1:nrow(coef_info)) {"
"0","          univariate_results <- rbind("
"0","            univariate_results,"
"0","            data.frame("
"0","              variable = ifelse(nrow(coef_info) == 1, var, rownames(coef_info)[i]),"
"0","              coef = coef_info[i, ""coef""],"
"0","              hr = coef_info[i, ""exp(coef)""],"
"0","              se = coef_info[i, ""se(coef)""],"
"0","              z = coef_info[i, ""z""],"
"0","              p_value = coef_info[i, ""Pr(>|z|)""],"
"0","              stringsAsFactors = FALSE"
"0","            )"
"0","          )"
"0","        }"
"0","      }"
"0","    }, error = function(e) {"
"0","      message(sprintf(""    Warning: Failed to fit univariate model for %s"", var))"
"0","    })"
"0","  }"
"0","  "
"0","  # på€¤ã§ã‚½ãƒ¼ãƒˆ"
"0","  univariate_results <- univariate_results[order(univariate_results$p_value), ]"
"0","  "
"0","  # ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°"
"0","  selected_results <- univariate_results[univariate_results$p_value < p_threshold, ]"
"0","  "
"0","  if (nrow(selected_results) > max_vars) {"
"0","    selected_results <- selected_results[1:max_vars, ]"
"0","  }"
"0","  "
"0","  # é¸æŠã•ã‚ŒãŸå¤‰æ•°ï¼ˆå…ƒã®å¤‰æ•°åã‚’å–å¾—ï¼‰"
"0","  selected_vars <- unique(sapply(selected_results$variable, function(x) {"
"0","    # å› å­ã®ãƒ¬ãƒ™ãƒ«è¡¨è¨˜ã‚’é™¤å»"
"0","    gsub(""^(.+?)(\\[.+\\])?$"", ""\\1"", x)"
"0","  }))"
"0","  "
"0","  message(sprintf(""  Selected %d variables (p < %.2f):"", "
"0","                 length(selected_vars), p_threshold))"
"0","  "
"0","  # ä¸Šä½5å¤‰æ•°ã®på€¤ã‚’è¡¨ç¤º"
"0","  top_vars <- head(selected_results, 5)"
"0","  for (i in 1:nrow(top_vars)) {"
"0","    message(sprintf(""    %s: p=%.4f, HR=%.2f"", "
"0","                   top_vars$variable[i], "
"0","                   top_vars$p_value[i],"
"0","                   top_vars$hr[i]))"
"0","  }"
"0","  "
"0","  # å¤šå¤‰é‡ãƒ¢ãƒ‡ãƒ«ã®æ§‹ç¯‰"
"0","  if (length(selected_vars) > 0) {"
"0","    multi_formula <- as.formula(paste(""surv_obj ~"", "
"0","                                     paste(selected_vars, collapse = "" + "")))"
"0","    final_model <- survival::coxph(multi_formula, data = train_data)"
"0","  } else {"
"0","    warning(""No variables selected in univariate screening"")"
"0","    final_model <- NULL"
"0","  }"
"0","  "
"0","  # çµæœã®æ§‹é€ åŒ–"
"0","  result <- list("
"0","    model = final_model,"
"0","    univariate_results = univariate_results,"
"0","    selected_results = selected_results,"
"0","    selected_vars = selected_vars,"
"0","    p_threshold = p_threshold"
"0","  )"
"0","  "
"0","  attr(result, ""method"") <- ""univariate_screen"""
"0","  attr(result, ""selected_vars"") <- selected_vars"
"0","  attr(result, ""n_vars"") <- length(selected_vars)"
"0","  "
"0","  class(result) <- c(""univariate_cox"", ""list"")"
"0","  "
"0","  return(result)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 6. Recursive Feature Elimination (RFE)"
"0","# ========================================================================"
"0",""
"0","#' RFEã«ã‚ˆã‚‹å¤‰æ•°é¸æŠ"
"0","#' @param train_data è¨“ç·´ãƒ‡ãƒ¼ã‚¿"
"0","#' @param min_vars æœ€å°å¤‰æ•°æ•°"
"0","#' @param step_size ä¸€åº¦ã«å‰Šé™¤ã™ã‚‹å¤‰æ•°æ•°"
"0","#' @return ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","build_rfe_model <- function(train_data,"
"0","                           min_vars = 5,"
"0","                           step_size = 1) {"
"0","  "
"0","  message(""\nâ™»ï¸ Building RFE Cox model..."")"
"0","  "
"0","  variables <- attr(train_data, ""variables"")"
"0","  current_vars <- variables"
"0","  "
"0","  # RFEãƒ—ãƒ­ã‚»ã‚¹"
"0","  rfe_history <- list()"
"0","  best_c_index <- 0"
"0","  best_vars <- NULL"
"0","  "
"0","  while (length(current_vars) >= min_vars) {"
"0","    # ç¾åœ¨ã®å¤‰æ•°ã‚»ãƒƒãƒˆã§ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰"
"0","    formula <- as.formula(paste(""surv_obj ~"", paste(current_vars, collapse = "" + "")))"
"0","    "
"0","    tryCatch({"
"0","      model <- survival::coxph(formula, data = train_data)"
"0","      "
"0","      # C-indexã®è¨ˆç®—"
"0","      c_index <- survival::concordance(model)$concordance"
"0","      "
"0","      # å±¥æ­´ã«ä¿å­˜"
"0","      rfe_history[[length(rfe_history) + 1]] <- list("
"0","        n_vars = length(current_vars),"
"0","        c_index = c_index,"
"0","        vars = current_vars"
"0","      )"
"0","      "
"0","      # ãƒ™ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«ã®æ›´æ–°"
"0","      if (c_index > best_c_index) {"
"0","        best_c_index <- c_index"
"0","        best_vars <- current_vars"
"0","      }"
"0","      "
"0","      # å¤‰æ•°é‡è¦åº¦ï¼ˆçµ¶å¯¾å€¤ã®zå€¤ï¼‰"
"0","      summary_model <- summary(model)"
"0","      importance <- abs(summary_model$coefficients[, ""z""])"
"0","      "
"0","      # æœ€ã‚‚é‡è¦åº¦ã®ä½ã„å¤‰æ•°ã‚’å‰Šé™¤"
"0","      if (length(current_vars) > min_vars) {"
"0","        # å¤‰æ•°åã®å–å¾—ï¼ˆå› å­ã®å ´åˆã®å‡¦ç†ï¼‰"
"0","        var_importance <- sapply(current_vars, function(v) {"
"0","          idx <- grep(paste0(""^"", v), names(importance))"
"0","          if (length(idx) > 0) {"
"0","            mean(importance[idx])"
"0","          } else {"
"0","            0"
"0","          }"
"0","        })"
"0","        "
"0","        # å‰Šé™¤ã™ã‚‹å¤‰æ•°"
"0","        n_remove <- min(step_size, length(current_vars) - min_vars)"
"0","        remove_vars <- names(sort(var_importance))[1:n_remove]"
"0","        current_vars <- setdiff(current_vars, remove_vars)"
"0","        "
"0","        message(sprintf(""  Variables: %d, C-index: %.3f"", "
"0","                       length(current_vars), c_index))"
"0","      } else {"
"0","        break"
"0","      }"
"0","      "
"0","    }, error = function(e) {"
"0","      message(sprintf(""    Warning: Failed with %d variables"", length(current_vars)))"
"0","      break"
"0","    })"
"0","  }"
"0","  "
"0","  # æœ€è‰¯ã®å¤‰æ•°ã‚»ãƒƒãƒˆã§ãƒ¢ãƒ‡ãƒ«å†æ§‹ç¯‰"
"0","  if (!is.null(best_vars)) {"
"0","    final_formula <- as.formula(paste(""surv_obj ~"", paste(best_vars, collapse = "" + "")))"
"0","    final_model <- survival::coxph(final_formula, data = train_data)"
"0","    "
"0","    message(sprintf(""  Best model: %d variables, C-index: %.3f"", "
"0","                   length(best_vars), best_c_index))"
"0","    message(sprintf(""  Selected: %s"", "
"0","                   paste(head(best_vars, 5), collapse = "", "")))"
"0","    "
"0","    if (length(best_vars) > 5) {"
"0","      message(sprintf(""    ... and %d more"", length(best_vars) - 5))"
"0","    }"
"0","  } else {"
"0","    final_model <- NULL"
"0","    best_vars <- character()"
"0","  }"
"0","  "
"0","  # çµæœã®æ§‹é€ åŒ–"
"0","  result <- list("
"0","    model = final_model,"
"0","    selected_vars = best_vars,"
"0","    best_c_index = best_c_index,"
"0","    rfe_history = rfe_history"
"0","  )"
"0","  "
"0","  attr(result, ""method"") <- ""rfe"""
"0","  attr(result, ""selected_vars"") <- best_vars"
"0","  attr(result, ""n_vars"") <- length(best_vars)"
"0","  "
"0","  class(result) <- c(""rfe_cox"", ""list"")"
"0","  "
"0","  return(result)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 7. Pre-defined Model"
"0","# ========================================================================"
"0",""
"0","#' äº‹å‰å®šç¾©å¤‰æ•°ã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«"
"0","#' @param train_data è¨“ç·´ãƒ‡ãƒ¼ã‚¿"
"0","#' @param predefined_vars äº‹å‰å®šç¾©å¤‰æ•°ãƒªã‚¹ãƒˆ"
"0","#' @return ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","build_predefined_model <- function(train_data,"
"0","                                  predefined_vars = NULL) {"
"0","  "
"0","  message(""\nğŸ“Œ Building Pre-defined Cox model..."")"
"0","  "
"0","  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¤‰æ•°ï¼ˆè‡¨åºŠçš„ã«é‡è¦ãªå¤‰æ•°ï¼‰"
"0","  if (is.null(predefined_vars)) {"
"0","    predefined_vars <- c(""age"", ""sex"", ""ALBIscore"", ""stage_diag"", ""t"", ""n"", ""m"")"
"0","  }"
"0","  "
"0","  # åˆ©ç”¨å¯èƒ½ãªå¤‰æ•°ã®ã¿é¸æŠ"
"0","  available_vars <- intersect(predefined_vars, names(train_data))"
"0","  missing_vars <- setdiff(predefined_vars, names(train_data))"
"0","  "
"0","  if (length(missing_vars) > 0) {"
"0","    message(sprintf(""  Warning: %d predefined variables not found: %s"","
"0","                   length(missing_vars),"
"0","                   paste(missing_vars, collapse = "", "")))"
"0","  }"
"0","  "
"0","  if (length(available_vars) == 0) {"
"0","    stop(""No predefined variables found in data"")"
"0","  }"
"0","  "
"0","  message(sprintf(""  Using %d variables: %s"", "
"0","                 length(available_vars),"
"0","                 paste(available_vars, collapse = "", "")))"
"0","  "
"0","  # ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰"
"0","  formula <- as.formula(paste(""surv_obj ~"", paste(available_vars, collapse = "" + "")))"
"0","  final_model <- survival::coxph(formula, data = train_data)"
"0","  "
"0","  # çµæœã®å±æ€§"
"0","  attr(final_model, ""method"") <- ""predefined"""
"0","  attr(final_model, ""selected_vars"") <- available_vars"
"0","  attr(final_model, ""n_vars"") <- length(available_vars)"
"0","  "
"0","  return(final_model)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 8. çµ±åˆãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' å…¨ãƒ¢ãƒ‡ãƒ«ã‚’ä¸€æ‹¬æ§‹ç¯‰"
"0","#' @param split_data åˆ†å‰²ãƒ‡ãƒ¼ã‚¿"
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ"
"0","#' @return ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ"
"0","build_all_models <- function(split_data, "
"0","                            config = NULL, "
"0","                            variables = NULL,"
"0","                            variable_set_name = ""postop_pathology_custom"") {  # â† è¿½åŠ "
"0","  "
"0","  message(""\n========================================"")"
"0","  message(""Building All Models"")"
"0","  message(sprintf(""Using variable set: %s"", variable_set_name))  # â† è¿½åŠ "
"0","  message(""========================================"")"
"0","  "
"0","  # ===== è¿½åŠ : YAMLã‹ã‚‰å¤‰æ•°ã‚»ãƒƒãƒˆã‚’å–å¾— ====="
"0","  candidate_vars <- NULL"
"0","  if (!is.null(variables) && !is.null(variables$variable_sets[[variable_set_name]])) {"
"0","    candidate_vars <- variables$variable_sets[[variable_set_name]]"
"0","    message(sprintf(""  Loaded %d variables from '%s'"", "
"0","                   length(candidate_vars), variable_set_name))"
"0","  }"
"0","  "
"0","  # è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ï¼ˆä¿®æ­£: candidate_varsã‚’æ¸¡ã™ï¼‰"
"0","  train_data <- prepare_model_data("
"0","    split_data$train,"
"0","    outcome_time = ""time2y"","
"0","    outcome_event = ""recur_2y"","
"0","    variables = candidate_vars,  # â† è¿½åŠ : YAMLã®å¤‰æ•°ã‚’æ¸¡ã™"
"0","    config = config"
"0","  )"
"0","  # ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ"
"0","  models <- list()"
"0","  "
"0","  # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ¢ãƒ‡ãƒ«ã®å–å¾—"
"0","  if (!is.null(config) && !is.null(config$models$active)) {"
"0","    active_models <- config$models$active"
"0","  } else {"
"0","    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ"
"0","    active_models <- c("
"0","      ""m1_stepaic_forward"","
"0","      ""m2_stepaic_backward"", "
"0","      ""m3_stepbic_forward"","
"0","      ""m4_stepbic_backward"","
"0","      ""m5_univariate_screen"","
"0","      ""m6_rfe"","
"0","      ""m7_lasso"","
"0","      ""m7k_lasso_constrained"","
"0","      ""m8_predefined"""
"0","    )"
"0","  }"
"0","  "
"0","  # å„ãƒ¢ãƒ‡ãƒ«ã®æ§‹ç¯‰"
"0","  for (model_name in active_models) {"
"0","    "
"0","    message(sprintf(""\n--- Model: %s ---"", model_name))"
"0","    "
"0","    tryCatch({"
"0","      "
"0","      if (model_name == ""m1_stepaic_forward"") {"
"0","        models[[model_name]] <- build_stepwise_model("
"0","          train_data, "
"0","          direction = ""forward"", "
"0","          criterion = ""AIC"""
"0","        )"
"0","        "
"0","      } else if (model_name == ""m2_stepaic_backward"") {"
"0","        models[[model_name]] <- build_stepwise_model("
"0","          train_data, "
"0","          direction = ""backward"", "
"0","          criterion = ""AIC"""
"0","        )"
"0","        "
"0","      } else if (model_name == ""m3_stepbic_forward"") {"
"0","        models[[model_name]] <- build_stepwise_model("
"0","          train_data, "
"0","          direction = ""forward"", "
"0","          criterion = ""BIC"""
"0","        )"
"0","        "
"0","      } else if (model_name == ""m4_stepbic_backward"") {"
"0","        models[[model_name]] <- build_stepwise_model("
"0","          train_data, "
"0","          direction = ""backward"", "
"0","          criterion = ""BIC"""
"0","        )"
"0","        "
"0","      } else if (model_name == ""m5_univariate_screen"") {"
"0","        p_threshold <- 0.10"
"0","        if (!is.null(config$models$settings$univariate_screen$p_threshold)) {"
"0","          p_threshold <- config$models$settings$univariate_screen$p_threshold"
"0","        }"
"0","        "
"0","        models[[model_name]] <- build_univariate_screen_model("
"0","          train_data,"
"0","          p_threshold = p_threshold"
"0","        )"
"0","        "
"0","      } else if (model_name == ""m6_rfe"") {"
"0","        min_vars <- 5"
"0","        if (!is.null(config$models$settings$rfe$min_vars)) {"
"0","          min_vars <- config$models$settings$rfe$min_vars"
"0","        }"
"0","        "
"0","        models[[model_name]] <- build_rfe_model("
"0","          train_data,"
"0","          min_vars = min_vars"
"0","        )"
"0","        "
"0","      } else if (model_name == ""m7_lasso"") {"
"0","        models[[model_name]] <- build_lasso_model(train_data)"
"0","        "
"0","      } else if (model_name == ""m7k_lasso_constrained"") {"
"0","        target_vars <- c(4, 6)"
"0","        if (!is.null(config$models$settings$lasso_constrained$target_variables)) {"
"0","          target_vars <- config$models$settings$lasso_constrained$target_variables"
"0","        }"
"0","        "
"0","        models[[model_name]] <- build_lasso_constrained("
"0","          train_data,"
"0","          target_nvars = target_vars[1],"
"0","          max_nvars = target_vars[2]"
"0","        )"
"0","        "
"0","      } else if (model_name == ""m8_predefined"") {"
"0","        predefined_vars <- NULL"
"0","        if (!is.null(config$models$settings$predefined$variables)) {"
"0","          predefined_vars <- config$models$settings$predefined$variables"
"0","        }"
"0","        "
"0","        models[[model_name]] <- build_predefined_model("
"0","          train_data,"
"0","          predefined_vars = predefined_vars"
"0","        )"
"0","        "
"0","      } else {"
"0","        message(sprintf(""  Unknown model: %s"", model_name))"
"0","      }"
"0","      "
"0","    }, error = function(e) {"
"0","      message(sprintf(""  âŒ Error building %s: %s"", model_name, e$message))"
"0","      models[[model_name]] <- NULL"
"0","    })"
"0","  }"
"0","  "
"0","  # ã‚µãƒãƒªãƒ¼"
"0","  message(""\nğŸ“Š Model Building Summary:"")"
"0","  "
"0","  for (model_name in names(models)) {"
"0","    if (!is.null(models[[model_name]])) {"
"0","      n_vars <- attr(models[[model_name]], ""n_vars"")"
"0","      if (is.null(n_vars)) {"
"0","        # coxphã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ"
"0","        if (""coefficients"" %in% names(models[[model_name]])) {"
"0","          n_vars <- length(coef(models[[model_name]]))"
"0","        }"
"0","      }"
"0","      message(sprintf(""  %s: %d variables"", model_name, n_vars))"
"0","    } else {"
"0","      message(sprintf(""  %s: Failed"", model_name))"
"0","    }"
"0","  }"
"0","  "
"0","  message(""\nâœ… Model building completed!"")"
"0","  message(""========================================\n"")"
"0","  "
"0","  # çµæœã®å±æ€§"
"0","  attr(models, ""train_data"") <- train_data"
"0","  attr(models, ""split_data"") <- split_data"
"0","  attr(models, ""config"") <- config"
"0","  "
"0","  return(models)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 9. ãƒ¢ãƒ‡ãƒ«ã®ä¿å­˜ã¨èª­ã¿è¾¼ã¿"
"0","# ========================================================================"
"0",""
"0","#' ãƒ¢ãƒ‡ãƒ«ã‚’ä¿å­˜"
"0","#' @param models ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ"
"0","#' @param file_path ä¿å­˜å…ˆãƒ‘ã‚¹"
"0","save_models <- function(models, file_path) {"
"0","  "
"0","  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ"
"0","  dir_path <- dirname(file_path)"
"0","  if (!dir.exists(dir_path)) {"
"0","    dir.create(dir_path, recursive = TRUE, showWarnings = FALSE)"
"0","  }"
"0","  "
"0","  saveRDS(models, file = file_path)"
"0","  message(sprintf(""  âœ“ Models saved to: %s"", file_path))"
"0","}"
"0",""
"0","#' ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿"
"0","#' @param file_path ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹"
"0","#' @return ãƒ¢ãƒ‡ãƒ«ãƒªã‚¹ãƒˆ"
"0","load_models <- function(file_path) {"
"0","  "
"0","  if (!file.exists(file_path)) {"
"0","    stop(sprintf(""Model file not found: %s"", file_path))"
"0","  }"
"0","  "
"0","  models <- readRDS(file_path)"
"0","  message(sprintf(""  âœ“ Models loaded from: %s"", file_path))"
"0","  "
"0","  return(models)"
"0","}"
