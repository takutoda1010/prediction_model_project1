"0","# ========================================================================"
"0","# 3. キャリブレーション評価（修正版）"
"0","# ========================================================================"
"0",""
"0","message(""\n2. Calibration Assessment (Fixed)"")"
"2","
2. Calibration Assessment (Fixed)
"
"0","message(""----------------------------------------"")"
"2","----------------------------------------
"
"0","assess_calibration_robust <- function(model, data, time_point = 24, n_groups = 10) {"
"0","  "
"0","  # リスクスコアから予測確率を計算"
"0","  if (inherits(model, ""coxph"")) {"
"0","    lp <- predict(model, newdata = data, type = ""lp"")"
"0","  } else if (inherits(model, ""list"") && ""model"" %in% names(model)) {"
"0","    model <- model$model"
"0","    lp <- predict(model, newdata = data, type = ""lp"")"
"0","  } else {"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # ベースラインハザードを使った予測確率の計算"
"0","  basehaz_df <- basehaz(model, centered = FALSE)"
"0","  time_idx <- which.min(abs(basehaz_df$time - time_point))"
"0","  "
"0","  if (length(time_idx) == 0) {"
"0","    # 24ヶ月のデータがない場合は最後の時点を使用"
"0","    time_idx <- nrow(basehaz_df)"
"0","  }"
"0","  "
"0","  baseline_cumhaz <- basehaz_df$hazard[time_idx]"
"0","  pred_prob <- 1 - exp(-baseline_cumhaz * exp(lp))"
"0","  "
"0","  # 予測確率が有効か確認"
"0","  if (all(is.na(pred_prob)) || length(unique(pred_prob)) < 3) {"
"0","    message(""  Warning: Insufficient variation in predicted probabilities"")"
"0","    return(NULL)"
"0","  }"
"0","  "
"0","  # グループ分割（エラーハンドリング付き）"
"0","  tryCatch({"
"0","    # 分位数でグループ分割"
"0","    if (length(unique(pred_prob)) >= n_groups) {"
"0","      pred_groups <- cut(pred_prob, "
"0","                        breaks = quantile(pred_prob, probs = seq(0, 1, length.out = n_groups + 1)),"
"0","                        include.lowest = TRUE,"
"0","                        labels = FALSE)"
"0","    } else {"
"0","      # 予測値のユニーク数が少ない場合はグループ数を減らす"
"0","      n_groups <- min(5, length(unique(pred_prob)))"
"0","      pred_groups <- cut(pred_prob, "
"0","                        breaks = n_groups,"
"0","                        include.lowest = TRUE,"
"0","                        labels = FALSE)"
"0","    }"
"0","  }, error = function(e) {"
"0","    # エラーの場合は等間隔でグループ分割"
"0","    pred_groups <- cut(rank(pred_prob), breaks = n_groups, labels = FALSE)"
"0","  })"
"0","  "
"0","  # 各グループの観察・期待イベント率"
"0","  calibration_data <- data.frame()"
"0","  "
"0","  for (g in 1:n_groups) {"
"0","    idx <- which(pred_groups == g)"
"0","    "
"0","    if (length(idx) >= 3) {  # 最小サンプルサイズを3に緩和"
"0","      # 観察イベント率（単純な比率）"
"0","      events_in_group <- sum(data$recur_2y[idx] == TRUE & data$time2y[idx] <= time_point)"
"0","      total_in_group <- length(idx)"
"0","      observed <- events_in_group / total_in_group"
"0","      "
"0","      # 期待イベント率"
"0","      expected <- mean(pred_prob[idx])"
"0","      "
"0","      calibration_data <- rbind(calibration_data, data.frame("
"0","        group = g,"
"0","        n = length(idx),"
"0","        expected = expected,"
"0","        observed = observed,"
"0","        events = events_in_group"
"0","      ))"
"0","    }"
"0","  }"
"0","  "
"0","  # データが十分にない場合"
"0","  if (nrow(calibration_data) < 3) {"
"0","    message(""  Warning: Insufficient data for calibration assessment"")"
"0","    return(list("
"0","      data = calibration_data,"
"0","      slope = NA,"
"0","      intercept = NA"
"0","    ))"
"0","  }"
"0","  "
"0","  # Calibration-in-the-large と Calibration slope"
"0","  cal_model <- tryCatch({"
"0","    lm(observed ~ expected, data = calibration_data, weights = n)"
"0","  }, error = function(e) {"
"0","    lm(observed ~ expected, data = calibration_data)  # weightなしで再試行"
"0","  })"
"0","  "
"0","  calibration_slope <- coef(cal_model)[2]"
"0","  calibration_intercept <- coef(cal_model)[1]"
"0","  "
"0","  return(list("
"0","    data = calibration_data,"
"0","    slope = calibration_slope,"
"0","    intercept = calibration_intercept"
"0","  ))"
"0","}"
"0",""
"0","# ベストモデルのキャリブレーション評価"
"0","best_calibration <- assess_calibration_robust("
"0","  model = best_model,"
"0","  data = split_data_fixed$test,"
"0","  time_point = 24"
"0",")"
"0",""
"0","if (!is.null(best_calibration)) {"
"0","  message(sprintf(""\nBest Model Calibration:""))"
"0","  message(sprintf(""  Calibration-in-the-large (intercept): %.3f"", "
"0","                 ifelse(is.na(best_calibration$intercept), NA, best_calibration$intercept)))"
"0","  message(sprintf(""  Calibration slope: %.3f"", "
"0","                 ifelse(is.na(best_calibration$slope), NA, best_calibration$slope)))"
"0","  "
"0","  if (!is.na(best_calibration$slope)) {"
"0","    interpretation <- ifelse("
"0","      abs(best_calibration$slope - 1) < 0.2, "
"0","      ""Good calibration"","
"0","      ifelse(best_calibration$slope < 0.8, "
"0","             ""Overfitting tendency"", "
"0","             ifelse(best_calibration$slope > 1.2,"
"0","                    ""Underfitting tendency"","
"0","                    ""Acceptable calibration""))"
"0","    )"
"0","    message(sprintf(""  Interpretation: %s"", interpretation))"
"0","  }"
"0","}"
"2","
Best Model Calibration:
"
"2","  Calibration-in-the-large (intercept): -0.196
"
"2","  Calibration slope: 0.913
"
"2","  Interpretation: Good calibration
"
