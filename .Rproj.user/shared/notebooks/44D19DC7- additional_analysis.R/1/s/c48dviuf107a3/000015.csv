"0","# ========================================================================"
"0","# 完全修正版：ROCカーブ作成（線が描画される版）"
"0","# ========================================================================"
"0",""
"0","message(""\n========================================"")"
"2","
========================================
"
"0","message(""FIXED ROC CURVES - COMPLETE SOLUTION"")"
"2","FIXED ROC CURVES - COMPLETE SOLUTION
"
"0","message(""========================================\n"")"
"2","========================================

"
"0","# ROC作成関数（完全修正版）"
"0","create_roc_curves_complete <- function(models, data, time_point = 24, output_file = NULL) {"
"0","  "
"0","  require(timeROC)"
"0","  require(pROC)  # バックアップ用"
"0","  "
"0","  # 結果格納用"
"0","  all_roc_data <- list()"
"0","  all_auc_values <- list()"
"0","  "
"0","  # カラーパレット"
"0","  model_colors <- c(""#E69F00"", ""#56B4E9"", ""#009E73"", ""#F0E442"", "
"0","                    ""#0072B2"", ""#D55E00"", ""#CC79A7"", ""#999999"", ""#000000"")"
"0","  "
"0","  # 各モデルのROC計算"
"0","  model_idx <- 0"
"0","  "
"0","  for (model_name in names(models)) {"
"0","    model <- models[[model_name]]"
"0","    model_idx <- model_idx + 1"
"0","    "
"0","    if (!is.null(model)) {"
"0","      message(sprintf(""Processing: %s"", model_name))"
"0","      "
"0","      # リスクスコアを取得"
"0","      risk_score <- tryCatch({"
"0","        if (inherits(model, ""coxph"")) {"
"0","          predict(model, newdata = data, type = ""lp"")"
"0","        } else if (inherits(model, ""list"") && ""model"" %in% names(model) && !is.null(model$model)) {"
"0","          predict(model$model, newdata = data, type = ""lp"")"
"0","        } else if (inherits(model, ""lasso_cox"")) {"
"0","          # LASSOモデル用の特別処理"
"0","          if (!is.null(model$selected_vars) && length(model$selected_vars) > 0) {"
"0","            # 簡易的な予測（選択された変数の線形結合）"
"0","            selected_vars_in_data <- intersect(model$selected_vars, names(data))"
"0","            if (length(selected_vars_in_data) > 0) {"
"0","              # ダミーのリスクスコア（変数の合計）"
"0","              as.numeric(as.matrix(data[, selected_vars_in_data, drop = FALSE]) %*% "
"0","                        rep(1, length(selected_vars_in_data)))"
"0","            } else {"
"0","              NULL"
"0","            }"
"0","          } else {"
"0","            NULL"
"0","          }"
"0","        } else {"
"0","          NULL"
"0","        }"
"0","      }, error = function(e) {"
"0","        message(sprintf(""  Error: %s"", e$message))"
"0","        NULL"
"0","      })"
"0","      "
"0","      if (!is.null(risk_score) && length(risk_score) == nrow(data)) {"
"0","        "
"0","        # Method 1: timeROCを試す（12ヶ月で - より安定）"
"0","        tryCatch({"
"0","          roc_obj <- timeROC("
"0","            T = data$time2y,"
"0","            delta = as.numeric(data$recur_2y == TRUE),"
"0","            marker = risk_score,"
"0","            cause = 1,"
"0","            weighting = ""marginal"","
"0","            times = c(12, 24),  # 複数時点"
"0","            iid = FALSE"
"0","          )"
"0","          "
"0","          # 12ヶ月のデータを使用（24ヶ月がNAの場合）"
"0","          if (!is.null(roc_obj$AUC) && length(roc_obj$AUC) >= 2) {"
"0","            auc_val <- ifelse(!is.na(roc_obj$AUC[3]), roc_obj$AUC[3], "
"0","                            ifelse(!is.na(roc_obj$AUC[2]), roc_obj$AUC[2], NA))"
"0","            "
"0","            if (!is.na(auc_val)) {"
"0","              # FP/TPを取得（12ヶ月のデータを使用）"
"0","              col_idx <- ifelse(all(!is.na(roc_obj$FP[, 2])), 2, 1)"
"0","              fp <- roc_obj$FP[, col_idx]"
"0","              tp <- roc_obj$TP[, col_idx]"
"0","              "
"0","              # NAを除去"
"0","              valid_idx <- !is.na(fp) & !is.na(tp)"
"0","              fp <- fp[valid_idx]"
"0","              tp <- tp[valid_idx]"
"0","              "
"0","              if (length(fp) > 0 && length(tp) > 0) {"
"0","                all_roc_data[[model_name]] <- data.frame("
"0","                  model = model_name,"
"0","                  FPR = c(0, fp, 1),"
"0","                  TPR = c(0, tp, 1)"
"0","                )"
"0","                all_auc_values[[model_name]] <- auc_val"
"0","                message(sprintf(""  AUC (timeROC): %.3f"", auc_val))"
"0","              }"
"0","            }"
"0","          }"
"0","        }, error = function(e) {"
"0","          message(sprintf(""  timeROC failed: %s"", e$message))"
"0","        })"
"0","        "
"0","        # Method 2: timeROCが失敗した場合、pROCを使用"
"0","        if (!(model_name %in% names(all_roc_data))) {"
"0","          tryCatch({"
"0","            # 24ヶ月時点でのバイナリ結果"
"0","            outcome_binary <- as.numeric(data$recur_2y == TRUE & data$time2y <= time_point)"
"0","            "
"0","            if (sum(outcome_binary) > 0 && sum(outcome_binary) < length(outcome_binary)) {"
"0","              roc_obj <- pROC::roc(outcome_binary, risk_score, quiet = TRUE)"
"0","              "
"0","              # ROCカーブのポイントを取得"
"0","              coords_all <- coords(roc_obj, ""all"", ret = c(""specificity"", ""sensitivity""))"
"0","              "
"0","              all_roc_data[[model_name]] <- data.frame("
"0","                model = model_name,"
"0","                FPR = 1 - coords_all$specificity,"
"0","                TPR = coords_all$sensitivity"
"0","              )"
"0","              "
"0","              all_auc_values[[model_name]] <- as.numeric(auc(roc_obj))"
"0","              message(sprintf(""  AUC (pROC): %.3f"", all_auc_values[[model_name]]))"
"0","            }"
"0","          }, error = function(e) {"
"0","            message(sprintf(""  pROC also failed: %s"", e$message))"
"0","          })"
"0","        }"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # TNMモデルも追加"
"0","  if (exists(""tnm_model"") && !is.null(tnm_model)) {"
"0","    message(""Processing: TNM Model"")"
"0","    "
"0","    tnm_risk <- predict(tnm_model, newdata = data, type = ""lp"")"
"0","    outcome_binary <- as.numeric(data$recur_2y == TRUE & data$time2y <= time_point)"
"0","    "
"0","    if (sum(outcome_binary) > 0) {"
"0","      roc_tnm <- pROC::roc(outcome_binary, tnm_risk, quiet = TRUE)"
"0","      coords_tnm <- coords(roc_tnm, ""all"", ret = c(""specificity"", ""sensitivity""))"
"0","      "
"0","      all_roc_data[[""TNM Model""]] <- data.frame("
"0","        model = ""TNM Model"","
"0","        FPR = 1 - coords_tnm$specificity,"
"0","        TPR = coords_tnm$sensitivity"
"0","      )"
"0","      "
"0","      all_auc_values[[""TNM Model""]] <- as.numeric(auc(roc_tnm))"
"0","      message(sprintf(""  TNM AUC: %.3f"", all_auc_values[[""TNM Model""]]))"
"0","    }"
"0","  }"
"0","  "
"0","  # データを結合"
"0","  if (length(all_roc_data) > 0) {"
"0","    roc_data_combined <- do.call(rbind, all_roc_data)"
"0","    "
"0","    # AUCデータフレーム作成"
"0","    auc_df <- data.frame("
"0","      model = names(all_auc_values),"
"0","      AUC = unlist(all_auc_values),"
"0","      stringsAsFactors = FALSE"
"0","    )"
"0","    "
"0","    # AUCでソート"
"0","    auc_df <- auc_df[order(auc_df$AUC, decreasing = TRUE), ]"
"0","    "
"0","    # プロット作成"
"0","    p <- ggplot(roc_data_combined, aes(x = FPR, y = TPR, color = model)) +"
"0","      geom_line(size = 1.2, alpha = 0.9) +"
"0","      geom_abline(intercept = 0, slope = 1, linetype = ""dashed"", "
"0","                  color = ""gray50"", size = 0.8) +"
"0","      scale_color_manual("
"0","        values = setNames(model_colors[1:length(unique(roc_data_combined$model))], "
"0","                         auc_df$model),"
"0","        labels = paste0(auc_df$model, "" (AUC = "", sprintf(""%.3f"", auc_df$AUC), "")""),"
"0","        breaks = auc_df$model"
"0","      ) +"
"0","      labs("
"0","        title = sprintf(""ROC Curves at %d Months"", time_point),"
"0","        subtitle = sprintf(""Best: %s (AUC = %.3f)"", auc_df$model[1], auc_df$AUC[1]),"
"0","        x = ""False Positive Rate (1 - Specificity)"","
"0","        y = ""True Positive Rate (Sensitivity)"","
"0","        color = ""Model"""
"0","      ) +"
"0","      theme_minimal(base_size = 11) +"
"0","      theme("
"0","        legend.position = ""right"","
"0","        legend.text = element_text(size = 9),"
"0","        panel.grid.minor = element_blank()"
"0","      ) +"
"0","      coord_equal() +"
"0","      xlim(0, 1) + ylim(0, 1)"
"0","    "
"0","    if (!is.null(output_file)) {"
"0","      ggsave(output_file, plot = p, width = 10, height = 8, dpi = 300)"
"0","      message(sprintf(""\n✓ ROC plot saved to: %s"", basename(output_file)))"
"0","    }"
"0","    "
"0","    # グローバル変数として保存（デバッグ用）"
"0","    assign(""roc_data_all"", roc_data_combined, envir = .GlobalEnv)"
"0","    assign(""auc_values"", auc_df, envir = .GlobalEnv)"
"0","    "
"0","    message(""\n✓ Created global variables: roc_data_all, auc_values"")"
"0","    "
"0","    return(p)"
"0","  } else {"
"0","    message(""\n✗ No ROC curves could be created"")"
"0","    return(NULL)"
"0","  }"
"0","}"
"0",""
"0","# 実行"
"0","roc_plot_final <- create_roc_curves_complete("
"0","  models = models,"
"0","  data = split_data_fixed$test,"
"0","  time_point = 24,"
"0","  output_file = file.path(paths$output_figures, ""roc_curves_complete.pdf"")"
"0",")"
"2","Processing: m1_stepaic_forward
"
"2","  AUC (pROC): 0.781
"
"2","Processing: m2_stepaic_backward
"
"2","  AUC (pROC): 0.747
"
"2","Processing: m3_stepbic_forward
"
"2","  AUC (pROC): 0.724
"
"2","Processing: m4_stepbic_backward
"
"2","  AUC (pROC): 0.682
"
"2","Processing: m5_univariate_screen
"
"2","  AUC (pROC): 0.760
"
"2","Processing: m6_rfe
"
"2","  AUC (pROC): 0.748
"
"2","Processing: m7_lasso
"
"2","  AUC (pROC): 0.719
"
"2","Processing: m7k_lasso_constrained
"
"2","  AUC (pROC): 0.718
"
"2","Processing: m8_predefined
"
"2","  AUC (pROC): 0.734
"
"2","Processing: TNM Model
"
"2","  TNM AUC: 0.717
"
"0","# プロット表示"
"0","if (!is.null(roc_plot_final)) {"
"0","  print(roc_plot_final)"
"0","  message(""\n✅ ROC curves successfully created with lines!"")"
"0","}"
"0",""
