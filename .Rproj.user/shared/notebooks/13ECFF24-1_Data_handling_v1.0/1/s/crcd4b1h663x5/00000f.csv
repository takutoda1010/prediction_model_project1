"0","# ---- ② Helpers ----"
"0",""
"0","# Excelの「日付・日時」混在（シリアル/文字列）をDateに：参照レベル等は一切変更しない"
"0","to_date_excel_mixed <- function(x){"
"0","  if (inherits(x,""Date"")) return(x)"
"0","  s <- trimws(as.character(x))"
"0","  s[s %in% c("""", ""NA"", ""N/A"", ""na"", ""n/a"")] <- NA"
"0",""
"0","  # 数値(=Excelシリアル, 1900起算) 優先候補"
"0","  num  <- suppressWarnings(as.numeric(s))"
"0","  dnum <- as.Date(num, origin = ""1899-12-30"")"
"0",""
"0","  # 文字列日付 正規化 → ymd"
"0","  s2 <- s"
"0","  s2 <- stringr::str_replace_all(s2, ""[.]"", ""/"")"
"0","  s2 <- stringr::str_replace_all(s2, ""年|月"", ""/"")"
"0","  s2 <- stringr::str_replace_all(s2, ""日"", """")"
"0","  s2 <- stringr::str_replace_all(s2, ""/"", ""-"")"
"0","  dchr <- suppressWarnings(lubridate::ymd(s2))"
"0",""
"0","  as.Date(dplyr::coalesce(dchr, dnum))"
"0","}"
"0",""
"0","# TRUE/FALSE の表記ゆらぎを論理値に（欠損はそのまま）"
"0","to_tf <- function(x){"
"0","  z <- trimws(as.character(x))"
"0","  z <- chartr(""＋－"", ""+-"", z)"
"0","  rec <- c(""TRUE""=""TRUE"",""T""=""TRUE"",""有""=""TRUE"",""Yes""=""TRUE"",""yes""=""TRUE"",""1""=""TRUE"",""+""=""TRUE"","
"0","           ""FALSE""=""FALSE"",""F""=""FALSE"",""無""=""FALSE"",""No""=""FALSE"",""no""=""FALSE"",""0""=""FALSE"",""-""=""FALSE"")"
"0","  as.logical(rec[z])"
"0","}"
"0",""
"0","# 手術時間： ""H:MM(:SS)"" と Excelの「1日を1.0とする小数」を“分”に"
"0","to_minutes_from_time <- function(x){"
"0","  s <- stringr::str_squish(as.character(x))"
"0","  s <- stringr::str_replace_all(s, ""："", "":"")"
"0","  has_colon <- stringr::str_detect(s, "":"")"
"0","  parts <- stringr::str_split_fixed(s, "":"", 3)"
"0","  hh <- suppressWarnings(as.numeric(parts[,1]))"
"0","  mm <- suppressWarnings(as.numeric(parts[,2]))"
"0","  ss <- suppressWarnings(as.numeric(parts[,3]))"
"0","  from_colon <- ifelse(has_colon, hh*60 + mm + ifelse(is.na(ss), 0, round(ss/60)), NA_real_)"
"0","  num <- suppressWarnings(as.numeric(s))"
"0","  from_frac <- ifelse(!has_colon & !is.na(num), num * 1440, NA_real_)"
"0","  round(dplyr::coalesce(from_colon, from_frac))"
"0","}"
"0",""
