"0","# ========================================================================"
"0","# 5. 変数変換関数"
"0","# ========================================================================"
"0",""
"0","#' 列名のエイリアスを適用"
"0","apply_column_aliases <- function(data) {"
"0","  for (old_name in names(COLUMN_ALIASES)) {"
"0","    new_name <- COLUMN_ALIASES[[old_name]]"
"0","    if (old_name %in% names(data) && !new_name %in% names(data)) {"
"0","      data <- dplyr::rename(data, !!new_name := !!old_name)"
"0","    }"
"0","  }"
"0","  return(data)"
"0","}"
"0",""
"0","#' マッピングに基づいて変数を作成"
"0","apply_variable_mapping <- function(data) {"
"0","  # すべてのマッピングカテゴリを処理"
"0","  all_mappings <- unlist(VARIABLE_MAPPING, recursive = FALSE)"
"0","  "
"0","  for (orig_col in names(all_mappings)) {"
"0","    if (orig_col %in% names(data)) {"
"0","      mapping <- all_mappings[[orig_col]]"
"0","      new_col <- mapping$name"
"0","      col_type <- mapping$type"
"0","      "
"0","      # 型に応じた変換"
"0","      if (col_type == ""numeric"") {"
"0","        data[[new_col]] <- suppressWarnings(as.numeric(data[[orig_col]]))"
"0","      } else if (col_type == ""character"") {"
"0","        data[[new_col]] <- as.character(data[[orig_col]])"
"0","      } else if (col_type == ""factor"") {"
"0","        data[[new_col]] <- as.factor(data[[orig_col]])"
"0","      } else if (col_type == ""date"") {"
"0","        data[[new_col]] <- to_date_excel_mixed(data[[orig_col]])"
"0","      } else if (col_type == ""logical"") {"
"0","        data[[new_col]] <- to_tf(data[[orig_col]])"
"0","      } else if (col_type == ""time_minutes"") {"
"0","        data[[new_col]] <- to_minutes_from_time(data[[orig_col]])"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  return(data)"
"0","}"
"0",""
"0","#' 群分けステージ変数を作成"
"0","create_stage_variables <- function(data) {"
"0","  # 手術時群分け"
"0","  c_surg <- grep(""手術時群分け\\s*R\\s*/\\s*BR1\\s*/\\s*BR2"", "
"0","                 names(data), value = TRUE, perl = TRUE)"
"0","  if (length(c_surg)) {"
"0","    data$stage_surg <- factor(data[[c_surg[1]]], levels = c(""R"", ""BR1"", ""BR2""))"
"0","  }"
"0","  "
"0","  # 診断時群分け"
"0","  c_diag <- grep(""診断時群分け\\s*R\\s*/\\s*BR1\\s*/\\s*BR2"", "
"0","                 names(data), value = TRUE, perl = TRUE)"
"0","  if (length(c_diag)) {"
"0","    data$stage_diag <- factor(data[[c_diag[1]]], levels = c(""R"", ""BR1"", ""BR2""))"
"0","  }"
"0","  "
"0","  # R/BR群分け（BR1とBR2をBRに統合）"
"0","  c_rb <- grep(""^群分け\\s*R\\s*/\\s*BR"", names(data), value = TRUE, perl = TRUE)"
"0","  if (length(c_rb)) {"
"0","    x <- stringr::str_squish(as.character(data[[c_rb[1]]]))"
"0","    x <- ifelse(x %in% c(""BR1"", ""BR2""), ""BR"", x)"
"0","    data$group_rb <- factor(x, levels = c(""R"", ""BR""))"
"0","  } else if (""stage_surg"" %in% names(data)) {"
"0","    x <- as.character(data$stage_surg)"
"0","    x[x %in% c(""BR1"", ""BR2"")] <- ""BR"""
"0","    data$group_rb <- factor(x, levels = c(""R"", ""BR""))"
"0","  } else if (""stage_diag"" %in% names(data)) {"
"0","    x <- as.character(data$stage_diag)"
"0","    x[x %in% c(""BR1"", ""BR2"")] <- ""BR"""
"0","    data$group_rb <- factor(x, levels = c(""R"", ""BR""))"
"0","  }"
"0","  "
"0","  # 非癌部肝ステージ（旧）"
"0","  cand_nc <- intersect(names(data), "
"0","                       c(""StageI+II or III+IV　非癌部肝(旧入力）"", "
"0","                         ""StageI+II or III+IV""))"
"0","  if (length(cand_nc) >= 1) {"
"0","    data$nc_liver_stage_old <- data[[cand_nc[1]]]"
"0","  }"
"0","  "
"0","  return(data)"
"0","}"
"0",""
"0","#' 死因カテゴリを作成"
"0","create_death_cause <- function(data) {"
"0","  if (""死因"" %in% names(data)) {"
"0","    y <- stringr::str_squish(as.character(data$`死因`))"
"0","    other_pat <- ""(他病死(（老衰）|\\(老衰\\))?|敗血症|死（原因不明）|死\\(原因不明\\))"""
"0","    "
"0","    data$death_cause4 <- dplyr::case_when("
"0","      is.na(y) | y == """" ~ ""aliver"","
"0","      stringr::str_detect(y, ""癌"") ~ ""Cancer"","
"0","      stringr::str_detect(y, ""肝不全"") ~ ""LiverFailure"","
"0","      stringr::str_detect(y, other_pat) ~ ""Other"","
"0","      TRUE ~ ""Other"""
"0","    ) |> "
"0","      factor(levels = c(""aliver"", ""Cancer"", ""LiverFailure"", ""Other""))"
"0","  }"
"0","  "
"0","  return(data)"
"0","}"
