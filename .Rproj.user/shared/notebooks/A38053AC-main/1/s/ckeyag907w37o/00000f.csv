"0","# ========================================================================"
"0","# 5.5 è©•ä¾¡å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆä¿®æ­£ç‰ˆï¼‰"
"0","# ========================================================================"
"0",""
"0","message(""\nğŸ§¹ Final cleaning before evaluation..."")"
"2","
ğŸ§¹ Final cleaning before evaluation...
"
"0","message(""----------------------------------------"")"
"2","----------------------------------------
"
"0","# å¤‰æ•°åã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯ï¼ˆè¿½åŠ ï¼‰"
"0","clean_names_final <- function(data) {"
"0","  old_names <- names(data)"
"0","  new_names <- gsub("" "", ""_"", old_names)"
"0","  new_names <- gsub(""\\+"", ""_plus"", new_names)"
"0","  new_names <- gsub(""Â±"", ""_pm"", new_names)"
"0","  names(data) <- new_names"
"0","  return(data)"
"0","}"
"0",""
"0","# å„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®å¤‰æ•°åã‚’ã‚¯ãƒªãƒ¼ãƒ³"
"0","split_data_clean$train <- clean_names_final(split_data_clean$train)"
"0","split_data_clean$val <- clean_names_final(split_data_clean$val)"
"0","split_data_clean$test <- clean_names_final(split_data_clean$test)"
"0",""
"0","# ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°é–¢æ•°"
"0","clean_for_evaluation <- function(data) {"
"0","  # 1. å®Œå…¨ã«ä¸è¦ãªå¤‰æ•°ã‚’å‰Šé™¤"
"0","  vars_to_remove <- c("
"0","    # æ—¥ä»˜ç³»ã®ä¸è¦å¤‰æ•°"
"0","    ""first_visit_dt"", ""adm_dt"",  # â† ã“ã‚Œã‚‰ã¯æœ¬å½“ã«ä¸è¦"
"0","    # BMI_categoryé–¢é€£"
"0","    ""BMI_category"", ""BMI_categoryNormal"", ""BMI_categoryOverweight"", ""BMI_categoryObese"","
"0","    # ãã®ä»–ä¸è¦"
"0","    ""im"", ""im1"", ""Pringle"", "
"0","    ""fc_inf_numeric"", ""sm_numeric"", ""sf_numeric"", ""fc_numeric"","
"0","    ""æœ€å¤§å¾„"", ""å€‹æ•°"", ""æ€§åˆ¥"""
"0","  )"
"0","  "
"0","  for (var in vars_to_remove) {"
"0","    if (var %in% names(data)) {"
"0","      data[[var]] <- NULL"
"0","      message(sprintf(""  Removed: %s"", var))"
"0","    }"
"0","  }"
"0","  "
"0","  # 2. recur_dateã¯æ¬ æã®ã¾ã¾æ®‹ã™ï¼ˆå†ç™ºãªã—æƒ…å ±ã¨ã—ã¦é‡è¦ï¼‰"
"0","  # ãŸã ã—ã€ãƒ¢ãƒ‡ãƒ«ã«ã¯ä½¿ã‚ãªã„ã®ã§å•é¡Œãªã—"
"0","  "
"0","  # 3. ä»–ã®å¤‰æ•°ã®æ¬ æå€¤ã‚’è£œå®Œ"
"0","  numeric_vars <- names(data)[sapply(data, is.numeric)]"
"0","  # recur_dateã¯é™¤å¤–ã—ã¦è£œå®Œ"
"0","  numeric_vars <- setdiff(numeric_vars, ""recur_date"")"
"0","  "
"0","  for (var in numeric_vars) {"
"0","    if (any(is.na(data[[var]]))) {"
"0","      med_val <- median(data[[var]], na.rm = TRUE)"
"0","      if (is.finite(med_val)) {"
"0","        data[[var]][is.na(data[[var]])] <- med_val"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°"
"0","  factor_vars <- names(data)[sapply(data, function(x) is.factor(x) || is.character(x))]"
"0","  # recur_dateã¨death_causeç³»ã¯é™¤å¤–"
"0","  factor_vars <- setdiff(factor_vars, c(""recur_date"", ""death_cause"", ""death_cause4""))"
"0","  "
"0","  for (var in factor_vars) {"
"0","    if (any(is.na(data[[var]]))) {"
"0","      tab <- table(data[[var]], useNA = ""no"")"
"0","      if (length(tab) > 0) {"
"0","        mode_val <- names(tab)[which.max(tab)]"
"0","        data[[var]][is.na(data[[var]])] <- mode_val"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # è«–ç†å¤‰æ•°"
"0","  logical_vars <- names(data)[sapply(data, is.logical)]"
"0","  for (var in logical_vars) {"
"0","    if (any(is.na(data[[var]]))) {"
"0","      data[[var]][is.na(data[[var]])] <- FALSE"
"0","    }"
"0","  }"
"0","  "
"0","  return(data)"
"0","}"
"0",""
"0","# å„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°"
"0","split_data_clean$train <- clean_for_evaluation(split_data_clean$train)"
"0","split_data_clean$val <- clean_for_evaluation(split_data_clean$val)"
"0","split_data_clean$test <- clean_for_evaluation(split_data_clean$test)"
"0",""
"0","# æœ€çµ‚ç¢ºèªï¼ˆrecur_dateä»¥å¤–ã®NAç¢ºèªï¼‰"
"0","message(""\n=== Final NA check (excluding recur_date) ==="")"
"2","
=== Final NA check (excluding recur_date) ===
"
"0","check_na <- function(data, name) {"
"0","  # recur_dateä»¥å¤–ã®åˆ—ã§NAã‚’ãƒã‚§ãƒƒã‚¯"
"0","  cols_to_check <- setdiff(names(data), c(""recur_date"", ""death_cause"", ""death_cause4""))"
"0","  na_count <- sum(is.na(data[, cols_to_check]))"
"0","  message(sprintf(""%s: %d NAs (excluding recur_date)"", name, na_count))"
"0","  "
"0","  if (na_count > 0) {"
"0","    na_cols <- colSums(is.na(data[, cols_to_check]))"
"0","    na_cols <- na_cols[na_cols > 0]"
"0","    if (length(na_cols) > 0) {"
"0","      message(sprintf(""  Remaining NAs in %s:"", name))"
"0","      print(na_cols)"
"0","    }"
"0","  }"
"0","  return(na_count)"
"0","}"
"0",""
"0","train_na <- check_na(split_data_clean$train, ""Train"")"
"2","Train: 0 NAs (excluding recur_date)
"
"0","val_na <- check_na(split_data_clean$val, ""Val"")"
"2","Val: 0 NAs (excluding recur_date)
"
"0","test_na <- check_na(split_data_clean$test, ""Test"")"
"2","Test: 0 NAs (excluding recur_date)
"
"0","# ã™ã¹ã¦0ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª"
"0","if (train_na + val_na + test_na == 0) {"
"0","  message(""\nâœ… Perfect! No problematic NAs remaining!"")"
"0","  message(""   (recur_date NAs are kept intentionally as 'no recurrence' indicator)"")"
"0","}"
"2","
âœ… Perfect! No problematic NAs remaining!
"
"2","   (recur_date NAs are kept intentionally as 'no recurrence' indicator)
"
