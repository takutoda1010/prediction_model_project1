"0","# ========================================================================"
"0","# 6. ãƒ¢ãƒ‡ãƒ«è©•ä¾¡"
"0","# ========================================================================"
"0",""
"0","message(""\n========================================"")"
"2","
========================================
"
"0","message(""FIXING EVALUATION DATA PREPARATION"")"
"2","FIXING EVALUATION DATA PREPARATION
"
"0","message(""========================================\n"")"
"2","========================================

"
"0","# Step 1: ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹é–¢æ•°"
"0","prepare_clean_split_data <- function(split_data, variables_to_use = NULL) {"
"0","  "
"0","  message(""Preparing clean split data for evaluation..."")"
"0","  "
"0","  # ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰æ™‚ã«ä½¿ç”¨ã•ã‚ŒãŸå¤‰æ•°ã‚’å–å¾—"
"0","  if (is.null(variables_to_use) && exists(""models"") && !is.null(attr(models, ""train_data""))) {"
"0","    train_data_used <- attr(models, ""train_data"")"
"0","    variables_to_use <- setdiff(names(train_data_used), c(""surv_obj""))"
"0","    message(sprintf(""  Using %d variables from model training"", length(variables_to_use)))"
"0","  }"
"0","  "
"0","  # å„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°"
"0","  clean_dataset <- function(data, name) {"
"0","    message(sprintf(""\n  Cleaning %s dataset..."", name))"
"0","    "
"0","    # å¿…è¦ãªå¤‰æ•°ã®ã¿é¸æŠ"
"0","    if (!is.null(variables_to_use)) {"
"0","      # time2yã¨recur_2yã¯å¿…é ˆ"
"0","      required_vars <- unique(c(""time2y"", ""recur_2y"", variables_to_use))"
"0","      available_vars <- intersect(required_vars, names(data))"
"0","      missing_vars <- setdiff(required_vars, names(data))"
"0","      "
"0","      if (length(missing_vars) > 0) {"
"0","        message(sprintf(""    Warning: %d variables missing"", length(missing_vars)))"
"0","        # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šæœ€åˆã®5å€‹ã‚’è¡¨ç¤º"
"0","        if (length(missing_vars) <= 5) {"
"0","          message(sprintf(""    Missing: %s"", paste(missing_vars, collapse = "", "")))"
"0","        }"
"0","      }"
"0","      "
"0","      data <- data[, available_vars, drop = FALSE]"
"0","      message(sprintf(""    Selected %d variables"", ncol(data)))"
"0","    }"
"0","    "
"0","    # é‡è¤‡ã—ãŸãƒ€ãƒŸãƒ¼å¤‰æ•°ã‚’å‰Šé™¤"
"0","    # TRUE/FALSEãŒé‡è¤‡ã—ã¦ã„ã‚‹å¤‰æ•°ã‚’æ¤œå‡º"
"0","    dup_patterns <- c(""TRUETRUE"", ""FALSEFALSE"", ""TRUEFALSE"", ""FALSETRUE"")"
"0","    for (pattern in dup_patterns) {"
"0","      bad_vars <- grep(pattern, names(data), value = TRUE)"
"0","      if (length(bad_vars) > 0) {"
"0","        data <- data[, !names(data) %in% bad_vars, drop = FALSE]"
"0","        message(sprintf(""    Removed %d duplicate variables with pattern '%s'"", "
"0","                       length(bad_vars), pattern))"
"0","      }"
"0","    }"
"0","    "
"0","    # surv_objã‚’ä½œæˆ"
"0","    if (all(c(""time2y"", ""recur_2y"") %in% names(data))) {"
"0","      data$surv_obj <- survival::Surv("
"0","        time = data$time2y,"
"0","        event = as.numeric(as.character(data$recur_2y) %in% c(""TRUE"", ""1""))"
"0","      )"
"0","      message(""    Created surv_obj"")"
"0","    }"
"0","    "
"0","    return(data)"
"0","  }"
"0","  "
"0","  # å„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’å‡¦ç†"
"0","  result <- list()"
"0","  if (!is.null(split_data$train)) {"
"0","    result$train <- clean_dataset(split_data$train, ""train"")"
"0","  }"
"0","  if (!is.null(split_data$val)) {"
"0","    result$val <- clean_dataset(split_data$val, ""val"")"
"0","  }"
"0","  if (!is.null(split_data$test)) {"
"0","    result$test <- clean_dataset(split_data$test, ""test"")"
"0","  }"
"0","  "
"0","  # ãƒ¡ã‚¿æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼"
"0","  result$meta <- split_data$meta"
"0","  result$indices <- split_data$indices"
"0","  "
"0","  return(result)"
"0","}"
"0",""
"0","# Step 2: ãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£"
"0","split_data_fixed <- prepare_clean_split_data(split_data_clean)"
"2","Preparing clean split data for evaluation...
"
"2","  Using 39 variables from model training
"
"2","
  Cleaning train dataset...
"
"2","    Selected 39 variables
"
"2","    Created surv_obj
"
"2","
  Cleaning val dataset...
"
"2","    Selected 39 variables
"
"2","    Created surv_obj
"
"2","
  Cleaning test dataset...
"
"2","    Selected 39 variables
"
"2","    Created surv_obj
"
"0","# Step 3: ç¢ºèª"
"0","message(""\nğŸ“Š Fixed data summary:"")"
"2","
ğŸ“Š Fixed data summary:
"
"0","for (set_name in c(""train"", ""val"", ""test"")) {"
"0","  if (!is.null(split_data_fixed[[set_name]])) {"
"0","    data <- split_data_fixed[[set_name]]"
"0","    message(sprintf(""\n%s:"", set_name))"
"0","    message(sprintf(""  Dimensions: %d Ã— %d"", nrow(data), ncol(data)))"
"0","    message(sprintf(""  Has surv_obj: %s"", ""surv_obj"" %in% names(data)))"
"0","    message(sprintf(""  Has time2y: %s"", ""time2y"" %in% names(data)))"
"0","    message(sprintf(""  Has recur_2y: %s"", ""recur_2y"" %in% names(data)))"
"0","  }"
"0","}"
"2","
train:
"
"2","  Dimensions: 567 Ã— 40
"
"2","  Has surv_obj: TRUE
"
"2","  Has time2y: TRUE
"
"2","  Has recur_2y: TRUE
"
"2","
val:
"
"2","  Dimensions: 189 Ã— 40
"
"2","  Has surv_obj: TRUE
"
"2","  Has time2y: TRUE
"
"2","  Has recur_2y: TRUE
"
"2","
test:
"
"2","  Dimensions: 189 Ã— 40
"
"2","  Has surv_obj: TRUE
"
"2","  Has time2y: TRUE
"
"2","  Has recur_2y: TRUE
"
"0","# Step 4: ä¿®æ­£ç‰ˆã®è©•ä¾¡ã‚’å®Ÿè¡Œ"
"0","message(""\n========================================"")"
"2","
========================================
"
"0","message(""RE-RUNNING EVALUATION WITH FIXED DATA"")"
"2","RE-RUNNING EVALUATION WITH FIXED DATA
"
"0","message(""========================================\n"")"
"2","========================================

"
"0","# evaluate_all_modelsã‚’å†å®šç¾©ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰"
"0","evaluate_all_models_fixed <- function(models, split_data_fixed) {"
"0","  "
"0","  results <- list()"
"0","  summary_table <- data.frame()"
"0","  "
"0","  for (model_name in names(models)) {"
"0","    model <- models[[model_name]]"
"0","    "
"0","    if (!is.null(model)) {"
"0","      message(sprintf(""\n--- Evaluating: %s ---"", model_name))"
"0","      "
"0","      # å„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§è©•ä¾¡"
"0","      for (set_name in c(""train"", ""val"", ""test"")) {"
"0","        data <- split_data_fixed[[set_name]]"
"0","        "
"0","        if (!is.null(data) && ""surv_obj"" %in% names(data)) {"
"0","          "
"0","          tryCatch({"
"0","            # C-indexã®è¨ˆç®—"
"0","            if (inherits(model, ""coxph"")) {"
"0","              pred <- predict(model, newdata = data, type = ""risk"")"
"0","            } else if (inherits(model, ""list"") && ""model"" %in% names(model) && !is.null(model$model)) {"
"0","              pred <- predict(model$model, newdata = data, type = ""risk"")"
"0","            } else if (inherits(model, ""lasso_cox"")) {"
"0","              # LASSOã®å ´åˆã®å‡¦ç†"
"0","              X_vars <- intersect(colnames(model$X), names(data))"
"0","              if (length(X_vars) > 0) {"
"0","                # ç°¡æ˜“ç‰ˆï¼šåˆ©ç”¨å¯èƒ½ãªå¤‰æ•°ã®ã¿ä½¿ç”¨"
"0","                formula_str <- paste(""~ -1 +"", paste(model$selected_vars[model$selected_vars %in% names(data)], collapse = "" + ""))"
"0","                X_new <- model.matrix(as.formula(formula_str), data = data)"
"0","                "
"0","                # æ¬ è½ã—ã¦ã„ã‚‹åˆ—ã‚’0ã§åŸ‹ã‚ã‚‹"
"0","                X_full <- matrix(0, nrow = nrow(data), ncol = ncol(model$X))"
"0","                colnames(X_full) <- colnames(model$X)"
"0","                common_cols <- intersect(colnames(X_new), colnames(model$X))"
"0","                if (length(common_cols) > 0) {"
"0","                  X_full[, common_cols] <- X_new[, common_cols]"
"0","                }"
"0","                "
"0","                pred <- predict(model$glmnet_model, newx = X_full, s = model$lambda_min, type = ""link"")[, 1]"
"0","              } else {"
"0","                pred <- rep(0, nrow(data))"
"0","              }"
"0","            } else {"
"0","              pred <- rep(0, nrow(data))"
"0","            }"
"0","            "
"0","            # C-indexè¨ˆç®—"
"0","            c_result <- survival::concordance(data$surv_obj ~ pred, reverse = TRUE)"
"0","            c_index <- c_result$concordance"
"0","            "
"0","            message(sprintf(""  %s: C-index = %.3f"", set_name, c_index))"
"0","            "
"0","            # çµæœã‚’ä¿å­˜"
"0","            if (!model_name %in% names(results)) {"
"0","              results[[model_name]] <- list()"
"0","            }"
"0","            results[[model_name]][[set_name]] <- list(c_index = c_index)"
"0","            "
"0","          }, error = function(e) {"
"0","            message(sprintf(""  %s: Error - %s"", set_name, e$message))"
"0","          })"
"0","        }"
"0","      }"
"0","      "
"0","      # ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ "
"0","      if (model_name %in% names(results)) {"
"0","        summary_row <- data.frame("
"0","          model = model_name,"
"0","          c_index_train = ifelse(""train"" %in% names(results[[model_name]]), "
"0","                                results[[model_name]]$train$c_index, NA),"
"0","          c_index_val = ifelse(""val"" %in% names(results[[model_name]]), "
"0","                              results[[model_name]]$val$c_index, NA),"
"0","          c_index_test = ifelse(""test"" %in% names(results[[model_name]]), "
"0","                               results[[model_name]]$test$c_index, NA)"
"0","        )"
"0","        summary_table <- rbind(summary_table, summary_row)"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # ã‚½ãƒ¼ãƒˆ"
"0","  if (nrow(summary_table) > 0) {"
"0","    summary_table <- summary_table[order(summary_table$c_index_test, decreasing = TRUE, na.last = TRUE), ]"
"0","    rownames(summary_table) <- NULL"
"0","  }"
"0","  "
"0","  return(list("
"0","    results = results,"
"0","    summary = summary_table"
"0","  ))"
"0","}"
"0",""
"0","# å®Ÿè¡Œ"
"0","eval_results_fixed <- evaluate_all_models_fixed(models, split_data_fixed)"
"2","
--- Evaluating: m1_stepaic_forward ---
"
"2","  train: C-index = 0.716
"
"2","  val: C-index = 0.691
"
"2","  test: C-index = 0.776
"
"2","
--- Evaluating: m2_stepaic_backward ---
"
"2","  train: C-index = 0.716
"
"2","  val: C-index = 0.672
"
"2","  test: C-index = 0.746
"
"2","
--- Evaluating: m3_stepbic_forward ---
"
"2","  train: C-index = 0.698
"
"2","  val: C-index = 0.688
"
"2","  test: C-index = 0.731
"
"2","
--- Evaluating: m4_stepbic_backward ---
"
"2","  train: C-index = 0.701
"
"2","  val: C-index = 0.679
"
"2","  test: C-index = 0.690
"
"2","
--- Evaluating: m5_univariate_screen ---
"
"2","  train: C-index = 0.719
"
"2","  val: C-index = 0.722
"
"2","  test: C-index = 0.767
"
"2","
--- Evaluating: m6_rfe ---
"
"2","  train: C-index = 0.720
"
"2","  val: C-index = 0.681
"
"2","  test: C-index = 0.749
"
"2","
--- Evaluating: m7_lasso ---
"
"2","  train: C-index = 0.703
"
"2","  val: C-index = 0.692
"
"2","  test: C-index = 0.744
"
"2","
--- Evaluating: m7k_lasso_constrained ---
"
"2","  train: C-index = 0.702
"
"2","  val: C-index = 0.691
"
"2","  test: C-index = 0.742
"
"2","
--- Evaluating: m8_predefined ---
"
"2","  train: C-index = 0.708
"
"2","  val: C-index = 0.683
"
"2","  test: C-index = 0.742
"
"0","# çµæœè¡¨ç¤º"
"0","if (!is.null(eval_results_fixed$summary) && nrow(eval_results_fixed$summary) > 0) {"
"0","  message(""\nğŸ“Š EVALUATION RESULTS (FIXED):"")"
"0","  print(eval_results_fixed$summary, digits = 3)"
"0","  "
"0","  # æˆåŠŸã—ãŸãƒ¢ãƒ‡ãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆ"
"0","  n_success <- sum(!is.na(eval_results_fixed$summary$c_index_test))"
"0","  message(sprintf(""\nâœ… Successfully evaluated %d/%d models"", "
"0","                 n_success, nrow(eval_results_fixed$summary)))"
"0","}"
"2","
ğŸ“Š EVALUATION RESULTS (FIXED):
"
