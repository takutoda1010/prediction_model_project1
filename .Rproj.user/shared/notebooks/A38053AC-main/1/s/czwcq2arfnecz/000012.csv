"0","# ========================================================================"
"0","# ROCカーブ作成関数の修正版（LASSO対応）"
"0","# ========================================================================"
"0",""
"0","message(""\n========================================"")"
"2","
========================================
"
"0","message(""FIXING ROC CALCULATION FOR LASSO MODELS"")"
"2","FIXING ROC CALCULATION FOR LASSO MODELS
"
"0","message(""========================================\n"")"
"2","========================================

"
"0","# 修正版：LASSOモデル対応のリスクスコア計算関数"
"0","get_risk_score_fixed <- function(model, data) {"
"0","  "
"0","  # Coxphモデル"
"0","  if (inherits(model, ""coxph"")) {"
"0","    return(predict(model, newdata = data, type = ""lp""))"
"0","  }"
"0","  "
"0","  # リスト型でcoxphを含む場合"
"0","  else if (inherits(model, ""list"") && ""model"" %in% names(model) && "
"0","           !is.null(model$model) && inherits(model$model, ""coxph"")) {"
"0","    return(predict(model$model, newdata = data, type = ""lp""))"
"0","  }"
"0","  "
"0","  # LASSOモデル（Method 2: glmnet直接使用）"
"0","  else if (inherits(model, ""lasso_cox"") || "
"0","           (!is.null(model$glmnet_model) && !is.null(model$X))) {"
"0","    "
"0","    # テストデータ用の行列を作成"
"0","    X_test <- matrix(0, nrow = nrow(data), ncol = ncol(model$X))"
"0","    colnames(X_test) <- colnames(model$X)"
"0","    "
"0","    # 利用可能な変数をマッチング"
"0","    common_vars <- intersect(colnames(model$X), names(data))"
"0","    "
"0","    for (var in common_vars) {"
"0","      if (var %in% names(data)) {"
"0","        # 数値に変換（因子変数の場合も考慮）"
"0","        if (is.factor(data[[var]])) {"
"0","          X_test[, var] <- as.numeric(data[[var]]) - 1  # 0/1に変換"
"0","        } else {"
"0","          X_test[, var] <- as.numeric(data[[var]])"
"0","        }"
"0","      }"
"0","    }"
"0","    "
"0","    # 予測"
"0","    pred <- predict(model$glmnet_model, "
"0","                   newx = X_test, "
"0","                   s = model$lambda_min, "
"0","                   type = ""link"")"
"0","    "
"0","    return(as.numeric(pred))"
"0","  }"
"0","  "
"0","  # その他の場合"
"0","  else {"
"0","    return(NULL)"
"0","  }"
"0","}"
"0",""
"0","# ROC作成関数を更新（LASSO対応版）"
"0","create_roc_curves_complete_v2 <- function(models, data, time_point = 24, output_file = NULL) {"
"0","  "
"0","  require(pROC)"
"0","  "
"0","  # 結果格納用"
"0","  all_roc_data <- list()"
"0","  all_auc_values <- list()"
"0","  "
"0","  # カラーパレット"
"0","  model_colors <- c(""#E69F00"", ""#56B4E9"", ""#009E73"", ""#F0E442"", "
"0","                    ""#0072B2"", ""#D55E00"", ""#CC79A7"", ""#999999"", ""#000000"")"
"0","  "
"0","  # 各モデルのROC計算"
"0","  model_idx <- 0"
"0","  "
"0","  for (model_name in names(models)) {"
"0","    model <- models[[model_name]]"
"0","    model_idx <- model_idx + 1"
"0","    "
"0","    if (!is.null(model)) {"
"0","      message(sprintf(""Processing: %s"", model_name))"
"0","      "
"0","      # 修正版のリスクスコア取得"
"0","      risk_score <- get_risk_score_fixed(model, data)"
"0","      "
"0","      if (!is.null(risk_score) && length(risk_score) == nrow(data)) {"
"0","        "
"0","        # バイナリアウトカム"
"0","        outcome_binary <- as.numeric(data$recur_2y == TRUE & data$time2y <= time_point)"
"0","        "
"0","        # 有効なデータのみ使用"
"0","        valid_idx <- !is.na(risk_score) & !is.na(outcome_binary)"
"0","        "
"0","        if (sum(valid_idx) > 10 && sum(outcome_binary[valid_idx]) > 0) {"
"0","          "
"0","          # pROCでROC計算"
"0","          tryCatch({"
"0","            roc_obj <- pROC::roc(outcome_binary[valid_idx], "
"0","                                risk_score[valid_idx], "
"0","                                quiet = TRUE)"
"0","            coords_all <- coords(roc_obj, ""all"", ret = c(""specificity"", ""sensitivity""))"
"0","            "
"0","            all_roc_data[[model_name]] <- data.frame("
"0","              model = model_name,"
"0","              FPR = 1 - coords_all$specificity,"
"0","              TPR = coords_all$sensitivity"
"0","            )"
"0","            "
"0","            all_auc_values[[model_name]] <- as.numeric(auc(roc_obj))"
"0","            message(sprintf(""  AUC: %.3f"", all_auc_values[[model_name]]))"
"0","            "
"0","          }, error = function(e) {"
"0","            message(sprintf(""  Error: %s"", e$message))"
"0","          })"
"0","        }"
"0","      } else {"
"0","        message(sprintf(""  Risk score calculation failed""))"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # TNMモデルも追加"
"0","  if (exists(""tnm_model"") && !is.null(tnm_model)) {"
"0","    message(""Processing: TNM Model"")"
"0","    "
"0","    tnm_risk <- get_risk_score_fixed(tnm_model, data)"
"0","    "
"0","    if (!is.null(tnm_risk)) {"
"0","      outcome_binary <- as.numeric(data$recur_2y == TRUE & data$time2y <= time_point)"
"0","      "
"0","      roc_tnm <- pROC::roc(outcome_binary, tnm_risk, quiet = TRUE)"
"0","      coords_tnm <- coords(roc_tnm, ""all"", ret = c(""specificity"", ""sensitivity""))"
"0","      "
"0","      all_roc_data[[""TNM Model""]] <- data.frame("
"0","        model = ""TNM Model"","
"0","        FPR = 1 - coords_tnm$specificity,"
"0","        TPR = coords_tnm$sensitivity"
"0","      )"
"0","      "
"0","      all_auc_values[[""TNM Model""]] <- as.numeric(auc(roc_tnm))"
"0","      message(sprintf(""  TNM AUC: %.3f"", all_auc_values[[""TNM Model""]]))"
"0","    }"
"0","  }"
"0","  "
"0","  # データを結合してプロット"
"0","  if (length(all_roc_data) > 0) {"
"0","    roc_data_combined <- do.call(rbind, all_roc_data)"
"0","    "
"0","    # AUCデータフレーム作成"
"0","    auc_df <- data.frame("
"0","      model = names(all_auc_values),"
"0","      AUC = unlist(all_auc_values),"
"0","      stringsAsFactors = FALSE"
"0","    )"
"0","    "
"0","    # AUCでソート"
"0","    auc_df <- auc_df[order(auc_df$AUC, decreasing = TRUE), ]"
"0","    "
"0","    # プロット作成"
"0","    p <- ggplot(roc_data_combined, aes(x = FPR, y = TPR, color = model)) +"
"0","      geom_line(size = 1.2, alpha = 0.9) +"
"0","      geom_abline(intercept = 0, slope = 1, linetype = ""dashed"", "
"0","                  color = ""gray50"", size = 0.8) +"
"0","      scale_color_manual("
"0","        values = setNames(model_colors[1:length(unique(roc_data_combined$model))], "
"0","                         auc_df$model),"
"0","        labels = paste0(auc_df$model, "" (AUC = "", sprintf(""%.3f"", auc_df$AUC), "")""),"
"0","        breaks = auc_df$model"
"0","      ) +"
"0","      labs("
"0","        title = sprintf(""ROC Curves at %d Months - All Models"", time_point),"
"0","        subtitle = sprintf(""Best: %s (AUC = %.3f)"", auc_df$model[1], auc_df$AUC[1]),"
"0","        x = ""False Positive Rate (1 - Specificity)"","
"0","        y = ""True Positive Rate (Sensitivity)"","
"0","        color = ""Model"""
"0","      ) +"
"0","      theme_minimal(base_size = 11) +"
"0","      theme("
"0","        legend.position = ""right"","
"0","        legend.text = element_text(size = 9),"
"0","        panel.grid.minor = element_blank()"
"0","      ) +"
"0","      coord_equal() +"
"0","      xlim(0, 1) + ylim(0, 1)"
"0","    "
"0","    if (!is.null(output_file)) {"
"0","      ggsave(output_file, plot = p, width = 10, height = 8, dpi = 300)"
"0","      message(sprintf(""\n✓ ROC plot saved to: %s"", basename(output_file)))"
"0","    }"
"0","    "
"0","    # グローバル変数を更新"
"0","    assign(""roc_data_all"", roc_data_combined, envir = .GlobalEnv)"
"0","    assign(""auc_values"", auc_df, envir = .GlobalEnv)"
"0","    "
"0","    return(p)"
"0","  } else {"
"0","    return(NULL)"
"0","  }"
"0","}"
"0",""
"0","# 修正版で再実行"
"0","message(""\nRe-running ROC with fixed LASSO support..."")"
"2","
Re-running ROC with fixed LASSO support...
"
"0","roc_plot_fixed <- create_roc_curves_complete_v2("
"0","  models = models,"
"0","  data = split_data_fixed$test,"
"0","  time_point = 24,"
"0","  output_file = file.path(paths$output_figures, ""roc_curves_all_models_fixed.pdf"")"
"0",")"
"2","Processing: m1_stepaic_forward
"
"2","  AUC: 0.781
"
"2","Processing: m2_stepaic_backward
"
"2","  AUC: 0.747
"
"2","Processing: m3_stepbic_forward
"
"2","  AUC: 0.724
"
"2","Processing: m4_stepbic_backward
"
"2","  AUC: 0.682
"
"2","Processing: m5_univariate_screen
"
"2","  AUC: 0.760
"
"2","Processing: m6_rfe
"
"2","  AUC: 0.748
"
"2","Processing: m7_lasso
"
"2","  AUC: 0.735
"
"2","Processing: m7k_lasso_constrained
"
"2","  AUC: 0.733
"
"2","Processing: m8_predefined
"
"2","  AUC: 0.734
"
"2","Processing: TNM Model
"
"2","  TNM AUC: 0.717
"
"0","# 確認"
"0","if (!is.null(roc_plot_fixed)) {"
"0","  print(roc_plot_fixed)"
"0","  "
"0","  # AUC値の確認"
"0","  message(""\n📊 Updated AUC values:"")"
"0","  print(auc_values)"
"0","  "
"0","  # Model Performance表も更新"
"0","  message(""\nUpdating performance table with correct AUC values..."")"
"0","  "
"0","  # 既存のテーブルを更新"
"0","  if (exists(""comprehensive_performance"")) {"
"0","    for (i in 1:nrow(comprehensive_performance)) {"
"0","      model_name <- comprehensive_performance$Model[i]"
"0","      if (model_name %in% auc_values$model) {"
"0","        idx <- which(auc_values$model == model_name)"
"0","        comprehensive_performance[i, ""AUC at 24mo""] <- auc_values$AUC[idx]"
"0","      }"
"0","    }"
"0","    "
"0","    # 再保存"
"0","    write.csv("
"0","      comprehensive_performance,"
"0","      file.path(paths$output_tables, ""model_performance_comprehensive_fixed.csv""),"
"0","      row.names = FALSE"
"0","    )"
"0","    "
"0","    message(""✓ Updated performance table saved"")"
"0","  }"
"0","}"
