"0","# ========================================================================"
"0","# Table 2: ãƒ¢ãƒ‡ãƒ«ä¿‚æ•°ã®è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«"
"0","# ========================================================================"
"0",""
"0","message(""\n========================================"")"
"2","
========================================
"
"0","message(""Creating Table 2: Model Coefficients"")"
"2","Creating Table 2: Model Coefficients
"
"0","message(""========================================\n"")"
"2","========================================

"
"0","create_table2 <- function(models, model_names = NULL, output_file = NULL) {"
"0","  "
"0","  # ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒˆãƒƒãƒ—3ï¼‰"
"0","  if (is.null(model_names)) {"
"0","    # C-indexã§ãƒˆãƒƒãƒ—3ã‚’é¸æŠ"
"0","    if (exists(""evaluation_results"")) {"
"0","      top_models <- head(evaluation_results$summary[order(evaluation_results$summary$c_index_test, "
"0","                                                          decreasing = TRUE), ""model""], 3)"
"0","      model_names <- top_models"
"0","    } else {"
"0","      model_names <- names(models)[1:min(3, length(models))]"
"0","    }"
"0","  }"
"0","  "
"0","  # å„ãƒ¢ãƒ‡ãƒ«ã®ä¿‚æ•°ã‚’æŠ½å‡º"
"0","  all_coef_tables <- list()"
"0","  "
"0","  for (model_name in model_names) {"
"0","    model <- models[[model_name]]"
"0","    "
"0","    if (!is.null(model)) {"
"0","      message(sprintf(""Processing: %s"", model_name))"
"0","      "
"0","      # Coxphãƒ¢ãƒ‡ãƒ«ã®å ´åˆ"
"0","      if (inherits(model, ""coxph"")) {"
"0","        # ä¿‚æ•°ã¨ãã®çµ±è¨ˆé‡ã‚’å–å¾—"
"0","        model_summary <- summary(model)"
"0","        coef_table <- as.data.frame(model_summary$coefficients)"
"0","        conf_int <- as.data.frame(model_summary$conf.int)"
"0","        "
"0","        # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä½œæˆ"
"0","        model_table <- data.frame("
"0","          Model = model_name,"
"0","          Variable = rownames(coef_table),"
"0","          Beta = coef_table[, ""coef""],"
"0","          SE = coef_table[, ""se(coef)""],"
"0","          HR = conf_int[, ""exp(coef)""],"
"0","          HR_Lower = conf_int[, ""lower .95""],"
"0","          HR_Upper = conf_int[, ""upper .95""],"
"0","          Z = coef_table[, ""z""],"
"0","          P_value = coef_table[, ""Pr(>|z|)""],"
"0","          stringsAsFactors = FALSE"
"0","        )"
"0","        "
"0","      } "
"0","      # ãƒªã‚¹ãƒˆå‹ãƒ¢ãƒ‡ãƒ«ï¼ˆRFEã€Univariateç­‰ï¼‰ã®å ´åˆ"
"0","      else if (inherits(model, ""list"") && ""model"" %in% names(model) && !is.null(model$model)) {"
"0","        inner_model <- model$model"
"0","        "
"0","        if (inherits(inner_model, ""coxph"")) {"
"0","          model_summary <- summary(inner_model)"
"0","          coef_table <- as.data.frame(model_summary$coefficients)"
"0","          conf_int <- as.data.frame(model_summary$conf.int)"
"0","          "
"0","          model_table <- data.frame("
"0","            Model = model_name,"
"0","            Variable = rownames(coef_table),"
"0","            Beta = coef_table[, ""coef""],"
"0","            SE = coef_table[, ""se(coef)""],"
"0","            HR = conf_int[, ""exp(coef)""],"
"0","            HR_Lower = conf_int[, ""lower .95""],"
"0","            HR_Upper = conf_int[, ""upper .95""],"
"0","            Z = coef_table[, ""z""],"
"0","            P_value = coef_table[, ""Pr(>|z|)""],"
"0","            stringsAsFactors = FALSE"
"0","          )"
"0","        } else {"
"0","          next"
"0","        }"
"0","        "
"0","      }"
"0","      # LASSOãƒ¢ãƒ‡ãƒ«ã®å ´åˆ"
"0","      else if (inherits(model, ""lasso_cox"")) {"
"0","        # LASSOã¯ä¿‚æ•°ã®ã¿ï¼ˆpå€¤ãªã—ï¼‰"
"0","        if (!is.null(model$selected_vars) && length(model$selected_vars) > 0) {"
"0","          # ç°¡æ˜“çš„ãªä¿‚æ•°è¡¨ç¤º"
"0","          model_table <- data.frame("
"0","            Model = model_name,"
"0","            Variable = model$selected_vars,"
"0","            Beta = NA,  # LASSOã§ã¯å€‹åˆ¥ä¿‚æ•°ã‚’å–å¾—ã™ã‚‹ã®ãŒè¤‡é›‘"
"0","            SE = NA,"
"0","            HR = NA,"
"0","            HR_Lower = NA,"
"0","            HR_Upper = NA,"
"0","            Z = NA,"
"0","            P_value = NA,"
"0","            stringsAsFactors = FALSE"
"0","          )"
"0","          "
"0","          # æ³¨é‡ˆã‚’è¿½åŠ "
"0","          model_table$Variable[1] <- paste0(model_table$Variable[1], "" (LASSO selected)"")"
"0","        } else {"
"0","          next"
"0","        }"
"0","      } else {"
"0","        next"
"0","      }"
"0","      "
"0","      # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ "
"0","      all_coef_tables[[model_name]] <- model_table"
"0","    }"
"0","  }"
"0","  "
"0","  # ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã®ä¿‚æ•°ã‚’çµåˆ"
"0","  if (length(all_coef_tables) > 0) {"
"0","    combined_table <- do.call(rbind, all_coef_tables)"
"0","    rownames(combined_table) <- NULL"
"0","    "
"0","    # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª¿æ•´"
"0","    combined_table$Beta <- sprintf(""%.3f"", combined_table$Beta)"
"0","    combined_table$SE <- sprintf(""%.3f"", combined_table$SE)"
"0","    combined_table$HR <- sprintf(""%.3f"", combined_table$HR)"
"0","    combined_table$CI_95 <- sprintf(""(%.3f-%.3f)"", "
"0","                                    combined_table$HR_Lower, "
"0","                                    combined_table$HR_Upper)"
"0","    "
"0","    # På€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
"0","    combined_table$P_value_formatted <- ifelse("
"0","      combined_table$P_value < 0.001, ""<0.001"","
"0","      sprintf(""%.3f"", combined_table$P_value)"
"0","    )"
"0","    "
"0","    # æœ‰æ„æ€§ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ "
"0","    combined_table$Significance <- ifelse("
"0","      combined_table$P_value < 0.001, ""***"","
"0","      ifelse(combined_table$P_value < 0.01, ""**"","
"0","             ifelse(combined_table$P_value < 0.05, ""*"", """"))"
"0","    )"
"0","    "
"0","    # æœ€çµ‚çš„ãªãƒ†ãƒ¼ãƒ–ãƒ«"
"0","    final_table <- combined_table[, c(""Model"", ""Variable"", ""Beta"", ""SE"", "
"0","                                      ""HR"", ""CI_95"", ""P_value_formatted"", ""Significance"")]"
"0","    "
"0","    names(final_table) <- c(""Model"", ""Variable"", ""Î²"", ""SE"", "
"0","                            ""HR"", ""95% CI"", ""P-value"", """")"
"0","    "
"0","    # CSVã¨ã—ã¦ä¿å­˜"
"0","    if (!is.null(output_file)) {"
"0","      write.csv(final_table, output_file, row.names = FALSE)"
"0","      message(sprintf(""âœ“ Table 2 saved to: %s"", basename(output_file)))"
"0","    }"
"0","    "
"0","    return(final_table)"
"0","  } else {"
"0","    message(""No valid models found for Table 2"")"
"0","    return(NULL)"
"0","  }"
"0","}"
"0",""
"0","# Table 2ã‚’ä½œæˆï¼ˆãƒ™ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«ã¨ãã®ä»–ã®ä¸»è¦ãƒ¢ãƒ‡ãƒ«ï¼‰"
"0","table2_result <- create_table2("
"0","  models = models,"
"0","  model_names = c(best_model_name, ""TNM Model""),  # ãƒ™ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«ã¨TNMãƒ¢ãƒ‡ãƒ«"
"0","  output_file = file.path(paths$output_tables, ""table2_model_coefficients.csv"")"
"0",")"
"2","Processing: m1_stepaic_forward
"
"2","âœ“ Table 2 saved to: table2_model_coefficients.csv
"
"0","# è¡¨ç¤º"
"0","if (!is.null(table2_result)) {"
"0","  message(""\nğŸ“‹ Table 2 Preview (first 20 rows):"")"
"0","  print(head(table2_result, 20))"
"0","}"
"2","
ğŸ“‹ Table 2 Preview (first 20 rows):
"
