"0","## ==== CHUNK-CR-FIX2: recover M7 vars, drop exact duplicates, harmonize ======"
"0","stopifnot(exists(""model_results""))"
"0","m7 <- model_results[[""M7_LASSO_postCox""]]"
"0",""
"0","# M7 の親候補を回収（fit / selected_parents / selected_vars のいずれか）"
"0","vars_fg <- NULL"
"0","if (!is.null(m7$selected_parents)) vars_fg <- m7$selected_parents"
"0","if (is.null(vars_fg) && !is.null(m7$selected_vars)) vars_fg <- m7$selected_vars"
"0","if (is.null(vars_fg) && !is.null(m7$fit)) {"
"0","  cn <- try(names(stats::coef(m7$fit)), silent = TRUE)"
"0","  if (!inherits(cn, ""try-error"") && length(cn)) {"
"0","    parent_guess <- gsub(""^`|`$"", """", cn)"
"0","    parent_guess <- sub("":.*$"", """", parent_guess)"
"0","    parent_guess <- sub(""\\..*$"", """", parent_guess)"
"0","    vars_fg <- unique(parent_guess)"
"0","  }"
"0","}"
"0","if (is.null(vars_fg) && exists(""fit_m7"")) {"
"0","  cn <- try(names(stats::coef(fit_m7)), silent = TRUE)"
"0","  if (!inherits(cn, ""try-error"") && length(cn)) {"
"0","    parent_guess <- gsub(""^`|`$"", """", cn)"
"0","    parent_guess <- sub("":.*$"", """", parent_guess)"
"0","    parent_guess <- sub(""\\..*$"", """", parent_guess)"
"0","    vars_fg <- unique(parent_guess)"
"0","  }"
"0","}"
"0","if (is.null(vars_fg) && exists(""var_all"")) {"
"0","  vars_fg <- intersect(var_all, names(trv_cr))"
"0","}"
"0","stopifnot(length(vars_fg) > 0)"
"0",""
"0","# Fine-Gray に投入可能な列に制限"
"0","vars_fg <- intersect(vars_fg, names(trv_cr)); stopifnot(length(vars_fg) > 0)"
"0",""
"0","# --- 完全重複の親を自動で片側除去（数値親で |r|>=0.999999） ----------------"
"0","num_par <- Filter(function(v) is.numeric(trv_cr[[v]]), vars_fg)"
"0","drop_par <- character(0)"
"0","if (length(num_par) >= 2) {"
"0","  # 簡易クラスタリング：最初に見つけた親を代表にし、以降は重複扱いを drop"
"0","  seen <- list()"
"0","  for (v in num_par) {"
"0","    x <- trv_cr[[v]]; okx <- is.finite(x)"
"0","    dup_to <- NA_character_"
"0","    for (rep in names(seen)) {"
"0","      y <- seen[[rep]]; ok <- okx & is.finite(y)"
"0","      if (sum(ok) >= 3) {"
"0","        r <- suppressWarnings(cor(x[ok], y[ok]))"
"0","        if (is.finite(r) && abs(r) >= 0.999999) { dup_to <- rep; break }"
"0","      }"
"0","    }"
"0","    if (is.na(dup_to)) {"
"0","      seen[[v]] <- x"
"0","    } else {"
"0","      drop_par <- union(drop_par, v)"
"0","    }"
"0","  }"
"0","}"
"0","vars_fg_pruned <- setdiff(vars_fg, drop_par)"
"0","if (length(drop_par)) {"
"0","  cat(""[FIX] Dropped parents due to exact duplication: "","
"0","      paste(drop_par, collapse="", ""), ""\n"", sep="""")"
"0","}"
"1","[FIX] Dropped parents due to exact duplication: "
"1",""
"1","tum_diam_pre_log1p"
"1",""
"1","
"
"0","stopifnot(length(vars_fg_pruned) > 0)"
"0",""
"0","# 文字/論理 → 因子化 & テスト側レベル合わせ"
"0","to_fac <- vapply(trv_cr[vars_fg_pruned], function(x) is.character(x) || is.logical(x), logical(1))"
"0","trv_cr[vars_fg_pruned[to_fac]] <- lapply(trv_cr[vars_fg_pruned[to_fac]], factor)"
"0","tst_cr[vars_fg_pruned[to_fac]] <- Map(function(x, lev) factor(x, levels = lev),"
"0","                                      tst_cr[vars_fg_pruned[to_fac]],"
"0","                                      lapply(trv_cr[vars_fg_pruned[to_fac]], levels))"
"0",""
"0","cat(sprintf(""[CR2] vars_fg_pruned (n=%d): %s\n"", length(vars_fg_pruned), paste(vars_fg_pruned, collapse="", "")))"
"1","[CR2] vars_fg_pruned (n=12): stage_diag, liver_damage, im, sm, t, macroVI, ALBIscore, ast_log1p, tum_count_pre_log1p, alt_log1p, max_diam_cm_log1p, afp_l3_log1p
"
