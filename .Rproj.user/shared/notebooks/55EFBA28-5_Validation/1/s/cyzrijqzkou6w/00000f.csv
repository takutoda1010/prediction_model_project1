"0","## ==== FIX: sanitize_cox_fit() 親マッピングを assign で厳密化 ================="
"0","sanitize_cox_fit <- function(fit, df_train, max_iter = 10L) {"
"0","  stopifnot(inherits(fit, ""coxph""))"
"0","  kept <- attr(terms(fit), ""term.labels"")"
"0","  if (is.null(kept) || !length(kept)) stop(""[sanitize] no term labels in fit"")"
"0",""
"0","  iter <- 0L"
"0","  repeat {"
"0","    iter <- iter + 1L"
"0","    if (iter > max_iter) stop(""[sanitize] still has NA coefs after pruning"")"
"0",""
"0","    # 現在の parents だけで再フィット"
"0","    form <- as.formula(paste(""Surv(time2y, event2y) ~"", paste(kept, collapse = "" + "")))"
"0","    fit2 <- survival::coxph(form, data = df_train, ties = ""efron"", x = TRUE, y = TRUE)"
"0",""
"0","    co <- stats::coef(fit2)"
"0","    if (!any(is.na(co))) return(fit2)  # 収束：NA なし"
"0",""
"0","    # --- 係数名 -> 親変数名の対応を model.matrix の assign で厳密に取得 ---"
"0","    mm       <- model.matrix(form, data = df_train)           # (Intercept) を含む"
"0","    cn       <- colnames(mm)"
"0","    has_int  <- ""(Intercept)"" %in% cn"
"0","    mm_noint <- if (has_int) mm[, cn != ""(Intercept)"", drop = FALSE] else mm"
"0","    assign_v <- attr(mm, ""assign""); if (has_int) assign_v <- assign_v[cn != ""(Intercept)""]"
"0","    term_lb  <- attr(terms(form), ""term.labels"")"
"0","    parent_by_col <- setNames(term_lb[assign_v], colnames(mm_noint))  # 列名 → 親"
"0",""
"0","    na_cols    <- names(co)[is.na(co)]"
"0","    na_parents <- unique(na.omit(parent_by_col[na_cols]))"
"0",""
"0","    if (!length(na_parents)) {"
"0","      # フォールバック（念のため）：因子ダミー名から親を推測"
"0","      na_parents <- unique(sub(""^(.*?)[[:alnum:]_]*$"", ""\\1"", na_cols))"
"0","    }"
"0",""
"0","    message(sprintf(""[sanitize] drop parents: %s"", paste(na_parents, collapse = "", "")))"
"0","    kept <- setdiff(kept, na_parents)"
"0","    if (!length(kept)) stop(""[sanitize] all parents removed; nothing left to fit"")"
"0","  }"
"0","}"
"0",""
