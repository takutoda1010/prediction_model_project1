"0","## ==== PATCH: Rebuild & save M7 fit into model_results ======================="
"0","stopifnot(exists(""model_results""))"
"0","stopifnot(!is.null(model_results[[""M7_LASSO_postCox""]]))"
"0","m7 <- model_results[[""M7_LASSO_postCox""]]"
"0",""
"0","# trv / tst が無ければ復元"
"0","if (!exists(""trv"") || !exists(""tst"")) {"
"0","  stopifnot(exists(""ds09_train""), exists(""ds09_val""), exists(""ds09_test""), exists(""prep_surv""))"
"0","  trv <- dplyr::bind_rows(prep_surv(ds09_train), prep_surv(ds09_val))"
"0","  tst <- prep_surv(ds09_test)"
"0","}"
"0",""
"0","# 選択変数を取得（親名）"
"0","sel <- m7$selected_vars"
"0","stopifnot(length(sel) > 0, all(sel %in% names(trv)))"
"0",""
"0","# 因子レベル整合（Train基準）"
"0","to_fac <- vapply(trv[sel], function(x) is.character(x) || is.logical(x) || is.factor(x), logical(1))"
"0","trv[sel[to_fac]] <- lapply(trv[sel[to_fac]], function(x) if (is.factor(x)) x else factor(x))"
"0","tst[sel[to_fac]] <- Map(function(x, lev){"
"0","  x <- if (is.factor(x)) x else factor(x)"
"0","  factor(x, levels = lev)"
"0","}, tst[sel[to_fac]], lapply(trv[sel[to_fac]], levels))"
"0",""
"0","# 定数（0分散）親を落とす保険"
"0","const_parent <- vapply(sel, function(v){"
"0","  x <- trv[[v]]"
"0","  u <- unique(if (is.factor(x)) as.character(x) else x)"
"0","  length(stats::na.omit(u)) <= 1"
"0","}, logical(1))"
"0","if (any(const_parent)) {"
"0","  sel <- sel[!const_parent]"
"0","}"
"0","stopifnot(length(sel) > 0)"
"0",""
"0","# 再フィットして保存"
"0","form_post <- as.formula(paste(""Surv(time2y, event2y) ~"", paste(sel, collapse = "" + "")))"
"0","fit_m7 <- survival::coxph(form_post, data = trv, ties = ""efron"", x = TRUE, y = TRUE)"
"0","model_results[[""M7_LASSO_postCox""]]$fit <- fit_m7"
"0","cat(sprintf(""[PATCH] Rebuilt M7 fit with %d variables and saved to model_results.\n"", length(sel)))"
"1","[PATCH] Rebuilt M7 fit with 13 variables and saved to model_results.
"
"0","# （任意）過去コード互換: auc_df フィールドが無ければ auc から補完"
"0","if (is.null(model_results[[""M7_LASSO_postCox""]]$auc_df) &&"
"0","    !is.null(model_results[[""M7_LASSO_postCox""]]$auc) &&"
"0","    all(c(""time"",""AUC"") %in% names(model_results[[""M7_LASSO_postCox""]]$auc))) {"
"0","  model_results[[""M7_LASSO_postCox""]]$auc_df <- "
"0","    model_results[[""M7_LASSO_postCox""]]$auc[, c(""time"",""AUC"")]"
"0","  cat(""[PATCH] Filled auc_df from auc.\n"")"
"0","}"
"0",""
