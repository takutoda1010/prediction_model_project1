"0","## ==== CAL-M7-VIS: Calibration @24m (KM) + Cox recalibration line ============"
"0","stopifnot(exists(""tst""))"
"0","t_star <- 24"
"0",""
"0","# -- 1) 予測確率（学習側 S0(24) を使用）と LP -------------------------------"
"0","fit_m7 <- if (exists(""fit_m7"")) fit_m7 else {"
"0","  mf <- model_results[[""M7_LASSO_postCox""]]$fit"
"0","  if (is.null(mf)) stop(""fit_m7 not found"")"
"0","  mf"
"0","}"
"0","lp_test <- suppressWarnings(as.numeric(predict(fit_m7, newdata = tst, type = ""lp"")))"
"0",""
"0","sf0   <- survival::survfit(fit_m7)"
"0","s0_24 <- try(as.numeric(summary(sf0, times = t_star)$surv), silent = TRUE)"
"0","if (inherits(s0_24, ""try-error"") || !is.finite(s0_24)) s0_24 <- tail(sf0$surv, 1)"
"0",""
"0","p_hat <- 1 - (s0_24)^(exp(lp_test))"
"0","p_hat <- pmin(pmax(p_hat, 1e-8), 1 - 1e-8)  # 数値安定化"
"0",""
"0","# -- 2) デシル分割 & 観測リスク（KM） ---------------------------------------"
"0","dfc <- data.frame(p_hat = p_hat,"
"0","                  T = as.numeric(tst$time2y),"
"0","                  D = as.integer(tst$event2y),"
"0","                  LP = lp_test)"
"0","keep <- is.finite(dfc$p_hat) & is.finite(dfc$T) & is.finite(dfc$D) & is.finite(dfc$LP)"
"0","dfc  <- dfc[keep, , drop = FALSE]"
"0",""
"0","if (!requireNamespace(""dplyr"", quietly = TRUE)) stop(""dplyr needed"")"
"0","dfc$grp <- dplyr::ntile(dfc$p_hat, 10)"
"0",""
"0","km_O24 <- function(d){"
"0","  sf <- survival::survfit(Surv(T, D) ~ 1, data = d)"
"0","  s  <- try(as.numeric(summary(sf, times = t_star)$surv), silent = TRUE)"
"0","  if (inherits(s, ""try-error"") || !is.finite(s)) s <- tail(sf$surv, 1)"
"0","  1 - s"
"0","}"
"0",""
"0","agg <- dplyr::group_by(dfc, grp) |>"
"0","  dplyr::summarise("
"0","    pred = mean(p_hat),"
"0","    obs  = km_O24(dplyr::cur_data()),"
"0","    n    = dplyr::n(),"
"0","    .groups = ""drop"""
"0","  )"
"0",""
"0","# --- [PATCH] ③ Cox 再校正（LPのみ）→ ベースラインは「LP=0」で取得 ----"
"0","fit_slope  <- survival::coxph(Surv(T, D) ~ LP, data = dfc, ties = ""efron"")"
"0","beta_hat   <- as.numeric(coef(fit_slope)[""LP""])"
"0",""
"0","# ★ ベースラインは newdata=LP=0 で取得（ここが重要）"
"0","sf_star      <- survival::survfit(fit_slope, newdata = data.frame(LP = 0))"
"0","s0_star_24   <- try(as.numeric(summary(sf_star, times = t_star)$surv), silent = TRUE)"
"0","if (inherits(s0_star_24, ""try-error"") || !is.finite(s0_star_24)) s0_star_24 <- tail(sf_star$surv, 1)"
"0",""
"0","# 正しい再校正予測"
"0","p_recal <- 1 - (s0_star_24)^(exp(beta_hat * dfc$LP))"
"0","p_recal <- pmin(pmax(p_recal, 1e-8), 1 - 1e-8)"
"0",""
"0","# p_recal を dfc の列として持たせる（これが抜けていた）"
"0","dfc$p_recal <- p_recal"
"0",""
"0","agg_recal <- dplyr::group_by(dfc, grp) |>"
"0","  dplyr::summarise("
"0","    pred  = mean(p_hat),"
"0","    recal = mean(p_recal),   # ← これで各グループごとの平均に"
"0","    .groups = ""drop"""
"0","  ) |>"
"0","  dplyr::arrange(pred)"
"0",""
"0",""
"0","agg_recal <- dplyr::group_by(dfc, grp) |>"
"0","  dplyr::summarise("
"0","    pred  = mean(p_hat),        # x軸は元の予測（デシルの平均）"
"0","    recal = mean(p_recal),      # y軸に再校正後の平均リスク"
"0","    .groups = ""drop"""
"0","  ) |>"
"0","  dplyr::arrange(pred)"
"0",""
"0","# -- 4) 描画：黒点（KM by decile）+ LOESS + 紫の再校正ライン -----------------"
"0","op <- par(no.readonly = TRUE); on.exit(par(op), add = TRUE)"
"0","par(mar = c(5,5,3,3))"
"0","plot(agg$pred, agg$obs, pch = 19, xlim = c(0,1), ylim = c(0,1),"
"0","     xlab = ""Predicted risk at 24 months"","
"0","     ylab = ""Observed risk (KM) at 24 months"","
"0","     main = ""Calibration plot at 24 months (M7)\nwith Cox recalibration line"")"
