"0","## ==== CHUNK-CR-FIX1: Build competing-risks vars (strict) ===================="
"0","stopifnot(exists(""trv""), exists(""tst""))"
"0",""
"0","build_cr_vars_strict <- function(df, t_star = 24, tie_tol = 0.01){"
"0","  d <- df"
"0",""
"0","  # helper: months between two Dates (robust)"
"0","  mon_diff <- function(a, b){"
"0","    if (!(""Date"" %in% class(a))) a <- as.Date(a)"
"0","    if (!(""Date"" %in% class(b))) b <- as.Date(b)"
"0","    as.numeric(a - b) / 30.4375"
"0","  }"
"0",""
"0","  # death フラグと死亡時間（生存なら NA にする）"
"0","  death_flag <- rep(NA, nrow(d))"
"0","  if (""vital10"" %in% names(d)) {"
"0","    # vital10: 生=TRUE / 死=FALSE"
"0","    death_flag <- (isTRUE(d$vital10) == FALSE)"
"0","  }"
"0","  if (""vital_status"" %in% names(d)) {"
"0","    vs <- tolower(as.character(d$vital_status))"
"0","    death_flag <- ifelse(!is.na(vs), death_flag | vs %in% c(""死"",""deceased"",""dead"",""死亡""), death_flag)"
"0","  }"
"0","  death_flag[is.na(death_flag)] <- FALSE"
"0",""
"0","  # 時間の用意"
"0","  os_m <- if (""os_months"" %in% names(d)) as.numeric(d$os_months) else NA_real_"
"0","  # 生存例の os_m は「死亡時刻」ではないので使わない（NA にする）"
"0","  os_m[!death_flag] <- NA_real_"
"0",""
"0","  # フォローアップ（打ち切り用）"
"0","  fu_m <- NA_real_"
"0","  if (all(c(""last_followup"",""op_date"") %in% names(d))) {"
"0","    fu_m <- suppressWarnings(mon_diff(d$last_followup, d$op_date))"
"0","  } else if (""time2y"" %in% names(d)) {"
"0","    fu_m <- as.numeric(d$time2y) # fallback"
"0","  }"
"0",""
"0","  # 再発時間：再発例のみ rfs_months、非再発は NA にする"
"0","  recur_flag <- if (""recur_tf"" %in% names(d)) (d$recur_tf == TRUE) else !is.na(d$recur_date)"
"0","  rfs_m <- if (""rfs_months"" %in% names(d)) as.numeric(d$rfs_months) else NA_real_"
"0","  rfs_m[!recur_flag] <- NA_real_"
"0",""
"0","  # first event の決定"
"0","  #  1) 再発も死亡もある → 早い方（同着は再発優先）"
"0","  #  2) 片方だけ → それ"
"0","  #  3) どちらも無い → censor @ fu_m"
"0","  who <- integer(nrow(d)); who[] <- 0L"
"0","  time_use <- rep(NA_real_, nrow(d))"
"0",""
"0","  both <- is.finite(rfs_m) & is.finite(os_m)"
"0","  earlier_r <- both & (rfs_m < os_m - tie_tol)"
"0","  earlier_d <- both & (os_m < rfs_m - tie_tol)"
"0","  tie       <- both & (abs(rfs_m - os_m) <= tie_tol)"
"0",""
"0","  who[earlier_r | tie] <- 1L"
"0","  time_use[earlier_r | tie] <- rfs_m[earlier_r | tie]"
"0",""
"0","  who[earlier_d] <- 2L"
"0","  time_use[earlier_d] <- os_m[earlier_d]"
"0",""
"0","  only_r <- is.finite(rfs_m) & !is.finite(os_m)"
"0","  who[only_r] <- 1L"
"0","  time_use[only_r] <- rfs_m[only_r]"
"0",""
"0","  only_d <- is.finite(os_m) & !is.finite(rfs_m)"
"0","  who[only_d] <- 2L"
"0","  time_use[only_d] <- os_m[only_d]"
"0",""
"0","  none <- !is.finite(rfs_m) & !is.finite(os_m)"
"0","  who[none] <- 0L"
"0","  time_use[none] <- fu_m[none]"
"0",""
"0","  # 出力"
"0","  out <- transform(d,"
"0","                   time_cr   = as.numeric(time_use),"
"0","                   status_cr = as.integer(who))"
"0","  list(df = out, t_star = t_star)"
"0","}"
"0",""
"0","# 再構築"
"0","cr_trv <- build_cr_vars_strict(trv)"
"0","cr_tst <- build_cr_vars_strict(tst)"
"0","trv_cr <- cr_trv$df %>% dplyr::filter(is.finite(time_cr), time_cr > 0)"
"0","tst_cr <- cr_tst$df %>% dplyr::filter(is.finite(time_cr), time_cr > 0)"
"0",""
"0","# 状態の内訳確認"
"0","cat(""== [FIX] Status composition after strict build (Train+Val) ==\n"")"
"1","== [FIX] Status composition after strict build (Train+Val) ==
"
"0","print(table(trv_cr$status_cr, useNA=""ifany""))"
"1","
"
"1","  1 "
"1","  2 "
"1","
"
"1","478 "
"1","303 "
"1","
"
