"0","## ==== CR3-VIS1: Calibration at 24m (CIF, Aalen–Johansen) ===================="
"0","stopifnot(exists(""tst_cr""), exists(""prodlim""))"
"0",""
"0","# 既に保存があるなら使う"
"0","if (exists(""cal_cr_M7_core"")) {"
"0","  pred_cif <- cal_cr_M7_core$pred_cif"
"0","  df_vis   <- cal_cr_M7_core$te"
"0","} else {"
"0","  # フォールバック（fit_fg がある前提）"
"0","  stopifnot(exists(""fit_fg""))"
"0","  pred_cif <- as.numeric(riskRegression::predictRisk(fit_fg, newdata = tst_cr, times = 24, cause = 1))"
"0","  df_vis   <- tst_cr"
"0","}"
"0","pred_cif <- pmin(pmax(pred_cif, 1e-8), 1-1e-8)"
"0",""
"0","# デシルごとに観測CIF（AJ）を計算"
"0","if (!requireNamespace(""dplyr"", quietly = TRUE)) stop(""dplyr required"")"
"0","df_plot <- data.frame(pred = pred_cif,"
"0","                      time = as.numeric(df_vis$time_cr),"
"0","                      status = as.integer(df_vis$status_cr))"
"0","df_plot <- df_plot[is.finite(df_plot$pred) & is.finite(df_plot$time) & is.finite(df_plot$status), , drop=FALSE]"
"0","df_plot$dec <- dplyr::ntile(df_plot$pred, 10L)"
"0",""
"0","aj_dec <- df_plot |>"
"0","  dplyr::group_by(dec) |>"
"0","  dplyr::summarise("
"0","    pred = mean(pred, na.rm = TRUE),"
"0","    obs  = {"
"0","      pl <- prodlim::prodlim(Hist(time, status) ~ 1, data = dplyr::cur_data())"
"0","      o  <- as.numeric(predict(pl, cause = 1, times = 24))"
"0","      if (!is.finite(o)) tail(predict(pl, cause = 1), 1) else o"
"0","    },"
"0","    n = dplyr::n(),"
"0","    .groups = ""drop"""
"0","  ) |>"
"0","  dplyr::arrange(pred)"
"0",""
"0","# 全体の観測CIF"
"0","pl_all <- prodlim::prodlim(Hist(time, status) ~ 1, data = df_plot)"
"0","obs_all_24 <- as.numeric(predict(pl_all, cause = 1, times = 24))"
"0","obs_all_24 <- ifelse(is.finite(obs_all_24), obs_all_24, tail(predict(pl_all, cause = 1), 1))"
"0","citl <- mean(df_plot$pred) - obs_all_24"
"0",""
"0","op <- par(no.readonly = TRUE); on.exit(par(op), add = TRUE)"
"0","par(mar = c(5,5,3,2))"
"0","plot(aj_dec$pred, aj_dec$obs,"
"0","     xlim = c(0,1), ylim = c(0,1),"
"0","     xlab = ""Predicted CIF at 24 months"","
"0","     ylab = ""Observed CIF at 24 months (Aalen–Johansen)"","
"0","     pch = 19, main = ""Competing-risks Calibration (24m)"")"
