"0","## ==== CHUNK-CR3-ROBUST: Fine-Gray with auto-pruning until non-singular ======"
"0","stopifnot(exists(""trv_cr""), exists(""tst_cr""))"
"0","start_vars <- if (exists(""vars_fg_pruned"")) vars_fg_pruned else vars_fg"
"0","stopifnot(length(start_vars) > 0)"
"0",""
"0","# -- helpers ------------------------------------------------------------------"
"0",".mm_by_parents <- function(d, parents){"
"0","  form_x <- as.formula(paste(""~"", paste(parents, collapse="" + "")))"
"0","  MM0 <- model.matrix(form_x, data = d)"
"0","  cn  <- colnames(MM0)"
"0","  has_int <- ""(Intercept)"" %in% cn"
"0","  MM  <- if (has_int) MM0[, cn!=""(Intercept)"", drop=FALSE] else MM0"
"0","  assign_v <- attr(MM0, ""assign""); if (has_int) assign_v <- assign_v[cn!=""(Intercept)""]"
"0","  term_lb  <- attr(terms(form_x), ""term.labels"")"
"0","  parent_by_col <- term_lb[assign_v]"
"0","  list(MM=MM, parent_by_col=parent_by_col)"
"0","}"
"0",""
"0",".drop_one_parent_for_fullrank <- function(MM, parent_by_col){"
"0","  # 1) 定数列を消す（親ごと）"
"0","  const_cols <- vapply(seq_len(ncol(MM)), function(j) length(unique(MM[, j])) <= 1, logical(1))"
"0","  if (any(const_cols)) {"
"0","    return(unique(parent_by_col[const_cols])[1])"
"0","  }"
"0","  # 2) 完全重複列（同一パターン）→ 重複親のうち1つ"
"0","  keys <- apply(MM, 2, function(col) paste(col, collapse="",""))"
"0","  dup_idx <- if (ncol(MM)>1) which(duplicated(keys)) else integer(0)"
"0","  if (length(dup_idx)) {"
"0","    return(unique(parent_by_col[dup_idx])[1])"
"0","  }"
"0","  # 3) QRランク落ち → 従属列の親のうちダミー数が多い親"
"0","  qrMM <- qr(MM)"
"0","  if (qrMM$rank < ncol(MM)) {"
"0","    dep_cols <- setdiff(seq_len(ncol(MM)), sort(qrMM$pivot[1:qrMM$rank]))"
"0","    dep_par  <- parent_by_col[dep_cols]"
"0","    tab <- sort(table(parent_by_col), decreasing = TRUE)"
"0","    cand <- intersect(names(tab), unique(dep_par))"
"0","    if (length(cand)) return(cand[1])"
"0","    # 保険：親の中で最も列が多いもの"
"0","    return(names(tab)[1])"
"0","  }"
"0","  # 4) すでにフルランクなら NULL"
"0","  NULL"
"0","}"
"0",""
"0",".try_fit_FGR <- function(vars_try){"
"0","  # 因子化レベル整合"
"0","  to_fac <- vapply(trv_cr[vars_try], function(x) is.character(x) || is.logical(x), logical(1))"
"0","  tr_loc <- trv_cr; te_loc <- tst_cr"
"0","  tr_loc[vars_try[to_fac]] <- lapply(tr_loc[vars_try[to_fac]], factor)"
"0","  te_loc[vars_try[to_fac]] <- Map(function(x, lev) factor(x, levels = lev),"
"0","                                  te_loc[vars_try[to_fac]], lapply(tr_loc[vars_try[to_fac]], levels))"
"0","  # フルランク確認"
"0","  mm <- .mm_by_parents(tr_loc, vars_try)"
"0","  qrMM <- qr(mm$MM)"
"0","  if (qrMM$rank < ncol(mm$MM)) {"
"0","    return(list(ok=FALSE, fit=NULL, vars=vars_try, reason=""rank_deficit"", tr=tr_loc, te=te_loc))"
"0","  }"
"0","  # FGR 本体"
"0","  form_fg <- as.formula(paste(""Hist(time_cr, status_cr) ~"", paste(vars_try, collapse="" + "")))"
"0","  fit <- try(riskRegression::FGR(form_fg, data = tr_loc, cause = 1), silent = TRUE)"
"0","  if (inherits(fit, ""try-error"")) {"
"0","    return(list(ok=FALSE, fit=NULL, vars=vars_try, reason=""fgr_singular"", tr=tr_loc, te=te_loc))"
"0","  }"
"0","  list(ok=TRUE, fit=fit, vars=vars_try, tr=tr_loc, te=te_loc)"
"0","}"
"0",""
"0","# -- main loop ----------------------------------------------------------------"
"0","vars_keep <- unique(start_vars)"
"0","max_iter  <- 50L"
"0","iter <- 0L"
"0","repeat {"
"0","  iter <- iter + 1L"
"0","  if (iter > max_iter) stop(""[CR3] Gave up after max iterations; still singular."")"
"0",""
"0","  # まず設計行列レベルでのフルランク化（親1つずつ削る）"
"0","  mm <- .mm_by_parents(trv_cr, vars_keep)"
"0","  drop_par <- .drop_one_parent_for_fullrank(mm$MM, mm$parent_by_col)"
"0","  if (!is.null(drop_par)) {"
"0","    message(sprintf(""[CR3] Drop(parent for rank): %s"", drop_par))"
"0","    vars_keep <- setdiff(vars_keep, drop_par)"
"0","    next"
"0","  }"
"0",""
"0","  # FGR を試す"
"0","  fit_try <- .try_fit_FGR(vars_keep)"
"0","  if (fit_try$ok) {"
"0","    message(sprintf(""[CR3] FGR fit OK with %d parents: %s"","
"0","                    length(vars_keep), paste(vars_keep, collapse="", "")))"
"0","    fit_fg  <- fit_try$fit"
"0","    tr_loc  <- fit_try$tr"
"0","    te_loc  <- fit_try$te"
"0","    break"
"0","  } else {"
"0","    # FGR 内部で特異行列 → “依存列に関与する親”を1つ落とす"
"0","    mm2 <- .mm_by_parents(trv_cr, vars_keep)"
"0","    qr2 <- qr(mm2$MM)"
"0","    dep_cols <- setdiff(seq_len(ncol(mm2$MM)), sort(qr2$pivot[1:qr2$rank]))"
"0","    dep_pars <- if (length(dep_cols)) unique(mm2$parent_by_col[dep_cols]) else character(0)"
"0","    # フォールバック：列数の多い親"
"0","    tab <- sort(table(mm2$parent_by_col), decreasing = TRUE)"
"0","    cand <- if (length(dep_pars)) intersect(names(tab), dep_pars) else names(tab)"
"0","    drop_par2 <- cand[1]"
"0","    message(sprintf(""[CR3] Drop(parent after FGR singular): %s"", drop_par2))"
"0","    vars_keep <- setdiff(vars_keep, drop_par2)"
"0","    if (length(vars_keep) == 0) stop(""[CR3] No parents left to fit FGR."")"
"0","    next"
"0","  }"
"0","}"
"2","[CR3] Drop(parent after FGR singular): t
"
"2","[CR3] Drop(parent after FGR singular): liver_damage
"
"2","[CR3] FGR fit OK with 10 parents: stage_diag, im, sm, macroVI, ALBIscore, ast_log1p, tum_count_pre_log1p, alt_log1p, max_diam_cm_log1p, afp_l3_log1p
"
"0","# -- predict CIF@24 & AJ observed --------------------------------------------"
"0","t_star <- 24"
"0","pred_cif <- as.numeric(riskRegression::predictRisk(fit_fg, newdata = te_loc, times = t_star, cause = 1))"
"0","pred_cif <- pmin(pmax(pred_cif, 1e-8), 1-1e-8)"
"0",""
"0","pl_all    <- prodlim::prodlim(Hist(time_cr, status_cr) ~ 1, data = te_loc)"
"0","obs_cif24 <- as.numeric(predict(pl_all, cause = 1, times = t_star))"
"0","if (!is.finite(obs_cif24)) obs_cif24 <- tail(predict(pl_all, cause = 1), 1)"
"0",""
"0","cat(sprintf(""[CR3] CIF@24: mean(pred)=%.3f, AJ(obs)=%.3f\n"", mean(pred_cif), obs_cif24))"
"1","[CR3] CIF@24: mean(pred)=0.430, AJ(obs)=0.321
"
"0","cat(sprintf(""[CR3] Parents used (final): %s\n"", paste(vars_keep, collapse="", "")))"
"1","[CR3] Parents used (final): stage_diag, im, sm, macroVI, ALBIscore, ast_log1p, tum_count_pre_log1p, alt_log1p, max_diam_cm_log1p, afp_l3_log1p
"
"0","# 保存（後続の可視化やCITL/傾き用）"
"0","cal_cr_M7_core <- list(fit_fg=fit_fg, pred_cif=pred_cif, obs_cif24=obs_cif24,"
"0","                       parents=vars_keep, tr=tr_loc, te=te_loc)"
"0",""
