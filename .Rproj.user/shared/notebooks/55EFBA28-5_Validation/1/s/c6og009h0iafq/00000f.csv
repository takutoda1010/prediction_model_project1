"0","## ==== CAL-M7-VIS: Calibration plot at 24m (KM-based) ========================"
"0","stopifnot(exists(""tst""))"
"0","t_star <- 24"
"0",""
"0","# 1) ‰∫àÊ∏¨Á¢∫ÁéáÔºàÊó¢„Å´‰Ωú„Å£„Å¶„ÅÑ„Çã„Å™„ÇâÂÜçÂà©Áî®OKÔºâ"
"0","fit_m7 <- if (exists(""fit_m7"")) fit_m7 else {"
"0","  if (!is.null(model_results[[""M7_LASSO_postCox""]]$fit)) model_results[[""M7_LASSO_postCox""]]$fit else stop(""fit_m7 not found"")"
"0","}"
"0","lp_test <- as.numeric(predict(fit_m7, newdata = tst, type = ""lp""))"
"0",""
"0","sf0   <- survival::survfit(fit_m7)"
"0","s0_24 <- try(as.numeric(summary(sf0, times = t_star)$surv), silent = TRUE)"
"0","if (inherits(s0_24, ""try-error"") || !is.finite(s0_24)) s0_24 <- tail(sf0$surv, 1)"
"0",""
"0","p_hat <- 1 - (s0_24)^(exp(lp_test))"
"0","p_hat <- pmin(pmax(p_hat, 1e-8), 1-1e-8)   # Êï∞ÂÄ§ÂÆâÂÆöÂåñ"
"0",""
"0","# 2) „Éá„Ç∑„É´ÂàÜÂâ≤ & ÂêÑ„Ç∞„É´„Éº„Éó„ÅÆË¶≥Ê∏¨„É™„Çπ„ÇØÔºàKMÔºâ„ÇíÁÆóÂá∫"
"0","dfc <- data.frame(p_hat = p_hat, T = as.numeric(tst$time2y), D = as.integer(tst$event2y))"
"0","keep <- is.finite(dfc$p_hat) & is.finite(dfc$T) & is.finite(dfc$D)"
"0","dfc  <- dfc[keep, , drop = FALSE]"
"0",""
"0","# ‰∫àÊ∏¨„Å´Âü∫„Å•„Åè10Á≠âÂàÜÔºàntile‰ΩøÁî®Ôºâ"
"0","if (!requireNamespace(""dplyr"", quietly = TRUE)) stop(""dplyr needed"")"
"0","dfc$grp <- dplyr::ntile(dfc$p_hat, 10)"
"0",""
"0","km_O24 <- function(d){"
"0","  sf <- survival::survfit(Surv(T, D) ~ 1, data = d)"
"0","  s  <- try(as.numeric(summary(sf, times = t_star)$surv), silent = TRUE)"
"0","  if (inherits(s, ""try-error"") || !is.finite(s)) s <- tail(sf$surv, 1)"
"0","  1 - s"
"0","}"
"0",""
"0","agg <- dplyr::group_by(dfc, grp) |>"
"0","  dplyr::summarise("
"0","    pred = mean(p_hat),"
"0","    obs  = km_O24(dplyr::cur_data()),"
"0","    n    = dplyr::n(),"
"0","    .groups = ""drop"""
"0","  )"
"2","Warning: [38;5;232mThere was 1 warning in `dplyr::summarise()`.[39m
[38;5;232m[36m‚Ñπ[38;5;232m In argument: `obs = km_O24(dplyr::cur_data())`.
[36m‚Ñπ[38;5;232m In group 1: `grp = 1`.[39m
Caused by warning:
[38;5;232m[33m![38;5;232m `cur_data()` was deprecated in dplyr 1.1.0.
[36m‚Ñπ[38;5;232m Please use `pick()` instead.
[90mThis warning is displayed once every 8 hours.[38;5;232m
[90mCall `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.[38;5;232m[39m"
"0","# 3) ÊèèÁîª"
"0","op <- par(no.readonly = TRUE); on.exit(par(op), add = TRUE)"
"0","par(mar = c(5,5,3,3))"
"0","plot(agg$pred, agg$obs, pch = 19, xlim = c(0,1), ylim = c(0,1),"
"0","     xlab = ""Predicted risk at 24 months"","
"0","     ylab = ""Observed risk (KM) at 24 months"","
"0","     main = ""Calibration plot at 24 months (M7, no competing risk)"")"
