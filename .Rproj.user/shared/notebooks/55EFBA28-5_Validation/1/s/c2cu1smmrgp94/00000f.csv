"0","## ==== CAL-M7-CITL-1: 24か月時点の予測確率 p_hat(24) を計算 ==================="
"0","# LP（大きいほど高リスク）"
"0","lp_test <- as.numeric(predict(fit_m7, newdata = tst, type = ""lp""))"
"0","# ベースライン生存 S0(t) を取得"
"0","sf0 <- survival::survfit(fit_m7)  # 学習（Train+Val）上のベースライン"
"0","s0_24 <- try(as.numeric(summary(sf0, times = t_star)$surv), silent = TRUE)"
"0","if (inherits(s0_24, ""try-error"") || !is.finite(s0_24)) {"
"0","  s0_24 <- tail(sf0$surv, 1)  # timesが一致しない場合は末尾で代替"
"0","}"
"0","# 予測確率 p = 1 - S0(24)^{exp(lp)}"
"0","p_hat <- 1 - (s0_24)^(exp(lp_test))"
"0","# 数値安定化"
"0","p_hat <- pmin(pmax(p_hat, 1e-8), 1 - 1e-8)"
"0",""
"0","cat(sprintf(""[M7][CITL] baseline S0(24)=%.4f, mean(pred)=%.4f\n"", s0_24, mean(p_hat)))"
"1","[M7][CITL] baseline S0(24)=0.3400, mean(pred)=NA
"
