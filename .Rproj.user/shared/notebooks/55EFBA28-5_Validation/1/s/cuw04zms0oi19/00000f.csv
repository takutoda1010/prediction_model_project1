"0","## ==== DCA-0: Helpers for 24m-risk & IPCW Net Benefit ========================"
"0","t_star <- 24"
"0",""
"0","# Coxの24m予測リスク（学習側のS0(t*)を使用）"
"0","predict_risk_cox <- function(fit, newdata, t_star = 24){"
"0","  lp  <- as.numeric(predict(fit, newdata = newdata, type = ""lp""))"
"0","  sf0 <- survival::survfit(fit)"
"0","  s0t <- try(as.numeric(summary(sf0, times = t_star)$surv), silent = TRUE)"
"0","  if (inherits(s0t, ""try-error"") || !is.finite(s0t)) s0t <- tail(sf0$surv, 1)"
"0","  p   <- 1 - (s0t)^(exp(lp))"
"0","  pmin(pmax(p, 1e-8), 1 - 1e-8)"
"0","}"
"0",""
"0","# IPCW（検閲の逆確率重み）を 24m 点に構築"
"0","# 入力は time2y(=min(time,24)), event2y(=1:24m以内再発) を想定"
"0","compute_ipcw_24 <- function(time2y, event2y, t_star = 24){"
"0","  time2y  <- as.numeric(time2y)"
"0","  event2y <- as.integer(event2y)"
"0",""
"0","  # 検閲イベント: 24m未満で打ち切り（= event2y==0 & time2y<24）"
"0","  delta_cens <- as.integer((event2y == 0) & (time2y < t_star))"
"0","  sfC <- survival::survfit(Surv(time2y, delta_cens) ~ 1)"
"0",""
"0","  Ghat_of <- function(u){"
"0","    s <- try(as.numeric(summary(sfC, times = u, extend = TRUE)$surv), silent = TRUE)"
"0","    if (inherits(s, ""try-error"") || !is.finite(s)) s <- tail(sfC$surv, 1)"
"0","    s"
"0","  }"
"0",""
"0","  w <- rep(NA_real_, length(time2y))"
"0","  # 24m以内イベント: w_i = 1 / Ghat(t_i)"
"0","  idx_e <- which(event2y == 1)"
"0","  if (length(idx_e)) w[idx_e] <- 1 / pmax(vapply(time2y[idx_e], Ghat_of, numeric(1)), 1e-6)"
"0","  # 24m時点で未再発（control）: w_i = 1 / Ghat(24)"
"0","  idx_c <- which((event2y == 0) & (time2y >= t_star))"
"0","  if (length(idx_c)) w[idx_c] <- 1 / pmax(Ghat_of(t_star), 1e-6)"
"0","  # 24m未満で打ち切りは0（寄与なし；IPCWが他で補う）"
"0","  idx_u <- which((event2y == 0) & (time2y < t_star))"
"0","  if (length(idx_u)) w[idx_u] <- 0"
"0",""
"0","  w"
"0","}"
"0",""
"0","# Net Benefit カーブ（IPCW版）"
"0","net_benefit_curve <- function(p_hat, time2y, event2y, thresholds, t_star = 24){"
"0","  w <- compute_ipcw_24(time2y, event2y, t_star)"
"0","  ok <- is.finite(w) & is.finite(p_hat)"
"0","  w  <- w[ok]; p_hat <- p_hat[ok]"
"0","  time2y <- time2y[ok]; event2y <- event2y[ok]"
"0","  N <- length(w)"
"0",""
"0","  out <- lapply(thresholds, function(pt){"
"0","    treat <- as.integer(p_hat >= pt)"
"0","    TP <- sum(w * treat * (event2y == 1), na.rm = TRUE) / N"
"0","    FP <- sum(w * treat * (event2y == 0 & time2y >= t_star), na.rm = TRUE) / N"
"0","    NB <- TP - FP * (pt / (1 - pt))"
"0","    c(pt = pt, NB = NB)"
"0","  })"
"0","  as.data.frame(do.call(rbind, out))"
"0","}"
"0",""
"0","# Treat-all / Treat-none の NB"
"0","nb_treat_all <- function(time2y, event2y, thresholds, t_star = 24){"
"0","  w <- compute_ipcw_24(time2y, event2y, t_star)"
"0","  ok <- is.finite(w); w <- w[ok]; time2y <- time2y[ok]; event2y <- event2y[ok]"
"0","  N <- length(w)"
"0","  base_TP <- sum(w * (event2y == 1), na.rm = TRUE) / N"
"0","  base_FP <- sum(w * (event2y == 0 & time2y >= t_star), na.rm = TRUE) / N"
"0","  data.frame("
"0","    pt = thresholds,"
"0","    NB = base_TP - base_FP * (thresholds / (1 - thresholds))"
"0","  )"
"0","}"
"0","nb_treat_none <- function(thresholds){"
"0","  data.frame(pt = thresholds, NB = 0)"
"0","}"
"0",""
