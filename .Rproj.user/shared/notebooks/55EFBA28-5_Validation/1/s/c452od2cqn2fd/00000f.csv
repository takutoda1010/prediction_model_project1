"0","## ==== CAL-M7-CITL-3: IPCWロジスティック再校正（切片= CITL） =================="
"0","# 目的：logit(Y(24)) ~ 1 + offset(logit(p_hat)), 重み=IPCW"
"0","# ここで Y(24)=1(24mまでに再発), 0(それ以外)。検閲はIPCWで補正。"
"0","logit <- function(x) log(x/(1-x))"
"0",""
"0","# (a) 検閲(KM)を推定： 'censored before 24m' をイベントにする"
"0","delta_c <- as.integer(T_test < t_star & D_test == 0)   # 24m前に打ち切り→1"
"0","sf_cens <- survival::survfit(Surv(T_test, delta_c) ~ 1)"
"0",""
"0","Ghat <- function(u){"
"0","  # 検閲生存 G(u) = P(C > u) を返す（外挿は最後の値で）"
"0","  su <- try(as.numeric(summary(sf_cens, times = u)$surv), silent = TRUE)"
"0","  if (inherits(su, ""try-error"") || !is.finite(su)) su <- tail(sf_cens$surv, 1)"
"0","  su"
"0","}"
"0",""
"0","# (b) 時点t*におけるIPCW重み（“t*で状態がわかる個体のみ”に重み付け）"
"0","w_ipcw <- numeric(length(T_test))"
"0","for (i in seq_along(T_test)) {"
"0","  if (D_test[i] == 1 && T_test[i] <= t_star) {"
"0","    # t* 前イベント → G(T-) で割る（実装上は G(T) を近似使用）"
"0","    g <- Ghat(T_test[i])"
"0","    w_ipcw[i] <- if (is.finite(g) && g > 1e-8) 1/g else 0"
"0","  } else if (T_test[i] >= t_star) {"
"0","    # t* まで無検閲で到達 → G(t*) で割る"
"0","    g <- Ghat(t_star)"
"0","    w_ipcw[i] <- if (is.finite(g) && g > 1e-8) 1/g else 0"
"0","  } else {"
"0","    # t* 前に検閲 → 状態不明なので寄与0"
"0","    w_ipcw[i] <- 0"
"0","  }"
"0","}"
"0",""
"0","# (c) ロジスティック再校正（切片のみ、offset=logit(p_hat)）"
"0","df_cal <- data.frame("
"0","  Y = as.integer(D_test == 1 & T_test <= t_star),"
"0","  off = logit(p_hat),"
"0","  w = w_ipcw"
"0",")"
"0","fit_cal <- glm(Y ~ 1 + offset(off),"
"0","               weights = w, family = binomial(), data = df_cal)"
"2","Warning: non-integer #successes in a binomial glm!"
"2","Warning: non-integer #successes in a binomial glm!"
"0","alpha <- coef(fit_cal)[1]                    # これが CITL（理想 0）"
"0","se_a  <- sqrt(vcov(fit_cal)[1,1])"
"0","ci_a  <- alpha + c(-1,1) * 1.96 * se_a"
"0",""
"0","cat(sprintf(""[M7][CITL][IPCW-logit] alpha (CITL) = %.4f (SE=%.4f), 95%% CI [%.4f, %.4f]\n"","
"0","            alpha, se_a, ci_a[1], ci_a[2]))"
"1","[M7][CITL][IPCW-logit] alpha (CITL) = -0.1512 (SE=0.1610), 95% CI [-0.4668, 0.1643]
"
"0","cat(sprintf(""[M7][CITL] counts: n_event<=24=%d, n_cens<24=%d, n_known@24=%d\n"","
"0","            sum(D_test==1 & T_test<=t_star),"
"0","            sum(D_test==0 & T_test<t_star),"
"0","            sum(T_test>=t_star) + sum(D_test==1 & T_test<=t_star)))"
"1","[M7][CITL] counts: n_event<=24=63, n_cens<24=73, n_known@24=123
"
