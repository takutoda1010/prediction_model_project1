"0","## ==== DCA-1 (REWRITE): risks for M7 and TNM (t+n+m) ========================="
"0","stopifnot(exists(""trv""), exists(""tst""), exists(""model_results""))"
"0","stopifnot(!is.null(model_results[[""M7_LASSO_postCox""]]$fit))"
"0","fit_m7 <- model_results[[""M7_LASSO_postCox""]]$fit"
"0",""
"0","# M7 の 24m リスク"
"0","risk_m7 <- predict_risk_cox(fit_m7, newdata = tst, t_star = if (exists(""t_star"")) t_star else 24)"
"0",""
"0","# TNM (t + n + m) で Cox を学習（Train+Val）→ Test に 24m リスク"
"0","tnm_vars <- intersect(c(""t"",""n"",""m""), names(trv))"
"0","stopifnot(all(c(""t"",""n"",""m"") %in% tnm_vars))"
"0",""
"0","# 文字/論理/因子を因子化し、level を Train+Val に合わせる"
"0","to_fac <- vapply(trv[tnm_vars], function(x) is.character(x) || is.logical(x) || is.factor(x), logical(1))"
"0","trv[tnm_vars[to_fac]] <- lapply(trv[tnm_vars[to_fac]], function(x) if (is.factor(x)) x else factor(x))"
"0","tst[tnm_vars[to_fac]] <- Map(function(x, lev){"
"0","  x <- if (is.factor(x)) x else factor(x)"
"0","  factor(x, levels = lev)"
"0","}, tst[tnm_vars[to_fac]], lapply(trv[tnm_vars[to_fac]], levels))"
"0",""
"0","fit_tnm  <- survival::coxph(Surv(time2y, event2y) ~ t + n + m, data = trv, ties = ""efron"", x = TRUE, y = TRUE)"
"0","risk_tnm <- predict_risk_cox(fit_tnm, newdata = tst, t_star = if (exists(""t_star"")) t_star else 24)"
"0",""
"0","# 参考: 件数チェック（必要なら）"
"0","cat(sprintf(""[DCA] Test N=%d | cases<=24=%d | controls@24=%d | cens<24=%d\n"","
"0","            nrow(tst),"
"0","            sum(tst$time2y <= (if (exists(""t_star"")) t_star else 24) & tst$event2y == 1, na.rm = TRUE),"
"0","            sum(tst$time2y >  (if (exists(""t_star"")) t_star else 24), na.rm = TRUE),"
"0","            sum(tst$time2y <  (if (exists(""t_star"")) t_star else 24) & tst$event2y == 0, na.rm = TRUE)))"
"1","[DCA] Test N=196 | cases<=24=63 | controls@24=0 | cens<24=73
"
