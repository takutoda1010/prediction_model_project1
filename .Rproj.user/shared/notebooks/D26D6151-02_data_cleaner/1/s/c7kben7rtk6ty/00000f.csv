"0","################################################################################"
"0","# 02_data_cleaner.R - ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã¨å‰å‡¦ç†"
"0","# "
"0","# Description: "
"0","#   ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ãªã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‡¦ç†"
"0","#   ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã®ä½œæˆã€å‚ç…§ãƒ¬ãƒ™ãƒ«è¨­å®šã€ãƒ‡ãƒ¼ã‚¿å‹ã®è©³ç´°èª¿æ•´"
"0","#"
"0","# Author: Takuto Yoshida"
"0","# Date: 2024-11-07"
"0","################################################################################"
"0",""
"0","# ========================================================================"
"0","# 1. ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã®ä½œæˆ"
"0","# ========================================================================"
"0",""
"0","#' R/BRç¾¤åˆ†ã‘ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã‚’ä½œæˆ"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @return ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","create_stage_variables <- function(df, config = NULL) {"
"0","  "
"0","  message(""\nğŸ·ï¸ Creating stage variables..."")"
"0","  "
"0","  # æ‰‹è¡“æ™‚ç¾¤åˆ†ã‘ï¼ˆR/BR1/BR2ï¼‰"
"0","  surg_pattern <- ""æ‰‹è¡“æ™‚ç¾¤åˆ†ã‘\\s*R\\s*/\\s*BR1\\s*/\\s*BR2"""
"0","  surg_cols <- grep(surg_pattern, names(df), value = TRUE, perl = TRUE)"
"0","  "
"0","  if (length(surg_cols) > 0) {"
"0","    df$stage_surg <- factor("
"0","      df[[surg_cols[1]]], "
"0","      levels = c(""R"", ""BR1"", ""BR2"")"
"0","    )"
"0","    message(""  âœ“ Created: stage_surg"")"
"0","  }"
"0","  "
"0","  # è¨ºæ–­æ™‚ç¾¤åˆ†ã‘ï¼ˆR/BR1/BR2ï¼‰"
"0","  diag_pattern <- ""è¨ºæ–­æ™‚ç¾¤åˆ†ã‘\\s*R\\s*/\\s*BR1\\s*/\\s*BR2"""
"0","  diag_cols <- grep(diag_pattern, names(df), value = TRUE, perl = TRUE)"
"0","  "
"0","  if (length(diag_cols) > 0) {"
"0","    df$stage_diag <- factor("
"0","      df[[diag_cols[1]]], "
"0","      levels = c(""R"", ""BR1"", ""BR2"")"
"0","    )"
"0","    message(""  âœ“ Created: stage_diag"")"
"0","  }"
"0","  "
"0","  # R/BRäºŒåˆ†é¡ï¼ˆBR1ã¨BR2ã‚’BRã«çµ±åˆï¼‰"
"0","  rb_pattern <- ""^ç¾¤åˆ†ã‘\\s*R\\s*/\\s*BR"""
"0","  rb_cols <- grep(rb_pattern, names(df), value = TRUE, perl = TRUE)"
"0","  "
"0","  if (length(rb_cols) > 0) {"
"0","    x <- stringr::str_squish(as.character(df[[rb_cols[1]]]))"
"0","    x <- ifelse(x %in% c(""BR1"", ""BR2""), ""BR"", x)"
"0","    df$group_rb <- factor(x, levels = c(""R"", ""BR""))"
"0","    message(""  âœ“ Created: group_rb"")"
"0","  } else if (""stage_surg"" %in% names(df)) {"
"0","    # stage_surgã‹ã‚‰ä½œæˆ"
"0","    x <- as.character(df$stage_surg)"
"0","    x[x %in% c(""BR1"", ""BR2"")] <- ""BR"""
"0","    df$group_rb <- factor(x, levels = c(""R"", ""BR""))"
"0","    message(""  âœ“ Created: group_rb (from stage_surg)"")"
"0","  } else if (""stage_diag"" %in% names(df)) {"
"0","    # stage_diagã‹ã‚‰ä½œæˆ"
"0","    x <- as.character(df$stage_diag)"
"0","    x[x %in% c(""BR1"", ""BR2"")] <- ""BR"""
"0","    df$group_rb <- factor(x, levels = c(""R"", ""BR""))"
"0","    message(""  âœ“ Created: group_rb (from stage_diag)"")"
"0","  }"
"0","  "
"0","  # éç™Œéƒ¨è‚ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆæ—§ï¼‰"
"0","  nc_candidates <- c("
"0","    ""StageI+II or III+IVã€€éç™Œéƒ¨è‚(æ—§å…¥åŠ›ï¼‰"","
"0","    ""StageI+II or III+IV"""
"0","  )"
"0","  nc_cols <- intersect(nc_candidates, names(df))"
"0","  "
"0","  if (length(nc_cols) > 0 && !""nc_liver_stage_old"" %in% names(df)) {"
"0","    df$nc_liver_stage_old <- df[[nc_cols[1]]]"
"0","    message(""  âœ“ Created: nc_liver_stage_old"")"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 2. ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ã®å‚ç…§ãƒ¬ãƒ™ãƒ«è¨­å®š"
"0","# ========================================================================"
"0",""
"0","#' ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ã®å‚ç…§ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ"
"0","#' @return å‚ç…§ãƒ¬ãƒ™ãƒ«ãŒè¨­å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","set_reference_levels <- function(df, config = NULL, variables = NULL) {"
"0","  "
"0","  message(""\nâš™ï¸ Setting reference levels for categorical variables..."")"
"0","  "
"0","  # è¨­å®šã‹ã‚‰å‚ç…§ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—"
"0","  ref_levels <- NULL"
"0","  if (!is.null(config) && !is.null(config$data_processing$reference_levels)) {"
"0","    ref_levels <- config$data_processing$reference_levels"
"0","  } else {"
"0","    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‚ç…§ãƒ¬ãƒ™ãƒ«"
"0","    ref_levels <- list("
"0","      sex = ""F"","
"0","      group_rb = ""R"","
"0","      stage_surg = ""R"","
"0","      stage_diag = ""R"","
"0","      vital_status = ""ç”Ÿ"","
"0","      vital10 = ""TRUE"","
"0","      recur_tf = ""FALSE"","
"0","      eventfree10 = ""FALSE"""
"0","    )"
"0","  }"
"0","  "
"0","  # å‚ç…§ãƒ¬ãƒ™ãƒ«ã®è¨­å®š"
"0","  for (var_name in names(ref_levels)) {"
"0","    if (var_name %in% names(df)) {"
"0","      current_levels <- unique(as.character(df[[var_name]]))"
"0","      ref_level <- ref_levels[[var_name]]"
"0","      "
"0","      if (ref_level %in% current_levels) {"
"0","        # å‚ç…§ãƒ¬ãƒ™ãƒ«ã‚’å…ˆé ­ã«é…ç½®"
"0","        other_levels <- setdiff(current_levels, ref_level)"
"0","        new_levels <- c(ref_level, other_levels)"
"0","        "
"0","        df[[var_name]] <- factor("
"0","          df[[var_name]], "
"0","          levels = new_levels"
"0","        )"
"0","        "
"0","        message(sprintf(""  âœ“ %s: reference = '%s'"", var_name, ref_level))"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # å¤‰æ•°å®šç¾©ã‹ã‚‰ã®è¿½åŠ è¨­å®š"
"0","  if (!is.null(variables) && !is.null(variables$column_mappings)) {"
"0","    for (mapping in variables$column_mappings) {"
"0","      col_name <- mapping$name"
"0","      "
"0","      if (col_name %in% names(df) && !is.null(mapping$reference)) {"
"0","        if (is.factor(df[[col_name]]) || is.character(df[[col_name]])) {"
"0","          current_levels <- unique(as.character(df[[col_name]]))"
"0","          "
"0","          if (as.character(mapping$reference) %in% current_levels) {"
"0","            other_levels <- setdiff(current_levels, as.character(mapping$reference))"
"0","            new_levels <- c(as.character(mapping$reference), other_levels)"
"0","            "
"0","            df[[col_name]] <- factor("
"0","              df[[col_name]], "
"0","              levels = new_levels"
"0","            )"
"0","          }"
"0","        }"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 3. æ­»å› åˆ†é¡ã®ä½œæˆ"
"0","# ========================================================================"
"0",""
"0","#' æ­»å› ã‚’4åˆ†é¡ã«æ•´ç†"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @return æ­»å› åˆ†é¡ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","create_death_cause_categories <- function(df) {"
"0","  "
"0","  if (""æ­»å› "" %in% names(df)) {"
"0","    message(""\nğŸ’€ Creating death cause categories..."")"
"0","    "
"0","    y <- stringr::str_squish(as.character(df$æ­»å› ))"
"0","    "
"0","    # ãã®ä»–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³"
"0","    other_pattern <- ""(ä»–ç—…æ­»(ï¼ˆè€è¡°ï¼‰|\\(è€è¡°\\))?|æ•—è¡€ç—‡|æ­»ï¼ˆåŸå› ä¸æ˜ï¼‰|æ­»\\(åŸå› ä¸æ˜\\))"""
"0","    "
"0","    df$death_cause4 <- dplyr::case_when("
"0","      is.na(y) | y == """" ~ ""aliver"","
"0","      stringr::str_detect(y, ""ç™Œ"") ~ ""Cancer"","
"0","      stringr::str_detect(y, ""è‚ä¸å…¨"") ~ ""LiverFailure"","
"0","      stringr::str_detect(y, other_pattern) ~ ""Other"","
"0","      TRUE ~ ""Other"""
"0","    ) %>%"
"0","      factor(levels = c(""aliver"", ""Cancer"", ""LiverFailure"", ""Other""))"
"0","    "
"0","    message(""  âœ“ Created: death_cause4"")"
"0","    "
"0","    # é›†è¨ˆè¡¨ç¤º"
"0","    death_table <- table(df$death_cause4, useNA = ""ifany"")"
"0","    message(""  Distribution:"")"
"0","    for (i in seq_along(death_table)) {"
"0","      message(sprintf(""    %s: %d"", names(death_table)[i], death_table[i]))"
"0","    }"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 4. é †åºå› å­ã®è¨­å®š"
"0","# ========================================================================"
"0",""
"0","#' é †åºå› å­å¤‰æ•°ã‚’é©åˆ‡ã«è¨­å®š"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ"
"0","#' @return é †åºå› å­ãŒè¨­å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","set_ordered_factors <- function(df, variables = NULL) {"
"0","  "
"0","  message(""\nğŸ“Š Setting ordered factors..."")"
"0","  "
"0","  # è„ˆç®¡ä¾µè¥²ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆ0-4ï¼‰"
"0","  vi_vars <- c(""vp_pre"", ""vv_pre"", ""vp_path"", ""vv_path"", ""va_path"", ""b_path"")"
"0","  "
"0","  for (var in vi_vars) {"
"0","    if (var %in% names(df)) {"
"0","      df[[var]] <- ordered("
"0","        df[[var]], "
"0","        levels = c(0, 1, 2, 3, 4)"
"0","      )"
"0","      message(sprintf(""  âœ“ %s: ordered (0-4)"", var))"
"0","    }"
"0","  }"
"0","  "
"0","  # PS (Performance Status)"
"0","  if (""ps"" %in% names(df)) {"
"0","    df$ps <- ordered(df$ps, levels = c(0, 1, 2, 3, 4))"
"0","    message(""  âœ“ ps: ordered (0-4)"")"
"0","  }"
"0","  "
"0","  # ASAåˆ†é¡"
"0","  if (""asa"" %in% names(df)) {"
"0","    df$asa <- ordered(df$asa, levels = c(1, 2, 3, 4, 5, 6))"
"0","    message(""  âœ“ asa: ordered (1-6)"")"
"0","  }"
"0","  "
"0","  # åˆä½µç—‡ã‚°ãƒ¬ãƒ¼ãƒ‰"
"0","  comp_vars <- c(""comp_any_grade"", ""comp_pleural"", ""comp_bleeding"", ""comp_ascites"")"
"0","  "
"0","  for (var in comp_vars) {"
"0","    if (var %in% names(df)) {"
"0","      df[[var]] <- ordered(df[[var]], levels = c(0, 1, 2, 3))"
"0","      message(sprintf(""  âœ“ %s: ordered (0-3)"", var))"
"0","    }"
"0","  }"
"0","  "
"0","  # ç·šç¶­åŒ–ãƒ»ç‚ç—‡ã‚¹ã‚³ã‚¢"
"0","  if (""fibrosis_score"" %in% names(df)) {"
"0","    df$fibrosis_score <- ordered(df$fibrosis_score, levels = c(0, 1, 2, 3, 4))"
"0","    message(""  âœ“ fibrosis_score: ordered (0-4)"")"
"0","  }"
"0","  "
"0","  if (""grading_score"" %in% names(df)) {"
"0","    df$grading_score <- ordered(df$grading_score, levels = c(0, 1, 2, 3))"
"0","    message(""  âœ“ grading_score: ordered (0-3)"")"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 5. ç‰¹æ®Šãªå¤‰æ•°ã®å‡¦ç†"
"0","# ========================================================================"
"0",""
"0","#' ç‰¹æ®Šãªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®å¤‰æ•°ã‚’å‡¦ç†"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @return å‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","handle_special_variables <- function(df) {"
"0","  "
"0","  message(""\nğŸ”§ Handling special variable codings..."")"
"0","  "
"0","  # fc, fc_inf, sf, sm ã®å‡¦ç†ï¼ˆ-/+ ã‚’ 0/1ã«ï¼‰"
"0","  margin_vars <- c(""fc"", ""fc_inf"", ""sf"", ""sm"")"
"0","  "
"0","  for (var in margin_vars) {"
"0","    if (var %in% names(df)) {"
"0","      x <- as.character(df[[var]])"
"0","      x <- dplyr::recode(x, ""-"" = ""0"", ""+"" = ""1"", .default = NA_character_)"
"0","      df[[var]] <- factor(x, levels = c(""0"", ""1""))"
"0","      message(sprintf(""  âœ“ %s: converted -/+ to 0/1"", var))"
"0","    }"
"0","  }"
"0","  "
"0","  # im (intrahepatic metastasis) ã®å‡¦ç†"
"0","  # 0ã‚’åŸºæº–ã€1/2/3/+ã¯1ã€S/Xã¯æ¬ ææ‰±ã„"
"0","  if (""im"" %in% names(df)) {"
"0","    x <- as.character(df$im)"
"0","    "
"0","    df$im <- dplyr::case_when("
"0","      is.na(x) ~ NA_character_,"
"0","      x %in% c(""S"", ""X"") ~ NA_character_,"
"0","      x %in% c(""0"") ~ ""0"","
"0","      x %in% c(""1"", ""2"", ""3"", ""+"") ~ ""1"","
"0","      TRUE ~ NA_character_"
"0","    ) %>%"
"0","      factor(levels = c(""0"", ""1""))"
"0","    "
"0","    message(""  âœ“ im: standardized (0 vs 1+)"")"
"0","  }"
"0","  "
"0","  # HBV ã®å‡¦ç†"
"0","  if (""hbv"" %in% names(df)) {"
"0","    # ãƒ¬ãƒ™ãƒ«ã®ç¢ºèªã¨çµ±ä¸€"
"0","    df$hbv <- factor(df$hbv, levels = c(""-"", ""Â±"", ""+"", ""*""))"
"0","    message(""  âœ“ hbv: factor levels set"")"
"0","  }"
"0","  "
"0","  # HCV ã®å‡¦ç†ï¼ˆTRUE/FALSEã‚’0/1ã«ï¼‰"
"0","  if (""hcv"" %in% names(df)) {"
"0","    if (is.logical(df$hcv)) {"
"0","      df$hcv <- factor(as.integer(df$hcv), levels = c(0, 1))"
"0","      message(""  âœ“ hcv: converted logical to 0/1"")"
"0","    } else {"
"0","      df$hcv <- factor(df$hcv, levels = c(0, 1))"
"0","    }"
"0","  }"
"0","  "
"0","  # Child-Pughåˆ†é¡"
"0","  if (""child_pugh"" %in% names(df)) {"
"0","    df$child_pugh <- factor(df$child_pugh, levels = c(""A"", ""B"", ""C""))"
"0","    message(""  âœ“ child_pugh: factor levels set (A/B/C)"")"
"0","  }"
"0","  "
"0","  # è‚éšœå®³åº¦"
"0","  if (""liver_damage"" %in% names(df)) {"
"0","    df$liver_damage <- factor(df$liver_damage, levels = c(""A"", ""B"", ""C""))"
"0","    message(""  âœ“ liver_damage: factor levels set (A/B/C)"")"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 6. ä½“ç©å¤‰æ•°ã®å‡¦ç†"
"0","# ========================================================================"
"0",""
"0","#' ä½“ç©å¤‰æ•°ã‚’äºŒå€¤åŒ–ï¼ˆ0/é0ï¼‰"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @return å‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","process_volume_variables <- function(df) {"
"0","  "
"0","  message(""\nğŸ“ Processing volume variables..."")"
"0","  "
"0","  volume_vars <- c("
"0","    ""liver_vol"", "
"0","    ""tumor_vol"", "
"0","    ""remnant_vol"", "
"0","    ""func_resect_rate"""
"0","  )"
"0","  "
"0","  for (var in volume_vars) {"
"0","    if (var %in% names(df)) {"
"0","      # å…ƒã®å¤‰æ•°åã‚’ä¿æŒï¼ˆ_origã¨ã„ã†åå‰ã§ï¼‰"
"0","      df[[paste0(var, ""_orig"")]] <- df[[var]]"
"0","      "
"0","      # äºŒå€¤åŒ–ï¼ˆ0 vs >0ï¼‰"
"0","      df[[var]] <- factor("
"0","        dplyr::case_when("
"0","          is.na(df[[var]]) ~ NA_real_,"
"0","          df[[var]] > 0 ~ 1,"
"0","          TRUE ~ 0"
"0","        ),"
"0","        levels = c(0, 1)"
"0","      )"
"0","      "
"0","      message(sprintf(""  âœ“ %s: binarized (0 vs >0)"", var))"
"0","    }"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 7. ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯"
"0","# ========================================================================"
"0",""
"0","#' ãƒ‡ãƒ¼ã‚¿å“è³ªã®åŒ…æ‹¬çš„ãƒã‚§ãƒƒã‚¯"
"0","#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ "
"0","#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ"
"0","#' @return ãƒã‚§ãƒƒã‚¯çµæœã®ãƒªã‚¹ãƒˆ"
"0","check_data_quality <- function(df, variables = NULL) {"
"0","  "
"0","  message(""\nğŸ” Performing data quality checks..."")"
"0","  "
"0","  issues <- list()"
"0","  "
"0","  # 1. å®Œå…¨é‡è¤‡è¡Œã®ãƒã‚§ãƒƒã‚¯"
"0","  dup_rows <- duplicated(df)"
"0","  if (any(dup_rows)) {"
"0","    issues$duplicate_rows <- which(dup_rows)"
"0","    message(sprintf(""  âš  Found %d duplicate rows"", sum(dup_rows)))"
"0","  }"
"0","  "
"0","  # 2. IDé‡è¤‡ã®ãƒã‚§ãƒƒã‚¯"
"0","  if (""id"" %in% names(df)) {"
"0","    dup_ids <- df$id[duplicated(df$id)]"
"0","    if (length(dup_ids) > 0) {"
"0","      issues$duplicate_ids <- unique(dup_ids)"
"0","      message(sprintf(""  âš  Found %d duplicate IDs"", length(unique(dup_ids))))"
"0","    }"
"0","  }"
"0","  "
"0","  # 3. æ—¥ä»˜ã®è«–ç†ãƒã‚§ãƒƒã‚¯"
"0","  date_checks <- list("
"0","    list(early = ""op_date"", late = ""recur_date"", "
"0","         msg = ""Recurrence before surgery""),"
"0","    list(early = ""op_date"", late = ""last_followup"", "
"0","         msg = ""Follow-up before surgery""),"
"0","    list(early = ""dob"", late = ""op_date"", "
"0","         msg = ""Surgery before birth"")"
"0","  )"
"0","  "
"0","  for (check in date_checks) {"
"0","    if (all(c(check$early, check$late) %in% names(df))) {"
"0","      early_dates <- df[[check$early]]"
"0","      late_dates <- df[[check$late]]"
"0","      "
"0","      if (inherits(early_dates, ""Date"") && inherits(late_dates, ""Date"")) {"
"0","        invalid <- which(!is.na(early_dates) & !is.na(late_dates) & "
"0","                        early_dates > late_dates)"
"0","        "
"0","        if (length(invalid) > 0) {"
"0","          issues[[paste0(""date_"", check$early, ""_"", check$late)]] <- invalid"
"0","          message(sprintf(""  âš  %s: %d cases"", check$msg, length(invalid)))"
"0","        }"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # 4. ç”Ÿå­˜æœŸé–“ã®è«–ç†ãƒã‚§ãƒƒã‚¯"
"0","  if (all(c(""os_months"", ""rfs_months"") %in% names(df))) {"
"0","    # RFS > OS ã®ãƒã‚§ãƒƒã‚¯"
"0","    invalid_surv <- which(!is.na(df$os_months) & !is.na(df$rfs_months) & "
"0","                         df$rfs_months > df$os_months)"
"0","    "
"0","    if (length(invalid_surv) > 0) {"
"0","      issues$rfs_exceeds_os <- invalid_surv"
"0","      message(sprintf(""  âš  RFS exceeds OS: %d cases"", length(invalid_surv)))"
"0","    }"
"0","  }"
"0","  "
"0","  # 5. ç¯„å›²å¤–ã®å€¤ãƒã‚§ãƒƒã‚¯"
"0","  if (!is.null(variables) && !is.null(variables$column_mappings)) {"
"0","    for (mapping in variables$column_mappings) {"
"0","      col_name <- mapping$name"
"0","      "
"0","      if (col_name %in% names(df) && !is.null(mapping$range)) {"
"0","        x <- suppressWarnings(as.numeric(df[[col_name]]))"
"0","        "
"0","        if (any(!is.na(x))) {"
"0","          out_of_range <- which(!is.na(x) & "
"0","                               (x < mapping$range[1] | x > mapping$range[2]))"
"0","          "
"0","          if (length(out_of_range) > 0) {"
"0","            issues[[paste0(""range_"", col_name)]] <- out_of_range"
"0","            message(sprintf(""  âš  %s out of range [%g, %g]: %d cases"","
"0","                           col_name, mapping$range[1], mapping$range[2],"
"0","                           length(out_of_range)))"
"0","          }"
"0","        }"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # çµæœã‚µãƒãƒªãƒ¼"
"0","  if (length(issues) == 0) {"
"0","    message(""  âœ… No data quality issues found"")"
"0","  } else {"
"0","    message(sprintf(""\n  Total issues found: %d types"", length(issues)))"
"0","  }"
"0","  "
"0","  return(issues)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 8. çµ±åˆã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³"
"0","#' @param dm DatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param config è¨­å®šãƒªã‚¹ãƒˆ"
"0","#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ"
"0","#' @return æ›´æ–°ã•ã‚ŒãŸDatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","clean_data_pipeline <- function(dm, config = NULL, variables = NULL) {"
"0","  "
"0","  message(""\n========================================"")"
"0","  message(""Starting Data Cleaning Pipeline"")"
"0","  message(""========================================"")"
"0","  "
"0","  # ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"
"0","  df <- dm$get_current()"
"0","  current_version <- dm$current_version"
"0","  "
"0","  # 1. ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã®ä½œæˆ (ds04)"
"0","  df_stage <- create_stage_variables(df, config)"
"0","  dm$add_version(df_stage, version = current_version + 1)"
"0","  "
"0","  # 2. æ­»å› åˆ†é¡ã®ä½œæˆ (ds05)"
"0","  df_death <- create_death_cause_categories(df_stage)"
"0","  dm$add_version(df_death, version = current_version + 2)"
"0","  "
"0","  # 3. å‚ç…§ãƒ¬ãƒ™ãƒ«ã®è¨­å®š (ds06)"
"0","  df_ref <- set_reference_levels(df_death, config, variables)"
"0","  dm$add_version(df_ref, version = current_version + 3)"
"0","  "
"0","  # 4. é †åºå› å­ã®è¨­å®š (ds07)"
"0","  df_ordered <- set_ordered_factors(df_ref, variables)"
"0","  dm$add_version(df_ordered, version = current_version + 4)"
"0","  "
"0","  # 5. ç‰¹æ®Šå¤‰æ•°ã®å‡¦ç† (ds08)"
"0","  df_special <- handle_special_variables(df_ordered)"
"0","  dm$add_version(df_special, version = current_version + 5)"
"0","  "
"0","  # 6. ä½“ç©å¤‰æ•°ã®å‡¦ç† (ds09)"
"0","  df_volume <- process_volume_variables(df_special)"
"0","  dm$add_version(df_volume, version = current_version + 6)"
"0","  "
"0","  # 7. å“è³ªãƒã‚§ãƒƒã‚¯"
"0","  quality_issues <- check_data_quality(df_volume, variables)"
"0","  "
"0","  # å“è³ªå•é¡Œã‚’å±æ€§ã¨ã—ã¦ä¿å­˜"
"0","  attr(df_volume, ""quality_issues"") <- quality_issues"
"0","  "
"0","  # æœ€çµ‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°"
"0","  dm$add_version(df_volume, version = current_version + 7)"
"0","  "
"0","  # ã‚µãƒãƒªãƒ¼è¡¨ç¤º"
"0","  dm$summary()"
"0","  "
"0","  message(""\nâœ… Data cleaning pipeline completed!"")"
"0","  message(""========================================\n"")"
"0","  "
"0","  return(dm)"
"0","}"
"0",""
"0","# ========================================================================"
"0","# 9. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°"
"0","# ========================================================================"
"0",""
"0","#' ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‰å¾Œã®æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆ"
"0","#' @param dm DatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ"
"0","#' @param before_version ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³"
"0","#' @param after_version ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å¾Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³"
"0","#' @return æ¯”è¼ƒçµæœ"
"0","compare_cleaning_results <- function(dm, "
"0","                                    before_version = 3, "
"0","                                    after_version = NULL) {"
"0","  "
"0","  if (is.null(after_version)) {"
"0","    after_version <- dm$current_version"
"0","  }"
"0","  "
"0","  df_before <- dm$get_version(before_version)"
"0","  df_after <- dm$get_version(after_version)"
"0","  "
"0","  message(""\nğŸ“Š Cleaning Comparison Report"")"
"0","  message(""========================================"")"
"0","  "
"0","  # åˆ—æ•°ã®å¤‰åŒ–"
"0","  cols_added <- setdiff(names(df_after), names(df_before))"
"0","  cols_removed <- setdiff(names(df_before), names(df_after))"
"0","  "
"0","  message(sprintf(""Columns: %d â†’ %d"", ncol(df_before), ncol(df_after)))"
"0","  "
"0","  if (length(cols_added) > 0) {"
"0","    message(sprintf(""  Added: %s"", paste(cols_added, collapse = "", "")))"
"0","  }"
"0","  "
"0","  if (length(cols_removed) > 0) {"
"0","    message(sprintf(""  Removed: %s"", paste(cols_removed, collapse = "", "")))"
"0","  }"
"0","  "
"0","  # å‹ã®å¤‰åŒ–"
"0","  common_cols <- intersect(names(df_before), names(df_after))"
"0","  type_changes <- character()"
"0","  "
"0","  for (col in common_cols) {"
"0","    type_before <- class(df_before[[col]])[1]"
"0","    type_after <- class(df_after[[col]])[1]"
"0","    "
"0","    if (type_before != type_after) {"
"0","      type_changes <- c(type_changes, "
"0","                       sprintf(""%s: %s â†’ %s"", col, type_before, type_after))"
"0","    }"
"0","  }"
"0","  "
"0","  if (length(type_changes) > 0) {"
"0","    message(""\nType changes:"")"
"0","    for (change in head(type_changes, 10)) {"
"0","      message(""  "", change)"
"0","    }"
"0","    if (length(type_changes) > 10) {"
"0","      message(sprintf(""  ... and %d more"", length(type_changes) - 10))"
"0","    }"
"0","  }"
"0","  "
"0","  message(""========================================\n"")"
"0","  "
"0","  invisible(list("
"0","    cols_added = cols_added,"
"0","    cols_removed = cols_removed,"
"0","    type_changes = type_changes"
"0","  ))"
"0","}"
