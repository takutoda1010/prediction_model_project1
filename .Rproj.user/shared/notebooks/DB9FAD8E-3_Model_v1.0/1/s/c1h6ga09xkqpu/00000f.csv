"0","## ==== CHUNK 0: Setup & Utils ===="
"0","req_pkgs <- c(""tidyverse"",""survival"",""broom"",""glmnet"",""Matrix"",""lubridate"")"
"0","to_install <- setdiff(req_pkgs, rownames(installed.packages()))"
"0","if(length(to_install)) install.packages(to_install, Ncpus = 2)"
"0","invisible(lapply(req_pkgs, library, character.only = TRUE))"
"0",""
"0","stopifnot(exists(""ds01_model""))"
"0",""
"0","# 変数マッピング（必要に応じて右辺を実データ列に合わせてください）"
"0","var_map <- list("
"0","  id          = ""id"","
"0","  sex         = ""sex"",            # ""M""/""F"""
"0","  alb_g_dl    = ""alb"",            # g/dL"
"0","  tbil_mg_dl  = ""tbil"",           # mg/dL"
"0","  afp_ng_ml   = ""afp"",            # ng/mL"
"0","  tum_diam_cm = ""tum_diam_pre"",   # cm（術前）"
"0","  tum_count   = ""tum_count_pre"",  # 個数（術前）"
"0","  time_months = ""rfs_months"",     # 月"
"0","  event_recur = ""recur_tf"",       # 1=再発, 0=打切り"
"0","  t_cat       = ""t"","
"0","  n_cat       = ""n"","
"0","  m_cat       = ""m"","
"0","  vp_pre      = ""vp_pre"","
"0","  vv_pre      = ""vv_pre"","
"0","  vp_path     = ""vp_path"","
"0","  vv_path     = ""vv_path"","
"0","  op_date     = ""op_date"",        # Date"
"0","  group_rb    = ""group_rb"","
"0","  stage_diag  = ""stage_diag"""
"0",")"
"0",""
"0","need_cols <- function(dat, vars){"
"0","  miss <- vars[!vars %in% names(dat)]"
"0","  if(length(miss)) stop(""必要列が見つかりません: "", paste(miss, collapse="", ""))"
"0","}"
"0",""
"0","safe_ln <- function(x) ifelse(is.finite(x) & x > 0, log(x), NA_real_)"
"0",""
"0","calc_albi <- function(alb_g_dl, tbil_mg_dl){"
"0","  alb_g_l   <- alb_g_dl * 10      # g/dL -> g/L"
"0","  tbil_umol <- tbil_mg_dl * 17.1  # mg/dL -> μmol/L"
"0","  score <- 0.66*log10(tbil_umol) - 0.085*alb_g_l"
"0","  grade <- dplyr::case_when("
"0","    is.na(score)     ~ NA_integer_,"
"0","    score <= -2.60   ~ 1L,"
"0","    score <= -1.39   ~ 2L,"
"0","    TRUE             ~ 3L"
"0","  )"
"0","  tibble(albi_score = score, albi_grade = grade)"
"0","}"
"0",""
"0","# C-index（Harrell）— CoxのLP（大きい=ハザード大）に対しreverse=TRUEで“正しい向き”"
"0","c_index <- function(time, event, lp){"
"0","  survival::concordance(Surv(time, event) ~ lp, reverse = TRUE)$concordance"
"0","}"
"0",""
"0","# 簡易補完（数値=中央値、因子=最頻）"
"0","Mode <- function(x){ ux <- unique(x[!is.na(x)]); if(length(ux)==0) return(NA); ux[which.max(tabulate(match(x, ux)))] }"
"0","impute_simple <- function(df){"
"0","  num_cols <- names(df)[sapply(df, is.numeric)]"
"0","  fac_cols <- names(df)[sapply(df, is.factor)]"
"0","  if(length(num_cols)) df[num_cols] <- lapply(df[num_cols], function(x){ if(all(is.na(x))) x else { x[is.na(x)] <- median(x, na.rm=TRUE); x }})"
"0","  if(length(fac_cols)) df[fac_cols] <- lapply(df[fac_cols], function(x){ if(all(is.na(x))) x else { x[is.na(x)] <- Mode(x); droplevels(x) }})"
"0","  df"
"0","}"
"0",""
