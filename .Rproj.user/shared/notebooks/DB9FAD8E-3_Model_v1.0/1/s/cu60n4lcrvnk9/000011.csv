"0","## ==== CHUNK 4-DIAG: Train+Val vs Test の設計行列ズレ診断 ===="
"0","# 前提: ds04_train, ds05_val, ds06_test, ds02 が存在"
"0",""
"0","# 1) 候補セット（CHUNK4で使っているものと同じにする）"
"0","core_vars  <- c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count"",""mvi_01"")"
"0","extra_vars <- c("
"0","  ""T_cat"",""N_cat"",""M_cat"","
"0","  ""tum_diam_pre"",""tum_count_pre"",""vp_pre"",""vv_pre"",""n_pre"",""m_pre"",""age"",""sex"","
"0","  ""hbv"",""hcv"",""plt"",""alb"",""tbil"",""che"",""ast"",""alt"",""nh3"",""pt_inr"",""icg10_cat"",""icg_r15"","
"0","  ""hh15"",""lhl15"",""liver_damage"",""child_pugh"",""afp"",""afp_l3"",""pivka2"",""cea"",""ca19_9"","
"0","  ""height_cm"",""weight_kg"",""ps"",""asa"",""op_time_min"",""bleed_ml"",""max_diam_cm"",""grouth_type"","
"0","  ""vp_path"",""vv_path"",""va_path"",""b_path"",""fc"",""fc_inf"",""sf"",""lm"",""sm"",""sm_mm"","
"0","  ""stage"",""fibrosis_score"",""grading_score"""
"0",")"
"0","candidates <- unique(intersect(c(core_vars, extra_vars), names(ds02)))"
"0",""
"0","# 2) 前処理なしだと NA/型で落ちるので、最小限の“診断用”前処理"
"0","Mode <- function(x){ ux <- unique(x[!is.na(x)]); if(length(ux)==0) return(NA); ux[which.max(tabulate(match(x, ux)))] }"
"0","diag_build_mm <- function(df, vars){"
"0","  X <- df %>% dplyr::select(all_of(vars))"
"0","  # 文字は因子化、T/N/M は明示因子化（存在すれば）"
"0","  X <- X %>% mutate(across(where(is.character), as.factor))"
"0","  for(cn in c(""T_cat"",""N_cat"",""M_cat"")) if(cn %in% names(X)) X[[cn]] <- factor(X[[cn]])"
"0","  # 単純補完（数値=中央値、因子=最頻）"
"0","  num_cols <- names(X)[sapply(X, is.numeric)]"
"0","  fac_cols <- names(X)[sapply(X, is.factor)]"
"0","  if(length(num_cols)) X[num_cols] <- lapply(X[num_cols], function(z){ if(all(is.na(z))) z else { z[is.na(z)] <- median(z, na.rm=TRUE); z }})"
"0","  if(length(fac_cols)) X[fac_cols] <- lapply(X[fac_cols], function(z){ m <- Mode(z); z[is.na(z)] <- m; droplevels(z) })"
"0","  # ダミー化（切片なし）。ここでは“定数列は削除しない”で生の列を出す"
"0","  mm <- model.matrix(~ 0 + ., data = X)"
"0","  list(mm=mm, X=X)"
"0","}"
"0",""
"0","# 3) データ準備"
"0","ds07_trva <- dplyr::bind_rows(ds04_train, ds05_val)"
"0",""
"0","# 4) 設計行列の作成"
"0","trva <- diag_build_mm(ds07_trva, candidates)"
"0","te   <- diag_build_mm(ds06_test,  candidates)"
"0","mm_trva <- trva$mm"
"0","mm_te   <- te$mm"
"0",""
"0","cat(""---- Matrix dims ----\n"")"
"1","---- Matrix dims ----
"
"0","cat(""Train+Val rows:"", nrow(mm_trva), "" cols:"", ncol(mm_trva), ""\n"")"
"1","Train+Val rows:"
"1"," "
"1","293"
"1"," "
"1"," cols:"
"1"," "
"1","65"
"1"," "
"1","
"
"0","cat(""Test      rows:"", nrow(mm_te),   "" cols:"", ncol(mm_te),   ""\n"")"
"1","Test      rows:"
"1"," "
"1","52"
"1"," "
"1"," cols:"
"1"," "
"1","64"
"1"," "
"1","
"
"0","# 5) 列名の差分"
"0","cols_trva <- colnames(mm_trva)"
"0","cols_te   <- colnames(mm_te)"
"0","only_in_trva <- setdiff(cols_trva, cols_te)"
"0","only_in_te   <- setdiff(cols_te,   cols_trva)"
"0",""
"0","cat(""\n---- Column set differences ----\n"")"
"1","
---- Column set differences ----
"
"0","cat(""Columns ONLY in Train+Val (count="", length(only_in_trva), ""):\n"", paste(utils::head(only_in_trva, 20), collapse="", ""), if(length(only_in_trva)>20) "" ..."", ""\n"", sep="""")"
"1","Columns ONLY in Train+Val (count="
"1",""
"1","3"
"1",""
"1","):
"
"1",""
"1","T_cat1, hbv±, sfX"
"1",""
"1","
"
"0","cat(""Columns ONLY in Test      (count="", length(only_in_te),   ""):\n"", paste(utils::head(only_in_te, 20),   collapse="", ""), if(length(only_in_te)>20) "" ..."", ""\n"", sep="""")"
"1","Columns ONLY in Test      (count="
"1",""
"1","2"
"1",""
"1","):
"
"1",""
"1","T_cat0, stage2"
"1",""
"1","
"
"0","# 6) 定数列（分散0）の有無"
"0","sd_trva <- apply(mm_trva, 2, sd)"
"0","sd_te   <- apply(mm_te,   2, sd)"
"0","const_trva <- names(sd_trva)[sd_trva == 0]"
"0","const_te   <- names(sd_te)[sd_te == 0]"
"0","cat(""\n---- Zero-variance columns ----\n"")"
"1","
---- Zero-variance columns ----
"
"0","cat(""Train+Val const ("", length(const_trva), ""): "", paste(utils::head(const_trva, 20), collapse="", ""),"
"0","    if(length(const_trva)>20) "" ..."", ""\n"", sep="""")"
"1","Train+Val const ("
"1",""
"1","2"
"1",""
"1","): "
"1",""
"1","ps, asa"
"1",""
"1","
"
"0","cat(""Test      const ("", length(const_te),   ""): "", paste(utils::head(const_te, 20),   collapse="", ""),"
"0","    if(length(const_te)>20) "" ..."", ""\n"", sep="""")"
"1","Test      const ("
"1",""
"1","0"
"1",""
"1","): "
"1",""
"1",""
"1",""
"1","
"
"0","# 7) 因子候補ごとの“水準ズレ”チェック"
"0","fac_cands <- candidates[sapply(ds02[candidates], function(z) is.factor(z) || is.character(z))]"
"0","fac_cands <- unique(c(fac_cands, intersect(c(""T_cat"",""N_cat"",""M_cat""), candidates)))"
"0","cat(""\n---- Factor level differences (Train+Val vs Test) ----\n"")"
"1","
---- Factor level differences (Train+Val vs Test) ----
"
"0","for(v in fac_cands){"
"0","  if(!v %in% names(ds07_trva) || !v %in% names(ds06_test)) next"
"0","  lev_trva <- levels(factor(ds07_trva[[v]]))"
"0","  lev_te   <- levels(factor(ds06_test[[v]]))"
"0","  add_in_trva <- setdiff(lev_trva, lev_te)"
"0","  add_in_te   <- setdiff(lev_te,   lev_trva)"
"0","  if(length(add_in_trva) || length(add_in_te)){"
"0","    cat(sprintf(""%s: levels_train+val=%s | levels_test=%s\n"","
"0","                v,"
"0","                paste(lev_trva, collapse=""|""),"
"0","                paste(lev_te,   collapse=""|"")))"
"0","    if(length(add_in_trva)) cat(""  only_in_train+val:"", paste(add_in_trva, collapse="",""), ""\n"")"
"0","    if(length(add_in_te))   cat(""  only_in_test     :"", paste(add_in_te,   collapse="",""), ""\n"")"
"0","  }"
"0","}"
"1","T_cat: levels_train+val=1|2|3|4 | levels_test=0|2|3|4
"
"1","  only_in_train+val:"
"1"," "
"1","1"
"1"," "
"1","
"
"1","  only_in_test     :"
"1"," "
"1","0"
"1"," "
"1","
"
"1","hbv: levels_train+val=-|+|± | levels_test=-|+
"
"1","  only_in_train+val:"
"1"," "
"1","±"
"1"," "
"1","
"
"1","sf: levels_train+val=-|+|X | levels_test=-|+
"
"1","  only_in_train+val:"
"1"," "
"1","X"
"1"," "
"1","
"
"1","stage: levels_train+val=2|3|4A|4B | levels_test=0|2|3|4A|4B
"
"1","  only_in_test     :"
"1"," "
"1","0"
"1"," "
"1","
"
"0","# 8) 強制投入コア6変数の存在確認とNA率（0/1や数値列として列があるか）"
"0","core_present_trva <- core_vars %in% cols_trva"
"0","core_present_te   <- core_vars %in% cols_te"
"0","cat(""\n---- Core 6 presence ----\n"")"
"1","
---- Core 6 presence ----
"
"0","print(data.frame(var=core_vars, in_train_val=core_present_trva, in_test=core_present_te, row.names=NULL))"
