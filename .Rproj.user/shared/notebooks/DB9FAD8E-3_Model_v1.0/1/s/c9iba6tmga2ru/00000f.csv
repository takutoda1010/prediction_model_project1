"0","## ==== CHUNK 5: Refit on Train+Val and Evaluate on Test (column-aligned) ===="
"0","stopifnot(exists(""best""), is.finite(best$alpha), is.finite(best$lambda))"
"0","stopifnot(exists(""ds04_train""), exists(""ds05_val""), exists(""ds06_test""))"
"0","stopifnot(exists(""fit_preproc""), exists(""transform_preproc""))  # CHUNK4の関数を使います"
"0","stopifnot(exists(""candidates""))"
"0",""
"0","# 1) Train+Val を結合"
"0","ds07_trva <- dplyr::bind_rows(ds04_train, ds05_val)"
"0",""
"0","# 2) 前処理を Train+Val で“学習”して列集合を固定"
"0","prep2  <- fit_preproc(ds07_trva, candidates)   # → prep2$ref_cols が基準列"
"0","x_trva <- prep2$mm"
"0","y_trva <- survival::Surv(ds07_trva$time, as.integer(ds07_trva$event != 0))"
"0",""
"0","# 3) Test には同じ前処理を“適用”（余分な列は落とし、足りない列は0で補う）"
"0","x_te <- transform_preproc(prep2, ds06_test)"
"0","y_te <- survival::Surv(ds06_test$time, as.integer(ds06_test$event != 0))"
"0","stopifnot(identical(colnames(x_trva), colnames(x_te)))"
"0",""
"0","# 4) ERASL-post の6変数は強制投入（penalty.factor=0）"
"0","pf2 <- rep(1, ncol(x_trva))"
"0","force_exact <- c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count"",""mvi_01"")"
"0","pf2[colnames(x_trva) %in% force_exact] <- 0"
"0",""
"0","# 5) Valで選んだ α, λ で最終学習（Train+Val）"
"0","fit_final <- glmnet(x = x_trva, y = y_trva, family = ""cox"","
"0","                    alpha = best$alpha, lambda = best$lambda,"
"0","                    penalty.factor = pf2, standardize = TRUE)"
"0",""
"0","# 6) Test で性能評価（向きは reverse=TRUE で正）"
"0","lp_test <- as.numeric(x_te %*% as.matrix(coef(fit_final)))"
"0","c_test  <- survival::concordance(y_te ~ lp_test, reverse = TRUE)$concordance"
"0",""
"0","list("
"0","  best_alpha  = best$alpha,"
"0","  best_lambda = best$lambda,"
"0","  cindex_test = c_test,"
"0","  n_trainval  = nrow(ds07_trva),"
"0","  n_test      = nrow(ds06_test)"
"0",")"
"1","$best_alpha
"
"1","[1]"
"1"," 0.25"
"1","
"
"1","
"
"1","$best_lambda
"
"1","[1]"
"1"," 0.6403246"
"1","
"
"1","
"
"1","$cindex_test
"
"1","[1]"
"1"," 0.4813559"
"1","
"
"1","
"
"1","$n_trainval
"
"1","[1]"
"1"," 293"
"1","
"
"1","
"
"1","$n_test
"
"1","[1]"
"1"," 52"
"1","
"
"1","
"
