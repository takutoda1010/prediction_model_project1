"0","## ==== CHUNK H: Cox with RCS (tum_diam_pre) + engineered features ===="
"0","library(splines)"
"0",""
"0","# 1) 必要列を欠損除外（Train/Test）"
"0","need_vars <- c(""sex_male"",""albi23"",""ln_afp"",""tum_diam_pre"",""tum_count_log1p"",""mvi_combo"",""time"",""event"")"
"0","train_rcs <- ds04_train %>% tidyr::drop_na(all_of(need_vars))"
"0","test_rcs  <- ds06_test  %>% tidyr::drop_na(all_of(need_vars))"
"0",""
"0","stopifnot(nrow(train_rcs) > 0, nrow(test_rcs) > 0)"
"0",""
"0","# 2) RCSのノットと境界をTrainで決定（固定）"
"0","#    ノットは分位点（10,50,90%）のユニーク値、境界は範囲。ノット数が足りなければ自動で線形や低次元にフォールバック。"
"0","vals_train <- train_rcs$tum_diam_pre"
"0","bknots <- range(vals_train, na.rm = TRUE)"
"0","iknots <- as.numeric(quantile(vals_train, probs = c(0.10, 0.50, 0.90), na.rm = TRUE))"
"0","iknots <- sort(unique(iknots))"
"0",""
"0","# 3) 同じ基底で Train/Test の基底行列を作成"
"0","make_ns_mat <- function(x, iknots, bknots){"
"0","  if (length(iknots) >= 2) {"
"0","    splines::ns(x, knots = iknots, Boundary.knots = bknots)"
"0","  } else if (length(iknots) == 1) {"
"0","    # 内点が1つしか作れない場合：df=2 相当（1内点＋境界）"
"0","    splines::ns(x, knots = iknots, Boundary.knots = bknots)"
"0","  } else {"
"0","    # 内点を作れない場合：自然スプラインは線形（df=1相当）"
"0","    splines::ns(x, Boundary.knots = bknots, df = 1)"
"0","  }"
"0","}"
"0",""
"0","B_tr <- make_ns_mat(train_rcs$tum_diam_pre, iknots, bknots)"
"0","B_te <- make_ns_mat(test_rcs$tum_diam_pre,  iknots, bknots)"
"0",""
"0","# 列名を付けて結合"
"0","colnames(B_tr) <- paste0(""rcs_diam"", seq_len(ncol(B_tr)))"
"0","colnames(B_te) <- colnames(B_tr)  # 同じ名前に固定"
"0","train_rcs <- dplyr::bind_cols(train_rcs, as.data.frame(B_tr))"
"0","test_rcs  <- dplyr::bind_cols(test_rcs,  as.data.frame(B_te))"
"0",""
"0","# 4) mvi_combo が単一水準になると推定が不安定なので、必要なら除外"
"0","use_mvi <- (is.factor(train_rcs$mvi_combo) && nlevels(train_rcs$mvi_combo) >= 2)"
"0",""
"0","# 5) フォーミュラを動的生成（RCS基底は列として展開）"
"0","rhs_terms <- c(""sex_male"", ""albi23"", ""ln_afp"","
"0","               colnames(B_tr),"
"0","               ""tum_count_log1p"","
"0","               if (use_mvi) ""mvi_combo"" else NULL)"
"0","form_rcs <- as.formula(paste(""Surv(time, event) ~"", paste(rhs_terms, collapse = "" + "")))"
"0",""
"0","# 6) 学習 & テスト評価（C-indexは正向き）"
"0","fit_rcs <- coxph(form_rcs, data = train_rcs, ties = ""efron"")"
"0","lp_rcs  <- predict(fit_rcs, newdata = test_rcs, type = ""lp"")"
"0",""
"0","c_index <- function(time, event, lp){"
"0","  survival::concordance(Surv(time, event) ~ lp, reverse = TRUE)$concordance"
"0","}"
"0","c_rcs <- c_index(test_rcs$time, as.integer(test_rcs$event != 0), lp_rcs)"
"0",""
"0","list("
"0","  rcs_knots          = iknots,"
"0","  rcs_boundary       = bknots,"
"0","  rcs_n_basis        = ncol(B_tr),"
"0","  mvi_combo_in_model = use_mvi,"
"0","  C_test_RCS_model   = c_rcs"
"0",")"
"1","$rcs_knots
"
"1","[1]"
"1","  3.20"
"1","  6.50"
"1"," 14.95"
"1","
"
"1","
"
"1","$rcs_boundary
"
"1","[1]"
"1","  0.3"
"1"," 20.5"
"1","
"
"1","
"
"1","$rcs_n_basis
"
"1","[1]"
"1"," 4"
"1","
"
"1","
"
"1","$mvi_combo_in_model
"
"1","[1]"
"1"," TRUE"
"1","
"
"1","
"
"1","$C_test_RCS_model
"
"1","[1]"
"1"," 0.554321"
"1","
"
"1","
"
