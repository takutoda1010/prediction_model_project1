"0","## ==== CHUNK 2: Temporal split (quantile-based, Date-safe) ===="
"0","stopifnot(exists(""ds02""))"
"0","ds02 <- ds02 %>% filter(!is.na(op_date)) %>% arrange(op_date)"
"0",""
"0","# 目標割合と最小件数"
"0","targets <- list("
"0","  c(0.70, 0.15, 0.15),"
"0","  c(0.65, 0.175, 0.175),"
"0","  c(0.60, 0.20, 0.20),"
"0","  c(0.55, 0.225, 0.225),"
"0","  c(0.50, 0.25, 0.25)"
"0",")"
"0","min_n_each <- 30"
"0",""
"0","split_ok <- FALSE"
"0","od_num <- as.numeric(ds02$op_date)  # days since 1970-01-01"
"0",""
"0","for (p in targets) {"
"0","  p_train <- p[1]; p_val <- p[2]; p_test <- p[3]"
"0",""
"0","  # Date を数値にして分位点 → Date に戻す"
"0","  q1_num <- stats::quantile(od_num, probs = p_train, na.rm = TRUE, type = 7)"
"0","  q2_num <- stats::quantile(od_num, probs = p_train + p_val, na.rm = TRUE, type = 7)"
"0","  q1 <- as.Date(q1_num, origin = ""1970-01-01"")"
"0","  q2 <- as.Date(q2_num, origin = ""1970-01-01"")"
"0",""
"0","  # q1==q2 のときは、次のユニーク日付へずらす"
"0","  if (!is.finite(q1) || !is.finite(q2) || q1 >= q2) {"
"0","    uniq_dates <- sort(unique(ds02$op_date))"
"0","    pos <- which(uniq_dates >= q1)[1]"
"0","    if (!is.na(pos) && pos < length(uniq_dates)) {"
"0","      q2 <- uniq_dates[pos + 1]"
"0","    } else {"
"0","      q1 <- uniq_dates[max(1, length(uniq_dates) - 2)]"
"0","      q2 <- uniq_dates[max(1, length(uniq_dates) - 1)]"
"0","    }"
"0","  }"
"0",""
"0","  ds04_train <- ds02 %>% filter(op_date <= q1)"
"0","  ds05_val   <- ds02 %>% filter(op_date >  q1 & op_date <= q2)"
"0","  ds06_test  <- ds02 %>% filter(op_date >  q2)"
"0",""
"0","  # Cox の要件: time>0"
"0","  ds04_train <- ds04_train %>% filter(is.finite(time), time > 0)"
"0","  ds05_val   <- ds05_val   %>% filter(is.finite(time), time > 0)"
"0","  ds06_test  <- ds06_test  %>% filter(is.finite(time), time > 0)"
"0",""
"0","  if (nrow(ds04_train) >= min_n_each &&"
"0","      nrow(ds05_val)   >= min_n_each &&"
"0","      nrow(ds06_test)  >= min_n_each) {"
"0","    split_ok <- TRUE"
"0","    message(sprintf(""Temporal split: %.0f/%.0f/%.0f%%  q1=%s  q2=%s  (n=%d/%d/%d)"","
"0","                    100*p_train, 100*p_val, 100*p_test,"
"0","                    as.character(q1), as.character(q2),"
"0","                    nrow(ds04_train), nrow(ds05_val), nrow(ds06_test)))"
"0","    break"
"0","  }"
"0","}"
"2","Temporal split: 70/15/15%  q1=2017-07-16  q2=2020-04-23  (n=242/51/52)
"
"0","if (!split_ok) {"
"0","  warning(""最小件数に届きません。最後の割合で続行。min_n_each や targets を調整してください。"")"
"0","}"
"0",""
"0","# サマリ"
"0","summarize_split <- function(d, name) {"
"0","  cat(sprintf(""%s: n=%d, events=%d, first=%s, last=%s\n"","
"0","              name, nrow(d), sum(d$event != 0, na.rm = TRUE),"
"0","              ifelse(nrow(d)>0, as.character(min(d$op_date)), NA),"
"0","              ifelse(nrow(d)>0, as.character(max(d$op_date)), NA)))"
"0","}"
"0","summarize_split(ds04_train, ""ds04_train"")"
"1","ds04_train: n=242, events=172, first=2000-01-27, last=2017-07-13
"
"0","summarize_split(ds05_val,   ""ds05_val"")"
"1","ds05_val: n=51, events=30, first=2017-08-01, last=2020-04-09
"
"0","summarize_split(ds06_test,  ""ds06_test"")"
"1","ds06_test: n=52, events=29, first=2020-09-04, last=2025-01-31
"
