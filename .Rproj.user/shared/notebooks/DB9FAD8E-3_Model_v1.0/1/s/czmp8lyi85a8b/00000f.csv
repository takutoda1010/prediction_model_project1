"0","## ==== CHUNK K-DEBUG: なぜ var_superset が空かを可視化 ===="
"0","# 前提: CHUNK J 実行済み（pool0, c_index など定義済）"
"0","train0 <- ds04_train %>% dplyr::filter(is.finite(time), time > 0, !is.na(event))"
"0","val0   <- ds05_val   %>% dplyr::filter(is.finite(time), time > 0, !is.na(event))"
"0","test0  <- ds06_test  %>% dplyr::filter(is.finite(time), time > 0, !is.na(event))"
"0",""
"0","miss_rate <- sapply(pool0, function(v) mean(is.na(train0[[v]])))"
"0","is_single <- sapply(pool0, function(v){"
"0","  x <- train0[[v]]; if (is.null(x)) TRUE else length(unique(na.omit(x))) < 2"
"0","})"
"0",""
"0","uni_screen <- function(v){"
"0","  dat <- train0 %>% dplyr::select(time, event, !!rlang::sym(v)) %>% tidyr::drop_na()"
"0","  if (nrow(dat) < 30 || sum(dat$event != 0) < 10) return(tibble::tibble(var=v, p=NA_real_, n=nrow(dat)))"
"0","  fit <- try(survival::coxph(Surv(time, event) ~ ., data=dat, ties=""efron""), silent=TRUE)"
"0","  if (inherits(fit, ""try-error"")) return(tibble::tibble(var=v, p=NA_real_, n=nrow(dat)))"
"0","  p <- tryCatch(anova(fit)[""."", ""P(>|Chi|)""], error=function(e) NA_real_)"
"0","  tibble::tibble(var=v, p=as.numeric(p), n=nrow(dat))"
"0","}"
"0",""
"0","uni_tab <- purrr::map_dfr(setdiff(pool0, names(which(is_single))), uni_screen) %>%"
"0","  dplyr::mutate(miss = miss_rate[var]) %>%"
"0","  dplyr::arrange(is.na(p), p, miss)"
"2","Warning: Loglik converged before variable  2 ; coefficient may be infinite. "
"0","evt_train <- sum(train0$event != 0)"
"0","Kmax <- max(3, min(10, floor(evt_train/10)))"
"0","cand_ranked <- uni_tab %>% dplyr::filter(is.na(p) | is.finite(p)) %>% dplyr::pull(var)"
"0","var_superset <- unique(head(cand_ranked, Kmax))"
"0",""
"0","cat(""---- K-DEBUG ----\n"")"
"1","---- K-DEBUG ----
"
"0","cat(sprintf(""Train rows=%d, events=%d, pool0=%d\n"", nrow(train0), evt_train, length(pool0)))"
"1","Train rows=242, events=172, pool0=58
"
"0","cat(sprintf(""is_single (TRUE) = %d\n"", sum(is_single)))"
"1","is_single (TRUE) = 2
"
"0","cat(""Top 10 by univariate p (var / p / miss / n):\n"")"
"1","Top 10 by univariate p (var / p / miss / n):
"
"0","print(head(uni_tab, 10))"
