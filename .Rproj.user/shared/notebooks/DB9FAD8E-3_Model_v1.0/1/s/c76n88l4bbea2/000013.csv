"0","# ==== ERASL-post方式（BRのみ・ds04_train→後退法→ds06_testで評価）===="
"0","suppressPackageStartupMessages({library(dplyr); library(survival); library(timeROC); library(tidyr); library(tibble)})"
"0",""
"0","stopifnot(exists(""ds04_train""), exists(""ds06_test""))"
"0",""
"0","# 学習・評価に不要な列は除外（必要ならここに追加）"
"0","drop_cols <- c(""id"",""op_date"",""time"",""event"",""group_rb"",""group_rb_fill"")"
"0","cand0 <- setdiff(names(ds04_train), drop_cols)"
"0",""
"0","# 使える列だけ（全欠損/定数列を除外）。文字列は因子に。"
"0","is_const <- function(x) { ux <- unique(na.omit(x)); length(ux) < 2 }"
"0","ok <- cand0[sapply(ds04_train[cand0], function(z) any(!is.na(z)) && !is_const(z))]"
"0","train_base <- ds04_train %>% mutate(across(where(is.character), as.factor))"
"0","test_base  <- ds06_test  %>% mutate(across(where(is.character), as.factor))"
"0",""
"0","## --- 単変量 p<0.20 のスクリーニング（FIX: namespace 明示） ---"
"0","keep <- c()"
"0","for(v in ok){"
"0","  # 存在しない列はスキップ"
"0","  if(!v %in% names(train_base)) next"
"0","  "
"0","  fm  <- as.formula(paste0(""Surv(time, event) ~ `"", v, ""`""))"
"0","  dat <- train_base |>"
"0","    dplyr::select(time, event, dplyr::all_of(v)) |>"
"0","    tidyr::drop_na()"
"0","  "
"0","  if(nrow(dat) < 20 || sum(dat$event != 0) < 10) next"
"0","  "
"0","  fit <- try(survival::coxph(fm, data = dat, ties = ""efron""), silent = TRUE)"
"0","  if(inherits(fit, ""try-error"")) next"
"0","  "
"0","  p <- tryCatch(coef(summary(fit))[1, ""Pr(>|z|)""], error = function(e) NA_real_)"
"0","  if(is.finite(p) && p < 0.20) keep <- c(keep, v)"
"0","}"
"2","Warning: Ran out of iterations and did not converge"
"2","Warning: one or more coefficients may be infinite"
"2","Warning: Loglik converged before variable  1 ; coefficient may be infinite. "
"2","Warning: Ran out of iterations and did not converge"
"2","Warning: Loglik converged before variable  1 ; coefficient may be infinite. "
"2","Warning: Loglik converged before variable  1 ; coefficient may be infinite. "
"2","Warning: Loglik converged before variable  2 ; coefficient may be infinite. "
"2","Warning: Loglik converged before variable  5,10,15,17,23,24,25,29,31,33,40,41,45,47,49,50 ; coefficient may be infinite. "
"2","Warning: Ran out of iterations and did not converge"
"2","Warning: Loglik converged before variable  9 ; coefficient may be infinite. "
"2","Warning: Loglik converged before variable  5,7,14,22 ; coefficient may be infinite. "
"2","Warning: Loglik converged before variable  4 ; coefficient may be infinite. "
"2","Warning: Loglik converged before variable  10 ; coefficient may be infinite. "
"2","Warning: Ran out of iterations and did not converge"
"0","if(!length(keep)) stop(""単変量で p<0.20 の候補がありません。"")"
"0",""
"0","## ---- FIX: robust univariate screen (ridge + impute + iter.max) ----"
"0","keep <- c()"
"0","ok   <- setdiff(ok, c(""time"",""event""))  # 念のため"
"0",""
"0","for(v in ok){"
"0","  if(!v %in% names(train_base)) next"
"0","  "
"0","  dat <- train_base |>"
"0","    dplyr::select(time, event, dplyr::all_of(v)) |>"
"0","    dplyr::filter(is.finite(time), time > 0, !is.na(event)) |>"
"0","    impute_simple()     # ★ 先に中央値/最頻でNA補完（drop_naしない）"
"0",""
"0","  # 変数が実質定数/ユニーク<2ならスキップ"
"0","  x <- dat[[v]]"
"0","  if(sum(!is.na(x)) < 20 || length(unique(stats::na.omit(x))) < 2) next"
"0","  if(sum(dat$event != 0, na.rm = TRUE) < 10) next"
"0",""
"0","  fm  <- stats::as.formula(paste0(""Surv(time, event) ~ ridge(`"", v, ""`, theta=1e-6)""))"
"0","  fit <- try("
"0","    survival::coxph(fm, data = dat, ties = ""efron"","
"0","                    control = survival::coxph.control(iter.max = 50)),"
"0","    silent = TRUE"
"0","  )"
"0","  if(inherits(fit, ""try-error"")) next"
"0",""
"0","  p <- tryCatch(coef(summary(fit))[1, ""Pr(>|z|)""], error = function(e) NA_real_)"
"0","  if(is.finite(p) && p < 0.20) keep <- c(keep, v)"
"0","}"
"2","Warning: Inner loop failed to coverge for iterations 1"
"0","keep <- unique(keep)"
"0","if(!length(keep)) stop(""単変量で p<0.20 の候補がありません。"")"
"2","Error: 単変量で p<0.20 の候補がありません。
"
