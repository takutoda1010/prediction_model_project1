"0","# ==== CHUNK0: packages ===="
"0","pkgs <- c(""dplyr"",""survival"",""Hmisc"",""timeROC"",""stringr"",""tibble"",""purrr"")"
"0","to_install <- pkgs[!pkgs %in% installed.packages()[,1]]"
"0","if(length(to_install)) install.packages(to_install, Ncpus = max(1, parallel::detectCores()-1))"
"0","invisible(lapply(pkgs, library, character.only = TRUE))"
"0",""
"0","# ==== CHUNK1: 可変な列名マップ（あなたのデータに合わせて調整） ===="
"0","var_map <- list("
"0","  br_group      = ""group_rb"","
"0","  time_months   = ""rfs_months"","
"0","  status_event  = ""recur_tf"","
"0","  sex           = ""sex"",        # M/F または 0/1"
"0","  alb_gdl       = ""Alb"",        # g/dL"
"0","  tbil_mgdl     = ""Tbil"",       # mg/dL"
"0","  afp_ngml      = ""AFP"",        # ng/mL (= μg/L)"
"0","  size_mm       = ""tum_diam_pre"", # mm想定（mmなら自動でcmに変換）"
"0","  size_cm       = NA,           # 既にcm列があるなら列名を入れる。なければNAのままでOK"
"0","  tum_count     = ""tum_count_pre"","
"0","  albi_grade    = NA,           # 既にgrade列があれば列名、無ければNAでAlb/Tbilから自動計算"
"0","  mvi01         = ""mvi_01""      # 0/1"
"0",")"
"0",""
"0","# ==== CHUNK2: ALBI計算 & 前処理ヘルパ ===="
"0","calc_albi <- function(alb_gdl = NULL, tbil_mgdl = NULL, alb_gL = NULL, tbil_umol = NULL){"
"0","  # 単位整合：Alb g/L, Tbil μmol/L に揃える"
"0","  alb_gL2   <- if(!is.null(alb_gL)) alb_gL else if(!is.null(alb_gdl)) alb_gdl*10 else NA_real_"
"0","  tbil_umol2<- if(!is.null(tbil_umol)) tbil_umol else if(!is.null(tbil_mgdl)) tbil_mgdl*17.104 else NA_real_"
"0","  score <- 0.66*log(tbil_umol2) - 0.085*alb_gL2"
"0","  grade <- cut(score, breaks = c(-Inf,-2.60,-1.39, Inf), labels = c(1L,2L,3L), right = TRUE)"
"0","  list(score = score, grade = as.integer(as.character(grade)))"
"0","}"
"0",""
"0","# 必要列を安全に取り出す"
"0","getv <- function(df, name){"
"0","  if(is.na(name) || !name %in% names(df)) return(rep(NA, nrow(df)))"
"0","  df[[name]]"
"0","}"
"0",""
"0","# ==== CHUNK3: ERASLスコア算出（BRのみ抽出） ===="
"0","compute_erasl_scores <- function(df, vm = var_map, restrict_BR = TRUE){"
"0","  d <- df"
"0",""
"0","  # BRのみ"
"0","  if(restrict_BR && vm$br_group %in% names(d)){"
"0","    d <- d %>% filter(str_detect(.data[[vm$br_group]], ""BR""))"
"0","  }"
"0",""
"0","  # sex（Male=1, Female=0に正規化）"
"0","  sex_raw <- getv(d, vm$sex)"
"0","  sex_male <- case_when("
"0","    is.numeric(sex_raw) ~ as.numeric(sex_raw),"
"0","    is.character(sex_raw) & str_detect(sex_raw, regex(""^m|male|男性"", ignore_case=TRUE)) ~ 1,"
"0","    is.character(sex_raw) & str_detect(sex_raw, regex(""^f|female|女性"", ignore_case=TRUE)) ~ 0,"
"0","    TRUE ~ NA_real_"
"0","  )"
"0",""
"0","  # 腫瘍径cm：cm列があれば優先、無ければmm→cm（閾値で自動判定）"
"0","  size_cm <- if(!is.na(vm$size_cm) && vm$size_cm %in% names(d)) {"
"0","    as.numeric(d[[vm$size_cm]])"
"0","  } else {"
"0","    mm <- as.numeric(getv(d, vm$size_mm))"
"0","    if(all(is.na(mm))) NA_real_ else mm/10"
"0","  }"
"0",""
"0","  # 腫瘍数カテゴリ（0:単発, 1:2-3個, 2:4個以上）"
"0","  tn <- as.numeric(getv(d, vm$tum_count))"
"0","  tum_cat <- case_when("
"0","    !is.na(tn) & tn <= 1 ~ 0L,"
"0","    !is.na(tn) & tn %in% 2:3 ~ 1L,"
"0","    !is.na(tn) & tn >= 4 ~ 2L,"
"0","    TRUE ~ NA_integer_"
"0","  )"
"0",""
"0","  # AFP（ln用; 0はlog不可なので1に底上げ）"
"0","  afp <- as.numeric(getv(d, vm$afp_ngml))"
"0","  ln_afp <- log(pmax(afp, 1))"
"0",""
"0","  # ln(腫瘍径cm)（0や負値は欠損扱い）"
"0","  ln_size <- ifelse(is.finite(size_cm) & size_cm > 0, log(size_cm), NA_real_)"
"0",""
"0","  # ALBI grade：列が無ければ算出"
"0","  if(!is.na(vm$albi_grade) && vm$albi_grade %in% names(d)){"
"0","    albi_grade <- as.integer(d[[vm$albi_grade]])"
"0","  } else {"
"0","    albi <- calc_albi(alb_gdl = as.numeric(getv(d, vm$alb_gdl)),"
"0","                      tbil_mgdl = as.numeric(getv(d, vm$tbil_mgdl)))"
"0","    albi_grade <- albi$grade"
"0","  }"
"0","  albi_bin <- ifelse(is.na(albi_grade), NA_integer_, ifelse(albi_grade >= 2, 1L, 0L))"
"0",""
"0","  # MVI（0/1）"
"0","  mvi01 <- as.integer(getv(d, vm$mvi01))"
"0",""
"0","  # --- ERASL式（論文Table 2） ---"
"0","  # ERASL-pre = 0.818*Male + 0.447*ALBI(2/3) + 0.100*lnAFP + 0.580*lnSize(cm) + 0.492*TumorNum(0/1/2)"
"0","  erasl_pre  <- 0.818*sex_male + 0.447*albi_bin + 0.100*ln_afp + 0.580*ln_size + 0.492*tum_cat"
"0","  # ERASL-post = 0.677*Male + 0.458*ALBI(2/3) + 0.661*MVI + 0.082*lnAFP + 0.451*lnSize + 0.379*TumorNum"
"0","  erasl_post <- 0.677*sex_male + 0.458*albi_bin + 0.661*mvi01 + 0.082*ln_afp + 0.451*ln_size + 0.379*tum_cat"
"0",""
"0","  d %>%"
"0","    mutate("
"0","      ERASL_pre  = erasl_pre,"
"0","      ERASL_post = erasl_post"
"0","    )"
"0","}"
"0",""
"0","# ==== CHUNK4: 指標計算（Harrell’s c + 2年tdAUC） ===="
"0","calc_metrics <- function(d, score_col, time_col, status_col, t_month = 24, boot = 200, seed = 42){"
"0","  dd <- d %>%"
"0","    filter(is.finite(.data[[score_col]]),"
"0","           is.finite(.data[[time_col]]),"
"0","           !is.na(.data[[status_col]]))"
"0",""
"0","  if(nrow(dd) < 10) stop(""有効な症例が少なすぎます（<10）。"")"
"0",""
"0","  # Harrell's c（ブートでSE）"
"0","  set.seed(seed)"
"0","  c0 <- Hmisc::rcorr.cens(dd[[score_col]], Surv(dd[[time_col]], dd[[status_col]]))"
"0","  c_est <- unname(c0[""C Index""])"
"0","  if(boot > 0){"
"0","    idxs <- replicate(boot, sample.int(nrow(dd), replace = TRUE), simplify = FALSE)"
"0","    c_vals <- vapply(idxs, function(i){"
"0","      d2 <- dd[i,]"
"0","      unname(Hmisc::rcorr.cens(d2[[score_col]], Surv(d2[[time_col]], d2[[status_col]]))[""C Index""])"
"0","    }, numeric(1))"
"0","    c_se <- stats::sd(c_vals, na.rm = TRUE)"
"0","  } else {"
"0","    c_se <- NA_real_"
"0","  }"
"0",""
"0","  # timeROC（iid=TRUEでSEを計算）※ 累積/ダイナミックROC"
"0","  tr <- timeROC::timeROC(T = dd[[time_col]],"
"0","                         delta = dd[[status_col]],"
"0","                         marker = dd[[score_col]],"
"0","                         cause = 1, times = c(t_month), iid = TRUE)"
"0","  auc_est <- as.numeric(tr$AUC[1])"
"0","  auc_se  <- as.numeric(tr$inference$vect_sd_1[1])"
"0",""
"0","  tibble::tibble("
"0","    model      = score_col,"
"0","    n          = nrow(dd),"
"0","    events     = sum(dd[[status_col]] == 1, na.rm = TRUE),"
"0","    c_index    = c_est,"
"0","    c_se       = c_se,"
"0","    tdAUC_t_mo = t_month,"
"0","    tdAUC      = auc_est,"
"0","    tdAUC_se   = auc_se"
"0","  )"
"0","}"
"0",""
"0","# ==== CHUNK5: 実行例（df をあなたのデータフレーム名に置き換え） ===="
"0","# df <- your_dataframe"
"0","# BRのみでスコア付与"
"0","# df_scored <- compute_erasl_scores(df, var_map, restrict_BR = TRUE)"
"0",""
"0","# 評価（Harrell's c と 2年tdAUC）"
"0","# res <- bind_rows("
"0","#   calc_metrics(df_scored, ""ERASL_pre"",  var_map$time_months, var_map$status_event, t_month = 24, boot = 200),"
"0","#   calc_metrics(df_scored, ""ERASL_post"", var_map$time_months, var_map$status_event, t_month = 24, boot = 200)"
"0","# )"
"0","# print(res)"
"0",""
