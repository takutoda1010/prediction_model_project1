"0","## ==== CHUNK 4: LASSO with core forced-in (Train tune on Val; column-align) ===="
"0",""
"0","# 候補（t/n/mは使わず、T_cat/N_cat/M_catは使う）"
"0","core_vars  <- c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count"",""mvi_01"")  # 常に入れる"
"0","extra_vars <- c("
"0","  ""T_cat"",""N_cat"",""M_cat"","
"0","  ""tum_diam_pre"",""tum_count_pre"",""vp_pre"",""vv_pre"",""n_pre"",""m_pre"",""age"",""sex"","
"0","  ""hbv"",""hcv"",""plt"",""alb"",""tbil"",""che"",""ast"",""alt"",""nh3"",""pt_inr"",""icg10_cat"",""icg_r15"","
"0","  ""hh15"",""lhl15"",""liver_damage"",""child_pugh"",""afp"",""afp_l3"",""pivka2"",""cea"",""ca19_9"","
"0","  ""height_cm"",""weight_kg"",""ps"",""asa"",""op_time_min"",""bleed_ml"",""max_diam_cm"",""grouth_type"","
"0","  ""vp_path"",""vv_path"",""va_path"",""b_path"",""fc"",""fc_inf"",""sf"",""lm"",""sm"",""sm_mm"","
"0","  ""stage"",""fibrosis_score"",""grading_score"""
"0",")"
"0","candidates <- unique(c(core_vars, extra_vars))"
"0","candidates <- intersect(candidates, names(ds02))"
"0",""
"0","# ---- 前処理“学習（Train基準）” & 変換関数 ----"
"0","Mode <- function(x){ ux <- unique(x[!is.na(x)]); if(length(ux)==0) return(NA); ux[which.max(tabulate(match(x, ux)))] }"
"0",""
"0","fit_preproc <- function(df, vars){"
"0","  X <- df %>% dplyr::select(all_of(vars)) %>% mutate(across(where(is.character), as.factor))"
"0","  # 明示的に因子化（存在すれば）"
"0","  for(cn in c(""T_cat"",""N_cat"",""M_cat"")) if(cn %in% names(X)) X[[cn]] <- factor(X[[cn]])"
"0","  # 補完パラメータ（Trainで学習）"
"0","  num_cols <- names(X)[sapply(X, is.numeric)]"
"0","  fac_cols <- names(X)[sapply(X, is.factor)]"
"0","  num_median <- setNames(lapply(X[num_cols], function(x) median(x, na.rm=TRUE)), num_cols)"
"0","  fac_mode   <- setNames(lapply(X[fac_cols], Mode), fac_cols)"
"0","  fac_levels <- setNames(lapply(X[fac_cols], levels), fac_cols)"
"0","  # 補完＆行列化"
"0","  if(length(num_cols)) X[num_cols] <- Map(function(x,m){ x[is.na(x)] <- m; x }, X[num_cols], num_median)"
"0","  if(length(fac_cols)) X[fac_cols] <- Map(function(x,m){ x[is.na(x)] <- m; droplevels(x) }, X[fac_cols], fac_mode)"
"0","  mm <- model.matrix(~ 0 + ., data = X)"
"0","  # Trainで定数列は削除（Val/Testも同じ列集合に強制）"
"0","  keep <- if(ncol(mm)) which(apply(mm, 2, sd) > 0) else integer(0)"
"0","  mm_keep <- if(length(keep)) mm[, keep, drop=FALSE] else matrix(0, nrow=nrow(X), ncol=0)"
"0","  list("
"0","    vars=vars, num_median=num_median, fac_mode=fac_mode, fac_levels=fac_levels,"
"0","    ref_cols=colnames(mm_keep), mm=mm_keep"
"0","  )"
"0","}"
"0",""
"0","transform_preproc <- function(prep, df){"
"0","  X <- df %>% dplyr::select(all_of(prep$vars)) %>% mutate(across(where(is.character), as.factor))"
"0","  # 因子水準を Train に合わせる"
"0","  for(cn in names(prep$fac_levels)){"
"0","    if(cn %in% names(X)) X[[cn]] <- factor(X[[cn]], levels=prep$fac_levels[[cn]])"
"0","  }"
"0","  # Trainのパラメータで補完"
"0","  for(cn in names(prep$num_median)){"
"0","    if(cn %in% names(X)){ x <- X[[cn]]; x[is.na(x)] <- prep$num_median[[cn]]; X[[cn]] <- x }"
"0","  }"
"0","  for(cn in names(prep$fac_mode)){"
"0","    if(cn %in% names(X)){ x <- X[[cn]]; x[is.na(x)] <- prep$fac_mode[[cn]]; X[[cn]] <- droplevels(x) }"
"0","  }"
"0","  mm <- model.matrix(~ 0 + ., data = X)"
"0","  # 列を Train に合わせて整列（足りない列は0、余計な列は落とす）"
"0","  cur  <- colnames(mm)"
"0","  extra <- setdiff(cur, prep$ref_cols)"
"0","  if(length(extra)) mm <- mm[, setdiff(cur, extra), drop=FALSE]"
"0","  miss <- setdiff(prep$ref_cols, colnames(mm))"
"0","  if(length(miss)) mm <- cbind(mm, matrix(0, nrow=nrow(mm), ncol=length(miss), dimnames=list(NULL, miss)))"
"0","  mm <- mm[, prep$ref_cols, drop=FALSE]"
"0","  mm"
"0","}"
"0",""
"0","# ---- Train / Val デザイン行列（Train基準で整列）----"
"0","prep <- fit_preproc(ds04_train, candidates)"
"0","x_tr <- prep$mm"
"0","y_tr <- Surv(ds04_train$time, as.integer(ds04_train$event != 0))"
"0",""
"0","x_va <- transform_preproc(prep, ds05_val)"
"0","y_va <- Surv(ds05_val$time, as.integer(ds05_val$event != 0))"
"0",""
"0","# ---- penalty.factor：ERASL-post 6変数は強制（=0）、他は1 ----"
"0","pf <- rep(1, ncol(x_tr))"
"0","force_exact <- c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count"",""mvi_01"")"
"0","is_forced <- colnames(x_tr) %in% force_exact  # 数値列はそのまま列名になる"
"0","pf[is_forced] <- 0"
"0",""
"0","# ---- α/λ チューニング（ValのC-index最大で選択）----"
"0","alpha_grid <- c(0.25, 0.5, 0.75, 1.0)"
"0","best <- list(cidx=-Inf, alpha=NA, lambda=NA, beta=NULL)"
"0",""
"0","for(a in alpha_grid){"
"0","  fit_path <- glmnet(x = x_tr, y = y_tr, family = ""cox"","
"0","                     alpha = a, nlambda = 600,"
"0","                     penalty.factor = pf, standardize = TRUE)"
"0","  if(is.null(fit_path$lambda)) next"
"0","  B <- as.matrix(coef(fit_path))"
"0","  for(j in seq_along(fit_path$lambda)){"
"0","    beta <- B[, j, drop=FALSE]"
"0","    lp_va <- as.numeric(x_va %*% beta)"
"0","    c_va  <- survival::concordance(y_va ~ lp_va, reverse = TRUE)$concordance"
"0","    if(is.finite(c_va) && c_va > best$cidx){"
"0","      best <- list(cidx=c_va, alpha=a, lambda=fit_path$lambda[j], beta=beta)"
"0","    }"
"0","  }"
"0","}"
"0",""
"0","best  # <- α, λ, Val C-index を確認"
"1","$cidx
"
"1","[1]"
"1"," 0.6263617"
"1","
"
"1","
"
"1","$alpha
"
"1","[1]"
"1"," 0.25"
"1","
"
"1","
"
"1","$lambda
"
"1","[1]"
"1"," 0.6403246"
"1","
"
"1","
"
"1","$beta
"
"1","                    "
"1","          s0"
"1","
sex_male            "
"1"," 0.213641611"
"1","
albi23              "
"1"," 0.170756086"
"1","
ln_afp              "
"1"," 0.004741471"
"1","
ln_diam             "
"1"," 0.115088099"
"1","
tum_count           "
"1"," 0.039368644"
"1","
mvi_01              "
"1"," 0.074526861"
"1","
T_cat1              "
"1"," 0.000000000"
"1","
T_cat2              "
"1"," 0.000000000"
"1","
T_cat3              "
"1"," 0.000000000"
"1","
T_cat4              "
"1"," 0.000000000"
"1","
N_cat1              "
"1"," 0.000000000"
"1","
M_cat1              "
"1"," 0.000000000"
"1","
tum_diam_pre        "
"1"," 0.000000000"
"1","
tum_count_pre       "
"1"," 0.000000000"
"1","
vp_pre              "
"1"," 0.000000000"
"1","
vv_pre              "
"1"," 0.000000000"
"1","
n_pre               "
"1"," 0.000000000"
"1","
m_pre               "
"1"," 0.000000000"
"1","
age                 "
"1"," 0.000000000"
"1","
sexM                "
"1"," 0.000000000"
"1","
hbv+                "
"1"," 0.000000000"
"1","
hbv±                "
"1"," 0.000000000"
"1","
hcv+                "
"1"," 0.000000000"
"1","
plt                 "
"1"," 0.000000000"
"1","
alb                 "
"1"," 0.000000000"
"1","
tbil                "
"1"," 0.000000000"
"1","
che                 "
"1"," 0.000000000"
"1","
ast                 "
"1"," 0.000000000"
"1","
alt                 "
"1"," 0.000000000"
"1","
nh3                 "
"1"," 0.000000000"
"1","
pt_inr              "
"1"," 0.000000000"
"1","
icg10_catICG 10%未満"
"1"," 0.000000000"
"1","
icg_r15             "
"1"," 0.000000000"
"1","
hh15                "
"1"," 0.000000000"
"1","
lhl15               "
"1"," 0.000000000"
"1","
liver_damageB       "
"1"," 0.000000000"
"1","
child_pughB         "
"1"," 0.000000000"
"1","
afp                 "
"1"," 0.000000000"
"1","
afp_l3              "
"1"," 0.000000000"
"1","
pivka2              "
"1"," 0.000000000"
"1","
cea                 "
"1"," 0.000000000"
"1","
ca19_9              "
"1"," 0.000000000"
"1","
height_cm           "
"1"," 0.000000000"
"1","
weight_kg           "
"1"," 0.000000000"
"1","
op_time_min         "
"1"," 0.000000000"
"1","
bleed_ml            "
"1"," 0.000000000"
"1","
max_diam_cm         "
"1"," 0.000000000"
"1","
vp_path             "
"1"," 0.000000000"
"1","
vv_path             "
"1"," 0.000000000"
"1","
va_path             "
"1"," 0.000000000"
"1","
b_path              "
"1"," 0.000000000"
"1","
fc+                 "
"1"," 0.000000000"
"1","
fc_inf+             "
"1"," 0.000000000"
"1","
sf+                 "
"1"," 0.000000000"
"1","
sfX                 "
"1"," 0.000000000"
"1","
sm+                 "
"1"," 0.000000000"
"1","
smX                 "
"1"," 0.000000000"
"1","
sm_mm               "
"1"," 0.000000000"
"1","
stage3              "
"1"," 0.000000000"
"1","
stage4A             "
"1"," 0.000000000"
"1","
stage4B             "
"1"," 0.000000000"
"1","
fibrosis_score      "
"1"," 0.000000000"
"1","
grading_score       "
"1"," 0.000000000"
"1","
"
"1","
"
