"0","## ==== CHUNK G: Time-block CV for alpha/lambda (Train only) ===="
"0","stopifnot(exists(""candidates""))"
"0","source_vars <- intersect(candidates, names(ds04_train))"
"0",""
"0","# 前処理（Train基準）学習"
"0","prep_tr <- fit_preproc(ds04_train, source_vars)"
"0","X_tr <- prep_tr$mm"
"0","y_tr <- Surv(ds04_train$time, as.integer(ds04_train$event != 0))"
"0",""
"0","# 時系列ブロック（op_date を5分位で）"
"0","K <- 5"
"0","od <- as.numeric(as.Date(ds04_train$op_date))"
"0","cuts <- quantile(od, probs = seq(0,1,length.out=K+1), na.rm = TRUE)"
"0","foldid <- cut(od, breaks = cuts, include.lowest = TRUE, labels = FALSE)"
"0",""
"0","# 罰則：ERASLコアは 0.3（完全0だと汎化悪化しやすいので“軽ペナルティ”）"
"0","pf_tr <- rep(1, ncol(X_tr))"
"0","core_exact <- c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count"",""mvi_01"")"
"0","pf_tr[colnames(X_tr) %in% core_exact] <- 0.3"
"0",""
"0","alpha_grid <- c(0.25, 0.5, 0.75, 1.0)"
"0","set.seed(123)"
"0","grid_res <- list()"
"0",""
"0","for(a in alpha_grid){"
"0","  cvfit <- glmnet::cv.glmnet(X_tr, y_tr, family = ""cox"","
"0","                             alpha = a, foldid = foldid,"
"0","                             penalty.factor = pf_tr, nlambda = 400,"
"0","                             standardize = TRUE)"
"0","  # cv.glmnet の規準は偏尤度だが、ここでは λmin を採用"
"0","  grid_res[[as.character(a)]] <- list(alpha=a, lambda=cvfit$lambda.min,"
"0","                                      lambda_1se=cvfit$lambda.1se,"
"0","                                      cvfit=cvfit)"
"0","}"
"0",""
"0","# 代表選択：lambda.1se を優先（簡潔で疎）"
"0","best_alpha <- NA; best_lambda <- NA"
"0","# ここでは a=0.5 をデフォルトにし、lambda.1se を使う例（必要なら AIC/BIC や外部Valで上書き）"
"0","if(""0.5"" %in% names(grid_res)){"
"0","  best_alpha  <- grid_res[[""0.5""]]$alpha"
"0","  best_lambda <- grid_res[[""0.5""]]$lambda_1se"
"0","} else {"
"0","  key <- names(grid_res)[1]"
"0","  best_alpha  <- grid_res[[key]]$alpha"
"0","  best_lambda <- grid_res[[key]]$lambda_1se"
"0","}"
"0",""
"0","best <- list(alpha = best_alpha, lambda = best_lambda)  # 以降 CHUNK5 相当で再学習→Test"
"0","best"
"1","$alpha
"
"1","[1]"
"1"," 0.5"
"1","
"
"1","
"
"1","$lambda
"
"1","[1]"
"1"," 0.6509858"
"1","
"
"1","
"
