"0","## ==== CHUNK M (FIX): Stability selection (no forced vars) ===="
"0","cand_ss <- pool_clean"
"0","tr_ss <- ds04_train %>% cc_time_only()"
"0","va_ss <- ds05_val   %>% cc_time_only()"
"0","te_ss <- ds06_test  %>% cc_time_only()"
"0",""
"0","prep_ss <- fit_preproc2(tr_ss, cand_ss)"
"0","X_tr <- transform_preproc2(prep_ss, tr_ss)"
"0","y_tr <- Surv(tr_ss$time, as.integer(tr_ss$event!=0))"
"0",""
"0","set.seed(123)"
"0","B <- 100L; prop <- 0.8"
"0","freq <- setNames(numeric(ncol(X_tr)), colnames(X_tr))"
"0",""
"0","for(b in 1:B){"
"0","  idx <- sample(seq_len(nrow(X_tr)), floor(prop*nrow(X_tr)), replace=TRUE)"
"0","  cv  <- glmnet::cv.glmnet(X_tr[idx, , drop=FALSE], y_tr[idx],"
"0","                           family=""cox"", alpha=0.7, nfolds=5, standardize=TRUE)"
"0","  fit <- glmnet::glmnet(X_tr[idx, , drop=FALSE], y_tr[idx],"
"0","                        family=""cox"", lambda=cv$lambda.1se, alpha=0.7, standardize=TRUE)"
"0","  nz  <- which(as.numeric(coef(fit)) != 0)"
"0","  if(length(nz)) freq[nz] <- freq[nz] + 1"
"0","}"
"0",""
"0","sel_terms <- names(freq)[freq/B >= 0.6]"
"0","to_parent <- function(nm) sub(""(.*?)[^:]*$"", ""\\1"", gsub(""[:].*$"","""", nm))"
"0","parents <- unique(to_parent(sel_terms))"
"0",""
"0","fit_ss <- if(length(parents)) coxph(as.formula(paste(""Surv(time, event) ~"", paste(parents, collapse="" + ""))),"
"0","                                    data = tr_ss, ties=""efron"", na.action=na.omit) else NULL"
"0","res_ss <- if(!is.null(fit_ss)){"
"0","  list("
"0","    C_train = {lp <- predict(fit_ss, newdata=tr_ss, type=""lp""); c_index(tr_ss$time, as.integer(tr_ss$event!=0), lp)},"
"0","    C_val   = {lp <- predict(fit_ss, newdata=va_ss, type=""lp""); c_index(va_ss$time, as.integer(va_ss$event!=0), lp)},"
"0","    C_test  = {lp <- predict(fit_ss, newdata=te_ss, type=""lp""); c_index(te_ss$time, as.integer(te_ss$event!=0), lp)}"
"0","  )"
"0","} else NULL"
"0",""
"0","list(stability_freq = sort(freq/B, decreasing=TRUE),"
"0","     selected_parents = parents, C_stability = res_ss)"
"1","$stability_freq
"
"1","              b_path "
"1","                hbv± "
"1","         op_time_min "
"1","             stage4A "
"1","                 alb "
"1","
"
"1","                0.19 "
"1","                0.05 "
"1","                0.03 "
"1","                0.03 "
"1","                0.02 "
"1","
"
"1","              ca19_9 "
"1","           height_cm "
"1","             ln_diam "
"1","                hh15 "
"1","       liver_damageB "
"1","
"
"1","                0.02 "
"1","                0.02 "
"1","                0.02 "
"1","                0.01 "
"1","                0.01 "
"1","
"
"1","              pivka2 "
"1","        tum_diam_pre "
"1","       tum_count_pre "
"1","              vv_pre "
"1","         max_diam_cm "
"1","
"
"1","                0.01 "
"1","                0.01 "
"1","                0.01 "
"1","                0.01 "
"1","                0.01 "
"1","
"
"1","             vv_path "
"1","               sm_mm "
"1","       grading_score "
"1","              albi23 "
"1","           tum_count "
"1","
"
"1","                0.01 "
"1","                0.01 "
"1","                0.01 "
"1","                0.01 "
"1","                0.01 "
"1","
"
"1","     tum_count_log1p "
"1","              M_cat1 "
"1","             stage4B "
"1","            sex_male "
"1","                 age "
"1","
"
"1","                0.01 "
"1","                0.01 "
"1","                0.01 "
"1","                0.00 "
"1","                0.00 "
"1","
"
"1","                hbv- "
"1","                hbv+ "
"1","                hcv+ "
"1","                 plt "
"1","                tbil "
"1","
"
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","
"
"1","                 che "
"1","                 ast "
"1","                 alt "
"1","                 nh3 "
"1","              pt_inr "
"1","
"
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","
"
"1","icg10_catICG 10%未満 "
"1","             icg_r15 "
"1","               lhl15 "
"1","         child_pughB "
"1","                 afp "
"1","
"
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","
"
"1","              afp_l3 "
"1","                 cea "
"1","           weight_kg "
"1","              vp_pre "
"1","               n_pre "
"1","
"
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","
"
"1","               m_pre "
"1","             vp_path "
"1","                 fc+ "
"1","             fc_inf+ "
"1","                 sf+ "
"1","
"
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","
"
"1","                 sfX "
"1","                 sm+ "
"1","                 smX "
"1","      fibrosis_score "
"1","              ln_afp "
"1","
"
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","
"
"1","              mvi_01 "
"1","         mvi_combo.L "
"1","         mvi_combo.Q "
"1","         mvi_combo.C "
"1","              T_cat2 "
"1","
"
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","
"
"1","              T_cat3 "
"1","              T_cat4 "
"1","              N_cat1 "
"1","            bleed_ml "
"1","              stage3 "
"1","
"
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","                0.00 "
"1","
"
"1","
"
"1","$selected_parents
"
"1","character(0)
"
"1","
"
"1","$C_stability
"
"1","NULL
"
"1","
"
