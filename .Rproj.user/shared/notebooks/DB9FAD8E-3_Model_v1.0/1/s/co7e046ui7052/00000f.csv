"0","# ==== Minimal: ERASL-pre/post → Harrell's c ＆ 2y tdAUC ===="
"0","suppressPackageStartupMessages({"
"0","  library(dplyr); library(survival); library(timeROC); library(tibble)"
"0","})"
"0",""
"0","stopifnot(exists(""ds02""))"
"0",""
"0","# BRだけに絞る（列名が group_rb じゃない場合は適宜変更）"
"0","br <- ds02 %>% filter(grepl(""BR"", as.character(group_rb)))"
"0",""
"0","# 腫瘍数カテゴリ（0:1個, 1:2-3個, 2:4個以上）"
"0","br <- br %>%"
"0","  mutate(tum_cat = case_when("
"0","    tum_count <= 1 ~ 0L,"
"0","    tum_count %in% 2:3 ~ 1L,"
"0","    tum_count >= 4 ~ 2L,"
"0","    TRUE ~ NA_integer_"
"0","  ))"
"0",""
"0","# ERASLスコア（論文の係数に合わせた線形予測子）"
"0","br <- br %>% mutate("
"0","  ERASL_pre  = 0.818*sex_male + 0.447*albi23 + 0.100*ln_afp + 0.580*ln_diam + 0.492*tum_cat,"
"0","  ERASL_post = 0.677*sex_male + 0.458*albi23 + 0.661*mvi_01 + 0.082*ln_afp + 0.451*ln_diam + 0.379*tum_cat"
"0",")"
"0",""
"0","# 共通テスト集合（完全ケース）"
"0","need_cols <- c(""time"",""event"",""ERASL_pre"",""ERASL_post"")"
"0","dd <- br %>% tidyr::drop_na(all_of(need_cols))"
"0","stopifnot(nrow(dd) >= 10)   # 少なすぎると推定が不安定"
"0",""
"0","# Harrell's c（向きは reverse=TRUE）"
"0","cidx <- function(score) survival::concordance(Surv(dd$time, dd$event) ~ score, reverse = TRUE)$concordance"
"0",""
"0","# 2年の time-dependent AUC（累積/ダイナミック）"
"0","td_auc_24 <- function(score) {"
"0","  tr <- timeROC(T = dd$time, delta = dd$event, marker = score, cause = 1, times = 24, iid = TRUE)"
"0","  unname(tr$AUC[1])"
"0","}"
"0",""
"0","res <- tibble("
"0","  model = c(""ERASL_pre"",""ERASL_post""),"
"0","  n     = nrow(dd),"
"0","  events= sum(dd$event==1, na.rm = TRUE),"
"0","  c_index = c(cidx(dd$ERASL_pre), cidx(dd$ERASL_post)),"
"0","  tdAUC_24m = c(td_auc_24(dd$ERASL_pre), td_auc_24(dd$ERASL_post))"
"0",")"
"0",""
"0","print(res)"
