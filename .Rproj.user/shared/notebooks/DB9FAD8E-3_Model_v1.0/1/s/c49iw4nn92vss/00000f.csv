"0","## ==== CHUNK L (USES var_superset from K-REPLACE) ===="
"0","stopifnot(exists(""var_superset""))"
"0","train_sw <- train0 %>% dplyr::select(time, event, dplyr::all_of(var_superset)) %>% tidyr::drop_na()"
"0","val_sw   <- val0   %>% dplyr::select(time, event, dplyr::all_of(var_superset)) %>% tidyr::drop_na()"
"0","test_sw  <- test0  %>% dplyr::select(time, event, dplyr::all_of(var_superset)) %>% tidyr::drop_na()"
"0",""
"0","cur <- character(0); best_valC <- -Inf"
"0","improve_min <- 0.01; max_terms <- min(10, length(var_superset))"
"0",""
"0","valC_of <- function(vars){"
"0","  if(!length(vars)) return(NA_real_)"
"0","  fm  <- as.formula(paste(""Surv(time, event) ~"", paste(vars, collapse="" + "")))"
"0","  fit <- try(suppressWarnings(survival::coxph(fm, data=train_sw, ties=""efron"", na.action=na.omit)), silent=TRUE)"
"0","  if(inherits(fit,""try-error"") || !is.finite(utils::tail(fit$loglik,1))) return(NA_real_)"
"0","  lp  <- try(predict(fit, newdata=val_sw, type=""lp""), silent=TRUE)"
"0","  if(inherits(lp,""try-error"") || all(is.na(lp))) return(NA_real_)"
"0","  survival::concordance(Surv(val_sw$time, as.integer(val_sw$event!=0)) ~ lp, reverse=TRUE)$concordance"
"0","}"
"0",""
"0","repeat{"
"0","  cand <- setdiff(var_superset, cur)"
"0","  if(!length(cand) || length(cur) >= max_terms) break"
"0","  tbl <- purrr::map_dfr(cand, ~tibble::tibble(var=.x, valC=valC_of(c(cur, .x))))"
"0","  tbl <- tbl %>% dplyr::arrange(dplyr::desc(valC))"
"0","  if(!nrow(tbl) || is.na(tbl$valC[1])) break"
"0","  if(tbl$valC[1] > best_valC + improve_min){"
"0","    cur <- c(cur, as.character(tbl$var[1])); best_valC <- tbl$valC[1]"
"0","  } else break"
"0","}"
"0",""
"0","fit_fwd <- if(length(cur)) survival::coxph("
"0","  as.formula(paste(""Surv(time, event) ~"", paste(cur, collapse="" + ""))),"
"0","  data=train_sw, ties=""efron"", na.action=na.omit"
"0",") else NULL"
"0",""
"0","c_idx <- function(fit, dat){"
"0","  if(is.null(fit) || !nrow(dat)) return(NA_real_)"
"0","  lp <- predict(fit, newdata=dat, type=""lp"")"
"0","  survival::concordance(Surv(dat$time, as.integer(dat$event!=0)) ~ lp, reverse=TRUE)$concordance"
"0","}"
"0",""
"0","list("
"0","  forward_selected = cur,"
"0","  C_forward = list("
"0","    C_train = c_idx(fit_fwd, train_sw),"
"0","    C_val   = c_idx(fit_fwd, val_sw),"
"0","    C_test  = c_idx(fit_fwd, test_sw)"
"0","  )"
"0",")"
"1","$forward_selected
"
"1","[1]"
"1"," ""alb"""
"1"," ""age"""
"1","
"
"1","
"
"1","$C_forward
"
"1","$C_forward$C_train
"
"1","[1]"
"1"," 0.5734452"
"1","
"
"1","
"
"1","$C_forward$C_val
"
"1","[1]"
"1"," 0.6502268"
"1","
"
"1","
"
"1","$C_forward$C_test
"
"1","[1]"
"1"," 0.4840183"
"1","
"
"1","
"
"1","
"
