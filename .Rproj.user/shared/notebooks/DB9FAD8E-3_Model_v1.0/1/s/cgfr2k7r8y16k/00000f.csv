"0","## ==== CHUNK K-REPLACE: 固定完全ケース & フォールバック付き stepAIC ===="
"0","fallback_superset <- function(){"
"0","  # 欠損が少なくて単一水準でないものから上位を拾う"
"0","  thr <- c(0.2, 0.4, 0.6, 1.0)"
"0","  for (t in thr){"
"0","    cand <- names(which((miss_rate <= t) & (!is_single)))"
"0","    cand <- intersect(cand, names(train0))"
"0","    if (length(cand) >= 3) return(head(cand, 8)) # 上限は8に制限"
"0","  }"
"0","  # 最後の最後の保険：とにかく存在する数値カラムから少数"
"0","  num_ok <- names(train0)[sapply(train0, is.numeric)]"
"0","  setdiff(num_ok, c(""time"",""event""))[1:3]"
"0","}"
"0",""
"0","if (length(var_superset) == 0) {"
"0","  message(""var_superset が空のため、欠損率ベースのフォールバックを適用します。"")"
"0","  var_superset <- fallback_superset()"
"0","}"
"2","var_superset が空のため、欠損率ベースのフォールバックを適用します。
"
"0","# 固定完全ケース（同じ列で NA drop）"
"0","train_sw <- train0 %>% dplyr::select(time, event, dplyr::all_of(var_superset)) %>% tidyr::drop_na()"
"0","val_sw   <- val0   %>% dplyr::select(time, event, dplyr::all_of(var_superset)) %>% tidyr::drop_na()"
"0","test_sw  <- test0  %>% dplyr::select(time, event, dplyr::all_of(var_superset)) %>% tidyr::drop_na()"
"0",""
"0","# 行・イベントが少なすぎる場合は superset を縮める"
"0","while ((nrow(train_sw) < 30 || sum(train_sw$event!=0) < 10) && length(var_superset) > 3){"
"0","  var_superset <- head(var_superset, -1)"
"0","  train_sw <- train0 %>% dplyr::select(time, event, dplyr::all_of(var_superset)) %>% tidyr::drop_na()"
"0","  val_sw   <- val0   %>% dplyr::select(time, event, dplyr::all_of(var_superset)) %>% tidyr::drop_na()"
"0","  test_sw  <- test0  %>% dplyr::select(time, event, dplyr::all_of(var_superset)) %>% tidyr::drop_na()"
"0","}"
"0",""
"0","if (length(var_superset) == 0 || nrow(train_sw) < 30 || sum(train_sw$event!=0) < 10) {"
"0","  stop(sprintf(""stepAIC: 依然として母集団が小さすぎます (rows=%d, events=%d, vars=%d)。"","
"0","               nrow(train_sw), sum(train_sw$event!=0), length(var_superset)))"
"0","}"
"0",""
"0","fit_start <- survival::coxph(Surv(time, event) ~ 1, data=train_sw, ties=""efron"", na.action=na.omit)"
"0","scope_up  <- as.formula(paste(""~"", paste(var_superset, collapse="" + "")))  # ここでもう空ではない"
"0",""
"0","# AIC"
"0","fit_sw_aic <- MASS::stepAIC(fit_start, scope=list(lower=~1, upper=scope_up),"
"0","                            direction=""both"", k=2, trace=FALSE)"
"2","Warning: Loglik converged before variable  2 ; coefficient may be infinite. "
"2","Warning: Loglik converged before variable  3 ; coefficient may be infinite. "
"0","terms_aic  <- attr(terms(fit_sw_aic), ""term.labels"")"
"0",""
"0","# BIC"
"0","k_bic <- log(nrow(train_sw))"
"0","fit_sw_bic <- MASS::stepAIC(fit_start, scope=list(lower=~1, upper=scope_up),"
"0","                            direction=""both"", k=k_bic, trace=FALSE)"
"2","Warning: Loglik converged before variable  2 ; coefficient may be infinite. "
"0","terms_bic  <- attr(terms(fit_sw_bic), ""term.labels"")"
"0",""
"0","c_idx <- function(fit, dat){"
"0","  if(!nrow(dat)) return(NA_real_)"
"0","  lp <- predict(fit, newdata=dat, type=""lp"")"
"0","  survival::concordance(Surv(dat$time, as.integer(dat$event!=0)) ~ lp, reverse=TRUE)$concordance"
"0","}"
"0",""
"0","list("
"0","  var_superset = var_superset,"
"0","  stepAIC_AIC_terms = terms_aic,"
"0","  C_stepAIC_AIC = list("
"0","    C_train = c_idx(fit_sw_aic, train_sw),"
"0","    C_val   = c_idx(fit_sw_aic, val_sw),"
"0","    C_test  = c_idx(fit_sw_aic, test_sw)"
"0","  ),"
"0","  stepAIC_BIC_terms = terms_bic,"
"0","  C_stepAIC_BIC = list("
"0","    C_train = c_idx(fit_sw_bic, train_sw),"
"0","    C_val   = c_idx(fit_sw_bic, val_sw),"
"0","    C_test  = c_idx(fit_sw_bic, test_sw)"
"0","  )"
"0",")"
"1","$var_superset
"
"1","[1]"
"1"," ""sex_male"""
"1"," ""age""     "
"1"," ""hbv""     "
"1"," ""hcv""     "
"1"," ""plt""     "
"1"," ""alb""     "
"1"," ""tbil""    "
"1"," ""che""     "
"1","
"
"1","
"
"1","$stepAIC_AIC_terms
"
"1","[1]"
"1"," ""alb"""
"1","
"
"1","
"
"1","$C_stepAIC_AIC
"
"1","$C_stepAIC_AIC$C_train
"
"1","[1]"
"1"," 0.5413282"
"1","
"
"1","
"
"1","$C_stepAIC_AIC$C_val
"
"1","[1]"
"1"," 0.6286848"
"1","
"
"1","
"
"1","$C_stepAIC_AIC$C_test
"
"1","[1]"
"1"," 0.4695586"
"1","
"
"1","
"
"1","
"
"1","$stepAIC_BIC_terms
"
"1","character(0)
"
"1","
"
"1","$C_stepAIC_BIC
"
"1","$C_stepAIC_BIC$C_train
"
"1","[1]"
"1"," 0.5"
"1","
"
"1","
"
"1","$C_stepAIC_BIC$C_val
"
"1","[1]"
"1"," 0.5"
"1","
"
"1","
"
"1","$C_stepAIC_BIC$C_test
"
"1","[1]"
"1"," 0.5"
"1","
"
"1","
"
"1","
"
