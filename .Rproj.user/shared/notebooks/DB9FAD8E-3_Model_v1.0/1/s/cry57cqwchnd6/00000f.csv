"0","## ==== CHUNK J (FIX): helpers & preprocessing (robust) ===="
"0","req_pkgs <- c(""tidyverse"",""survival"",""glmnet"")"
"0","to_install <- setdiff(req_pkgs, rownames(installed.packages()))"
"0","if(length(to_install)) install.packages(to_install, Ncpus=2)"
"0","invisible(lapply(req_pkgs, library, character.only=TRUE))"
"0","# stepAIC は明示的に MASS:: を使う（library(MASS) は読み込まない）"
"0","if(!""MASS"" %in% rownames(installed.packages())) install.packages(""MASS"")"
"0",""
"0","c_index <- function(time, event, lp){"
"0","  survival::concordance(Surv(time, event) ~ lp, reverse = TRUE)$concordance"
"0","}"
"0",""
"0","cc_time_only <- function(df){"
"0","  df %>% dplyr::filter(is.finite(time), time > 0, !is.na(event))"
"0","}"
"0",""
"0","# ---- LASSO用 前処理（学習側でも単一水準factorを救済）----"
"0","fit_preproc2 <- function(df, vars){"
"0","  X0 <- df %>% dplyr::select(dplyr::all_of(vars)) %>%"
"0","    dplyr::mutate(across(where(is.character), as.factor))"
"0","  fac_levels <- lapply(X0[, sapply(X0, is.factor), drop=FALSE], levels)"
"0","  num_median <- sapply(X0[, sapply(X0, is.numeric), drop=FALSE], function(x) median(x, na.rm=TRUE))"
"0","  fac_mode   <- sapply(X0[, sapply(X0, is.factor),  drop=FALSE], function(x){"
"0","    ux <- stats::na.omit(x); if(length(ux)) names(sort(table(ux), decreasing=TRUE))[1] else NA"
"0","  })"
"0","  # 欠損補完"
"0","  for (cn in names(num_median)) { v <- X0[[cn]]; v[is.na(v)] <- num_median[cn]; X0[[cn]] <- v }"
"0","  for (cn in names(fac_mode))   { v <- X0[[cn]]; v[is.na(v)] <- fac_mode[cn]; X0[[cn]] <- droplevels(v) }"
"0","  # ★ 学習側でも単一水準factorを救済"
"0","  fac_cols <- names(X0)[sapply(X0, is.factor)]"
"0","  for (cn in fac_cols) if (nlevels(X0[[cn]]) <= 1) {"
"0","    X0[[cn]] <- factor(as.character(X0[[cn]]), levels = unique(c(levels(X0[[cn]]), ""__dummy__"")))"
"0","  }"
"0","  mm0 <- model.matrix(~ 0 + ., data = X0)"
"0","  keep <- if(ncol(mm0)) which(apply(mm0, 2, sd) > 0) else integer(0)"
"0","  ref_cols <- if(length(keep)) colnames(mm0)[keep] else character(0)"
"0","  list(vars=vars, fac_levels=fac_levels, num_median=num_median,"
"0","       fac_mode=fac_mode, ref_cols=ref_cols)"
"0","}"
"0",""
"0","transform_preproc2 <- function(prep, df){"
"0","  X <- df %>% dplyr::select(dplyr::all_of(prep$vars)) %>%"
"0","    dplyr::mutate(across(where(is.character), as.factor))"
"0","  for (cn in names(prep$fac_levels)) if (cn %in% names(X)) {"
"0","    X[[cn]] <- factor(X[[cn]], levels = prep$fac_levels[[cn]])"
"0","  }"
"0","  for (cn in names(prep$num_median)) if (cn %in% names(X)) {"
"0","    v <- X[[cn]]; v[is.na(v)] <- prep$num_median[[cn]]; X[[cn]] <- v"
"0","  }"
"0","  for (cn in names(prep$fac_mode)) if (cn %in% names(X)) {"
"0","    v <- X[[cn]]; v[is.na(v)] <- prep$fac_mode[[cn]]; X[[cn]] <- droplevels(v)"
"0","  }"
"0","  fac_cols <- names(X)[sapply(X, is.factor)]"
"0","  for (cn in fac_cols) if (nlevels(X[[cn]]) <= 1) {"
"0","    X[[cn]] <- factor(as.character(X[[cn]]), levels = unique(c(levels(X[[cn]]), ""__dummy__"")))"
"0","  }"
"0","  mm <- model.matrix(~ 0 + ., data = X)"
"0","  cur <- colnames(mm)"
"0","  extra <- setdiff(cur, prep$ref_cols)"
"0","  if(length(extra)) mm <- mm[, setdiff(cur, extra), drop=FALSE]"
"0","  miss <- setdiff(prep$ref_cols, colnames(mm))"
"0","  if(length(miss)) mm <- cbind(mm, matrix(0, nrow=nrow(mm), ncol=length(miss),"
"0","                                          dimnames=list(NULL, miss)))"
"0","  mm <- mm[, prep$ref_cols, drop=FALSE]"
"0","  mm"
"0","}"
"0",""
"0","# 候補プール（存在列だけに絞る）"
"0","pool0 <- c("
"0","  ""sex_male"",""age"",""hbv"",""hcv"",""plt"",""alb"",""tbil"",""che"",""ast"",""alt"",""nh3"","
"0","  ""pt_inr"",""icg10_cat"",""icg_r15"",""hh15"",""lhl15"",""liver_damage"",""child_pugh"","
"0","  ""afp"",""afp_l3"",""pivka2"",""cea"",""ca19_9"",""height_cm"",""weight_kg"",""ps"",""asa"","
"0","  ""tum_diam_pre"",""tum_count_pre"",""vp_pre"",""vv_pre"",""n_pre"",""m_pre"","
"0","  ""max_diam_cm"",""grouth_type"",""vp_path"",""vv_path"",""va_path"",""b_path"","
"0","  ""fc"",""fc_inf"",""sf"",""lm"",""sm"",""sm_mm"",""fibrosis_score"",""grading_score"","
"0","  ""albi23"",""ln_afp"",""ln_diam"",""tum_count"",""mvi_01"",""tum_count_log1p"",""mvi_combo"","
"0","  ""T_cat"",""N_cat"",""M_cat"",""op_time_min"",""bleed_ml"",""stage"""
"0",")"
"0","pool0 <- intersect(pool0, names(ds04_train))"
"0",""
