"0","## ==== CHUNK 1: Build ds02 (BRのみ・特徴量) ===="
"0","need_cols(ds01_model, c(var_map$id, var_map$sex, var_map$alb_g_dl, var_map$tbil_mg_dl,"
"0","                        var_map$afp_ng_ml, var_map$tum_diam_cm, var_map$tum_count,"
"0","                        var_map$time_months, var_map$event_recur,"
"0","                        var_map$t_cat, var_map$n_cat, var_map$m_cat,"
"0","                        var_map$vp_pre, var_map$vv_pre, var_map$vp_path, var_map$vv_path,"
"0","                        var_map$op_date, var_map$group_rb, var_map$stage_diag))"
"0",""
"0","# group_rb の補完"
"0","ds02 <- ds01_model %>%"
"0","  mutate("
"0","    group_rb_fill = dplyr::case_when("
"0","      !is.na(.data[[var_map$group_rb]]) ~ .data[[var_map$group_rb]],"
"0","      .data[[var_map$stage_diag]] %in% c(""BR1"",""BR2"") ~ ""BR"","
"0","      .data[[var_map$stage_diag]] %in% c(""R"") ~ ""R"","
"0","      TRUE ~ NA_character_"
"0","    )"
"0","  ) %>%"
"0","  filter(group_rb_fill == ""BR"") %>%                         # BRのみ残す"
"0","  mutate("
"0","    op_date = as.Date(.data[[var_map$op_date]]),"
"0","    sex_male = dplyr::case_when(.data[[var_map$sex]] %in% c(""M"",""m"") ~ 1,"
"0","                                .data[[var_map$sex]] %in% c(""F"",""f"") ~ 0,"
"0","                                TRUE ~ NA_real_)"
"0","  ) %>%"
"0","  bind_cols(calc_albi( .[[var_map$alb_g_dl]], .[[var_map$tbil_mg_dl]] )) %>%"
"0","  mutate("
"0","    albi23    = if_else(albi_grade >= 2, 1, 0, missing = NA_integer_),"
"0","    ln_afp    = safe_ln( .[[var_map$afp_ng_ml]] ),"
"0","    ln_diam   = safe_ln( .[[var_map$tum_diam_cm]] ),"
"0","    tum_count = suppressWarnings(as.numeric(.data[[var_map$tum_count]])),"
"0","    time      = suppressWarnings(as.numeric(.data[[var_map$time_months]])),"
"0","    event     = as.integer(.data[[var_map$event_recur]]),"
"0",""
"0","    # TNM（factor; 参照は最小レベル）"
"0","    T_cat = factor(.data[[var_map$t_cat]]),"
"0","    N_cat = factor(.data[[var_map$n_cat]]),"
"0","    M_cat = factor(.data[[var_map$m_cat]])"
"0","  )"
"0",""
"0","# relevel"
"0","ds02$T_cat <- relevel(ds02$T_cat, ref = levels(ds02$T_cat)[1])"
"0","ds02$N_cat <- relevel(ds02$N_cat, ref = levels(ds02$N_cat)[1])"
"0","ds02$M_cat <- relevel(ds02$M_cat, ref = levels(ds02$M_cat)[1])"
"0",""
"0","# mvi_01: (vp_pre==0 & vp_path>=1) OR (vv_pre==0 & vv_path>=1)"
"0","ds02 <- ds02 %>%"
"0","  mutate("
"0","    vp_pre_num  = suppressWarnings(as.numeric(.data[[var_map$vp_pre]])),"
"0","    vv_pre_num  = suppressWarnings(as.numeric(.data[[var_map$vv_pre]])),"
"0","    vp_path_num = suppressWarnings(as.numeric(.data[[var_map$vp_path]])),"
"0","    vv_path_num = suppressWarnings(as.numeric(.data[[var_map$vv_path]])),"
"0","    mvi_01 = case_when("
"0","      (vp_pre_num == 0 & vp_path_num >= 1) | (vv_pre_num == 0 & vv_path_num >= 1) ~ 1L,"
"0","      is.na(vp_pre_num) & is.na(vv_pre_num) & is.na(vp_path_num) & is.na(vv_path_num) ~ NA_integer_,"
"0","      TRUE ~ 0L"
"0","    )"
"0","  ) %>%"
"0","  dplyr::select(-dplyr::all_of(c(""vp_pre_num"",""vv_pre_num"",""vp_path_num"",""vv_path_num"")))"
"0",""
