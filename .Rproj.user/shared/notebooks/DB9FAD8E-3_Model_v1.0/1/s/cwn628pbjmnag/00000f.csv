"0","## ==== CHUNK 6: Collect C-index (ERASL-pre/post, TNM, LASSO) ===="
"0",""
"0","library(survival)"
"0","c_index <- function(time, event, lp){"
"0","  survival::concordance(Surv(time, event) ~ lp, reverse = TRUE)$concordance"
"0","}"
"0",""
"0","# ない場合は再計算するためのヘルパ"
"0","cidx_from_fit <- function(fit, need_vars){"
"0","  stopifnot(exists(""ds06_test""))"
"0","  test_common <- ds06_test |> tidyr::drop_na(all_of(c(need_vars, ""time"",""event"")))"
"0","  if(nrow(test_common) == 0) return(NA_real_)"
"0","  lp <- predict(fit, newdata = test_common, type = ""lp"")"
"0","  c_index(test_common$time, test_common$event, lp)"
"0","}"
"0",""
"0","results <- list()"
"0",""
"0","# ERASL-pre"
"0","if (exists(""c_pre_test"")) {"
"0","  results$ERASL_pre <- c_pre_test"
"0","} else if (exists(""fit_erasl_pre"")) {"
"0","  results$ERASL_pre <- cidx_from_fit(fit_erasl_pre,"
"0","    c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count""))"
"0","}"
"0",""
"0","# ERASL-post"
"0","if (exists(""c_post_test"")) {"
"0","  results$ERASL_post <- c_post_test"
"0","} else if (exists(""fit_erasl_post"")) {"
"0","  results$ERASL_post <- cidx_from_fit(fit_erasl_post,"
"0","    c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count"",""mvi_01""))"
"0","}"
"0",""
"0","# TNM"
"0","if (exists(""c_tnm_test"")) {"
"0","  results$TNM <- c_tnm_test"
"0","} else if (exists(""fit_tnm"")) {"
"0","  results$TNM <- cidx_from_fit(fit_tnm, c(""T_cat"",""N_cat"",""M_cat""))"
"0","}"
"0",""
"0","# LASSO（CHUNK5で作った最終モデル）"
"0","if (exists(""c_test"")) {"
"0","  results$LASSO <- c_test"
"0","} else if (exists(""fit_final"")) {"
"0","  # Train+Val基準の前処理オブジェクト（prepまたはprep2）を使って Test を行列化"
"0","  if (exists(""prep2"")) {"
"0","    mm_te <- transform_preproc(prep2, ds06_test)         # CHUNK5のprep2"
"0","  } else if (exists(""prep"")) {"
"0","    mm_te <- transform_preproc(prep,  ds06_test)         # CHUNK4のprep"
"0","  } else {"
"0","    stop(""LASSOの前処理オブジェクト（prep/prep2）が見つかりません。"")"
"0","  }"
"0","  lp <- as.numeric(mm_te %*% as.matrix(coef(fit_final)))"
"0","  results$LASSO <- c_index(ds06_test$time, as.integer(ds06_test$event != 0), lp)"
"0","}"
"0",""
"0","# リスト or 表で出力"
"0","results"
"1","$ERASL_pre
"
"1","[1]"
"1"," 0.4777778"
"1","
"
"1","
"
"1","$ERASL_post
"
"1","[1]"
"1"," 0.4925926"
"1","
"
"1","
"
"1","$TNM
"
"1","[1]"
"1"," 0.580791"
"1","
"
"1","
"
"1","$LASSO
"
"1","[1]"
"1"," 0.4813559"
"1","
"
"1","
"
"0","# tibbleにしたい場合は↓"
"0","# tibble::tibble(model = names(results), c_index = unlist(results))"
"0",""
