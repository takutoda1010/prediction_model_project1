"0","## ==== CHUNK E: Feature engineering (applied in place) ===="
"0","recode_block <- function(d){"
"0","  d %>%"
"0","    mutate("
"0","      # tum_count: 連続 log1p + カテゴリ"
"0","      tum_count_log1p = log1p(tum_count),"
"0","      tum_count_cat = cut(tum_count,"
"0","                          breaks = c(-Inf,1,3,5,Inf),"
"0","                          labels = c(""1"",""2-3"",""4-5"",""6+""),"
"0","                          right = TRUE, ordered_result = TRUE),"
"0",""
"0","      # 径のRCSはモデル式で ns() を使う（ここではそのまま）"
"0","      # 例: Surv(...) ~ ns(tum_diam_cm, knots=quantile(tum_diam_cm, c(.1,.5,.9), na.rm=TRUE))"
"0",""
"0","      # MVI拡張：vp/vv 病理の単独/両陽性カテゴリ"
"0","      vp_path_pos = as.integer(suppressWarnings(as.numeric(.data[[""vp_path""]])) >= 1),"
"0","      vv_path_pos = as.integer(suppressWarnings(as.numeric(.data[[""vv_path""]])) >= 1),"
"0","      mvi_combo = dplyr::case_when("
"0","        is.na(vp_path_pos) & is.na(vv_path_pos) ~ NA_character_,"
"0","        vp_path_pos==1 & vv_path_pos==1 ~ ""both"","
"0","        vp_path_pos==1 & (vv_path_pos==0 | is.na(vv_path_pos)) ~ ""vp_only"","
"0","        vv_path_pos==1 & (vp_path_pos==0 | is.na(vp_path_pos)) ~ ""vv_only"","
"0","        TRUE ~ ""none"""
"0","      ),"
"0","      mvi_combo = factor(mvi_combo, levels=c(""none"",""vp_only"",""vv_only"",""both""), ordered = TRUE)"
"0","    )"
"0","}"
"0",""
"0","ds04_train <- recode_block(ds04_train)"
"0","ds05_val   <- recode_block(ds05_val)"
"0","ds06_test  <- recode_block(ds06_test)"
"0",""
