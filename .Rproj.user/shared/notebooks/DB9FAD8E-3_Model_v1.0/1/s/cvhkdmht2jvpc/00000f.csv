"0","## ==== CHUNK B: Common test set & linear predictors ===="
"0","stopifnot(exists(""ds06_test""))"
"0",""
"0","# 必要列（ERASL-post ⊇ ERASL-pre, ＋ TNM）"
"0","vars_pre   <- c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count"")"
"0","vars_post  <- c(vars_pre, ""mvi_01"")"
"0","vars_tnm   <- c(""T_cat"",""N_cat"",""M_cat"")"
"0","vars_common <- c(unique(c(vars_post, vars_tnm)), ""time"",""event"")"
"0",""
"0","test_common <- ds06_test %>% tidyr::drop_na(all_of(vars_common))"
"0","message(""Common test n = "", nrow(test_common))"
"2","Common test n = 50
"
"0","# ---- LP: ERASL-pre/post/TNM ----"
"0","stopifnot(exists(""fit_erasl_pre""), exists(""fit_erasl_post""), exists(""fit_tnm""))"
"0","lp_pre  <- predict(fit_erasl_pre,  newdata = test_common, type = ""lp"")"
"0","lp_post <- predict(fit_erasl_post, newdata = test_common, type = ""lp"")"
"0","lp_tnm  <- predict(fit_tnm,        newdata = test_common, type = ""lp"")"
"0",""
"0","## ---- LP: LASSO（Train基準の前処理をTestへ適用）----"
"0","stopifnot(exists(""fit_final""))"
"0","mm_te <- if (exists(""prep2"")) transform_preproc_safe(prep2, test_common) else transform_preproc_safe(prep, test_common)"
"0","beta_lasso <- as.matrix(coef(fit_final))"
"0","lp_lasso <- as.numeric(mm_te %*% beta_lasso)"
"0",""
"0",""
"0","# まとめ"
"0","y_time  <- test_common$time"
"0","y_event <- as.integer(test_common$event != 0)"
"0",""
