"0","## ==== CHUNK P (FIX): Plain LASSO (no forced vars) ===="
"0","cand_lasso <- pool_clean"
"0","tr_la <- ds04_train %>% cc_time_only()"
"0","va_la <- ds05_val   %>% cc_time_only()"
"0","te_la <- ds06_test  %>% cc_time_only()"
"0",""
"0","prep_la_tr <- fit_preproc2(tr_la, cand_lasso)   # ★ 学習側救済が効く"
"0","X_tr <- transform_preproc2(prep_la_tr, tr_la)"
"0","y_tr <- Surv(tr_la$time, as.integer(tr_la$event!=0))"
"0",""
"0","alpha_grid <- c(0.25, 0.5, 0.75, 1.0)"
"0","set.seed(123)"
"0","grid <- lapply(alpha_grid, function(a){"
"0","  cv <- glmnet::cv.glmnet(X_tr, y_tr, family=""cox"", alpha=a, nfolds=10, standardize=TRUE)"
"0","  list(alpha=a, cv=cv, lambda_min=cv$lambda.min, lambda_1se=cv$lambda.1se, cvm_min=min(cv$cvm, na.rm=TRUE))"
"0","})"
"0","best <- grid[[ which.min(sapply(grid, `[[`, ""cvm_min"")) ]]"
"0",""
"0","# Train+Val で refit（前処理も Train+Val で作り直し）"
"0","trva_la <- dplyr::bind_rows(tr_la, va_la)"
"0","prep_la  <- fit_preproc2(trva_la, cand_lasso)"
"0","X_trva   <- transform_preproc2(prep_la, trva_la)"
"0","y_trva   <- Surv(trva_la$time, as.integer(trva_la$event!=0))"
"0",""
"0","fit_glm <- glmnet::glmnet(X_trva, y_trva, family=""cox"","
"0","                          alpha=best$alpha, lambda=best$lambda_1se, standardize=TRUE)"
"0",""
"0","X_te  <- transform_preproc2(prep_la, te_la)"
"0","lp    <- as.numeric(X_te %*% as.matrix(coef(fit_glm)))"
"0","c_test <- c_index(te_la$time, as.integer(te_la$event!=0), lp)"
"0",""
"0","list(best_alpha = best$alpha, best_lambda = best$lambda_1se, C_test_LASSO = c_test,"
"0","     n_selected = sum(abs(as.matrix(coef(fit_glm))) > 0))"
"1","$best_alpha
"
"1","[1]"
"1"," 0.5"
"1","
"
"1","
"
"1","$best_lambda
"
"1","[1]"
"1"," 0.37753"
"1","
"
"1","
"
"1","$C_test_LASSO
"
"1","[1]"
"1"," 0.5"
"1","
"
"1","
"
"1","$n_selected
"
"1","[1]"
"1"," 0"
"1","
"
"1","
"
