"0","## ==== CHUNK Z: Compare all built models on the same Test set ===="
"0","# 前提: ds06_test があり、fit_* など各モデルが「存在する場合」はそのまま使います"
"0","# 必要パッケージ"
"0","req_pkgs <- c(""tidyverse"",""survival"",""timeROC"")"
"0","to_install <- setdiff(req_pkgs, rownames(installed.packages()))"
"0","if(length(to_install)) install.packages(to_install, Ncpus=2)"
"0","invisible(lapply(req_pkgs, library, character.only=TRUE))"
"0",""
"0","# 既存ヘルパ（未定義なら定義）"
"0","if(!exists(""c_index"")){"
"0","  c_index <- function(time, event, lp){"
"0","    survival::concordance(Surv(time, event) ~ lp, reverse = TRUE)$concordance"
"0","  }"
"0","}"
"0","if(!exists(""cc_dat"")){"
"0","  cc_dat <- function(df, vars){"
"0","    vars <- unique(c(vars,""time"",""event""))"
"0","    df   <- df[, intersect(vars, names(df)), drop=FALSE]"
"0","    tidyr::drop_na(df)"
"0","  }"
"0","}"
"0","# transform_preproc_safe がない場合の後方互換"
"0","if(!exists(""transform_preproc_safe"") && exists(""transform_preproc"")){"
"0","  transform_preproc_safe <- transform_preproc"
"0","}"
"0",""
"0","# 共通 Test（最低限の整備）"
"0","stopifnot(exists(""ds06_test""))"
"0","test0 <- ds06_test %>% dplyr::filter(is.finite(time), time > 0, !is.na(event))"
"0",""
"0","# ---------- 共通ユーティリティ ----------"
"0","boot_ci_c <- function(time, event, lp, B=1000, seed=123){"
"0","  set.seed(seed)"
"0","  n <- length(time)"
"0","  if(n==0 || length(lp)!=n) return(c(mean=NA, lo=NA, hi=NA))"
"0","  out <- numeric(B)"
"0","  for(b in 1:B){"
"0","    idx <- sample.int(n, n, replace=TRUE)"
"0","    out[b] <- c_index(time[idx], event[idx], lp[idx])"
"0","  }"
"0","  out <- out[is.finite(out)]"
"0","  if(!length(out)) return(c(mean=NA, lo=NA, hi=NA))"
"0","  qs <- quantile(out, c(.025,.975), na.rm=TRUE)"
"0","  c(mean=mean(out, na.rm=TRUE), lo=unname(qs[1]), hi=unname(qs[2]))"
"0","}"
"0",""
"0","auc_and_iauc <- function(time, event, lp, tau_vec=c(12,36,60), tau_grid=12:60){"
"0","  if(length(time)==0 || length(lp)!=length(time)) return(c(AUC_1y=NA, AUC_3y=NA, AUC_5y=NA, iAUC_1to5=NA))"
"0","  safe_timeROC <- function(times){"
"0","    tryCatch({"
"0","      tr <- timeROC(T=time, delta=event, marker=lp, cause=1, times=times, iid=FALSE)"
"0","      tr$AUC"
"0","    }, error=function(e) rep(NA_real_, length(times)))"
"0","  }"
"0","  A <- safe_timeROC(tau_vec)"
"0","  tr_grid <- tryCatch(timeROC(T=time, delta=event, marker=lp, cause=1, times=tau_grid, iid=FALSE),"
"0","                      error=function(e) NULL)"
"0","  iA <- if(!is.null(tr_grid)){"
"0","    # 台形公式"
"0","    sum((tau_grid[-1]-tau_grid[-length(tau_grid)]) * (tr_grid$AUC[-1]+tr_grid$AUC[-length(tr_grid$AUC)]) / 2) /"
"0","      (max(tau_grid)-min(tau_grid))"
"0","  } else NA_real_"
"0","  c(AUC_1y=A[1], AUC_3y=A[2], AUC_5y=A[3], iAUC_1to5=iA)"
"0","}"
"0",""
"0","k_ncoef <- function(fit){"
"0","  if(inherits(fit, ""coxph"")){"
"0","    b <- stats::coef(fit)"
"0","    sum(is.finite(b) & b!=0)"
"0","  } else if(inherits(fit, ""glmnet"")){"
"0","    b <- as.matrix(coef(fit))"
"0","    sum(abs(b)>0)"
"0","  } else NA_integer_"
"0","}"
"0",""
"0","# ---------- LPを作るラッパ ----------"
"0","lp_from_cox <- function(fit, need_vars, test_df=test0){"
"0","  if(!exists(deparse(substitute(fit)))) return(NULL)"
"0","  if(is.null(fit)) return(NULL)"
"0","  dat <- cc_dat(test_df, need_vars)"
"0","  if(!nrow(dat)) return(NULL)"
"0","  lp  <- predict(fit, newdata=dat, type=""lp"")"
"0","  list(lp=as.numeric(lp), time=dat$time, event=as.integer(dat$event!=0), n=nrow(dat))"
"0","}"
"0",""
"0","lp_from_glmnet <- function(fit, prep_obj, test_df=test0){"
"0","  if(is.null(fit) || is.null(prep_obj)) return(NULL)"
"0","  # time/event の完全ケース行だけを使う（列整列は transform_preproc_safe に任せる）"
"0","  dat <- test_df %>% dplyr::filter(is.finite(time), time > 0, !is.na(event))"
"0","  if(!nrow(dat)) return(NULL)"
"0","  mm  <- transform_preproc_safe(prep_obj, dat)"
"0","  beta <- as.matrix(coef(fit))"
"0","  lp <- as.numeric(mm %*% beta)"
"0","  list(lp=lp, time=dat$time, event=as.integer(dat$event!=0), n=nrow(dat))"
"0","}"
"0",""
"0","# ---------- 個別モデルごとの取得 ----------"
"0","rows <- list()"
"0",""
"0","# ERASL_pre"
"0","if(exists(""fit_erasl_pre"")){"
"0","  out <- lp_from_cox(fit_erasl_pre, c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count""))"
"0","  if(!is.null(out)){"
"0","    rows[[""ERASL_pre""]] <- list(kind=""coxph"", fit=fit_erasl_pre, n=out$n, time=out$time, event=out$event, lp=out$lp)"
"0","  }"
"0","}"
"0",""
"0","# ERASL_post"
"0","if(exists(""fit_erasl_post"")){"
"0","  out <- lp_from_cox(fit_erasl_post, c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count"",""mvi_01""))"
"0","  if(!is.null(out)){"
"0","    rows[[""ERASL_post""]] <- list(kind=""coxph"", fit=fit_erasl_post, n=out$n, time=out$time, event=out$event, lp=out$lp)"
"0","  }"
"0","}"
"0",""
"0","# TNM"
"0","if(exists(""fit_tnm"")){"
"0","  out <- lp_from_cox(fit_tnm, c(""T_cat"",""N_cat"",""M_cat""))"
"0","  if(!is.null(out)){"
"0","    rows[[""TNM""]] <- list(kind=""coxph"", fit=fit_tnm, n=out$n, time=out$time, event=out$event, lp=out$lp)"
"0","  }"
"0","}"
"0",""
"0","# LASSO（強制入り）— CHUNK5 の fit_final / prep2 or prep"
"0","if(exists(""fit_final"") && (exists(""prep2"") || exists(""prep""))){"
"0","  prep_obj <- if(exists(""prep2"")) prep2 else prep"
"0","  out <- lp_from_glmnet(fit_final, prep_obj, ds06_test)  # LASSO は元の ds06_test 全列から"
"0","  if(!is.null(out)){"
"0","    rows[[""LASSO_forced""]] <- list(kind=""glmnet"", fit=fit_final, n=out$n, time=out$time, event=out$event, lp=out$lp)"
"0","  }"
"0","}"
"0",""
"0","# LASSO（強制なし）— CHUNK P の fit_glm / prep_la"
"0","if(exists(""fit_glm"") && exists(""prep_la"")){"
"0","  out <- lp_from_glmnet(fit_glm, prep_la, ds06_test)"
"0","  if(!is.null(out)){"
"0","    rows[[""LASSO_plain""]] <- list(kind=""glmnet"", fit=fit_glm, n=out$n, time=out$time, event=out$event, lp=out$lp)"
"0","  }"
"0","}"
"0",""
"0","# Stepwise AIC / BIC / Forward"
"0","if(exists(""fit_sw_aic"")){"
"0","  tv <- attr(terms(fit_sw_aic), ""term.labels"")"
"0","  out <- lp_from_cox(fit_sw_aic, tv)"
"0","  if(!is.null(out)) rows[[""STEP_AIC""]] <- list(kind=""coxph"", fit=fit_sw_aic, n=out$n, time=out$time, event=out$event, lp=out$lp)"
"0","}"
"0","if(exists(""fit_sw_bic"")){"
"0","  tv <- attr(terms(fit_sw_bic), ""term.labels"")"
"0","  out <- lp_from_cox(fit_sw_bic, tv)"
"0","  if(!is.null(out)) rows[[""STEP_BIC""]] <- list(kind=""coxph"", fit=fit_sw_bic, n=out$n, time=out$time, event=out$event, lp=out$lp)"
"0","}"
"0","if(exists(""fit_fwd"") && !is.null(fit_fwd)){"
"0","  tv <- attr(terms(fit_fwd), ""term.labels"")"
"0","  out <- lp_from_cox(fit_fwd, tv)"
"0","  if(!is.null(out)) rows[[""FORWARD""]] <- list(kind=""coxph"", fit=fit_fwd, n=out$n, time=out$time, event=out$event, lp=out$lp)"
"0","}"
"0",""
"0","# RCS モデル（CHUNK H）"
"0","if(exists(""fit_rcs"") && exists(""test_rcs"")){"
"0","  dat <- test_rcs %>% dplyr::filter(is.finite(time), time > 0, !is.na(event))"
"0","  if(nrow(dat)){"
"0","    lp <- predict(fit_rcs, newdata=dat, type=""lp"")"
"0","    rows[[""RCS""]] <- list(kind=""coxph"", fit=fit_rcs, n=nrow(dat), time=dat$time, event=as.integer(dat$event!=0), lp=as.numeric(lp))"
"0","  }"
"0","}"
"0",""
"0","# Stability selection（CHUNK M）"
"0","if(exists(""fit_ss"") && !is.null(fit_ss)){"
"0","  tv <- attr(terms(fit_ss), ""term.labels"")"
"0","  out <- lp_from_cox(fit_ss, tv)"
"0","  if(!is.null(out)) rows[[""StabilitySel""]] <- list(kind=""coxph"", fit=fit_ss, n=out$n, time=out$time, event=out$event, lp=out$lp)"
"0","}"
"0",""
"0","# （必要なら）ERASL Published（係数ベクトルが存在するときのみ）"
"0","if(exists(""erasl_coefs_pre"")){"
"0","  need <- c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count"")"
"0","  dat <- test0 %>% tidyr::drop_na(all_of(c(need,""time"",""event"")))"
"0","  if(nrow(dat)){"
"0","    X <- model.matrix(~ 1 + ., data=dat[,need,drop=FALSE])"
"0","    miss <- setdiff(names(erasl_coefs_pre), colnames(X)); if(length(miss)) X <- cbind(X, matrix(0, nrow=nrow(X), ncol=length(miss), dimnames=list(NULL, miss)))"
"0","    extra <- setdiff(colnames(X), names(erasl_coefs_pre)); if(length(extra)) X <- X[, setdiff(colnames(X), extra), drop=FALSE]"
"0","    X <- X[, names(erasl_coefs_pre), drop=FALSE]"
"0","    lp <- as.numeric(X %*% erasl_coefs_pre)"
"0","    rows[[""ERASL_published_pre""]] <- list(kind=""published"", fit=NULL, n=nrow(dat), time=dat$time, event=as.integer(dat$event!=0), lp=lp)"
"0","  }"
"0","}"
"0","if(exists(""erasl_coefs_post"")){"
"0","  need <- c(""sex_male"",""albi23"",""ln_afp"",""ln_diam"",""tum_count"",""mvi_01"")"
"0","  dat <- test0 %>% tidyr::drop_na(all_of(c(need,""time"",""event"")))"
"0","  if(nrow(dat)){"
"0","    X <- model.matrix(~ 1 + ., data=dat[,need,drop=FALSE])"
"0","    miss <- setdiff(names(erasl_coefs_post), colnames(X)); if(length(miss)) X <- cbind(X, matrix(0, nrow=nrow(X), ncol=length(miss), dimnames=list(NULL, miss)))"
"0","    extra <- setdiff(colnames(X), names(erasl_coefs_post)); if(length(extra)) X <- X[, setdiff(colnames(X), extra), drop=FALSE]"
"0","    X <- X[, names(erasl_coefs_post), drop=FALSE]"
"0","    lp <- as.numeric(X %*% erasl_coefs_post)"
"0","    rows[[""ERASL_published_post""]] <- list(kind=""published"", fit=NULL, n=nrow(dat), time=dat$time, event=as.integer(dat$event!=0), lp=lp)"
"0","  }"
"0","}"
"0",""
"0","# ---------- 集計 ----------"
"0","if(!length(rows)) stop(""比較できるモデルオブジェクトが見つかりません。先に各 CHUNK を実行してください。"")"
"0",""
"0","B_boot <- 1000  # ブート回数（重ければ 200 などに下げてOK）"
"0","tau_vec  <- c(12,36,60)"
"0","tau_grid <- 12:60"
"0",""
"0","collect <- purrr::imap_dfr(rows, function(r, name){"
"0","  # C & CI"
"0","  ci <- boot_ci_c(r$time, r$event, r$lp, B=B_boot)"
"0","  # AUC(t), iAUC"
"0","  au <- auc_and_iauc(r$time, r$event, r$lp, tau_vec, tau_grid)"
"0","  # 係数本数"
"0","  k  <- if(!is.null(r$fit)) k_ncoef(r$fit) else NA_integer_"
"0","  tibble::tibble("
"0","    model = name,"
"0","    n_test = r$n,"
"0","    events_test = sum(r$event==1, na.rm=TRUE),"
"0","    C = c_index(r$time, r$event, r$lp),"
"0","    C_lo = ci[""lo""], C_hi = ci[""hi""],"
"0","    AUC_1y = au[""AUC_1y""], AUC_3y = au[""AUC_3y""], AUC_5y = au[""AUC_5y""],"
"0","    iAUC_1to5 = au[""iAUC_1to5""],"
"0","    n_coef = k,"
"0","    over_0_5 = as.logical(ci[""lo""] > 0.5)"
"0","  )"
"0","})"
"0",""
"0","# C降順で表示"
"0","collect %>% dplyr::arrange(dplyr::desc(C))"
