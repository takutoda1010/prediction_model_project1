"0","## ==== CHUNK B-FIX: 安全版 transform_preproc（単一水準の因子を自動救済） ===="
"0","transform_preproc_safe <- function(prep, df){"
"0","  X <- df %>%"
"0","    dplyr::select(dplyr::all_of(prep$vars)) %>%"
"0","    dplyr::mutate(across(where(is.character), as.factor))"
"0",""
"0","  # Train 側の因子レベルに合わせる"
"0","  for (cn in names(prep$fac_levels)) {"
"0","    if (cn %in% names(X)) {"
"0","      X[[cn]] <- factor(X[[cn]], levels = prep$fac_levels[[cn]])"
"0","    }"
"0","  }"
"0",""
"0","  # Train の中央値/最頻値で補完"
"0","  for (cn in names(prep$num_median)) if (cn %in% names(X)) {"
"0","    v <- X[[cn]]; v[is.na(v)] <- prep$num_median[[cn]]; X[[cn]] <- v"
"0","  }"
"0","  for (cn in names(prep$fac_mode)) if (cn %in% names(X)) {"
"0","    v <- X[[cn]]; v[is.na(v)] <- prep$fac_mode[[cn]]; X[[cn]] <- droplevels(v)"
"0","  }"
"0",""
"0","  # ★ 単一水準の因子にダミーレベルを追加（例: ""__dummy__""）"
"0","  fac_cols <- names(X)[sapply(X, is.factor)]"
"0","  for (cn in fac_cols) {"
"0","    if (nlevels(X[[cn]]) <= 1) {"
"0","      cur <- levels(X[[cn]])"
"0","      new_levels <- unique(c(if(length(cur)) cur else as.character(X[[cn]]), ""__dummy__""))"
"0","      X[[cn]] <- factor(as.character(X[[cn]]), levels = new_levels)"
"0","    }"
"0","  }"
"0",""
"0","  # ダミー化"
"0","  mm <- model.matrix(~ 0 + ., data = X)"
"0",""
"0","  # 列を Train 基準に合わせる（不足は0埋め、余剰は落とす）"
"0","  cur   <- colnames(mm)"
"0","  extra <- setdiff(cur, prep$ref_cols)"
"0","  if (length(extra)) mm <- mm[, setdiff(cur, extra), drop = FALSE]"
"0","  miss  <- setdiff(prep$ref_cols, colnames(mm))"
"0","  if (length(miss)) {"
"0","    mm <- cbind(mm, matrix(0, nrow = nrow(mm), ncol = length(miss),"
"0","                           dimnames = list(NULL, miss)))"
"0","  }"
"0","  mm <- mm[, prep$ref_cols, drop = FALSE]"
"0","  mm"
"0","}"
"0",""
