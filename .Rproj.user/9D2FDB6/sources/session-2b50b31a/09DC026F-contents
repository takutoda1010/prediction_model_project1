---
title: "03_feature_engineer"
author: "Takuto Yoshida"
date: "2025-11-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
```{r}
################################################################################
# 03_feature_engineer.R - ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã¨æ´¾ç”Ÿå¤‰æ•°ä½œæˆ
# 
# Description: 
#   æ´¾ç”Ÿå¤‰æ•°ã®ä½œæˆï¼ˆALBIã€BMIã€microVIã€macroVIç­‰ï¼‰
#   å¤‰æ•°å¤‰æ›ï¼ˆå¯¾æ•°å¤‰æ›ã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰
#   æ¬ æå€¤å‡¦ç†
#
# Author: Takuto Yoshida
# Date: 2024-11-07
################################################################################

# ========================================================================
# 1. åŒ»å­¦çš„ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
# ========================================================================

#' ALBIã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @return ALBIã‚¹ã‚³ã‚¢ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
compute_albi_score <- function(df) {
  
  if (all(c("tbil", "alb") %in% names(df))) {
    message("\nğŸ“Š Computing ALBI score...")
    
    # å˜ä½ç¢ºèªã¨å¤‰æ›
    # tbil: mg/dL â†’ Î¼mol/L (Ã—17.1)
    # alb: g/dL â†’ g/L (Ã—10)
    
    bil_umol <- df$tbil * 17.1
    alb_gl <- df$alb * 10
    
    # ALBIã‚¹ã‚³ã‚¢è¨ˆç®—
    df$ALBIscore <- dplyr::case_when(
      !is.na(bil_umol) & bil_umol > 0 & !is.na(alb_gl) ~ 
        (log10(bil_umol) * 0.66) + (alb_gl * -0.085),
      TRUE ~ NA_real_
    )
    
    # ALBIã‚°ãƒ¬ãƒ¼ãƒ‰
    df$ALBIgrade <- dplyr::case_when(
      is.na(df$ALBIscore) ~ NA_character_,
      df$ALBIscore <= -2.60 ~ "1",
      df$ALBIscore <= -1.39 ~ "2",
      TRUE ~ "3"
    ) %>% factor(levels = c("1", "2", "3"))
    
    # çµ±è¨ˆã‚µãƒãƒªãƒ¼
    albi_summary <- summary(df$ALBIscore)
    message(sprintf("  âœ“ ALBI score: median = %.2f, range = [%.2f, %.2f]",
                   median(df$ALBIscore, na.rm = TRUE),
                   min(df$ALBIscore, na.rm = TRUE),
                   max(df$ALBIscore, na.rm = TRUE)))
    
    # ã‚°ãƒ¬ãƒ¼ãƒ‰åˆ†å¸ƒ
    grade_table <- table(df$ALBIgrade, useNA = "ifany")
    message("  âœ“ ALBI grade distribution:")
    for (i in seq_along(grade_table)) {
      message(sprintf("    Grade %s: %d (%.1f%%)", 
                     names(grade_table)[i], 
                     grade_table[i],
                     100 * grade_table[i] / sum(grade_table)))
    }
  }
  
  return(df)
}

#' BMIã‚’è¨ˆç®—
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @return BMIãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
compute_bmi <- function(df) {
  
  if (all(c("height_cm", "weight_kg") %in% names(df))) {
    message("\nğŸ“ Computing BMI...")
    
    df$BMI <- dplyr::case_when(
      !is.na(df$weight_kg) & !is.na(df$height_cm) & df$height_cm > 0 ~ 
        df$weight_kg / ((df$height_cm / 100)^2),
      TRUE ~ NA_real_
    )
    
    # BMIã‚«ãƒ†ã‚´ãƒªï¼ˆWHOåŸºæº–ï¼‰
    df$BMI_category <- dplyr::case_when(
      is.na(df$BMI) ~ NA_character_,
      df$BMI < 18.5 ~ "Underweight",
      df$BMI < 25 ~ "Normal",
      df$BMI < 30 ~ "Overweight",
      TRUE ~ "Obese"
    ) %>% factor(levels = c("Underweight", "Normal", "Overweight", "Obese"))
    
    # ã‚µãƒãƒªãƒ¼
    bmi_summary <- summary(df$BMI)
    message(sprintf("  âœ“ BMI: median = %.1f, range = [%.1f, %.1f]",
                   median(df$BMI, na.rm = TRUE),
                   min(df$BMI, na.rm = TRUE),
                   max(df$BMI, na.rm = TRUE)))
  }
  
  return(df)
}

# ========================================================================
# 2. è„ˆç®¡ä¾µè¥²å¤‰æ•°ã®ä½œæˆ
# ========================================================================

#' microVIã¨macroVIã‚’ä½œæˆï¼ˆä¿®æ­£ç‰ˆå®šç¾©ï¼‰
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @return VIå¤‰æ•°ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
create_vascular_invasion_variables <- function(df) {
  
  message("\nğŸ”¬ Creating vascular invasion variables...")
  
  # æ•°å€¤ã«å¤‰æ›ï¼ˆå®‰å…¨ã«ï¼‰
  get_numeric_vi <- function(x) {
    suppressWarnings(as.numeric(as.character(x)))
  }
  
  # microVI: è¡“å‰Vp/Vv=0 ã‹ã¤ è¡“å¾ŒVp/Vv/Va/b>0
  if (all(c("vp_pre", "vv_pre") %in% names(df))) {
    
    vp_pre_num <- get_numeric_vi(df$vp_pre)
    vv_pre_num <- get_numeric_vi(df$vv_pre)
    
    # è¡“å¾Œã®è„ˆç®¡ä¾µè¥²
    post_vi <- FALSE
    if ("vp_path" %in% names(df)) {
      vp_path_num <- get_numeric_vi(df$vp_path)
      post_vi <- post_vi | (!is.na(vp_path_num) & vp_path_num > 0)
    }
    if ("vv_path" %in% names(df)) {
      vv_path_num <- get_numeric_vi(df$vv_path)
      post_vi <- post_vi | (!is.na(vv_path_num) & vv_path_num > 0)
    }
    if ("va_path" %in% names(df)) {
      va_path_num <- get_numeric_vi(df$va_path)
      post_vi <- post_vi | (!is.na(va_path_num) & va_path_num > 0)
    }
    if ("b_path" %in% names(df)) {
      b_path_num <- get_numeric_vi(df$b_path)
      post_vi <- post_vi | (!is.na(b_path_num) & b_path_num > 0)
    }
    
    # microVIåˆ¤å®š
    df$microVI <- (vp_pre_num == 0 & vv_pre_num == 0) & post_vi
    
    message(sprintf("  âœ“ microVI: %d cases (%.1f%%)",
                   sum(df$microVI, na.rm = TRUE),
                   100 * mean(df$microVI, na.rm = TRUE)))
  }
  
  # macroVI: è¡“å‰Vp/Vv>=1 ã‹ã¤ è¡“å¾ŒVp/Vv>=1
  if (all(c("vp_pre", "vv_pre", "vp_path", "vv_path") %in% names(df))) {
    
    vp_pre_num <- get_numeric_vi(df$vp_pre)
    vv_pre_num <- get_numeric_vi(df$vv_pre)
    vp_path_num <- get_numeric_vi(df$vp_path)
    vv_path_num <- get_numeric_vi(df$vv_path)
    
    # macroVIåˆ¤å®š
    df$macroVI <- ((vp_pre_num >= 1 | vv_pre_num >= 1) & 
                   (vp_path_num >= 1 | vv_path_num >= 1))
    
    message(sprintf("  âœ“ macroVI: %d cases (%.1f%%)",
                   sum(df$macroVI, na.rm = TRUE),
                   100 * mean(df$macroVI, na.rm = TRUE)))
  }
  
  # è«–ç†ãƒã‚§ãƒƒã‚¯
  if (all(c("microVI", "macroVI") %in% names(df))) {
    both_true <- sum(df$microVI == TRUE & df$macroVI == TRUE, na.rm = TRUE)
    if (both_true > 0) {
      warning(sprintf("  âš  %d cases have both microVI and macroVI = TRUE", both_true))
    }
  }
  
  return(df)
}

# ========================================================================
# 3. æ™‚é–“é–¢é€£å¤‰æ•°ã®ä½œæˆ
# ========================================================================

#' 2å¹´å†ç™ºãƒ»ã‚¤ãƒ™ãƒ³ãƒˆå¤‰æ•°ã‚’ä½œæˆ
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @return æ™‚é–“å¤‰æ•°ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
create_time_variables <- function(df) {
  
  message("\nâ±ï¸ Creating time-related variables...")
  
  # ===== Step 1: å¿…è¦ãªåŸºæœ¬å¤‰æ•°ã‚’æ—¥æœ¬èªåˆ—åã‹ã‚‰ä½œæˆ =====
  
  # ç„¡å†ç™ºç”Ÿå­˜æœŸé–“ â†’ rfs_months
  if (!"rfs_months" %in% names(df) && "ç„¡å†ç™ºç”Ÿå­˜æœŸé–“" %in% names(df)) {
    df$rfs_months <- as.numeric(df$ç„¡å†ç™ºç”Ÿå­˜æœŸé–“)
    message("  âœ“ Created rfs_months from ç„¡å†ç™ºç”Ÿå­˜æœŸé–“")
  }
  
  # å…¨ç”Ÿå­˜æœŸé–“m â†’ os_months  
  if (!"os_months" %in% names(df) && "å…¨ç”Ÿå­˜æœŸé–“m" %in% names(df)) {
    df$os_months <- as.numeric(df$å…¨ç”Ÿå­˜æœŸé–“m)
    message("  âœ“ Created os_months from å…¨ç”Ÿå­˜æœŸé–“m")
  }
  
  # å†ç™ºæœ‰ç„¡TRUE/FALSEã®äºŒç¾¤ â†’ recur_tf
  # ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã‚’ä½¿ç”¨ã—ã¦åˆ—åã‚’æ­£ç¢ºã«æŒ‡å®š
  if (!"recur_tf" %in% names(df)) {
    # å¯èƒ½ãªåˆ—åã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
    recur_cols <- grep("å†ç™ºæœ‰ç„¡", names(df), value = TRUE)
    if (length(recur_cols) > 0) {
      df$recur_tf <- df[[recur_cols[1]]]  # æœ€åˆã«ãƒãƒƒãƒã—ãŸåˆ—ã‚’ä½¿ç”¨
      message(sprintf("  âœ“ Created recur_tf from %s", recur_cols[1]))
    }
  }
  
  # ç”Ÿæ­» â†’ vital_status
  if (!"vital_status" %in% names(df) && "ç”Ÿæ­»" %in% names(df)) {
    df$vital_status <- df$ç”Ÿæ­»
    message("  âœ“ Created vital_status from ç”Ÿæ­»")
  }
  
  # ç”Ÿ1æ­»0 â†’ vital10
  if (!"vital10" %in% names(df) && "ç”Ÿ1æ­»0" %in% names(df)) {
    df$vital10 <- df$ç”Ÿ1æ­»0
    message("  âœ“ Created vital10 from ç”Ÿ1æ­»0")
  }
  
  # ===== Step 2: æ´¾ç”Ÿå¤‰æ•°ã‚’ä½œæˆ =====
  
  # 2å¹´æ‰“ã¡åˆ‡ã‚Šæ™‚é–“ (time2y) - æœ€é‡è¦å¤‰æ•°
  if ("rfs_months" %in% names(df)) {
    df$time2y <- pmin(df$rfs_months, 24, na.rm = FALSE)
    message(sprintf("  âœ“ time2y: created (median = %.1f months)",
                   median(df$time2y, na.rm = TRUE)))
  } else if ("os_months" %in% names(df)) {
    df$time2y <- pmin(df$os_months, 24, na.rm = FALSE)
    message("  âœ“ time2y: created from os_months (fallback)")
  } else {
    warning("Cannot create time2y: neither rfs_months nor os_months found")
    return(df)
  }
  
  # 2å¹´å†ç™º (recur_2y) - æœ€é‡è¦å¤‰æ•°
  if (all(c("recur_tf", "rfs_months") %in% names(df))) {
    # recur_tfã‚’è«–ç†å€¤ã«å¤‰æ›
    recur_logical <- df$recur_tf %in% c("TRUE", TRUE, "1", 1, "æœ‰")
    
    # 2å¹´ä»¥å†…ã«å†ç™ºã—ãŸã‹ã©ã†ã‹
    df$recur_2y <- recur_logical & (df$rfs_months <= 24)
    
    message(sprintf("  âœ“ recur_2y: %d events (%.1f%%)",
                   sum(df$recur_2y, na.rm = TRUE),
                   100 * mean(df$recur_2y, na.rm = TRUE)))
  } else {
    warning("Cannot create recur_2y: missing recur_tf or rfs_months")
  }
  
  # 2å¹´ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒªãƒ¼ç”Ÿå­˜ (eventfree_2y)
  if (all(c("rfs_months", "os_months", "vital_status") %in% names(df))) {
    # æ­»äº¡ãƒ•ãƒ©ã‚°
    is_dead <- df$vital_status %in% "æ­»" | df$vital10 %in% c("FALSE", FALSE, "0", 0)
    
    # 2å¹´ä»¥å†…å†ç™º
    rec_2y <- !is.na(df$rfs_months) & df$rfs_months <= 24 & 
              df$recur_tf %in% c("TRUE", TRUE, "1", 1)
    
    # 2å¹´ä»¥å†…æ­»äº¡
    death_2y <- is_dead & !is.na(df$os_months) & df$os_months <= 24
    
    df$eventfree_2y <- !(rec_2y | death_2y)
    
    message(sprintf("  âœ“ eventfree_2y: %d event-free (%.1f%%)",
                   sum(df$eventfree_2y == TRUE, na.rm = TRUE),
                   100 * mean(df$eventfree_2y == TRUE, na.rm = TRUE)))
  }
  
  # 2å¹´ç”Ÿå­˜ (vital_2y)
  if (all(c("os_months", "vital_status") %in% names(df))) {
    is_dead <- df$vital_status %in% "æ­»" | df$vital10 %in% c("FALSE", FALSE, "0", 0)
    
    df$vital_2y <- !(is_dead & df$os_months <= 24)
    
    message(sprintf("  âœ“ vital_2y: %d alive at 2y (%.1f%%)",
                   sum(df$vital_2y == TRUE, na.rm = TRUE),
                   100 * mean(df$vital_2y == TRUE, na.rm = TRUE)))
  }
  
  return(df)
}

# ========================================================================
# 4. å¤‰æ•°å¤‰æ›ï¼ˆå¯¾æ•°å¤‰æ›ç­‰ï¼‰
# ========================================================================

#' æ­ªã‚“ã å¤‰æ•°ã®å¤‰æ›
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ
#' @param threshold æ­ªåº¦ã®é–¾å€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1.0ï¼‰
#' @return å¤‰æ›å¤‰æ•°ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
transform_skewed_variables <- function(df, variables = NULL, threshold = 1.0) {
  
  message("\nğŸ“ˆ Transforming skewed variables...")
  
  # å¤‰æ›å€™è£œã®å–å¾—
  transform_candidates <- character()
  
  if (!is.null(variables) && !is.null(variables$transformations$log_transform$candidates)) {
    transform_candidates <- variables$transformations$log_transform$candidates
  } else {
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¤‰æ›å€™è£œ
    transform_candidates <- c(
      "afp", "afp_l3", "pivka2", "cea", "ca19_9",
      "ast", "alt", "tbil", "plt",
      "icg_r15", "lhl15", "hh15",
      "tum_diam_pre", "tum_count_pre",
      "max_diam_cm", "count",
      "bleed_ml", "specimen_wt"
    )
  }
  
  # æ­ªåº¦è¨ˆç®—é–¢æ•°
  skewness <- function(x) {
    x <- x[is.finite(x)]
    if (length(x) < 3) return(NA_real_)
    m <- mean(x)
    s <- sd(x)
    if (!is.finite(s) || s == 0) return(NA_real_)
    mean((x - m)^3) / (s^3)
  }
  
  # å¤‰æ›å®Ÿè¡Œ
  transformed_count <- 0
  
  for (var in transform_candidates) {
    if (var %in% names(df) && is.numeric(df[[var]])) {
      
      # æ­ªåº¦ãƒã‚§ãƒƒã‚¯
      skew <- skewness(df[[var]])
      
      if (is.finite(skew) && abs(skew) > threshold) {
        
        # å¤‰æ›ã‚¿ã‚¤ãƒ—ã®æ±ºå®š
        x <- df[[var]]
        min_val <- min(x, na.rm = TRUE)
        
        if (!is.finite(min_val)) next
        
        if (skew > 0) {  # å³æ­ªã¿
          if (min_val >= 0) {
            # log1på¤‰æ›
            df[[paste0(var, "_log1p")]] <- log1p(x)
            transformed_count <- transformed_count + 1
            message(sprintf("  âœ“ %s_log1p: created (skew = %.2f)", var, skew))
          } else {
            # asinhå¤‰æ›ï¼ˆè² å€¤å¯¾å¿œï¼‰
            df[[paste0(var, "_asinh")]] <- asinh(x)
            transformed_count <- transformed_count + 1
            message(sprintf("  âœ“ %s_asinh: created (skew = %.2f)", var, skew))
          }
        } else {  # å·¦æ­ªã¿
          max_val <- max(x, na.rm = TRUE)
          if (is.finite(max_val)) {
            # åè»¢log1på¤‰æ›
            df[[paste0(var, "_reflog1p")]] <- log1p(pmax(max_val - x, 0))
            transformed_count <- transformed_count + 1
            message(sprintf("  âœ“ %s_reflog1p: created (skew = %.2f)", var, skew))
          }
        }
      }
    }
  }
  
  message(sprintf("  Total transformations: %d", transformed_count))
  
  return(df)
}

# ========================================================================
# 5. æ¬ æå€¤å‡¦ç†
# ========================================================================

#' æ¬ æå€¤ã®å‡¦ç†
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @param config è¨­å®šãƒªã‚¹ãƒˆ
#' @param method è£œå®Œæ–¹æ³•ï¼ˆ"median", "mode", "forward", "none"ï¼‰
#' @return æ¬ æå‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
handle_missing_values <- function(df, config = NULL, method = "median") {
  
  message("\nğŸ”§ Handling missing values...")
  
  # æ¬ æç‡ã®è¨ˆç®—
  missing_rates <- colMeans(is.na(df))
  
  # é«˜æ¬ æå¤‰æ•°ã®é™¤å¤–é–¾å€¤
  threshold <- 0.30
  if (!is.null(config) && !is.null(config$data_processing$missing_threshold)) {
    threshold <- config$data_processing$missing_threshold
  }
  
  # é«˜æ¬ æå¤‰æ•°ã®é™¤å¤–
  keep_always <- c("recur_date", "recur_2y", "death_cause", "death_cause4")
  high_missing <- names(missing_rates)[missing_rates > threshold]
  to_remove <- setdiff(high_missing, keep_always)
  
  if (length(to_remove) > 0) {
    message(sprintf("  âš  Removing %d variables with >%.0f%% missing:",
                   length(to_remove), threshold * 100))
    for (var in head(to_remove, 5)) {
      message(sprintf("    - %s (%.1f%% missing)", 
                     var, 100 * missing_rates[var]))
    }
    df <- df[, !names(df) %in% to_remove, drop = FALSE]
  }
  
  # ===== é‡è¦ï¼šã™ã¹ã¦ã®å¤‰æ•°ã‚’è£œå®Œ =====
  message(sprintf("\n  Applying %s imputation...", method))
  
  # 1. æ•°å€¤å¤‰æ•°ã®ä¸­å¤®å€¤è£œå®Œ
  numeric_vars <- names(df)[sapply(df, is.numeric)]
  for (var in numeric_vars) {
    if (any(is.na(df[[var]]))) {
      med_val <- median(df[[var]], na.rm = TRUE)
      if (is.finite(med_val)) {
        n_imputed <- sum(is.na(df[[var]]))
        df[[var]][is.na(df[[var]])] <- med_val
        message(sprintf("    %s: %d values imputed (median = %.2f)",
                       var, n_imputed, med_val))
      }
    }
  }
  
  # 2. ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ã®æœ€é »å€¤è£œå®Œï¼ˆè¿½åŠ ï¼ï¼‰
  factor_vars <- names(df)[sapply(df, function(x) is.factor(x) || is.character(x))]
  for (var in factor_vars) {
    if (any(is.na(df[[var]]))) {
      tab <- table(df[[var]], useNA = "no")
      if (length(tab) > 0) {
        mode_val <- names(tab)[which.max(tab)]
        n_imputed <- sum(is.na(df[[var]]))
        df[[var]][is.na(df[[var]])] <- mode_val
        message(sprintf("    %s: %d values imputed (mode = %s)",
                       var, n_imputed, mode_val))
      }
    }
  }
  
  # 3. è«–ç†å¤‰æ•°ã®è£œå®Œï¼ˆè¿½åŠ ï¼ï¼‰
  logical_vars <- names(df)[sapply(df, is.logical)]
  for (var in logical_vars) {
    if (any(is.na(df[[var]]))) {
      # æœ€é »å€¤ï¼ˆTRUE/FALSEï¼‰ã§è£œå®Œ
      mode_val <- names(sort(table(df[[var]]), decreasing = TRUE))[1] == "TRUE"
      n_imputed <- sum(is.na(df[[var]]))
      df[[var]][is.na(df[[var]])] <- mode_val
      message(sprintf("    %s: %d values imputed (mode = %s)",
                       var, n_imputed, mode_val))
    }
  }
  
  # æœ€çµ‚ç¢ºèª
  final_missing <- colMeans(is.na(df))
  remaining_missing <- sum(final_missing > 0)
  
  if (remaining_missing > 0) {
    message(sprintf("\n  âš  Warning: %d variables still have missing values:", 
                   remaining_missing))
    miss_vars <- names(final_missing)[final_missing > 0]
    for (var in head(miss_vars, 5)) {
      message(sprintf("    - %s: %.1f%% missing", 
                     var, 100 * final_missing[var]))
    }
  } else {
    message("\n  âœ“ All missing values successfully imputed!")
  }
  
  return(df)
}

# ========================================================================
# 6. å¤‰æ•°é¸æŠã®æº–å‚™
# ========================================================================

#' ãƒ¢ãƒ‡ãƒ«æŠ•å…¥ç”¨ã®å¤‰æ•°ã‚»ãƒƒãƒˆã‚’æº–å‚™
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ
#' @param set_name ä½¿ç”¨ã™ã‚‹å¤‰æ•°ã‚»ãƒƒãƒˆå
#' @return é¸æŠã•ã‚ŒãŸå¤‰æ•°ã®ãƒ™ã‚¯ãƒˆãƒ«
prepare_variable_sets <- function(df, variables = NULL, set_name = "model_all_candidates") {
  
  message("\nğŸ“‹ Preparing variable sets...")
  
  # å¤‰æ•°ã‚»ãƒƒãƒˆã®å–å¾—
  var_set <- NULL
  
  if (!is.null(variables) && !is.null(variables$variable_sets[[set_name]])) {
    var_set <- variables$variable_sets[[set_name]]
  } else {
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒãƒˆ
    message("  Using default variable set")
    var_set <- c(
      "age", "sex", "plt", "alb", "tbil", "ast", "alt",
      "afp_log1p", "pivka2_log1p",
      "max_diam_cm_log1p", "count",
      "vp_path", "vv_path", "t", "n", "m",
      "ALBIscore", "microVI", "macroVI"
    )
  }
  
  # å®Ÿåœ¨ã™ã‚‹å¤‰æ•°ã®ã¿é¸æŠ
  available_vars <- intersect(var_set, names(df))
  missing_vars <- setdiff(var_set, names(df))
  
  message(sprintf("  Variable set '%s':", set_name))
  message(sprintf("    Requested: %d variables", length(var_set)))
  message(sprintf("    Available: %d variables", length(available_vars)))
  
  if (length(missing_vars) > 0 && length(missing_vars) <= 10) {
    message(sprintf("    Missing: %s", paste(missing_vars, collapse = ", ")))
  } else if (length(missing_vars) > 10) {
    message(sprintf("    Missing: %d variables", length(missing_vars)))
  }
  
  return(available_vars)
}

# ========================================================================
# 7. çµ±åˆç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°
# ========================================================================

#' ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
#' @param dm DatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
#' @param config è¨­å®šãƒªã‚¹ãƒˆ
#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ
#' @return æ›´æ–°ã•ã‚ŒãŸDatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
feature_engineering_pipeline <- function(dm, config = NULL, variables = NULL) {
  
  message("\n========================================")
  message("Starting Feature Engineering Pipeline")
  message("========================================")
  
  # ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  df <- dm$get_current()
  current_version <- dm$current_version
  
  # 1. ALBIã‚¹ã‚³ã‚¢è¨ˆç®—
  df_albi <- compute_albi_score(df)
  dm$add_version(df_albi, version = current_version + 1)
  
  # 2. BMIè¨ˆç®—
  df_bmi <- compute_bmi(df_albi)
  dm$add_version(df_bmi, version = current_version + 2)
  
  # 3. è„ˆç®¡ä¾µè¥²å¤‰æ•°ä½œæˆ
  df_vi <- create_vascular_invasion_variables(df_bmi)
  dm$add_version(df_vi, version = current_version + 3)
  
  # 4. æ™‚é–“é–¢é€£å¤‰æ•°ä½œæˆ
  df_time <- create_time_variables(df_vi)
  dm$add_version(df_time, version = current_version + 4)
  
  # 5. å¤‰æ•°å¤‰æ›
  df_transformed <- transform_skewed_variables(df_time, variables)
  dm$add_version(df_transformed, version = current_version + 5)
  
  # 6. æ¬ æå€¤å‡¦ç†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  imputation_method <- "none"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  if (!is.null(config) && !is.null(config$data_processing$imputation_method)) {
    imputation_method <- config$data_processing$imputation_method
  }
  
  df_imputed <- handle_missing_values(df_transformed, config, method = imputation_method)
  dm$add_version(df_imputed, version = current_version + 6)
  
  # 7. å¤‰æ•°ã‚»ãƒƒãƒˆã®æº–å‚™ï¼ˆç¢ºèªã®ã¿ï¼‰
  available_vars <- prepare_variable_sets(df_transformed, variables)
  
  # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
  dm$summary()
  
  # ç‰¹å¾´é‡ã®ã‚µãƒãƒªãƒ¼
  message("\nğŸ“Š Feature Engineering Summary:")
  message(sprintf("  Total variables: %d", ncol(df_transformed)))
  message(sprintf("  Numeric variables: %d", sum(sapply(df_transformed, is.numeric))))
  message(sprintf("  Factor variables: %d", sum(sapply(df_transformed, is.factor))))
  message(sprintf("  Derived variables created: %d", 
                 length(grep("(_log1p|_asinh|_reflog1p|ALBI|BMI|microVI|macroVI|_2y|time2y)", 
                            names(df_transformed)))))
  
  message("\nâœ… Feature engineering pipeline completed!")
  message("========================================\n")
  
  return(dm)
}

# ========================================================================
# 8. ç‰¹å¾´é‡ã®å“è³ªãƒã‚§ãƒƒã‚¯
# ========================================================================

#' ä½œæˆã•ã‚ŒãŸç‰¹å¾´é‡ã®å“è³ªãƒã‚§ãƒƒã‚¯
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @return ãƒã‚§ãƒƒã‚¯çµæœ
check_feature_quality <- function(df) {
  
  message("\nğŸ” Checking feature quality...")
  
  issues <- list()
  
  # 1. microVI/macroVIã®è«–ç†ãƒã‚§ãƒƒã‚¯
  if (all(c("microVI", "macroVI") %in% names(df))) {
    both_true <- which(df$microVI == TRUE & df$macroVI == TRUE)
    if (length(both_true) > 0) {
      issues$vi_conflict <- both_true
      message(sprintf("  âš  VI conflict: %d cases with both micro/macroVI = TRUE",
                     length(both_true)))
    }
  }
  
  # 2. ALBIã‚¹ã‚³ã‚¢ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
  if ("ALBIscore" %in% names(df)) {
    albi_range <- range(df$ALBIscore, na.rm = TRUE)
    if (albi_range[1] < -4 || albi_range[2] > 2) {
      message(sprintf("  âš  ALBI score out of expected range: [%.2f, %.2f]",
                     albi_range[1], albi_range[2]))
    }
  }
  
  # 3. æ™‚é–“å¤‰æ•°ã®è«–ç†ãƒã‚§ãƒƒã‚¯
  if (all(c("recur_2y", "rfs_months") %in% names(df))) {
    # 2å¹´è¶…ãªã®ã«2å¹´å†ç™ºã¨ã•ã‚Œã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹
    illogical <- which(df$recur_2y == TRUE & df$rfs_months > 24)
    if (length(illogical) > 0) {
      issues$time_conflict <- illogical
      message(sprintf("  âš  Time conflict: %d cases with recur_2y=TRUE but RFS>24m",
                     length(illogical)))
    }
  }
  
  # 4. å¤‰æ›å¤‰æ•°ã®ç„¡é™å€¤ãƒã‚§ãƒƒã‚¯
  log_vars <- grep("_log1p|_asinh|_reflog1p", names(df), value = TRUE)
  for (var in log_vars) {
    if (any(is.infinite(df[[var]]))) {
      n_inf <- sum(is.infinite(df[[var]]))
      issues[[paste0("inf_", var)]] <- which(is.infinite(df[[var]]))
      message(sprintf("  âš  Infinite values in %s: %d cases", var, n_inf))
    }
  }
  
  if (length(issues) == 0) {
    message("  âœ… All feature quality checks passed")
  }
  
  return(issues)
}

# ========================================
# ä¸è¦ãªå¤‰æ•°ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã€æ¬ æå€¤ã‚’ç¢ºå®Ÿã«è£œå®Œ
# ========================================

clean_and_impute_completely <- function(data) {
  
  message("\nğŸ§¹ Cleaning and imputing data COMPLETELY...")
  
  # Step 1: ä¸è¦ãªå¤‰æ•°ã‚’å‰Šé™¤
  vars_to_remove <- c(
    # BMI_categoryé–¢é€£ï¼ˆæ¬ æç‡45%ï¼‰
    "BMI_category", "BMI_categoryNormal", "BMI_categoryOverweight", "BMI_categoryObese",
    # ä¸è¦ãªå¤‰æ•°
    "im", "im1", "Pringle", 
    # ãã®ä»–ã®ä¸è¦ãª_numericç³»
    "fc_inf_numeric", "sm_numeric", "sf_numeric", "fc_numeric",
    # å…ƒã®å¤‰æ•°åãŒæ®‹ã£ã¦ã„ã‚Œã°å‰Šé™¤
    "æœ€å¤§å¾„", "å€‹æ•°", "æ€§åˆ¥"
  )
  
  for (var in vars_to_remove) {
    if (var %in% names(data)) {
      data[[var]] <- NULL
      message(sprintf("  Removed: %s", var))
    }
  }
  
  # Step 2: ã™ã¹ã¦ã®æ¬ æå€¤ã‚’è£œå®Œ
  # æ•°å€¤å¤‰æ•°
  numeric_vars <- names(data)[sapply(data, is.numeric)]
  for (var in numeric_vars) {
    if (any(is.na(data[[var]]))) {
      if (var == "recur_date") {
        # recur_dateã¯ç‰¹åˆ¥æ‰±ã„ï¼ˆæ¬ æ=å†ç™ºãªã—ï¼‰
        next
      }
      med_val <- median(data[[var]], na.rm = TRUE)
      if (is.finite(med_val)) {
        data[[var]][is.na(data[[var]])] <- med_val
      } else {
        data[[var]][is.na(data[[var]])] <- 0
      }
    }
  }
  
  # ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°
  factor_vars <- names(data)[sapply(data, function(x) is.factor(x) || is.character(x))]
  for (var in factor_vars) {
    if (any(is.na(data[[var]]))) {
      tab <- table(data[[var]], useNA = "no")
      if (length(tab) > 0) {
        mode_val <- names(tab)[which.max(tab)]
        data[[var]][is.na(data[[var]])] <- mode_val
      } else {
        # ã‚‚ã—å…¨éƒ¨NAãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        if (is.factor(data[[var]])) {
          data[[var]][is.na(data[[var]])] <- levels(data[[var]])[1]
        } else {
          data[[var]][is.na(data[[var]])] <- "0"
        }
      }
    }
  }
  
  # è«–ç†å¤‰æ•°
  logical_vars <- names(data)[sapply(data, is.logical)]
  for (var in logical_vars) {
    if (any(is.na(data[[var]]))) {
      data[[var]][is.na(data[[var]])] <- FALSE
    }
  }
  
  # Step 3: æœ€çµ‚ç¢ºèª
  remaining_na <- sum(is.na(data))
  if (remaining_na > 0) {
    message(sprintf("\nâš ï¸ WARNING: Still %d NA values remaining!", remaining_na))
    na_cols <- colSums(is.na(data))
    na_cols <- na_cols[na_cols > 0]
    print(na_cols)
  } else {
    message("\nâœ… SUCCESS: All NAs removed!")
  }
  
  return(data)
}

# # å„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«é©ç”¨
# split_data_clean$train <- clean_and_impute_completely(split_data_clean$train)
# split_data_clean$val <- clean_and_impute_completely(split_data_clean$val)
# split_data_clean$test <- clean_and_impute_completely(split_data_clean$test)
# 
# # ç¢ºèª
# message("\n=== Final check ===")
# message("Train NAs: ", sum(is.na(split_data_clean$train)))
# message("Val NAs: ", sum(is.na(split_data_clean$val)))
# message("Test NAs: ", sum(is.na(split_data_clean$test)))
# 
# # è©•ä¾¡ã‚’å†å®Ÿè¡Œ
# source(file.path(PROJECT_DIR, "04_Script/R/06_model_evaluator.R"))
# eval_results <- evaluate_all_models(
#   models = models,
#   split_data = split_data_clean,
#   config = config
# )
# 
# # çµæœ
# if (!is.null(eval_results$summary)) {
#   print(eval_results$summary[, c("model", "c_index_test")], digits = 3)
# }
```

