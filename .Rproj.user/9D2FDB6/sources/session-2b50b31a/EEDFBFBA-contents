---
title: "02_data_cleaner"
author: "Takuto Yoshida"
date: "2025-11-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
```{r}
################################################################################
# 02_data_cleaner.R - ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã¨å‰å‡¦ç†
# 
# Description: 
#   ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ãªã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‡¦ç†
#   ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã®ä½œæˆã€å‚ç…§ãƒ¬ãƒ™ãƒ«è¨­å®šã€ãƒ‡ãƒ¼ã‚¿å‹ã®è©³ç´°èª¿æ•´
#
# Author: Takuto Yoshida
# Date: 2024-11-07
################################################################################

# ========================================================================
# 1. ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã®ä½œæˆ
# ========================================================================

#' R/BRç¾¤åˆ†ã‘ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã‚’ä½œæˆ
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @param config è¨­å®šãƒªã‚¹ãƒˆ
#' @return ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
create_stage_variables <- function(df, config = NULL) {
  
  message("\nğŸ·ï¸ Creating stage variables...")
  
  # æ‰‹è¡“æ™‚ç¾¤åˆ†ã‘ï¼ˆR/BR1/BR2ï¼‰
  surg_pattern <- "æ‰‹è¡“æ™‚ç¾¤åˆ†ã‘\\s*R\\s*/\\s*BR1\\s*/\\s*BR2"
  surg_cols <- grep(surg_pattern, names(df), value = TRUE, perl = TRUE)
  
  if (length(surg_cols) > 0) {
    df$stage_surg <- factor(
      df[[surg_cols[1]]], 
      levels = c("R", "BR1", "BR2")
    )
    message("  âœ“ Created: stage_surg")
  }
  
  # è¨ºæ–­æ™‚ç¾¤åˆ†ã‘ï¼ˆR/BR1/BR2ï¼‰
  diag_pattern <- "è¨ºæ–­æ™‚ç¾¤åˆ†ã‘\\s*R\\s*/\\s*BR1\\s*/\\s*BR2"
  diag_cols <- grep(diag_pattern, names(df), value = TRUE, perl = TRUE)
  
  if (length(diag_cols) > 0) {
    df$stage_diag <- factor(
      df[[diag_cols[1]]], 
      levels = c("R", "BR1", "BR2")
    )
    message("  âœ“ Created: stage_diag")
  }
  
  # R/BRäºŒåˆ†é¡ï¼ˆBR1ã¨BR2ã‚’BRã«çµ±åˆï¼‰
  rb_pattern <- "^ç¾¤åˆ†ã‘\\s*R\\s*/\\s*BR"
  rb_cols <- grep(rb_pattern, names(df), value = TRUE, perl = TRUE)
  
  if (length(rb_cols) > 0) {
    x <- stringr::str_squish(as.character(df[[rb_cols[1]]]))
    x <- ifelse(x %in% c("BR1", "BR2"), "BR", x)
    df$group_rb <- factor(x, levels = c("R", "BR"))
    message("  âœ“ Created: group_rb")
  } else if ("stage_surg" %in% names(df)) {
    # stage_surgã‹ã‚‰ä½œæˆ
    x <- as.character(df$stage_surg)
    x[x %in% c("BR1", "BR2")] <- "BR"
    df$group_rb <- factor(x, levels = c("R", "BR"))
    message("  âœ“ Created: group_rb (from stage_surg)")
  } else if ("stage_diag" %in% names(df)) {
    # stage_diagã‹ã‚‰ä½œæˆ
    x <- as.character(df$stage_diag)
    x[x %in% c("BR1", "BR2")] <- "BR"
    df$group_rb <- factor(x, levels = c("R", "BR"))
    message("  âœ“ Created: group_rb (from stage_diag)")
  }
  
  # éç™Œéƒ¨è‚ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆæ—§ï¼‰
  nc_candidates <- c(
    "StageI+II or III+IVã€€éç™Œéƒ¨è‚(æ—§å…¥åŠ›ï¼‰",
    "StageI+II or III+IV"
  )
  nc_cols <- intersect(nc_candidates, names(df))
  
  if (length(nc_cols) > 0 && !"nc_liver_stage_old" %in% names(df)) {
    df$nc_liver_stage_old <- df[[nc_cols[1]]]
    message("  âœ“ Created: nc_liver_stage_old")
  }
  
  return(df)
}

# ========================================================================
# 2. ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ã®å‚ç…§ãƒ¬ãƒ™ãƒ«è¨­å®š
# ========================================================================

#' ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ã®å‚ç…§ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @param config è¨­å®šãƒªã‚¹ãƒˆ
#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ
#' @return å‚ç…§ãƒ¬ãƒ™ãƒ«ãŒè¨­å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
set_reference_levels <- function(df, config = NULL, variables = NULL) {
  
  message("\nâš™ï¸ Setting reference levels for categorical variables...")
  
  # è¨­å®šã‹ã‚‰å‚ç…§ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
  ref_levels <- NULL
  if (!is.null(config) && !is.null(config$data_processing$reference_levels)) {
    ref_levels <- config$data_processing$reference_levels
  } else {
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‚ç…§ãƒ¬ãƒ™ãƒ«
    ref_levels <- list(
      sex = "F",
      group_rb = "R",
      stage_surg = "R",
      stage_diag = "R",
      vital_status = "ç”Ÿ",
      vital10 = "TRUE",
      recur_tf = "FALSE",
      eventfree10 = "FALSE"
    )
  }
  
  # å‚ç…§ãƒ¬ãƒ™ãƒ«ã®è¨­å®š
  for (var_name in names(ref_levels)) {
    if (var_name %in% names(df)) {
      current_levels <- unique(as.character(df[[var_name]]))
      ref_level <- ref_levels[[var_name]]
      
      if (ref_level %in% current_levels) {
        # å‚ç…§ãƒ¬ãƒ™ãƒ«ã‚’å…ˆé ­ã«é…ç½®
        other_levels <- setdiff(current_levels, ref_level)
        new_levels <- c(ref_level, other_levels)
        
        df[[var_name]] <- factor(
          df[[var_name]], 
          levels = new_levels
        )
        
        message(sprintf("  âœ“ %s: reference = '%s'", var_name, ref_level))
      }
    }
  }
  
  # å¤‰æ•°å®šç¾©ã‹ã‚‰ã®è¿½åŠ è¨­å®š
  if (!is.null(variables) && !is.null(variables$column_mappings)) {
    for (mapping in variables$column_mappings) {
      col_name <- mapping$name
      
      if (col_name %in% names(df) && !is.null(mapping$reference)) {
        if (is.factor(df[[col_name]]) || is.character(df[[col_name]])) {
          current_levels <- unique(as.character(df[[col_name]]))
          
          if (as.character(mapping$reference) %in% current_levels) {
            other_levels <- setdiff(current_levels, as.character(mapping$reference))
            new_levels <- c(as.character(mapping$reference), other_levels)
            
            df[[col_name]] <- factor(
              df[[col_name]], 
              levels = new_levels
            )
          }
        }
      }
    }
  }
  
  return(df)
}

# ========================================================================
# 3. æ­»å› åˆ†é¡ã®ä½œæˆ
# ========================================================================

#' æ­»å› ã‚’4åˆ†é¡ã«æ•´ç†
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @return æ­»å› åˆ†é¡ãŒè¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
create_death_cause_categories <- function(df) {
  
  if ("æ­»å› " %in% names(df)) {
    message("\nğŸ’€ Creating death cause categories...")
    
    y <- stringr::str_squish(as.character(df$æ­»å› ))
    
    # ãã®ä»–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
    other_pattern <- "(ä»–ç—…æ­»(ï¼ˆè€è¡°ï¼‰|\\(è€è¡°\\))?|æ•—è¡€ç—‡|æ­»ï¼ˆåŸå› ä¸æ˜ï¼‰|æ­»\\(åŸå› ä¸æ˜\\))"
    
    df$death_cause4 <- dplyr::case_when(
      is.na(y) | y == "" ~ "aliver",
      stringr::str_detect(y, "ç™Œ") ~ "Cancer",
      stringr::str_detect(y, "è‚ä¸å…¨") ~ "LiverFailure",
      stringr::str_detect(y, other_pattern) ~ "Other",
      TRUE ~ "Other"
    ) %>%
      factor(levels = c("aliver", "Cancer", "LiverFailure", "Other"))
    
    message("  âœ“ Created: death_cause4")
    
    # é›†è¨ˆè¡¨ç¤º
    death_table <- table(df$death_cause4, useNA = "ifany")
    message("  Distribution:")
    for (i in seq_along(death_table)) {
      message(sprintf("    %s: %d", names(death_table)[i], death_table[i]))
    }
  }
  
  return(df)
}

# ========================================================================
# 4. é †åºå› å­ã®è¨­å®š
# ========================================================================

#' é †åºå› å­å¤‰æ•°ã‚’é©åˆ‡ã«è¨­å®š
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ
#' @return é †åºå› å­ãŒè¨­å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
set_ordered_factors <- function(df, variables = NULL) {
  
  message("\nğŸ“Š Setting ordered factors...")
  
  # è„ˆç®¡ä¾µè¥²ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼ˆ0-4ï¼‰
  vi_vars <- c("vp_pre", "vv_pre", "vp_path", "vv_path", "va_path", "b_path")
  
  for (var in vi_vars) {
    if (var %in% names(df)) {
      df[[var]] <- ordered(
        df[[var]], 
        levels = c(0, 1, 2, 3, 4)
      )
      message(sprintf("  âœ“ %s: ordered (0-4)", var))
    }
  }
  
  # PS (Performance Status)
  if ("ps" %in% names(df)) {
    df$ps <- ordered(df$ps, levels = c(0, 1, 2, 3, 4))
    message("  âœ“ ps: ordered (0-4)")
  }
  
  # ASAåˆ†é¡
  if ("asa" %in% names(df)) {
    df$asa <- ordered(df$asa, levels = c(1, 2, 3, 4, 5, 6))
    message("  âœ“ asa: ordered (1-6)")
  }
  
  # åˆä½µç—‡ã‚°ãƒ¬ãƒ¼ãƒ‰
  comp_vars <- c("comp_any_grade", "comp_pleural", "comp_bleeding", "comp_ascites")
  
  for (var in comp_vars) {
    if (var %in% names(df)) {
      df[[var]] <- ordered(df[[var]], levels = c(0, 1, 2, 3))
      message(sprintf("  âœ“ %s: ordered (0-3)", var))
    }
  }
  
  # ç·šç¶­åŒ–ãƒ»ç‚ç—‡ã‚¹ã‚³ã‚¢
  if ("fibrosis_score" %in% names(df)) {
    df$fibrosis_score <- ordered(df$fibrosis_score, levels = c(0, 1, 2, 3, 4))
    message("  âœ“ fibrosis_score: ordered (0-4)")
  }
  
  if ("grading_score" %in% names(df)) {
    df$grading_score <- ordered(df$grading_score, levels = c(0, 1, 2, 3))
    message("  âœ“ grading_score: ordered (0-3)")
  }
  
  return(df)
}

# ========================================================================
# 5. ç‰¹æ®Šãªå¤‰æ•°ã®å‡¦ç†
# ========================================================================

#' ç‰¹æ®Šãªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®å¤‰æ•°ã‚’å‡¦ç†
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @return å‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
handle_special_variables <- function(df) {
  
  message("\nğŸ”§ Handling special variable codings...")
  
  # fc, fc_inf, sf, sm ã®å‡¦ç†ï¼ˆ-/+ ã‚’ 0/1ã«ï¼‰
  margin_vars <- c("fc", "fc_inf", "sf", "sm")
  
  for (var in margin_vars) {
    if (var %in% names(df)) {
      x <- as.character(df[[var]])
      x <- dplyr::recode(x, "-" = "0", "+" = "1", .default = NA_character_)
      df[[var]] <- factor(x, levels = c("0", "1"))
      message(sprintf("  âœ“ %s: converted -/+ to 0/1", var))
    }
  }
  
  # im (intrahepatic metastasis) ã®å‡¦ç†
  # 0ã‚’åŸºæº–ã€1/2/3/+ã¯1ã€S/Xã¯æ¬ ææ‰±ã„
  if ("im" %in% names(df)) {
    x <- as.character(df$im)
    
    df$im <- dplyr::case_when(
      is.na(x) ~ NA_character_,
      x %in% c("S", "X") ~ NA_character_,
      x %in% c("0") ~ "0",
      x %in% c("1", "2", "3", "+") ~ "1",
      TRUE ~ NA_character_
    ) %>%
      factor(levels = c("0", "1"))
    
    message("  âœ“ im: standardized (0 vs 1+)")
  }
  
  # HBV ã®å‡¦ç†
  if ("hbv" %in% names(df)) {
    # ãƒ¬ãƒ™ãƒ«ã®ç¢ºèªã¨çµ±ä¸€
    df$hbv <- factor(df$hbv, levels = c("-", "Â±", "+", "*"))
    message("  âœ“ hbv: factor levels set")
  }
  
  # HCV ã®å‡¦ç†ï¼ˆTRUE/FALSEã‚’0/1ã«ï¼‰
  if ("hcv" %in% names(df)) {
    if (is.logical(df$hcv)) {
      df$hcv <- factor(as.integer(df$hcv), levels = c(0, 1))
      message("  âœ“ hcv: converted logical to 0/1")
    } else {
      df$hcv <- factor(df$hcv, levels = c(0, 1))
    }
  }
  
  # Child-Pughåˆ†é¡
  if ("child_pugh" %in% names(df)) {
    df$child_pugh <- factor(df$child_pugh, levels = c("A", "B", "C"))
    message("  âœ“ child_pugh: factor levels set (A/B/C)")
  }
  
  # è‚éšœå®³åº¦
  if ("liver_damage" %in% names(df)) {
    df$liver_damage <- factor(df$liver_damage, levels = c("A", "B", "C"))
    message("  âœ“ liver_damage: factor levels set (A/B/C)")
  }
  
  return(df)
}

# ========================================================================
# 5.5. æ—¥ä»˜å¤‰æ•°ã®å‡¦ç†ï¼ˆè¿½åŠ ï¼‰
# ========================================================================

#' æ—¥ä»˜å¤‰æ•°ã‚’å‡¦ç†ã—ã¦op_dateãªã©ã‚’ä½œæˆ
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @return å‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
process_date_variables <- function(df) {
  
  message("\nğŸ“… Processing date variables...")
  
  # to_date_excel_mixedé–¢æ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
  if (!exists("to_date_excel_mixed")) {
    # ç°¡æ˜“ç‰ˆã®æ—¥ä»˜å¤‰æ›é–¢æ•°
    to_date_excel_mixed <- function(x) {
      if (inherits(x, "Date")) return(x)
      return(as.Date(x))
    }
  }
  
  # æ‰‹è¡“æ—¥ â†’ op_date
  if ("æ‰‹è¡“æ—¥" %in% names(df) && !"op_date" %in% names(df)) {
    df$op_date <- to_date_excel_mixed(df$æ‰‹è¡“æ—¥)
    message("  âœ“ Created: op_date from æ‰‹è¡“æ—¥")
  }
  
  # æœ€çµ‚ç¢ºèªæ—¥ â†’ last_followup
  if ("æœ€çµ‚ç¢ºèªæ—¥" %in% names(df) && !"last_followup" %in% names(df)) {
    df$last_followup <- to_date_excel_mixed(df$æœ€çµ‚ç¢ºèªæ—¥)
    message("  âœ“ Created: last_followup from æœ€çµ‚ç¢ºèªæ—¥")
  }
  
  # åˆè¨ºæ—¥ â†’ first_visit_dt
  if ("åˆè¨ºæ—¥" %in% names(df) && !"first_visit_dt" %in% names(df)) {
    df$first_visit_dt <- to_date_excel_mixed(df$åˆè¨ºæ—¥)
    message("  âœ“ Created: first_visit_dt from åˆè¨ºæ—¥")
  }
  
  # å…¥é™¢æ—¥ â†’ adm_dt
  if ("å…¥é™¢æ—¥" %in% names(df) && !"adm_dt" %in% names(df)) {
    df$adm_dt <- to_date_excel_mixed(df$å…¥é™¢æ—¥)
    message("  âœ“ Created: adm_dt from å…¥é™¢æ—¥")
  }
  
  # å†ç™ºæ—¥ â†’ recur_date
  if ("å†ç™ºæ—¥" %in% names(df) && !"recur_date" %in% names(df)) {
    df$recur_date <- to_date_excel_mixed(df$å†ç™ºæ—¥)
    message("  âœ“ Created: recur_date from å†ç™ºæ—¥")
  }
  
  # date of birth â†’ dob
  if ("date of birth" %in% names(df) && !"dob" %in% names(df)) {
    df$dob <- to_date_excel_mixed(df$`date of birth`)
    message("  âœ“ Created: dob from date of birth")
  }
  
  return(df)
}

# ========================================================================
# 6. ä½“ç©å¤‰æ•°ã®å‡¦ç†
# ========================================================================

#' ä½“ç©å¤‰æ•°ã‚’äºŒå€¤åŒ–ï¼ˆ0/é0ï¼‰
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @return å‡¦ç†å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
process_volume_variables <- function(df) {
  
  message("\nğŸ“ Processing volume variables...")
  
  volume_vars <- c(
    "liver_vol", 
    "tumor_vol", 
    "remnant_vol", 
    "func_resect_rate"
  )
  
  for (var in volume_vars) {
    if (var %in% names(df)) {
      # å…ƒã®å¤‰æ•°åã‚’ä¿æŒï¼ˆ_origã¨ã„ã†åå‰ã§ï¼‰
      df[[paste0(var, "_orig")]] <- df[[var]]
      
      # äºŒå€¤åŒ–ï¼ˆ0 vs >0ï¼‰
      df[[var]] <- factor(
        dplyr::case_when(
          is.na(df[[var]]) ~ NA_real_,
          df[[var]] > 0 ~ 1,
          TRUE ~ 0
        ),
        levels = c(0, 1)
      )
      
      message(sprintf("  âœ“ %s: binarized (0 vs >0)", var))
    }
  }
  
  return(df)
}

# ========================================================================
# 7. ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯
# ========================================================================

#' ãƒ‡ãƒ¼ã‚¿å“è³ªã®åŒ…æ‹¬çš„ãƒã‚§ãƒƒã‚¯
#' @param df ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ 
#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ
#' @return ãƒã‚§ãƒƒã‚¯çµæœã®ãƒªã‚¹ãƒˆ
check_data_quality <- function(df, variables = NULL) {
  
  message("\nğŸ” Performing data quality checks...")
  
  issues <- list()
  
  # 1. å®Œå…¨é‡è¤‡è¡Œã®ãƒã‚§ãƒƒã‚¯
  dup_rows <- duplicated(df)
  if (any(dup_rows)) {
    issues$duplicate_rows <- which(dup_rows)
    message(sprintf("  âš  Found %d duplicate rows", sum(dup_rows)))
  }
  
  # 2. IDé‡è¤‡ã®ãƒã‚§ãƒƒã‚¯
  if ("id" %in% names(df)) {
    dup_ids <- df$id[duplicated(df$id)]
    if (length(dup_ids) > 0) {
      issues$duplicate_ids <- unique(dup_ids)
      message(sprintf("  âš  Found %d duplicate IDs", length(unique(dup_ids))))
    }
  }
  
  # 3. æ—¥ä»˜ã®è«–ç†ãƒã‚§ãƒƒã‚¯
  date_checks <- list(
    list(early = "op_date", late = "recur_date", 
         msg = "Recurrence before surgery"),
    list(early = "op_date", late = "last_followup", 
         msg = "Follow-up before surgery"),
    list(early = "dob", late = "op_date", 
         msg = "Surgery before birth")
  )
  
  for (check in date_checks) {
    if (all(c(check$early, check$late) %in% names(df))) {
      early_dates <- df[[check$early]]
      late_dates <- df[[check$late]]
      
      if (inherits(early_dates, "Date") && inherits(late_dates, "Date")) {
        invalid <- which(!is.na(early_dates) & !is.na(late_dates) & 
                        early_dates > late_dates)
        
        if (length(invalid) > 0) {
          issues[[paste0("date_", check$early, "_", check$late)]] <- invalid
          message(sprintf("  âš  %s: %d cases", check$msg, length(invalid)))
        }
      }
    }
  }
  
  # 4. ç”Ÿå­˜æœŸé–“ã®è«–ç†ãƒã‚§ãƒƒã‚¯
  if (all(c("os_months", "rfs_months") %in% names(df))) {
    # RFS > OS ã®ãƒã‚§ãƒƒã‚¯
    invalid_surv <- which(!is.na(df$os_months) & !is.na(df$rfs_months) & 
                         df$rfs_months > df$os_months)
    
    if (length(invalid_surv) > 0) {
      issues$rfs_exceeds_os <- invalid_surv
      message(sprintf("  âš  RFS exceeds OS: %d cases", length(invalid_surv)))
    }
  }
  
  # 5. ç¯„å›²å¤–ã®å€¤ãƒã‚§ãƒƒã‚¯
  if (!is.null(variables) && !is.null(variables$column_mappings)) {
    for (mapping in variables$column_mappings) {
      col_name <- mapping$name
      
      if (col_name %in% names(df) && !is.null(mapping$range)) {
        x <- suppressWarnings(as.numeric(df[[col_name]]))
        
        if (any(!is.na(x))) {
          out_of_range <- which(!is.na(x) & 
                               (x < mapping$range[1] | x > mapping$range[2]))
          
          if (length(out_of_range) > 0) {
            issues[[paste0("range_", col_name)]] <- out_of_range
            message(sprintf("  âš  %s out of range [%g, %g]: %d cases",
                           col_name, mapping$range[1], mapping$range[2],
                           length(out_of_range)))
          }
        }
      }
    }
  }
  
  # çµæœã‚µãƒãƒªãƒ¼
  if (length(issues) == 0) {
    message("  âœ… No data quality issues found")
  } else {
    message(sprintf("\n  Total issues found: %d types", length(issues)))
  }
  
  return(issues)
}

# ========================================================================
# 8. çµ±åˆã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°é–¢æ•°
# ========================================================================

#' ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
#' @param dm DatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
#' @param config è¨­å®šãƒªã‚¹ãƒˆ
#' @param variables å¤‰æ•°å®šç¾©ãƒªã‚¹ãƒˆ
#' @return æ›´æ–°ã•ã‚ŒãŸDatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
clean_data_pipeline <- function(dm, config = NULL, variables = NULL) {
  
  message("\n========================================")
  message("Starting Data Cleaning Pipeline")
  message("========================================")
  
  # ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  df <- dm$get_current()
  current_version <- dm$current_version
  
  # 1. ã‚¹ãƒ†ãƒ¼ã‚¸å¤‰æ•°ã®ä½œæˆ (ds04)
  df_stage <- create_stage_variables(df, config)
  dm$add_version(df_stage, version = current_version + 1)
  
  # 2. æ­»å› åˆ†é¡ã®ä½œæˆ (ds05)
  df_death <- create_death_cause_categories(df_stage)
  dm$add_version(df_death, version = current_version + 2)
  
  # 3. å‚ç…§ãƒ¬ãƒ™ãƒ«ã®è¨­å®š (ds06)
  df_ref <- set_reference_levels(df_death, config, variables)
  dm$add_version(df_ref, version = current_version + 3)
  
  # 4. é †åºå› å­ã®è¨­å®š (ds07)
  df_ordered <- set_ordered_factors(df_ref, variables)
  dm$add_version(df_ordered, version = current_version + 4)
  
  # 5. ç‰¹æ®Šå¤‰æ•°ã®å‡¦ç† (ds08)
  df_special <- handle_special_variables(df_ordered)
  dm$add_version(df_special, version = current_version + 5)
  
  # 5.5. æ—¥ä»˜å¤‰æ•°ã®å‡¦ç† (ds09) â† è¿½åŠ 
  df_dates <- process_date_variables(df_special)
  dm$add_version(df_dates, version = current_version + 6)
  
  # 6. ä½“ç©å¤‰æ•°ã®å‡¦ç† (ds10) â† ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’èª¿æ•´
  df_volume <- process_volume_variables(df_dates)  # df_special â†’ df_dates ã«å¤‰æ›´
  dm$add_version(df_volume, version = current_version + 7)
  
  # 7. å“è³ªãƒã‚§ãƒƒã‚¯
  quality_issues <- check_data_quality(df_volume, variables)
  
  # å“è³ªå•é¡Œã‚’å±æ€§ã¨ã—ã¦ä¿å­˜
  attr(df_volume, "quality_issues") <- quality_issues
  
  # æœ€çµ‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
  dm$add_version(df_volume, version = current_version + 7)
  
  # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
  dm$summary()
  
  message("\nâœ… Data cleaning pipeline completed!")
  message("========================================\n")
  
  return(dm)
}

# ========================================================================
# 9. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
# ========================================================================

#' ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‰å¾Œã®æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆ
#' @param dm DatasetManagerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
#' @param before_version ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
#' @param after_version ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å¾Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
#' @return æ¯”è¼ƒçµæœ
compare_cleaning_results <- function(dm, 
                                    before_version = 3, 
                                    after_version = NULL) {
  
  if (is.null(after_version)) {
    after_version <- dm$current_version
  }
  
  df_before <- dm$get_version(before_version)
  df_after <- dm$get_version(after_version)
  
  message("\nğŸ“Š Cleaning Comparison Report")
  message("========================================")
  
  # åˆ—æ•°ã®å¤‰åŒ–
  cols_added <- setdiff(names(df_after), names(df_before))
  cols_removed <- setdiff(names(df_before), names(df_after))
  
  message(sprintf("Columns: %d â†’ %d", ncol(df_before), ncol(df_after)))
  
  if (length(cols_added) > 0) {
    message(sprintf("  Added: %s", paste(cols_added, collapse = ", ")))
  }
  
  if (length(cols_removed) > 0) {
    message(sprintf("  Removed: %s", paste(cols_removed, collapse = ", ")))
  }
  
  # å‹ã®å¤‰åŒ–
  common_cols <- intersect(names(df_before), names(df_after))
  type_changes <- character()
  
  for (col in common_cols) {
    type_before <- class(df_before[[col]])[1]
    type_after <- class(df_after[[col]])[1]
    
    if (type_before != type_after) {
      type_changes <- c(type_changes, 
                       sprintf("%s: %s â†’ %s", col, type_before, type_after))
    }
  }
  
  if (length(type_changes) > 0) {
    message("\nType changes:")
    for (change in head(type_changes, 10)) {
      message("  ", change)
    }
    if (length(type_changes) > 10) {
      message(sprintf("  ... and %d more", length(type_changes) - 10))
    }
  }
  
  message("========================================\n")
  
  invisible(list(
    cols_added = cols_added,
    cols_removed = cols_removed,
    type_changes = type_changes
  ))
}
```

