"0","# ========================================"
"0","# Calibrationã®çµ±è¨ˆçš„æ¤œå®š"
"0","# ========================================"
"0",""
"0","message(""\nğŸ“Š Statistical Tests for Calibration"")"
"2","
ğŸ“Š Statistical Tests for Calibration
"
"0","message(paste(rep(""="", 50), collapse = """"))"
"2","==================================================
"
"0","# 1. Calibration Slopeã®ä¿¡é ¼åŒºé–“ã¨æ¤œå®š"
"0","test_calibration_slope <- function(model, data, B = 100) {"
"0","  "
"0","  # äºˆæ¸¬å€¤ï¼ˆç·šå½¢äºˆæ¸¬å­ï¼‰"
"0","  lp <- predict(model, newdata = data, type = ""lp"")"
"0","  "
"0","  # Calibration model: å®Ÿéš›ã®ã‚¢ã‚¦ãƒˆã‚«ãƒ  ~ äºˆæ¸¬å€¤"
"0","  cal_cox <- coxph(data$surv_obj ~ lp, data = data)"
"0","  "
"0","  # Slopeï¼ˆç†æƒ³ã¯1.0ï¼‰"
"0","  slope <- coef(cal_cox)"
"0","  se <- sqrt(vcov(cal_cox)[1,1])"
"0","  "
"0","  # 95%ä¿¡é ¼åŒºé–“"
"0","  ci_lower <- slope - 1.96 * se"
"0","  ci_upper <- slope + 1.96 * se"
"0","  "
"0","  # H0: slope = 1 ã®æ¤œå®š"
"0","  z_stat <- (slope - 1) / se"
"0","  p_value <- 2 * pnorm(-abs(z_stat))"
"0","  "
"0","  result <- list("
"0","    slope = slope,"
"0","    se = se,"
"0","    ci = c(ci_lower, ci_upper),"
"0","    z_stat = z_stat,"
"0","    p_value = p_value,"
"0","    interpretation = ifelse(p_value < 0.05, "
"0","                           ""Significant miscalibration"", "
"0","                           ""Adequate calibration"")"
"0","  )"
"0","  "
"0","  return(result)"
"0","}"
"0",""
"0","# 2. GrÃ¸nnesby-Borgan Testï¼ˆCoxå›å¸°ç”¨ã®Hosmer-Lemeshowæ¤œå®šï¼‰"
"0","gronnesby_borgan_test <- function(model, data, g = 10) {"
"0","  "
"0","  # ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ã§ç¾¤åˆ†ã‘"
"0","  risk <- predict(model, newdata = data, type = ""risk"")"
"0","  "
"0","  # gç¾¤ã«åˆ†å‰²"
"0","  risk_groups <- cut(risk, "
"0","                    breaks = quantile(risk, probs = seq(0, 1, 1/g)),"
"0","                    include.lowest = TRUE,"
"0","                    labels = FALSE)"
"0","  "
"0","  # å„ç¾¤ã®è¦³å¯Ÿãƒ»æœŸå¾…ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’è¨ˆç®—"
"0","  obs_events <- numeric(g)"
"0","  exp_events <- numeric(g)"
"0","  "
"0","  for(i in 1:g) {"
"0","    group_data <- data[risk_groups == i, ]"
"0","    "
"0","    # è¦³å¯Ÿã‚¤ãƒ™ãƒ³ãƒˆæ•°"
"0","    obs_events[i] <- sum(group_data$recur_2y == TRUE)"
"0","    "
"0","    # æœŸå¾…ã‚¤ãƒ™ãƒ³ãƒˆæ•°ï¼ˆNelson-Aalenæ¨å®šé‡ã‚’ä½¿ç”¨ï¼‰"
"0","    fit <- survfit(model, newdata = group_data)"
"0","    # 24ãƒ¶æœˆæ™‚ç‚¹ã§ã®æœŸå¾…ã‚¤ãƒ™ãƒ³ãƒˆç‡"
"0","    surv_24m <- summary(fit, times = 24)$surv"
"0","    exp_prob <- 1 - mean(surv_24m, na.rm = TRUE)"
"0","    exp_events[i] <- exp_prob * nrow(group_data)"
"0","  }"
"0","  "
"0","  # ã‚«ã‚¤äºŒä¹—çµ±è¨ˆé‡"
"0","  chi_sq <- sum((obs_events - exp_events)^2 / exp_events, na.rm = TRUE)"
"0","  df <- g - 1"
"0","  p_value <- pchisq(chi_sq, df, lower.tail = FALSE)"
"0","  "
"0","  result <- list("
"0","    chi_squared = chi_sq,"
"0","    df = df,"
"0","    p_value = p_value,"
"0","    groups = g,"
"0","    observed = obs_events,"
"0","    expected = exp_events,"
"0","    interpretation = ifelse(p_value < 0.05,"
"0","                           ""Poor calibration"","
"0","                           ""Good calibration"")"
"0","  )"
"0","  "
"0","  return(result)"
"0","}"
"0",""
"0","# 3. ICI (Integrated Calibration Index)ã¨E50/E90"
"0","calculate_ici <- function(predicted, observed) {"
"0","  # äºˆæ¸¬ã¨è¦³å¯Ÿã®çµ¶å¯¾å·®ã®å¹³å‡"
"0","  ici <- mean(abs(predicted - observed))"
"0","  "
"0","  # E50: 50ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«èª¤å·®"
"0","  e50 <- quantile(abs(predicted - observed), 0.50)"
"0","  "
"0","  # E90: 90ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«èª¤å·®"
"0","  e90 <- quantile(abs(predicted - observed), 0.90)"
"0","  "
"0","  return(list("
"0","    ICI = ici,"
"0","    E50 = e50,"
"0","    E90 = e90,"
"0","    interpretation = case_when("
"0","      ici < 0.05 ~ ""Excellent calibration"","
"0","      ici < 0.10 ~ ""Good calibration"","
"0","      ici < 0.15 ~ ""Moderate calibration"","
"0","      TRUE ~ ""Poor calibration"""
"0","    )"
"0","  ))"
"0","}"
"0",""
"0","# 4. å®Ÿè¡Œ"
"0","message(""\n--- Testing Best Model Calibration ---"")"
"2","
--- Testing Best Model Calibration ---
"
"0","# Test setã§ã®æ¤œå®š"
"0","if (exists(""best_model"") && exists(""split_data_fixed"")) {"
"0","  "
"0","  test_data <- split_data_fixed$test"
"0","  "
"0","  # Calibration slope test"
"0","  message(""\n1. Calibration Slope Test:"")"
"0","  slope_test <- test_calibration_slope(best_model, test_data)"
"0","  message(sprintf(""  Slope: %.3f (95%% CI: %.3f-%.3f)"", "
"0","                 slope_test$slope, slope_test$ci[1], slope_test$ci[2]))"
"0","  message(sprintf(""  H0: slope=1, p-value: %.4f"", slope_test$p_value))"
"0","  message(sprintf(""  Interpretation: %s"", slope_test$interpretation))"
"0","  "
"0","  # GrÃ¸nnesby-Borgan test"
"0","  message(""\n2. GrÃ¸nnesby-Borgan Test:"")"
"0","  gb_test <- gronnesby_borgan_test(best_model, test_data, g = 10)"
"0","  message(sprintf(""  Chi-squared: %.2f (df=%d)"", gb_test$chi_squared, gb_test$df))"
"0","  message(sprintf(""  p-value: %.4f"", gb_test$p_value))"
"0","  message(sprintf(""  Interpretation: %s"", gb_test$interpretation))"
"0","  "
"0","  # ICIè¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰"
"0","  message(""\n3. Calibration Metrics:"")"
"0","  pred_prob <- get_predictions(best_model, test_data, time_point = 24)"
"0","  obs_prob <- as.numeric(test_data$recur_2y)"
"0","  "
"0","  ici_result <- calculate_ici(pred_prob, obs_prob)"
"0","  message(sprintf(""  ICI: %.3f"", ici_result$ICI))"
"0","  message(sprintf(""  E50: %.3f"", ici_result$E50))"
"0","  message(sprintf(""  E90: %.3f"", ici_result$E90))"
"0","  message(sprintf(""  Interpretation: %s"", ici_result$interpretation))"
"0","}"
"2","
1. Calibration Slope Test:
"
"2","  Slope: 1.044 (95% CI: 0.778-1.310)
"
"2","  H0: slope=1, p-value: 0.7470
"
"2","  Interpretation: Adequate calibration
"
"2","
2. GrÃ¸nnesby-Borgan Test:
"
"2","  Chi-squared: 13.42 (df=9)
"
"2","  p-value: 0.1446
"
"2","  Interpretation: Good calibration
"
"2","
3. Calibration Metrics:
"
"2","  ICI: 0.753
"
"2","  E50: 0.651
"
"2","  E90: 1.401
"
"2","  Interpretation: Poor calibration
"
"0","# 5. Bootstrapä¿¡é ¼åŒºé–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰"
"0","if (FALSE) {  # æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯OFF"
"0","  message(""\n4. Bootstrap Confidence Intervals:"")"
"0","  "
"0","  bootstrap_calibration <- function(model, data, B = 100) {"
"0","    slopes <- numeric(B)"
"0","    "
"0","    for(i in 1:B) {"
"0","      # ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°"
"0","      idx <- sample(nrow(data), replace = TRUE)"
"0","      boot_data <- data[idx, ]"
"0","      "
"0","      # Calibration slopeè¨ˆç®—"
"0","      lp <- predict(model, newdata = boot_data, type = ""lp"")"
"0","      cal_cox <- coxph(boot_data$surv_obj ~ lp, data = boot_data)"
"0","      slopes[i] <- coef(cal_cox)"
"0","    }"
"0","    "
"0","    return(list("
"0","      mean_slope = mean(slopes),"
"0","      ci_95 = quantile(slopes, c(0.025, 0.975)),"
"0","      se = sd(slopes)"
"0","    ))"
"0","  }"
"0","  "
"0","  boot_result <- bootstrap_calibration(best_model, test_data, B = 100)"
"0","  message(sprintf(""  Bootstrap slope: %.3f (95%% CI: %.3f-%.3f)"","
"0","                 boot_result$mean_slope, "
"0","                 boot_result$ci_95[1], "
"0","                 boot_result$ci_95[2]))"
"0","}"
