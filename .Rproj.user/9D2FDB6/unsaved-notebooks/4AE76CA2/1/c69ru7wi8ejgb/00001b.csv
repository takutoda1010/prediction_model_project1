"2","
✓ Full coefficient table saved to: all_model_coefficients.csv
"
"2","
Top 10 most frequently selected variables:
"
"1","
"
"1","    ALBIscore "
"1","            t "
"1","stage_diagBR1 "
"1","stage_diagBR2 "
"1","          alb "
"1","liver_damageB "
"1","liver_damageC "
"1","
"
"1","            7 "
"1","            7 "
"1","            5 "
"1","            5 "
"1","            4 "
"1","            4 "
"1","            4 "
"1","
"
"1","  macroVITRUE "
"1","  microVITRUE "
"1","          sm1 "
"1","
"
"1","            4 "
"1","            4 "
"1","            4 "
"1","
"
"0","# ========================================"
"0","# 質問5: 予測の方向性確認"
"0","# ========================================"
"0",""
"0","message(""\n"" , paste(rep(""="", 60), collapse = """"))"
"2","
============================================================
"
"0","message(""Q5: Prediction Direction Check"")"
"2","Q5: Prediction Direction Check
"
"0","message(paste(rep(""="", 60), collapse = """"), ""\n"")"
"2","============================================================

"
"0","# ベストモデルで確認"
"0","if (exists(""best_model"") && exists(""split_data_fixed"")) {"
"0","  test_data <- split_data_fixed$test"
"0","  "
"0","  # リスクスコアを取得"
"0","  if (inherits(best_model, ""coxph"")) {"
"0","    risk_scores <- predict(best_model, newdata = test_data, type = ""risk"")"
"0","    lp_scores <- predict(best_model, newdata = test_data, type = ""lp"")"
"0","  }"
"0","  "
"0","  # 実際の再発との関係"
"0","  actual_recurrence <- as.numeric(test_data$recur_2y == TRUE | test_data$recur_2y == ""TRUE"")"
"0","  "
"0","  # 相関を確認"
"0","  cor_risk <- cor(risk_scores, actual_recurrence, use = ""complete.obs"")"
"0","  cor_lp <- cor(lp_scores, actual_recurrence, use = ""complete.obs"")"
"0","  "
"0","  message(""Prediction Direction Verification:"")"
"0","  message(sprintf(""  Correlation (risk score vs actual recurrence): %.3f"", cor_risk))"
"0","  message(sprintf(""  Correlation (linear predictor vs actual recurrence): %.3f"", cor_lp))"
"0","  "
"0","  # 高リスク群と低リスク群の再発率"
"0","  risk_median <- median(risk_scores)"
"0","  high_risk <- actual_recurrence[risk_scores > risk_median]"
"0","  low_risk <- actual_recurrence[risk_scores <= risk_median]"
"0","  "
"0","  message(""\nRisk Stratification Check:"")"
"0","  message(sprintf(""  High risk group recurrence rate: %.1f%%"", mean(high_risk) * 100))"
"0","  message(sprintf(""  Low risk group recurrence rate: %.1f%%"", mean(low_risk) * 100))"
"0","  "
"0","  if (mean(high_risk) > mean(low_risk)) {"
"0","    message(""  ✓ Correct: Model predicts RECURRENCE (higher scores = higher risk)"")"
"0","  } else {"
"0","    message(""  ✗ Inverted: Model might be predicting NON-recurrence"")"
"0","  }"
"0","}"
"2","Prediction Direction Verification:
"
"2","  Correlation (risk score vs actual recurrence): 0.394
"
"2","  Correlation (linear predictor vs actual recurrence): 0.461
"
"2","
Risk Stratification Check:
"
"2","  High risk group recurrence rate: 54.3%
"
"2","  Low risk group recurrence rate: 13.7%
"
"2","  ✓ Correct: Model predicts RECURRENCE (higher scores = higher risk)
"
"0","# ========================================"
"0","# 質問6: Test setのパフォーマンス分析"
"0","# ========================================"
"0",""
"0","message(""\n"" , paste(rep(""="", 60), collapse = """"))"
"2","
============================================================
"
"0","message(""Q6: Test Set Performance Analysis"")"
"2","Q6: Test Set Performance Analysis
"
"0","message(paste(rep(""="", 60), collapse = """"), ""\n"")"
"2","============================================================

"
"0","# 各セットの詳細な特性を比較"
"0","if (exists(""split_data_fixed"")) {"
"0","  "
"0","  dataset_characteristics <- data.frame()"
"0","  "
"0","  for (set_name in c(""train"", ""val"", ""test"")) {"
"0","    data <- split_data_fixed[[set_name]]"
"0","    "
"0","    if (!is.null(data)) {"
"0","      # 基本統計"
"0","      n <- nrow(data)"
"0","      events <- sum(data$recur_2y == TRUE, na.rm = TRUE)"
"0","      event_rate <- events / n"
"0","      "
"0","      # 時間的特性"
"0","      if (""op_date"" %in% names(data)) {"
"0","        date_range <- range(data$op_date, na.rm = TRUE)"
"0","        date_span <- as.numeric(date_range[2] - date_range[1]) / 365.25"
"0","      } else {"
"0","        date_range <- c(NA, NA)"
"0","        date_span <- NA"
"0","      }"
"0","      "
"0","      # フォローアップ期間"
"0","      if (""time2y"" %in% names(data)) {"
"0","        fu_median <- median(data$time2y, na.rm = TRUE)"
"0","        fu_mean <- mean(data$time2y, na.rm = TRUE)"
"0","      } else {"
"0","        fu_median <- NA"
"0","        fu_mean <- NA"
"0","      }"
"0","      "
"0","      dataset_characteristics <- rbind(dataset_characteristics, data.frame("
"0","        Dataset = set_name,"
"0","        N = n,"
"0","        Events = events,"
"0","        Event_Rate = sprintf(""%.1f%%"", event_rate * 100),"
"0","        Start_Date = as.character(date_range[1]),"
"0","        End_Date = as.character(date_range[2]),"
"0","        Span_Years = sprintf(""%.1f"", date_span),"
"0","        Median_FU = sprintf(""%.1f"", fu_median),"
"0","        Mean_FU = sprintf(""%.1f"", fu_mean)"
"0","      ))"
"0","    }"
"0","  }"
"0","  "
"0","  message(""Dataset Characteristics Comparison:"")"
"0","  print(dataset_characteristics)"
"0","  "
"0","  message(""\nPossible reasons for better test performance:"")"
"0","  message(""  1. Test set has more recent cases (surgical improvements)"")"
"0","  message(""  2. Different case mix or patient selection"")"
"0","  message(""  3. Temporal trends in outcomes"")"
"0","  message(""  4. Random variation (especially with smaller sample size)"")"
"0","}"
"2","Dataset Characteristics Comparison:
"
