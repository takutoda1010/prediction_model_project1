"0","# ========================================"
"0","# 質問1: reference_dateの確認"
"0","# ========================================"
"0",""
"0","message(""\n"" , paste(rep(""="", 60), collapse = """"))"
"2","
============================================================
"
"0","message(""Q1: Reference Date Investigation"")"
"2","Q1: Reference Date Investigation
"
"0","message(paste(rep(""="", 60), collapse = """"), ""\n"")"
"2","============================================================

"
"0","# split_dataのメタ情報から確認"
"0","if (exists(""split_data"") && !is.null(split_data$meta)) {"
"0","  message(""From split_data metadata:"")"
"0","  message(sprintf(""  Reference date: %s"", split_data$meta$reference_date))"
"0","  message(sprintf(""  Cutoff date: %s"", split_data$meta$cutoff_date))"
"0","  message(sprintf(""  Prediction months: %d"", split_data$meta$prediction_months))"
"0","  message(sprintf(""  Split method: %s"", split_data$meta$method))"
"0","}"
"2","From split_data metadata:
"
"2","  Reference date: 2025-11-13
"
"2","  Cutoff date: 2023-11-13
"
"2","  Prediction months: 24
"
"2","  Split method: temporal
"
"0","# 実際のデータの日付範囲を確認"
"0","if (""op_date"" %in% names(final_data)) {"
"0","  op_date_range <- range(final_data$op_date, na.rm = TRUE)"
"0","  message(""\nActual surgery date range in data:"")"
"0","  message(sprintf(""  Earliest: %s"", op_date_range[1]))"
"0","  message(sprintf(""  Latest: %s"", op_date_range[2]))"
"0","  "
"0","  # 最新手術日から今日までの経過月数"
"0","  months_from_latest <- as.numeric(Sys.Date() - op_date_range[2]) / 30.44"
"0","  message(sprintf(""  Months from latest surgery to today: %.1f months"", months_from_latest))"
"0","}"
"2","
Actual surgery date range in data:
"
"2","  Earliest: 2000-01-04
"
"2","  Latest: 2025-01-31
"
"2","  Months from latest surgery to today: 9.4 months
"
"0","# ========================================"
"0","# 質問2: DCAの解釈とイベント率"
"0","# ========================================"
"0",""
"0","message(""\n"" , paste(rep(""="", 60), collapse = """"))"
"2","
============================================================
"
"0","message(""Q2: DCA Interpretation & Event Rates"")"
"2","Q2: DCA Interpretation & Event Rates
"
"0","message(paste(rep(""="", 60), collapse = """"), ""\n"")"
"2","============================================================

"
"0","# 各データセットのイベント率を計算"
"0","calculate_event_rates <- function(data_list) {"
"0","  results <- data.frame()"
"0","  "
"0","  for (set_name in names(data_list)) {"
"0","    if (!is.null(data_list[[set_name]]) && ""recur_2y"" %in% names(data_list[[set_name]])) {"
"0","      data <- data_list[[set_name]]"
"0","      "
"0","      # 2年再発率"
"0","      events <- sum(data$recur_2y == TRUE | data$recur_2y == ""TRUE"", na.rm = TRUE)"
"0","      total <- nrow(data)"
"0","      event_rate <- events / total"
"0","      "
"0","      # 実際の2年以内イベント（時間も考慮）"
"0","      if (""time2y"" %in% names(data)) {"
"0","        events_2y <- sum(data$recur_2y == TRUE & data$time2y <= 24, na.rm = TRUE)"
"0","        event_rate_2y <- events_2y / total"
"0","      } else {"
"0","        event_rate_2y <- event_rate"
"0","      }"
"0","      "
"0","      results <- rbind(results, data.frame("
"0","        Dataset = set_name,"
"0","        N = total,"
"0","        Events = events,"
"0","        Event_Rate = sprintf(""%.1f%%"", event_rate * 100),"
"0","        Events_2y = events_2y,"
"0","        Event_Rate_2y = sprintf(""%.1f%%"", event_rate_2y * 100)"
"0","      ))"
"0","    }"
"0","  }"
"0","  "
"0","  return(results)"
"0","}"
"0",""
"0","# split_data_fixedで計算"
"0","if (exists(""split_data_fixed"")) {"
"0","  event_rates <- calculate_event_rates(split_data_fixed)"
"0","  message(""Event rates in each dataset:"")"
"0","  print(event_rates)"
"0","  "
"0","  message(""\nDCA Interpretation:"")"
"0","  message(""  - The intersection of 'Treat All' and 'Treat None' at ~0.33 threshold"")"
"0","  message(""    indicates the event rate in the test set is approximately 33%"")"
"0","  message(""  - Best Model and TNM Model show positive net benefit above this threshold"")"
"0","  message(""  - Models provide clinical value for threshold probabilities between ~0.15 and 0.45"")"
"0","}"
"2","Event rates in each dataset:
"
