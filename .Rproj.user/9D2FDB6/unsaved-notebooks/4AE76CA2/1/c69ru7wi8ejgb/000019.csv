"2","
DCA Interpretation:
"
"2","  - The intersection of 'Treat All' and 'Treat None' at ~0.33 threshold
"
"2","    indicates the event rate in the test set is approximately 33%
"
"2","  - Best Model and TNM Model show positive net benefit above this threshold
"
"2","  - Models provide clinical value for threshold probabilities between ~0.15 and 0.45
"
"0","# ========================================"
"0","# 質問3: Calibration統計量の詳細"
"0","# ========================================"
"0",""
"0","message(""\n"" , paste(rep(""="", 60), collapse = """"))"
"2","
============================================================
"
"0","message(""Q3: Calibration Statistics"")"
"2","Q3: Calibration Statistics
"
"0","message(paste(rep(""="", 60), collapse = """"), ""\n"")"
"2","============================================================

"
"0","# best_calibrationオブジェクトから統計量を取得"
"0","if (exists(""best_calibration"") && !is.null(best_calibration)) {"
"0","  message(""Calibration Statistics for Best Model:"")"
"0","  message(sprintf(""  Calibration-in-the-large (intercept): %.3f"", best_calibration$intercept))"
"0","  message(sprintf(""  Calibration slope: %.3f"", best_calibration$slope))"
"0","  "
"0","  message(""\nInterpretation:"")"
"0","  if (best_calibration$slope < 1) {"
"0","    message(""  - Slope < 1 indicates overfitting (model too extreme in predictions)"")"
"0","    message(""  - The model tends to overestimate high risks and underestimate low risks"")"
"0","  } else if (best_calibration$slope > 1) {"
"0","    message(""  - Slope > 1 indicates underfitting (predictions too moderate)"")"
"0","  } else {"
"0","    message(""  - Slope ≈ 1 indicates good calibration"")"
"0","  }"
"0","  "
"0","  if (best_calibration$intercept < 0) {"
"0","    message(""  - Negative intercept: model tends to overestimate risk overall"")"
"0","  } else if (best_calibration$intercept > 0) {"
"0","    message(""  - Positive intercept: model tends to underestimate risk overall"")"
"0","  }"
"0","  "
"0","  # Hosmer-Lemeshow test (optional)"
"0","  if (!is.null(best_calibration$groups)) {"
"0","    message(""\nCalibration by risk groups:"")"
"0","    print(best_calibration$groups[, c(""group"", ""n"", ""expected"", ""observed"")])"
"0","  }"
"0","}"
"2","Calibration Statistics for Best Model:
"
"2","  Calibration-in-the-large (intercept): -0.196
"
"2","  Calibration slope: 0.913
"
"2","
Interpretation:
"
"2","  - Slope < 1 indicates overfitting (model too extreme in predictions)
"
"2","  - The model tends to overestimate high risks and underestimate low risks
"
"2","  - Negative intercept: model tends to overestimate risk overall
"
"0","# ========================================"
"0","# 質問4: 各モデルの変数と統計量"
"0","# ========================================"
"0",""
"0","message(""\n"" , paste(rep(""="", 60), collapse = """"))"
"2","
============================================================
"
"0","message(""Q4: Model Variables and Coefficients"")"
"2","Q4: Model Variables and Coefficients
"
"0","message(paste(rep(""="", 60), collapse = """"), ""\n"")"
"2","============================================================

"
"0","# 全モデルの係数を抽出"
"0","extract_all_coefficients <- function(models) {"
"0","  all_coef <- list()"
"0","  "
"0","  for (model_name in names(models)) {"
"0","    model <- models[[model_name]]"
"0","    "
"0","    if (!is.null(model)) {"
"0","      # Coxphモデル"
"0","      if (inherits(model, ""coxph"")) {"
"0","        model_summary <- summary(model)"
"0","        coef_df <- as.data.frame(model_summary$coefficients)"
"0","        conf_int <- as.data.frame(model_summary$conf.int)"
"0","        "
"0","        result <- data.frame("
"0","          Model = model_name,"
"0","          Variable = rownames(coef_df),"
"0","          Beta = coef_df[, ""coef""],"
"0","          SE = coef_df[, ""se(coef)""],"
"0","          HR = conf_int[, ""exp(coef)""],"
"0","          Lower_95CI = conf_int[, ""lower .95""],"
"0","          Upper_95CI = conf_int[, ""upper .95""],"
"0","          P_value = coef_df[, ""Pr(>|z|)""],"
"0","          stringsAsFactors = FALSE"
"0","        )"
"0","        "
"0","        all_coef[[model_name]] <- result"
"0","        "
"0","      # リスト型モデル"
"0","      } else if (inherits(model, ""list"") && ""model"" %in% names(model) && !is.null(model$model)) {"
"0","        inner_model <- model$model"
"0","        if (inherits(inner_model, ""coxph"")) {"
"0","          model_summary <- summary(inner_model)"
"0","          coef_df <- as.data.frame(model_summary$coefficients)"
"0","          conf_int <- as.data.frame(model_summary$conf.int)"
"0","          "
"0","          result <- data.frame("
"0","            Model = model_name,"
"0","            Variable = rownames(coef_df),"
"0","            Beta = coef_df[, ""coef""],"
"0","            SE = coef_df[, ""se(coef)""],"
"0","            HR = conf_int[, ""exp(coef)""],"
"0","            Lower_95CI = conf_int[, ""lower .95""],"
"0","            Upper_95CI = conf_int[, ""upper .95""],"
"0","            P_value = coef_df[, ""Pr(>|z|)""],"
"0","            stringsAsFactors = FALSE"
"0","          )"
"0","          "
"0","          all_coef[[model_name]] <- result"
"0","        }"
"0","      }"
"0","    }"
"0","  }"
"0","  "
"0","  # 結合"
"0","  if (length(all_coef) > 0) {"
"0","    combined <- do.call(rbind, all_coef)"
"0","    rownames(combined) <- NULL"
"0","    return(combined)"
"0","  }"
"0","  "
"0","  return(NULL)"
"0","}"
"0",""
"0","# 実行"
"0","if (exists(""models"")) {"
"0","  model_coefficients <- extract_all_coefficients(models)"
"0","  "
"0","  if (!is.null(model_coefficients)) {"
"0","    # ベストモデルのみ表示（全体は大きいため）"
"0","    best_model_coef <- model_coefficients[model_coefficients$Model == best_model_name, ]"
"0","    message(sprintf(""Coefficients for Best Model (%s):"", best_model_name))"
"0","    print(best_model_coef, digits = 3)"
"0","    "
"0","    # CSVとして保存"
"0","    write.csv(model_coefficients, "
"0","              file.path(paths$output_tables, ""all_model_coefficients.csv""),"
"0","              row.names = FALSE)"
"0","    message(sprintf(""\n✓ Full coefficient table saved to: all_model_coefficients.csv""))"
"0","    "
"0","    # 変数の使用頻度"
"0","    var_frequency <- table(model_coefficients$Variable)"
"0","    var_frequency <- sort(var_frequency, decreasing = TRUE)"
"0","    message(""\nTop 10 most frequently selected variables:"")"
"0","    print(head(var_frequency, 10))"
"0","  }"
"0","}"
"2","Coefficients for Best Model (m1_stepaic_forward):
"
